<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no">

        <!-- Performance: DNS prefetch and preconnect for external resources -->
        <link rel="dns-prefetch" href="https://fonts.googleapis.com">
        <link rel="dns-prefetch" href="https://fonts.gstatic.com">
        <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
        <link rel="dns-prefetch" href="https://js.stripe.com">
        <link rel="preconnect" href="https://unpkg.com" crossorigin>

        <!-- Preload critical resources -->
        <link rel="preload"
            href="{{ url_for('static', filename='css/loader.css') }}"
            as="style">
        <link rel="preload"
            href="{{ url_for('static', filename='css/combined.css') }}"
            as="style">
        <link rel="preload"
            href="{{ url_for('static', filename='js/loader.js') }}" as="script">
        <link rel="preload"
            href="{{ url_for('static', filename='img/ahoy_logo.png') }}"
            as="image"
            fetchpriority="high">
        <meta name="description"
            content="{% block description %}Discover and save indie music, videos, and media. Create playlists, save favorites, and explore new artists on Ahoy Indie Media.{% endblock %}">
        <meta name="keywords"
            content="indie music, indie videos, music discovery, save music, music playlists, indie artists, music platform">
        <meta name="author" content="Ahoy Indie Media">
        <meta name="robots" content="index, follow">

        <!-- PWA Meta Tags -->
        <meta name="theme-color" content="#111111">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style"
            content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Ahoy">
        <link rel="manifest" href="/static/manifest.webmanifest">
        <link rel="apple-touch-icon" href="/static/images/icon-192.png">

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="{{ request.url }}">
        <meta property="og:title"
            content="{% block og_title %}Ahoy Indie Media - Discover Indie Music & Videos{% endblock %}">
        <meta property="og:description"
            content="{% block og_description %}Discover and save indie music, videos, and media. Create playlists, save favorites, and explore new artists.{% endblock %}">
        <meta property="og:image"
            content="{{ url_for('static', filename='img/ahoy_logo.png', _external=True) }}">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:site_name" content="Ahoy Indie Media">

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:url" content="{{ request.url }}">
        <meta name="twitter:title"
            content="{% block twitter_title %}Ahoy Indie Media - Discover Indie Music & Videos{% endblock %}">
        <meta name="twitter:description"
            content="{% block twitter_description %}Discover and save indie music, videos, and media. Create playlists, save favorites, and explore new artists.{% endblock %}">
        <meta name="twitter:image"
            content="{{ url_for('static', filename='img/ahoy_logo.png', _external=True) }}">
        <meta name="twitter:image:alt" content="Ahoy Indie Media Logo">

        <!-- Canonical URL -->
        <link rel="canonical" href="{{ request.url }}">

        <!-- Favicon -->
        <link rel="icon" type="image/png"
            href="{{ url_for('static', filename='img/ahoy-fall2025-favicon.png') }}">
        <link rel="shortcut icon" type="image/png"
            href="{{ url_for('static', filename='img/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon"
            href="{{ url_for('static', filename='img/ahoy-fall2025-favicon.png') }}">
        <link rel="apple-touch-icon" sizes="180x180"
            href="{{ url_for('static', filename='img/ahoy-fall2025-favicon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32"
            href="{{ url_for('static', filename='img/ahoy-fall2025-favicon.png') }}">
        <link rel="icon" type="image/png" sizes="16x16"
            href="{{ url_for('static', filename='img/ahoy-fall2025-favicon.png') }}">

        <title>{% block title %}Ahoy Indie Media{% endblock %}</title>

        <!-- CSS - Load design tokens first, then loader for instant display -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/design-tokens.css') }}">
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/loader.css') }}">
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/main.css') }}">
        <!-- Combined: global.css + base.css (reduces HTTP requests) -->
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/combined.css') }}">
        <link rel="stylesheet"
            href="{{ url_for('static', filename='css/mobile.css') }}">
        {% block extra_css %}{% endblock %}

        <!-- Google Fonts - Inter (optimized loading with font-display: swap) -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
            media="print" onload="this.media='all'"
            crossorigin="anonymous">
        <noscript>
            <link
                href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
                rel="stylesheet">
        </noscript>

        <!-- Font Awesome (non-render-blocking) -->
        <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            media="print" onload="this.media='all'">
        <noscript>
            <link rel="stylesheet"
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        </noscript>

        <!-- NProgress - Loading Progress Bar (deferred, we have our own loader now) -->
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css"
            media="print" onload="this.media='all'">
        <script defer
            src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

        <!-- Stripe publishable key (online checkout uses Stripe-hosted Checkout) -->
        <meta name="stripe-publishable-key"
            content="{{ STRIPE_PUBLISHABLE_KEY }}">

        <!-- App data component - must load before Alpine.js -->
        <script>
        // Stub for toast function (will be defined later in app.js)
        window.__ahoyToast = window.__ahoyToast || function(msg) {
          console.log('Toast:', msg);
        };
        
        // Define the main app component for Alpine.js (body element)
        // This must be defined before Alpine.js loads
        window.appData = function() {
          return {
            // Navigation state
            navOpen: false,
            accountOpen: false,
            mobileDrawer: false,
            
            // Auth modals state
            showLogin: false,
            showRegister: false,
            loginForm: {
              username: '',
              password: ''
            },
            registerForm: {
              username: '',
              email: '',
              password: ''
            },
            isLoading: false,
            
            // Auth methods
            async login() {
              if (!this.loginForm.username || !this.loginForm.password) {
                window.__ahoyToast && window.__ahoyToast('Please enter username and password');
                return;
              }
              
              this.isLoading = true;
              try {
                const response = await fetch('/api/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({
                    identifier: this.loginForm.username, // Email OR username
                    password: this.loginForm.password
                  })
                });
                
                if (response.ok) {
                  const data = await response.json();
                  try { 
                    if (typeof localStorage !== 'undefined' && localStorage.setItem) {
                      localStorage.setItem('ahoyLastIdentifier', this.loginForm.username);
                    }
                  } catch (_) {}
                  if (window.__ahoyToast) {
                    window.__ahoyToast('Login successful!');
                  }
                  this.showLogin = false;
                  this.loginForm = { username: '', password: '' };
                  // Reload page to update UI
                  setTimeout(() => {
                    window.location.reload();
                  }, 500);
                } else {
                  let errorMessage = 'Login failed';
                  try {
                    const error = await response.json();
                    errorMessage = error.message || error.error || errorMessage;
                  } catch (_) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                  }
                  if (window.__ahoyToast) {
                    window.__ahoyToast(errorMessage);
                  }
                }
              } catch (error) {
                console.error('Login error:', error);
                window.__ahoyToast && window.__ahoyToast('Login failed. Please try again.');
              } finally {
                this.isLoading = false;
              }
            },
            
            async register() {
              if (!this.registerForm.username || !this.registerForm.email || !this.registerForm.password) {
                window.__ahoyToast && window.__ahoyToast('Please fill in all fields');
                return;
              }
              
              this.isLoading = true;
              try {
                const response = await fetch('/api/auth/register', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({
                    username: this.registerForm.username,
                    email: this.registerForm.email,
                    password: this.registerForm.password
                  })
                });
                
                if (response.ok) {
                  const data = await response.json();
                  try { 
                    if (typeof localStorage !== 'undefined' && localStorage.setItem) {
                      localStorage.setItem('ahoyLastIdentifier', this.registerForm.username);
                    }
                  } catch (_) {}
                  if (window.__ahoyToast) {
                    window.__ahoyToast('Registration successful!');
                  }
                  this.showRegister = false;
                  this.registerForm = { username: '', email: '', password: '' };
                  // Reload page to update UI
                  setTimeout(() => {
                    window.location.reload();
                  }, 500);
                } else {
                  let errorMessage = 'Registration failed';
                  try {
                    const error = await response.json();
                    errorMessage = error.message || error.error || errorMessage;
                  } catch (_) {
                    errorMessage = response.statusText || errorMessage;
                  }
                  if (window.__ahoyToast) {
                    window.__ahoyToast(errorMessage);
                  }
                }
              } catch (error) {
                console.error('Registration error:', error);
                if (window.__ahoyToast) {
                  window.__ahoyToast('Registration failed. Please try again.');
                }
              } finally {
                this.isLoading = false;
              }
            }
          };
        };

        // Compact Footer Component
        window.compactFooter = function() {
          return {
            currentTime: '',
            tickerOffset: 0,
            tickerSpeed: 0.5,
            announcements: [
              'Welcome to Ahoy Indie Media',
              'Discover new indie music and videos',
              'Create playlists and save your favorites',
              'Follow your favorite artists',
              'Explore videos and events'
            ],
            
            init() {
              // Update time immediately and every second (pause when tab hidden)
              this.updateTime();
              let timePoller = null;
              const startTimeUpdate = () => {
                if (timePoller) return;
                timePoller = setInterval(() => {
                  if (document.visibilityState === 'visible') {
                    this.updateTime();
                  }
                }, 1000);
              };
              const stopTimeUpdate = () => {
                if (timePoller) {
                  clearInterval(timePoller);
                  timePoller = null;
                }
              };
              if (document.visibilityState === 'visible') startTimeUpdate();
              document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                  this.updateTime(); // Update immediately on return
                  startTimeUpdate();
                } else {
                  stopTimeUpdate();
                }
              });
              
              // Start ticker animation
              this.startTicker();
            },
            
            updateTime() {
              const now = new Date();
              this.currentTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
              });
            },
            
            startTicker() {
              // Wait for Alpine to render, then start animation
              setTimeout(() => {
                const tickerContent = document.querySelector('.ticker-content');
                if (!tickerContent) {
                  // Retry if not ready yet
                  setTimeout(() => this.startTicker(), 200);
                  return;
                }
                
                const animate = () => {
                  this.tickerOffset -= this.tickerSpeed;
                  
                  // Get the ticker wrapper
                  const tickerWrapper = document.querySelector('.ticker-wrapper');
                  
                  if (tickerWrapper && tickerContent) {
                    const contentWidth = tickerContent.scrollWidth / 2; // Half because we duplicate
                    const wrapperWidth = tickerWrapper.offsetWidth;
                    
                    // Reset when scrolled past first set of announcements
                    if (Math.abs(this.tickerOffset) >= contentWidth) {
                      this.tickerOffset = 0;
                    }
                  }
                  
                  requestAnimationFrame(animate);
                };
                
                requestAnimationFrame(animate);
              }, 300);
            }
          };
        };
        </script>

        <!-- Alpine.js for reactive components -->
        <script defer
            src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <!-- Mobile helpers -->
        <script defer
            src="{{ url_for('static', filename='js/mobile.js') }}"></script>

        <!-- Three.js visualizer removed (perf). -->

        <!-- Loading is now handled by loader.js -->
        <script>
        // Global cast receiver: accept ahoy:play messages from /cast sender
        window.addEventListener('message', (e) => {
            try {
                const data = e && e.data || {};
                if (data && data.type === 'ahoy:play' && data.payload) {
                    // If global player helper exists, trigger playback
                    if (window.globalPlayer && typeof window.globalPlayer.play === 'function') {
                        window.globalPlayer.play(data.payload);
                    } else {
                        // Fallback: navigate to the player page
                        const item = data.payload;
                        const type = (item.type === 'show' || item.video_url) ? 'show' : 'music';
                        window.location.href = `/player?id=${encodeURIComponent(item.id)}&type=${type}`;
                    }
                }
            } catch (err) { console.error('Cast receive failed', err); }
        });
    </script>

        {% block extra_head %}{% endblock %}
    </head>

    <body x-data="appData()"
        class="overflow-x-hidden">
        {% set show_dashboard_sidebars = show_dashboard_sidebars|default(false)
        %}

        <!-- Full Page Loading Screen with Progress -->
        <div id="app-loader">
            <!-- Floating Ambient Light Orbs -->
            <div class="orb blue"></div>
            <div class="orb purple"></div>
            <div class="orb blue-alt"></div>
            
            <!-- Glass Panel Container -->
            <div class="loader-content">
                <div class="logo-glass">
                    <img src="{{ url_for('static', filename='img/ahoy_logo.png') }}"
                        alt="Ahoy Logo"
                        class="loader-logo"
                        onerror="this.style.display='none'">
                </div>
                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="status-text" id="progress-text"></div>
                    <div class="status-details" id="progress-details"></div>
                    <div class="progress-percent" id="progress-percent">0%</div>
                </div>
            </div>
        </div>

        <!-- Mobile Status Bar (fixed top, compact) -->
        <div class="mobile-status-bar mobile-only" x-data="statusBar()"
            x-init="init()">
            <div class="status-bar-content">
                <div class="status-left">
                    <a href="/" class="status-action-btn status-home-btn" title="Home" aria-label="Home">
                        <i class="fas fa-home"></i>
                    </a>
                    <span class="status-time" id="statusTime"></span>
                    <span class="status-breadcrumb" x-text="breadcrumbText"
                        :title="breadcrumbText"
                        style="margin-left:10px; max-width: 60vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color: rgba(255,255,255,0.82);"></span>
                </div>
                <div class="status-right">
                    <button @click="openMobileSearch()"
                        class="status-action-btn" title="Search" type="button"
                        aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                    <a href="/bookmarks" class="status-action-btn"
                        title="Bookmarks" aria-label="Bookmarks">
                        <i class="fas fa-bookmark"></i>
                        <span class="notification-badge"
                            x-show="hasNewBookmarks"
                            x-text="newBookmarkCount > 0 ? newBookmarkCount : ''"></span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="app-header" style="padding-top:8px; padding-bottom:8px;">
            <!-- Mobile Auth Bar (Top) - Hidden per user request -->
            <div class="mobile-auth-bar mobile-only"
                style="display: none !important;"
                x-data="{ menuOpen: false }"
                x-init="document.body.classList.add('mobile-auth-active')">
                {% if LOGGED_IN %}
                <div class="auth-bar-user">
                    <a href="/account" class="auth-user-link"
                        aria-label="Account">
                        <i class="fas fa-user-circle"></i>
                        <span>Account</span>
                    </a>
                    <a href="/settings" class="auth-settings-link"
                        aria-label="Settings">
                        <i class="fas fa-cog"></i>
                    </a>
                </div>
                {% else %}
                <div class="auth-bar-guest">
                    <a href="/auth" class="auth-login-btn auth-cta"
                        aria-label="Sign In">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Sign In</span>
                    </a>
                    <a href="/auth" class="auth-signup-btn auth-cta"
                        aria-label="Create Account">
                        <span>Sign Up</span>
                    </a>
                </div>
                {% endif %}
            </div>
            <!-- Mobile Top Bar -->
            <div class="mobile-nav-root"
                x-data="{ open:false, searchOpen:false, boostOpen:false }">
                <nav class="mobile-top-nav mobile-only" role="navigation"
                    aria-label="Primary">
                    <a href="{{ url_for('music') }}"
                        class="mobile-tab {% if request.endpoint == 'music' %}active{% endif %}">
                        <i class="fas fa-music" aria-hidden="true"></i>
                        <span>Music</span>
                    </a>
                    <a href="{{ url_for('shows') }}"
                        class="mobile-tab {% if request.endpoint == 'shows' %}active{% endif %}">
                        <i class="fas fa-video" aria-hidden="true"></i>
                        <span>Videos</span>
                    </a>
                    <a href="{{ url_for('live_tv_page') }}"
                        class="mobile-tab {% if request.endpoint == 'live_tv_page' %}active{% endif %}">
                        <i class="fas fa-tv" aria-hidden="true"></i>
                        <span>Live TV</span>
                    </a>
                    <a href="{{ url_for('artists') }}"
                        class="mobile-tab {% if request.endpoint == 'artists' %}active{% endif %}">
                        <i class="fas fa-users" aria-hidden="true"></i>
                        <span>Artists</span>
                    </a>
                    <a href="/podcasts"
                        class="mobile-tab {% if request.path.startswith('/podcasts') %}active{% endif %}">
                        <i class="fas fa-podcast" aria-hidden="true"></i>
                        <span>Podcasts</span>
                    </a>
                    <a href="/merch"
                        class="mobile-tab {% if request.endpoint == 'merch' or request.endpoint == 'merch_page' %}active{% endif %}">
                        <i class="fas fa-shopping-bag" aria-hidden="true"></i>
                        <span>Merch</span>
                    </a>
                    <a href="/radio" class="mobile-tab">
                        <i class="fas fa-broadcast-tower"
                            aria-hidden="true"></i>
                        <span>Radio</span>
                    </a>
                    <a href="/bookmarks"
                        class="mobile-tab {% if request.endpoint == 'bookmarks_page' %}active{% endif %}">
                        <i class="fas fa-bookmark" aria-hidden="true"></i>
                        <span>Saved</span>
                    </a>
                </nav>
                <!-- Mobile hamburger overlay removed to avoid duplicate navigation.
                         Mobile uses the bottom tab bar + the top utility bar. -->
                <div x-show="searchOpen" class="mobile-search-panel"
                    style="display:none;">
                    <!-- existing search input -->
                </div>
                <div x-show="boostOpen" class="mobile-boost-panel"
                    style="display:none;">
                    <!-- existing boost UI -->
                </div>
            </div>
            <!-- Navigation -->
            <nav class="navbar desktop-nav" x-data="navbar()" x-init="init()">
                <div class="nav-container ds-statusbar max-w-7xl mx-auto px-4">

                    <!-- Logo (avoid duplicate logo when AppShell sidebar is present) -->
                    {% if show_dashboard_sidebars %}
                    <div class="nav-logo">
                        <a href="{{ url_for('home') }}">
                            <img
                                src="{{ url_for('static', filename='img/ahoy_logo.png') }}"
                                alt="Ahoy Indie Media">
                        </a>
                    </div>
                    {% endif %}
                    <!-- Logo for mobile (always visible on mobile) -->
                    <div class="nav-logo mobile-only" {% if not
                        show_dashboard_sidebars %}style="display: flex;" {%
                        endif %}>
                        <a href="{{ url_for('home') }}">
                            <img
                                src="{{ url_for('static', filename='img/ahoy_logo.png') }}"
                                alt="Ahoy Indie Media">
                        </a>
                    </div>
                    <!-- Mobile Title (text instead of logo) - Hidden, logo shows instead -->
                    <div class="nav-title-mobile mobile-only"
                        style="display: none;">Ahoy Indie
                        Media</div>

                    <!-- Mobile Hamburger -->
                    <button class="mobile-hamburger mobile-only"
                        @click="navOpen = true; accountOpen = false; $store?.mobileNav ? ($store.mobileNav.open = true, $store.mobileNav.account = false) : null"
                        title="Menu"
                        aria-label="Open Menu">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Status Bar Layout -->
                    <div class="ds-statusbar__left">
                        <!-- Back/Forward (Desktop) -->
                        <div class="nav-history desktop-only"
                            aria-label="History navigation">
                            <button class="nav-history-btn" type="button"
                                title="Back" aria-label="Back"
                                @click="goBack()">
                                <i class="fas fa-chevron-left"
                                    aria-hidden="true"></i>
                            </button>
                            <button class="nav-history-btn" type="button"
                                title="Forward" aria-label="Forward"
                                @click="goForward()">
                                <i class="fas fa-chevron-right"
                                    aria-hidden="true"></i>
                            </button>
                        </div>

                        <!-- Breadcrumb / Location -->
                        <nav class="ds-crumbs" aria-label="Location">
                            <template x-for="(c, idx) in breadcrumbs"
                                :key="idx">
                                <span class="ds-crumbs__item">
                                    <template
                                        x-if="c.href && idx < breadcrumbs.length - 1">
                                        <a :href="c.href" x-text="c.label"
                                            class="ds-crumbs__link"></a>
                                    </template>
                                    <template
                                        x-if="!c.href || idx === breadcrumbs.length - 1">
                                        <span
                                            :class="idx === breadcrumbs.length - 1 ? 'ds-crumbs__current' : 'ds-crumbs__muted'"
                                            x-text="c.label"></span>
                                    </template>
                                    <span class="ds-crumbs__sep"
                                        x-show="idx < breadcrumbs.length - 1">›</span>
                                </span>
                            </template>
                        </nav>
                    </div>

                    <!-- Now / Live State (subtle) -->
                    <div class="statusbar-center desktop-only"
                        aria-label="Now Playing">
                        <div class="statusbar-pill" x-show="nowPillText"
                            x-text="nowPillText"></div>
                    </div>

                    <!-- Utilities (Right) -->
                    <div class="ds-statusbar__right">
                        <!-- Account Features Dropdown (Desktop Only - Logged In) -->
                        <div class="hidden-mobile account-menu-container"
                            x-show="isLoggedIn" x-cloak
                            @click.outside="accountMenuOpen = false">
                            <button
                                @click="accountMenuOpen = !accountMenuOpen; console.log('Account menu clicked, new state:', accountMenuOpen)"
                                class="ds-iconbtn ds-iconbtn--account nav-item account-menu-btn"
                                title="Account">
                                <i class="fas fa-user"
                                    style="font-size:16px;color:#bdbdbd;"></i>
                                <i class="fas fa-chevron-down"
                                    style="font-size:10px;color:#bdbdbd;transition:transform .2s;"
                                    :class="{'rotate-180': accountMenuOpen}"></i>
                            </button>

                            <!-- Unified Account Features Dropdown -->
                            <div x-show="accountMenuOpen"
                                x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 scale-95 translate-y-1"
                                x-transition:enter-end="opacity-100 scale-100 translate-y-0"
                                x-transition:leave="transition ease-in duration-150"
                                x-transition:leave-start="opacity-100 scale-100 translate-y-0"
                                x-transition:leave-end="opacity-0 scale-95 translate-y-1"
                                class="account-dropdown-menu">

                                <!-- User Header -->
                                <div
                                    class="px-4 py-4 bg-gradient-to-br from-purple-600/20 via-pink-600/20 to-blue-600/20 border-b border-neutral-700/50">
                                    <div class="mb-2">
                                        <p
                                            class="hdr-username text-sm font-semibold text-white truncate"
                                            x-text="userProfile.display_name || userProfile.username || 'Guest'"></p>
                                    </div>
                                </div>

                                <!-- Main Menu Items -->
                                <div class="account-menu-items">

                                    <!-- Profile first (prominent) -->
                                    <a href="/account"
                                        class="account-menu-item account-menu-item--primary"
                                        @click="accountMenuOpen = false">
                                        <i
                                            class="fas fa-user-circle account-menu-icon"></i>
                                        <div class="account-menu-text">
                                            <div
                                                class="account-menu-label">Profile</div>
                                            <div
                                                class="account-menu-desc">Account
                                                & security</div>
                                        </div>
                                    </a>

                                    <a href="/bookmarks"
                                        class="account-menu-item account-menu-item-badge"
                                        @click="accountMenuOpen = false">
                                        <i
                                            class="fas fa-bookmark account-menu-icon"></i>
                                        <div class="account-menu-text">
                                            <div
                                                class="account-menu-label">Bookmarks</div>
                                            <div class="account-menu-desc">Saved
                                                content</div>
                                        </div>
                                        <span x-show="totalBookmarkCount > 0"
                                            class="account-menu-badge"
                                            x-text="totalBookmarkCount"></span>
                                    </a>

                                    <a href="/settings"
                                        class="account-menu-item"
                                        @click="accountMenuOpen = false">
                                        <i
                                            class="fas fa-cog account-menu-icon"></i>
                                        <div class="account-menu-text">
                                            <div
                                                class="account-menu-label">Settings</div>
                                            <div
                                                class="account-menu-desc">Preferences</div>
                                        </div>
                                    </a>
                                </div>

                                <!-- Divider -->
                                <div class="account-menu-divider"></div>

                                <!-- Sign Out -->
                                <div class="account-menu-items">
                                    <button
                                        @click="logout(); accountMenuOpen = false"
                                        class="account-menu-item account-menu-item-signout">
                                        <i
                                            class="fas fa-sign-out-alt account-menu-icon"></i>
                                        <div class="account-menu-text">
                                            <div class="account-menu-label">Sign
                                                Out</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Fullscreen Toggle (Desktop Only) -->
                        <button @click="toggleFullscreen()"
                            class="ds-iconbtn nav-item hidden-mobile"
                            title="Fullscreen">
                            <i class="fas fa-expand" style="font-size:16px;"></i>
                        </button>
                    </div>

                    <!-- Mobile Right: Explore + Guest (text) -->
                    <div class="mobile-only" style="display:flex; gap:8px;">
                        <button id="openExplore" class="nav-item"
                            style="min-width:44px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#e5e7eb;">
                            Explore
                        </button>
                        <button id="openAccount" class="nav-item"
                            style="min-width:44px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#e5e7eb;">
                            Guest
                        </button>
                    </div>
                </div>
            </nav>
        </header>
        <!-- Mobile Explore replaced by overlay -->
        <!-- Mobile Footer Logo (centered above nav) -->
        <div class="mobile-footer-logo mobile-only">
            <img src="{{ url_for('static', filename='img/ahoy_logo.png') }}"
                alt="Ahoy" class="mobile-footer-logo-img">
        </div>
        <!-- Mobile Secondary Navigation - Secondary Features (above primary nav) -->
        <nav class="mobile-secondary-nav mobile-only" role="navigation"
            aria-label="Secondary Navigation">
            <a href="/"
                class="mobile-tab {% if request.endpoint == 'home' %}active{% endif %}">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="{{ url_for('artists') }}"
                class="mobile-tab {% if request.endpoint == 'artists' %}active{% endif %}">
                <i class="fas fa-users"></i>
                <span>Artists</span>
            </a>
            <a href="/merch"
                class="mobile-tab {% if request.endpoint == 'merch' or request.endpoint == 'merch_page' %}active{% endif %}">
                <i class="fas fa-shopping-bag"></i>
                <span>Merch</span>
            </a>
            <a href="/events"
                class="mobile-tab {% if request.endpoint == 'events_page' or request.path.startswith('/events') %}active{% endif %}">
                <i class="fas fa-calendar-alt"></i>
                <span>Events</span>
            </a>
            <a href="/account"
                class="mobile-tab {% if request.endpoint == 'account' or request.endpoint == 'account_page' %}active{% endif %}">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </a>
        </nav>
        <!-- Mobile Bottom Navigation - Media Features (Primary Row) -->
        <nav class="mobile-bottom-nav mobile-only" role="navigation"
            aria-label="Media Navigation">
            <a href="{{ url_for('music') }}"
                class="mobile-tab {% if request.endpoint == 'music' %}active{% endif %}">
                <i class="fas fa-music"></i>
                <span>Music</span>
            </a>
            <a href="/podcasts"
                class="mobile-tab {% if request.endpoint == 'podcasts_page' or request.path.startswith('/podcasts') %}active{% endif %}">
                <i class="fas fa-podcast"></i>
                <span>Podcasts</span>
            </a>
            <a href="{{ url_for('live_tv_page') }}"
                class="mobile-tab {% if request.endpoint == 'live_tv_page' %}active{% endif %}">
                <i class="fas fa-tv"></i>
                <span>Live TV</span>
            </a>
            <a href="{{ url_for('shows') }}"
                class="mobile-tab {% if request.endpoint == 'shows' %}active{% endif %}">
                <i class="fas fa-video"></i>
                <span>Videos</span>
            </a>
        </nav>
        <div class="desktop-only">
            {% include '_nav_main.html' %}
            {% include '_nav_user.html' %}
        </div>

        <!-- New Mobile Overlays -->
        <div id="mobileMenu" class="mobile-menu hidden mobile-only"
            aria-hidden="true"></div>
        <div id="accountMenu" class="mobile-account hidden mobile-only"
            aria-hidden="true"></div>

        <!-- Mobile Search Popup (mobile only) -->
        <div id="mobile-search-popup" class="mobile-search-popup mobile-only"
            x-data="mobileSearch()" x-show="isOpen" x-cloak
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4"
            x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 translate-y-4"
            style="display: none;">
            <div class="mobile-search-overlay" @click="close()"></div>
            <div class="mobile-search-container">
                <div class="mobile-search-header">
                    <h2>Search</h2>
                    <button @click="close()" class="mobile-search-close"
                        aria-label="Close search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mobile-search-input-wrapper">
                    <i class="fas fa-search mobile-search-icon"></i>
                    <input type="text"
                        x-model="searchQuery"
                        @keyup.enter="performSearch()"
                        @input="handleInput()"
                        placeholder="Search music, videos, artists..."
                        class="mobile-search-input"
                        autofocus>
                    <button @click="clearSearch()" class="mobile-search-clear"
                        x-show="searchQuery">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mobile-search-suggestions"
                    x-show="searchQuery.length > 0 && suggestions.length > 0">
                    <div class="suggestions-header">Suggestions</div>
                    <div class="suggestions-list">
                        <template x-for="suggestion in suggestions"
                            :key="suggestion.id">
                            <button @click="selectSuggestion(suggestion)"
                                class="suggestion-item">
                                <i :class="suggestion.icon"></i>
                                <div class="suggestion-content">
                                    <div class="suggestion-title"
                                        x-text="suggestion.title"></div>
                                    <div class="suggestion-subtitle"
                                        x-text="suggestion.subtitle"></div>
                                </div>
                            </button>
                        </template>
                    </div>
                </div>
                <div class="mobile-search-recents"
                    x-show="searchQuery.length === 0 && recentSearches.length > 0">
                    <div class="recents-header">
                        <span>Recent Searches</span>
                        <button @click="clearRecents()"
                            class="clear-recents-btn">Clear</button>
                    </div>
                    <div class="recents-list">
                        <template x-for="(recent, index) in recentSearches"
                            :key="index">
                            <button @click="selectRecent(recent)"
                                class="recent-item">
                                <i class="fas fa-clock"></i>
                                <span x-text="recent"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top boost status badge -->
        <div id="boost-status-badge" aria-live="polite" class="hidden">
            <i class="fas fa-check-circle"></i>
            <span class="boost-status-text">Boost Sent</span>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            {% if show_dashboard_sidebars %}
            <div class="dashboard-sidebars">
                <!-- Left Dashboard: Collection -->
                <aside class="dashboard-sidebar dashboard-left desktop-only"
                    x-data="dashboardCollection()" x-init="init()">
                    <div class="sidebar-content">

                        <!-- Global Search -->
                        <div class="sidebar-panel sidebar-item desktop-only"
                            data-sidebar-section="search">
                            <div class="section-title">Search</div>
                            <div class="sidebar-search-container">
                                <i
                                    class="fas fa-search sidebar-search-icon"></i>
                                <input type="text"
                                    placeholder="Search music, videos, artists..."
                                    x-model="searchQuery"
                                    @keyup.enter="performSearch()"
                                    class="sidebar-search-input">
                                <button @click="clearSearch()"
                                    class="sidebar-search-clear"
                                    x-show="searchQuery">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Bookmarks -->
                        <div class="sidebar-panel sidebar-item"
                            data-sidebar-section="bookmarks">
                            <div class="section-title">Bookmarks</div>

                            <!-- Collections List -->
                            <div class="collections-list"
                                x-show="collections.length > 0">
                                <template x-for="col in collections"
                                    :key="col.id">
                                    <div class="sidebar-list-item"
                                        @click="goToCollection(col.id)"
                                        style="cursor: pointer; padding: 8px 0; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-folder"
                                            style="color: var(--text-muted);"></i>
                                        <span class="item-name"
                                            x-text="col.name"
                                            style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.9rem;"></span>
                                        <span class="item-count"
                                            x-text="col.items ? col.items.length : 0"
                                            style="font-size: 0.75rem; color: var(--text-muted);"></span>
                                    </div>
                                </template>
                            </div>

                        </div>

                        <!-- Boost (Compact) -->
                        <div class="tip-jar-card sidebar-item">
                            <div class="tip-jar-compact">
                                <!-- Compact select (top) -->
                                <div class="tip-jar-row tip-compact-row">
                                    <select x-model="selectedArtistId"
                                        class="tip-jar-select tip-compact-select tip-mini-field"
                                        aria-label="Select artist to boost">
                                        <option value>Artist…</option>
                                        <template x-for="artist in artists"
                                            :key="artist.id || artist.name">
                                            <option
                                                :value="artist.id || artist.name"
                                                x-text="artist.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <!-- Compact amount input (below) -->
                                <div class="tip-jar-row tip-compact-row">
                                    <div
                                        class="tip-jar-amount-group tip-mini-field">
                                        <span
                                            class="tip-jar-currency-prefix">$</span>
                                        <input type="number" x-model="tipAmount"
                                            min="0.50" step="0.01"
                                            placeholder="0.50"
                                            class="tip-jar-amount-input"
                                            @input="tipAmount = $event.target.value">
                                    </div>
                                </div>

                                <!-- Boost Breakdown Card -->
                                <div x-show="isValid"
                                    x-transition:enter="transition ease-out duration-200"
                                    x-transition:enter-start="opacity-0"
                                    x-transition:enter-end="opacity-100"
                                    class="tip-breakdown-card">
                                    <div class="tip-breakdown-title">Your Boost
                                        Breakdown</div>

                                    <div class="tip-breakdown-row">
                                        <span class="tip-breakdown-label">Boost
                                            Amount</span>
                                        <span class="tip-breakdown-value"
                                            x-text="'$' + (parseFloat(tipAmount || 0)).toFixed(2)"></span>
                                    </div>

                                    <div class="tip-breakdown-row">
                                        <span class="tip-breakdown-label">Stripe
                                            Fee (2.9% + $0.30)</span>
                                        <span class="tip-breakdown-value"
                                            x-text="'$' + calculateStripeFee(parseFloat(tipAmount || 0)).toFixed(2)"></span>
                                    </div>

                                    <div class="tip-breakdown-row">
                                        <span
                                            class="tip-breakdown-label">Platform
                                            Fee (7.5%)</span>
                                        <span class="tip-breakdown-value"
                                            x-text="'$' + calculatePlatformFee(parseFloat(tipAmount || 0)).toFixed(2)"></span>
                                    </div>

                                    <div class="tip-breakdown-divider"></div>

                                    <div
                                        class="tip-breakdown-row tip-breakdown-total">
                                        <span class="tip-breakdown-label">Total
                                            Charge</span>
                                        <span class="tip-breakdown-value"
                                            x-text="'$' + calculateTotalCharge(parseFloat(tipAmount || 0)).toFixed(2)"></span>
                                    </div>

                                    <div class="tip-breakdown-caption">
                                        100% of your boost goes directly to the
                                        artist.
                                    </div>
                                </div>

                                <!-- Send Boost Button -->
                                <button
                                    @click="window.location.href = `/checkout?type=boost&artist_id=${encodeURIComponent(selectedArtistId||'')}&amount=${encodeURIComponent(tipAmount||'')}`"
                                    :disabled="!isValid || isTipping"
                                    class="tip-jar-submit">
                                    <i class="fas fa-heart"
                                        x-show="!isTipping"></i>
                                    <i class="fas fa-spinner fa-spin"
                                        x-show="isTipping"></i>
                                    <span
                                        x-text="isTipping ? 'Processing…' : 'Boost'"></span>
                                </button>
                                <div class="text-right">
                                    <button type="button" class="tip-cancel"
                                        :disabled="!tipAmount || parseFloat(tipAmount || 0) <= 0"
                                        @click="tipAmount=''; document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Boost canceled.' }))">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Success Toast -->
                        <div x-show="showTipSuccess"
                            x-transition:enter="transition ease-out duration-300"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-200"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="fixed bottom-6 right-6 z-50 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 max-w-sm">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-2xl"></i>
                            </div>
                            <div>
                                <p class="font-semibold">Thanks for boosting
                                    independent artists!</p>
                            </div>
                        </div>

                        <!-- XP Reinforcement Modal -->
                        <template x-if="showXpReward">
                            <div class="xp-overlay"
                                @click.self="showXpReward=false">
                                <div class="xp-card">
                                    <div
                                        style="font-size:18px; font-weight:800; margin-bottom:6px;">Great
                                        job!</div>
                                    <div>You earned <span class="xp-points"
                                            x-text="'+' + (xpGain || 0)"></span>
                                        XP</div>
                                    <div
                                        style="opacity:.8; font-size:12px; margin-top:6px;">Total
                                        XP: <span x-text="xpTotal"></span></div>
                                    <button class="xp-close tip-cancel"
                                        @click="showXpReward=false">Close</button>
                                </div>
                            </div>
                        </template>

                        <!-- Merit Badges -->
                        <div class="sidebar-panel sidebar-item"
                            data-sidebar-section="merit-badges">
                            <div class="section-title">Merit Badges</div>
                            <div class="badges-mini">
                                <template x-for="badge in badges.slice(0, 4)"
                                    :key="badge.key">
                                    <div class="badge-mini"
                                        :class="'badge-' + (badge.tier || 'bronze')"
                                        :title="badge.title">
                                        <i
                                            :class="badge.icon || 'fas fa-medal'"></i>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Bookmarks -->
                        <div class="sidebar-panel sidebar-item"
                            data-sidebar-section="bookmarks">
                            <div class="section-title">Bookmarks</div>
                        </div>

                        <!-- Mini Player Footer -->
                        <div class="sidebar-mini-player" x-show="currentTrack">
                            <img
                                :src="currentTrack?.cover_art || currentTrack?.thumbnail || '/static/img/default-cover.jpg'"
                                alt="Track cover" class="mini-player-cover">
                            <div class="mini-player-info">
                                <div class="mini-player-title"
                                    x-text="currentTrack?.title || 'No track'"></div>
                                <div class="mini-player-artist"
                                    x-text="currentTrack?.artist || ''"></div>
                            </div>
                            <button @click="toggleTinyPlayer()"
                                class="mini-player-control">
                                <i
                                    :class="isTinyPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                            </button>
                        </div>
                    </div>
                </aside>

                <!-- Center Content -->
                <div class="content-area content-pad-bottom app-content">
                    {% block content %}{% endblock %}
                </div>

                <!-- Right Dashboard: Clock + Content -->
                <aside class="dashboard-sidebar dashboard-right"
                    x-data="dashboardUpNext()" x-init="init()">
                    <div class="sidebar-header"
                        style="display:flex;align-items:center;justify-content:center;padding: 1rem 0;">
                        <div
                            style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
                                    font-weight: 500;
                                    letter-spacing: .08em;
                                    font-size: 0.95rem;
                                    padding:.35rem .9rem;
                                    border-radius: 20px;
                                    background: linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
                                    box-shadow: 2px 2px 5px rgba(0,0,0,0.2), -1px -1px 4px rgba(255,255,255,0.05);
                                    border: 1px solid rgba(255,255,255,.08);
                                    backdrop-filter: blur(6px);
                                    color: rgba(255,255,255,.85);"
                            x-text="nowTime"></div>
                    </div>
                    <div class="sidebar-content">
                        <!-- Now Playing -->
                        <div class="section-title">Playing Now</div>
                        <div class="now-playing-mini" x-show="nowPlaying">
                            <div class="item-mini"
                                @click="goToMediaItem(nowPlaying)"
                                :class="{'radio-track': isRadioTrack(nowPlaying)}">
                                <img
                                    :src="nowPlaying?.cover_art || '/static/img/default-cover.jpg'"
                                    class="mini-cover">
                                <div>
                                    <div class="mini-title"
                                        x-text="nowPlaying?.title || ''"></div>
                                    <div class="mini-artist"
                                        x-text="nowPlaying?.artist || ''"></div>
                                </div>
                            </div>
                        </div>
                        <div class="empty-mini" x-show="!nowPlaying">
                            <span>Nothing playing</span>
                        </div>

                        <!-- Up Next Queue -->
                        <div class="section-title">Up Next</div>
                        <div class="queue-mini" x-show="queueItems.length > 0">
                            <template x-for="(item, index) in queueItems"
                                :key="item.id || index">
                                <div class="item-mini queue-item"
                                    @click="goToMediaItem(item)">
                                    <img :src="item.cover_art || item.thumbnail"
                                        class="mini-thumb">
                                    <div class="mini-info">
                                        <span class="mini-title"
                                            x-text="item.title"></span>
                                    </div>
                                    <button @click.stop="removeFromQueue(index)"
                                        class="queue-remove-btn"
                                        title="Remove from queue">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div class="empty-mini"
                            x-show="queueItems.length === 0">
                            <span>Queue is empty</span>
                        </div>

                        <!-- Recently Added -->
                        <div class="section-title">Recently Added</div>
                        <div class="recent-mini">
                            <template x-for="item in recent.slice(0, 3)"
                                :key="item.id">
                                <div class="item-mini"
                                    @click="goToMediaItem(item)">
                                    <img :src="item.cover_art"
                                        class="mini-thumb">
                                    <div class="mini-info">
                                        <span class="mini-title"
                                            x-text="item.title"></span>
                                    </div>
                                    <button @click.stop="addToQueue(item)"
                                        class="queue-add-btn"
                                        title="Add to queue">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <!-- Events -->
                        <div class="section-title">Events</div>
                        <div class="actions-mini actions-mini-vertical">
                            <a class="action-mini" href="/events">
                                Upcoming live Ahoy videos →
                            </a>
                        </div>

                        <!-- Quick Actions -->
                        <!-- <div class="section-title">Quick</div>
                        <div class="actions-mini actions-mini-vertical">
                            <div class="action-mini"
                                @click="goTo('/music')">Music</div>
                            <div class="action-mini"
                                @click="goTo('/shows')">Videos</div>
                            <div class="action-mini"
                                @click="goTo('/live-tv')">Live TV</div>
                            <div class="action-mini"
                                @click="goTo('/artists')">Artists</div>
                        </div> -->
                    </div>
                </aside>
            </div>
            {% else %}
            <div class="app-shell">
                <aside class="app-sidebar" aria-label="Primary">
                    <a class="app-sidebar-logo" href="{{ url_for('home') }}"
                        aria-label="Ahoy Home">
                        <img
                            src="{{ url_for('static', filename='img/ahoy_logo.png') }}"
                            alt="Ahoy Indie Media" />
                    </a>

                    <nav class="app-sidebar-nav"
                        aria-label="Primary navigation">
                        <a
                            class="app-sidebar-item {% if request.path == '/' %}active{% endif %}"
                            href="{{ url_for('home') }}"
                            data-icon="compass">
                            <i class="fas fa-compass" aria-hidden="true"></i>
                            <span>Explore</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'music' %}active{% endif %}"
                            href="{{ url_for('music') }}"
                            data-icon="music">
                            <i class="fas fa-music" aria-hidden="true"></i>
                            <span>Music</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.path.startswith('/podcasts') %}active{% endif %}"
                            href="/podcasts"
                            data-icon="podcast">
                            <i class="fas fa-podcast" aria-hidden="true"></i>
                            <span>Podcasts</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'live_tv_page' %}active{% endif %}"
                            href="/live-tv"
                            data-icon="tv">
                            <i class="fas fa-tv" aria-hidden="true"></i>
                            <span>Live TV</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'shows' %}active{% endif %}"
                            href="{{ url_for('shows') }}"
                            data-icon="video">
                            <i class="fas fa-video"
                                aria-hidden="true"></i>
                            <span>Videos</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'artists' %}active{% endif %}"
                            href="{{ url_for('artists') }}"
                            data-icon="users">
                            <i class="fas fa-users" aria-hidden="true"></i>
                            <span>Artists</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'radio_page' %}active{% endif %}"
                            href="/radio"
                            data-icon="broadcast-tower">
                            <i class="fas fa-broadcast-tower"
                                aria-hidden="true"></i>
                            <span>Radio</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'events_page' or request.path.startswith('/events') %}active{% endif %}"
                            href="/events"
                            data-icon="calendar-alt">
                            <i class="fas fa-calendar-alt"
                                aria-hidden="true"></i>
                            <span>Events</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'merch' or request.endpoint == 'merch_page' or request.path.startswith('/merch') %}active{% endif %}"
                            href="/merch"
                            data-icon="shopping-bag">
                            <i class="fas fa-shopping-bag"
                                aria-hidden="true"></i>
                            <span>Merch</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'bookmarks_page' %}active{% endif %}"
                            href="/bookmarks"
                            data-icon="bookmark">
                            <i class="fas fa-bookmark" aria-hidden="true"></i>
                            <span>Saved</span>
                        </a>
                    </nav>

                    <div class="app-sidebar-divider"></div>

                    <div class="app-sidebar-spacer"></div>

                    <nav class="app-sidebar-nav app-sidebar-nav--secondary"
                        aria-label="Account">
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'account_page' %}active{% endif %}"
                            href="/account"
                            data-icon="user">
                            <i class="fas fa-user" aria-hidden="true"></i>
                            <span>Profile</span>
                        </a>
                        <a
                            class="app-sidebar-item {% if request.endpoint == 'settings_page' %}active{% endif %}"
                            href="/settings"
                            data-icon="cog">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                            <span>Settings</span>
                        </a>
                    </nav>
                </aside>

                <div class="app-main">
                    <div class="content-area content-pad-bottom app-content">
                        {{ self.content() }}
                    </div>
                </div>
            </div>
            {% endif %}
        </main>

        <!-- Global Player - Glassy Now Playing -->
        <div class="now-playing-wrapper" x-data="globalPlayer()"
            x-show="currentTrack || isPlaying"
            x-effect="document.body.classList.toggle('has-player', !!(currentTrack || isPlaying))"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="transform translate-y-full opacity-0"
            x-transition:enter-end="transform translate-y-0 opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="transform translate-y-0 opacity-100"
            x-transition:leave-end="transform translate-y-full opacity-0">

            <!-- Glassy Now Playing Bar -->
            <div class="now-playing-glass now-playing-sticky">
                <div class="now-playing-container">
                    <!-- Left: Album Artwork -->
                    <div class="now-playing-album-art"
                        @click="openFullPlayer()">
                        <img
                            :src="currentTrack?.cover_art || '/static/img/default-cover.jpg'"
                            :alt="currentTrack?.title"
                            class="now-playing-album-img"
                            :class="{'spinning': isPlaying}">
                        <div class="now-playing-album-overlay"
                            x-show="!isPlaying">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>

                    <!-- Center: Track Info -->
                    <div class="now-playing-info">
                        <div class="now-playing-title"
                            x-text="currentTrack?.title || 'Unknown Title'"></div>
                        <div class="now-playing-secondary">
                            <div class="now-playing-artist"
                                x-show="currentTrack?.type === 'show'"
                                x-text="currentTrack?.host || currentTrack?.creator || 'Unknown Host'"></div>
                            <div class="now-playing-artist"
                                x-show="currentTrack?.type !== 'show'"
                                x-text="currentTrack?.artist || 'Unknown Artist'"></div>
                            <span x-show="currentTrack?.type === 'show'"
                                class="category-pill">
                                <i class="fas fa-play-circle"></i> Video
                            </span>
                            <span x-show="currentTrack?.type === 'podcast'"
                                class="category-pill">
                                <i class="fas fa-podcast"></i> Podcasts
                            </span>
                            <span
                                x-show="currentTrack?.type !== 'show' && currentTrack?.type !== 'podcast'"
                                class="category-pill">
                                <i class="fas fa-music"></i> Music
                            </span>
                        </div>
                    </div>

                    <!-- Right: Controls -->
                    <div class="now-playing-controls">
                        <button @click="previousTrack()" class="now-playing-btn"
                            title="Previous">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button @click="togglePlay()"
                            class="now-playing-btn now-playing-play-btn"
                            :title="isPlaying ? 'Pause' : 'Play'">
                            <i
                                :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                        </button>
                        <button @click="nextTrack()" class="now-playing-btn"
                            title="Next">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button @click="toggleShuffle()" class="now-playing-btn"
                            :class="{'active': isShuffled}"
                            title="Shuffle">
                            <i class="fas fa-random"></i>
                        </button>
                        <button @click="toggleRepeat()" class="now-playing-btn"
                            :class="{'active': isRepeated}"
                            title="Repeat">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button @click="openBoost()" class="now-playing-btn"
                            title="Boost">
                            <i class="fas fa-bolt"></i>
                        </button>
                        <button @click="toggleBookmarkCurrent()" class="now-playing-btn"
                            :class="{'active': isSaved}"
                            title="Bookmark">
                            <i :class="isSaved ? 'fas fa-bookmark' : 'far fa-bookmark'"
                                :style="isSaved ? 'color: var(--accent-color);' : ''"></i>
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="now-playing-progress">
                        <div class="now-playing-progress-bar"
                            @click="seekTo($event)">
                            <div class="now-playing-progress-fill"
                                :style="`width: ${progressPercent}%`"></div>
                            <div class="now-playing-progress-handle"
                                :style="`left: ${progressPercent}%`"></div>
                        </div>
                        <div class="now-playing-time">
                            <span x-text="formatTime(currentTime)"></span>
                            <span x-text="formatTime(duration)"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legacy Global Player (hidden, kept for compatibility) -->
        <div class="global-player" x-data="globalPlayer()" x-show="false"
            style="display: none;">
            <div class="player-container">
                <div class="player-info">
                    <div class="player-cover-container">
                        <img
                            :src="currentTrack?.cover_art || '/static/img/default-cover.jpg'"
                            :alt="currentTrack?.title"
                            class="player-cover"
                            :class="{'spinning': isPlaying}">
                        <div class="play-overlay" x-show="!isPlaying">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="player-details">
                        <h4
                            x-text="currentTrack?.title || 'Unknown Title'"></h4>
                        <p x-show="currentTrack?.type === 'show'"
                            x-text="currentTrack?.host || currentTrack?.creator || 'Unknown Host'"></p>
                        <p x-show="currentTrack?.type !== 'show'"
                            x-text="currentTrack?.artist || 'Unknown Artist'"></p>
                        <div class="player-meta">
                            <span x-show="currentTrack?.type === 'show'"
                                class="media-type">
                                <i class="fas fa-play-circle"></i> Video
                            </span>
                            <span x-show="currentTrack?.type === 'podcast'"
                                class="media-type">
                                <i class="fas fa-podcast"></i> Podcasts
                            </span>
                            <span
                                x-show="currentTrack?.type !== 'show' && currentTrack?.type !== 'podcast'"
                                class="media-type">
                                <i class="fas fa-music"></i> Music
                            </span>
                        </div>
                    </div>
                </div>

                <div class="player-controls">
                    <button @click="previousTrack()" class="control-btn"
                        title="Previous">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button @click="seekBackward()" class="control-btn"
                        title="15 seconds back">
                        <i class="fas fa-backward"></i>
                    </button>
                    <button @click="togglePlay()" class="control-btn play-btn"
                        :title="isPlaying ? 'Pause' : 'Play'">
                        <i
                            :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                    </button>
                    <button @click="toggleBookmarkCurrent()" class="control-btn"
                        :aria-pressed="isSaved" title="Bookmark">
                        <i
                            :class="isSaved ? 'fas fa-bookmark' : 'far fa-bookmark'"></i>
                    </button>
                    <button @click="seekForward()" class="control-btn"
                        title="15 seconds forward">
                        <i class="fas fa-forward"></i>
                    </button>
                    <button @click="nextTrack()" class="control-btn"
                        title="Next">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button @click="toggleShuffle()" class="control-btn"
                        :class="{'active': isShuffled}" title="Shuffle">
                        <i class="fas fa-random"></i>
                    </button>
                    <button @click="toggleRepeat()" class="control-btn"
                        :class="{'active': isRepeated}" title="Repeat">
                        <i class="fas fa-redo"></i>
                    </button>
                    <canvas x-ref="clock" class="analog-clock" width="40"
                        height="40" aria-hidden="true"></canvas>
                </div>

                <div class="player-progress">
                    <span class="time-current"
                        x-text="formatTime(currentTime)"></span>
                    <div class="progress-bar" @click="seekTo($event)">
                        <div class="progress-fill"
                            :style="`width: ${progressPercent}%`"></div>
                        <div class="progress-handle"
                            :style="`left: ${progressPercent}%`"></div>
                    </div>
                    <span class="time-total"
                        x-text="formatTime(currentTrack?.duration_seconds || 0)"></span>
                </div>

                <div class="player-actions">
                    <button @click="toggleLike()" class="action-btn"
                        :class="{'liked': isLiked}" title="Like">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button @click="toggleBookmarkCurrent()" class="action-btn bm-btn"
                        :class="{'saved': isSaved}"
                        :aria-pressed="isSaved"
                        title="Bookmark">
                        <span aria-hidden="true">
                            <i
                                x-show="isSaved"
                                class="fas fa-bookmark"
                                style="color: var(--accent-color);"></i>
                            <i
                                x-show="!isSaved"
                                class="far fa-bookmark"></i>
                        </span>
                        <span class="sr-only">Bookmark</span>
                    </button>
                    <button @click="addToPlaylist()" class="action-btn"
                        title="Add to Playlist">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button @click="toggleMute()" class="action-btn"
                        :class="{'muted': isMuted}" title="Mute">
                        <i
                            :class="isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up'"></i>
                    </button>
                    <button @click="openFullPlayer()" class="action-btn"
                        title="Full Player">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div x-show="showLogin" x-cloak class="modal-overlay"
            @click.away="showLogin = false">
            <div class="modal">
                <h3>Welcome back to Ahoy ✨</h3>
                <form @submit.prevent="login()">
                    <input type="text" x-model="loginForm.username"
                        placeholder="Email or username" required>
                    <input type="password" x-model="loginForm.password"
                        placeholder="Password" required>
                    <button type="submit" class="btn btn-primary"
                        :disabled="isLoading">
                        <span x-show="!isLoading">Let’s go 🎧</span>
                        <span x-show="isLoading">Logging in...</span>
                    </button>
                </form>
                <p class="modal-footer">
                    Don't have an account?
                    <a href="#"
                        @click="showLogin = false; showRegister = true">Sign
                        up</a>
                </p>
            </div>
        </div>

        <!-- Register Modal -->
        <div x-show="showRegister" x-cloak class="modal-overlay"
            @click.away="showRegister = false">
            <div class="modal">
                <h3>Claim your username 🚀</h3>
                <form @submit.prevent="register()">
                    <input type="text" x-model="registerForm.username"
                        placeholder="Username" required>
                    <input type="email" x-model="registerForm.email"
                        placeholder="Email" required>
                    <input type="password" x-model="registerForm.password"
                        placeholder="Password" required>
                    <button type="submit" class="btn btn-primary"
                        :disabled="isLoading">
                        <span x-show="!isLoading">Claim it 🎉</span>
                        <span x-show="isLoading">Creating account...</span>
                    </button>
                </form>
                <p class="modal-footer">
                    Already have an account?
                    <a href="#"
                        @click="showRegister = false; showLogin = true">Login</a>
                </p>
            </div>
        </div>

        <!-- Stripe Boost Modal -->
        <div id="stripe-boost-modal" class="modal-overlay"
            style="display:none; align-items:center; justify-content:center;">
            <div class="modal-mini" @click.stop>
                <h4 style="margin-bottom:10px;">Enter Card Details</h4>
                <div id="card-element"
                    style="padding:10px; border:1px solid #333; border-radius:8px; background:#1e1e1e;"></div>
                <div id="stripe-errors"
                    style="color:#ff6b6b; margin-top:10px; display:none;"></div>
                <div
                    style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                    <button id="stripe-boost-close" type="button"
                        class="btn-mini">Close</button>
                </div>
            </div>
        </div>

        <!-- Boost Modal (simple sheet) -->
        <div id="ahoy-boost-modal" class="ahoy-modal-overlay"
            style="display:none;"
            aria-hidden="true">
            <div class="ahoy-modal" role="dialog" aria-modal="true"
                aria-label="Boost">
                <div class="ahoy-modal-header">
                    <div class="ahoy-modal-title">Boost</div>
                    <button type="button" class="ahoy-modal-close"
                        aria-label="Close Boost" data-boost-close>
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="ahoy-modal-body">
                    <div class="ahoy-boost-recipient">
                        <div class="ahoy-boost-recipient-label">Sending to</div>
                        <div class="ahoy-boost-recipient-name"
                            id="ahoy-boost-recipient-name">—</div>
                    </div>

                    <div class="ahoy-boost-amounts">
                        <button class="ahoy-boost-amt" type="button"
                            data-boost-amt="1">$1</button>
                        <button class="ahoy-boost-amt" type="button"
                            data-boost-amt="3">$3</button>
                        <button class="ahoy-boost-amt" type="button"
                            data-boost-amt="5">$5</button>
                        <button class="ahoy-boost-amt" type="button"
                            data-boost-amt="custom">Custom</button>
                    </div>

                    <div class="ahoy-boost-custom" id="ahoy-boost-custom"
                        style="display:none;">
                        <label class="ahoy-boost-custom-label"
                            for="ahoy-boost-custom-input">Custom amount</label>
                        <div class="ahoy-boost-custom-row">
                            <span class="ahoy-boost-custom-prefix">$</span>
                            <input id="ahoy-boost-custom-input"
                                class="ahoy-boost-custom-input" type="number"
                                min="0.50" step="0.01" placeholder="0.50">
                        </div>
                    </div>

                    <div class="ahoy-boost-copy">
                        <div class="ahoy-boost-copy-strong">100% goes to the
                            artist/show.</div>
                        <div class="ahoy-boost-copy-small">Fees (Stripe + Ahoy)
                            are shown on checkout.</div>
                    </div>

                    <div class="ahoy-boost-actions">
                        <button type="button" class="ahoy-boost-confirm"
                            data-boost-confirm>
                            Confirm Boost
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <!-- Column 1: Brand / Logo -->
                <div class="footer-column footer-brand-column">
                    <div class="footer-logo">
                        <img
                            src="{{ url_for('static', filename='img/ahoy_logo.png') }}"
                            alt="Ahoy Indie Media"
                            loading="lazy"
                            decoding="async">
                    </div>
                    <p class="footer-tagline">Your gateway to independent music
                        discovery and organization</p>
                </div>

                <!-- Column 2: App Navigation -->
                <div class="footer-column">
                    <h4 class="footer-column-title">App Navigation</h4>
                    <ul>
                        <li><a href="{{ url_for('home') }}">Explore</a></li>
                        <li><a href="{{ url_for('music') }}">Music</a></li>
                        <li><a href="/podcasts">Podcasts</a></li>
                        <li><a href="/live-tv">Live TV</a></li>
                        <li><a href="{{ url_for('shows') }}">Videos</a></li>
                        <li><a href="{{ url_for('artists') }}">Artists</a></li>
                        <li><a href="/events">Events</a></li>
                        <li><a href="/merch">Merch</a></li>
                        <li><a href="/bookmarks">Saved</a></li>
                    </ul>
                </div>

                <!-- Column 2: Legal -->
                <div class="footer-column">
                    <h4 class="footer-column-title">Legal</h4>
                    <ul>
                        <li><a href="/privacy" rel="nofollow">Privacy
                                Policy</a></li>
                        <li><a href="/terms" rel="nofollow">Terms of
                                Service</a></li>
                        <li><a href="/security">Security</a></li>
                        <li><a
                                href="{{ url_for('sitemap_page') }}">Sitemap</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p class="footer-copyright">&copy; 2026 Ahoy Indie Media. All
                    rights reserved.</p>
                {% if current_user.is_authenticated and current_user.email == 'alex@ahoy.ooo' %}
                <a href="/admin" class="footer-admin-link" title="Admin Dashboard">⚙</a>
                {% endif %}
            </div>
        </footer>

        <!-- Compact Fixed Footer -->
        <div id="compact-footer" class="compact-footer" x-data="compactFooter()"
            x-init="init()">
            <div class="compact-footer-content">
                <div class="compact-footer-time-weather">
                    <span class="compact-time" x-text="currentTime"></span>
                </div>
                <div class="compact-footer-ticker">
                    <div class="ticker-wrapper">
                        <div class="ticker-content"
                            :style="`transform: translateX(${tickerOffset}px)`">
                            <template x-for="(item, index) in announcements"
                                :key="index">
                                <span class="ticker-item" x-text="item"></span>
                            </template>
                            <!-- Duplicate for seamless loop -->
                            <template x-for="(item, index) in announcements"
                                :key="'dup-' + index">
                                <span class="ticker-item" x-text="item"></span>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="compact-footer-quicklinks">
                    <a href="{{ url_for('music') }}" class="quicklink">Music</a>
                    <span class="quicklink-sep">•</span>
                    <a href="{{ url_for('shows') }}"
                        class="quicklink">Videos</a>
                    <span class="quicklink-sep">•</span>
                    <a href="{{ url_for('artists') }}"
                        class="quicklink">Artists</a>
                    <span class="quicklink-sep">•</span>
                    <a href="/bookmarks" class="quicklink">Bookmarks</a>
                </div>
            </div>
        </div>

        <!-- Bottom Sheet -->
        <div id="playlist-sheet"
            class="hidden fixed inset-0 z-50 grid place-items-end bg-black/30 transition opacity-0">
            <div class="w-full max-w-xl m-4 rounded-2xl bg-white shadow-lg p-5">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Create Playlist from <span
                            data-col-name class="italic"></span></h3>
                    <button class="text-gray-500 hover:text-black"
                        onclick="document.getElementById('playlist-sheet').classList.remove('opacity-100'); setTimeout(()=>document.getElementById('playlist-sheet').classList.add('hidden'), 150)">✕</button>
                </div>

                <form class="mt-4 space-y-3">
                    <input type="hidden" name="owner"
                        value="{% if session.username %}{{ session.username }}{% endif %}">
                    <label class="block">
                        <span class="text-sm text-gray-600">Playlist name</span>
                        <input name="playlist_name"
                            class="mt-1 w-full rounded-xl border p-2"
                            placeholder="Road Trip Mix"
                            required>
                    </label>

                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="is_public" class="rounded">
                        <span class="text-sm text-gray-700">Make it public
                            (shareable)</span>
                    </label>

                    <div class="flex items-center gap-2 pt-2">
                        <button type="submit"
                            class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition">Create
                            Playlist</button>
                        <button type="button"
                            class="px-3 py-2 rounded-xl border"
                            onclick="document.getElementById('playlist-sheet').classList.remove('opacity-100'); setTimeout(()=>document.getElementById('playlist-sheet').classList.add('hidden'), 150)">Cancel</button>
                    </div>

                    <p class="text-xs text-gray-500 pt-2">Pro tip: you can
                        reorder items later for the perfect flow.</p>
                </form>
            </div>
        </div>

        <!-- Toast -->
        <div id="playlist-toast"
            class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-black text-white px-4 py-2 rounded-full shadow">
            Playlist created!
        </div>

        <!-- Global Toast -->
        <div id="app-toast"
            class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-black text-white px-4 py-2 rounded-full shadow">
        </div>

        <!-- Celebration overlay -->
        <div id="celebrate"
            class="hidden fixed inset-0 z-[70] grid place-items-center bg-black/20 backdrop-blur-sm transition opacity-0">
            <div
                class="px-5 py-3 rounded-2xl bg-white text-black text-lg font-semibold shadow-2xl">
                <span data-celebrate-text>You bookmarked!</span>
            </div>
        </div>

        <!-- Simple Paywall Modal -->
        <div id="paywall"
            class="hidden fixed inset-0 z-50 grid place-items-center bg-black/40">
            <div class="bg-white rounded-2xl p-6 w-[28rem] shadow-xl">
                <h3 class="text-xl font-semibold">Go Plus to unlock more</h3>
                <p class="text-sm text-gray-600 mt-2">Free plan allows up to 3
                    Collections & 3 Playlists.</p>
                <ul class="text-sm text-gray-700 mt-3 list-disc ml-5">
                    <li>Unlimited Collections & Playlists</li>
                    <li>Reorder with drag & drop</li>
                    <li>Public share links</li>
                </ul>
                <div class="flex gap-2 mt-4">
                    <button id="paywall-upgrade"
                        class="px-4 py-2 rounded-xl bg-blue-600 text-white">Upgrade
                        – $3/mo</button>
                    <button class="px-3 py-2 rounded-xl border"
                        onclick="document.getElementById('paywall').classList.add('hidden')">Not
                        now</button>
                </div>
            </div>
        </div>

        <!-- Loading Progress Tracker -->
        <script defer
            src="{{ url_for('static', filename='js/loader.js') }}"></script>

        <!-- JavaScript -->
        <script>window.LOGGED_IN = JSON.parse('{{ LOGGED_IN|tojson|safe }}');</script>
        <script>
        // Hard env switch (default to 'development'). Override to 'production' to enable prod-only behaviors.
        window.APP_ENV = window.APP_ENV || 'development';
    </script>
        <script defer
            src="{{ url_for('static', filename='js/guest-bootstrap.js') }}"></script>
        <script defer
            src="{{ url_for('static', filename='js/bookmarks.js') }}"></script>
        <script defer
            src="{{ url_for('static', filename='js/app.js') }}"></script>
        <!-- Player: kept global (drives the bottom now-playing bar everywhere) -->
        <script defer
            src="{{ url_for('static', filename='js/player.js') }}"></script>

        <!-- Now Playing (lazy loaded): avoids parsing heavy scripts on pages where it’s unused -->
        <script type="module">
        (function () {
          const hasNowPlayingUI = !!document.querySelector('.now-playing-glass');
          if (!hasNowPlayingUI) return;

          const idle = window.requestIdleCallback || ((cb) => setTimeout(cb, 200));
          idle(async () => {
            try {
              // Color extraction powers the glass gradient + album glow (optional enhancement)
              // Load with lower priority - if it fails, nowPlaying.js has fallback colors
              import('/static/js/colorExtractor.js').catch(() => {
                // Silently fail - color extraction is a nice-to-have, not required
              });
              // No visualizer → no audioAnalyser needed (keeps mobile lighter)
              await import('/static/js/nowPlaying.js');
            } catch (e) {
              // Non-fatal
              console.warn('NowPlaying lazy load failed', e);
            }
          });
        })();
        </script>
        <!-- Page-specific scripts: lazy-load to keep mobile startup snappy -->
        <script type="module">
        (function () {
          const idle = window.requestIdleCallback || ((cb) => setTimeout(cb, 250));
          const loadScriptOnce = (() => {
            const cache = new Map();
            return (src) => {
              if (cache.has(src)) return cache.get(src);
              const p = new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.defer = true;
                s.onload = () => resolve(true);
                s.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(s);
              });
              cache.set(src, p);
              return p;
            };
          })();

          // Collections manager + quick-assign: only used on Bookmarks page
          // Load ASAP on that page so the UI feels instant.
          if (document.querySelector('.bookmarks-container') || document.querySelector('[data-quick-assign],[data-quick-last]')) {
            (async () => {
              try {
                await loadScriptOnce('/static/js/collections-manager.js');
                await import('/static/js/collections-quickassign.js');
              } catch (e) {
                console.warn('Collections scripts lazy load failed', e);
              }
            })();
          }

          // Playlist creation from collections: only if the page renders the trigger buttons
          if (document.querySelector('[data-make-playlist]')) {
            (async () => {
              try { await import('/static/js/playlist-ui.js'); } catch (e) { console.warn('playlist-ui lazy load failed', e); }
            })();
          }

          // Player queue wiring: load only when something tries to enqueue/replace a playlist
          let queueLoaded = false;
          document.addEventListener('playlist:created', async (e) => {
            if (queueLoaded) return;
            queueLoaded = true;
            try {
              await import('/static/js/player-queue.js');
              // Re-emit for the newly-loaded listener.
              document.dispatchEvent(new CustomEvent('playlist:created', { detail: e.detail }));
            } catch (err) {
              console.warn('player-queue lazy load failed', err);
            }
          }, { capture: true, once: true });
        })();
        </script>

        <script type="module">
        import { showToast } from "{{ url_for('static', filename='js/toast.js') }}";

        // Listen for 402 responses globally and open paywall
        async function fetchWithPaywall(input, init) {
            const r = await fetch(input, init);
            if (r.status === 402) {
                document.getElementById('paywall').classList.remove('hidden');
                const data = await r.json().catch(() => ({}));
                if (data && data.message) showToast(data.message, 3000);
            }
            return r;
        }
        // Optional: attach to window to use in your API clients
        window.fetchWithPaywall = fetchWithPaywall;

        // Fake upgrade action (tonight stub)
        document.getElementById('paywall-upgrade')?.addEventListener('click', () => {
            showToast("Pretend checkout → set plan=plus", 2500);
            document.getElementById('paywall').classList.add('hidden');
        });
    </script>

        <!-- Status Bar JavaScript -->
        <script>
        // Shared breadcrumb helper (used by both mobile status bar + desktop navbar status bar)
        function ahoyBuildBreadcrumb() {
            const path = (window.location && window.location.pathname ? window.location.pathname : '/') || '/';
            const normalized = path.replace(/\/+$/, '') || '/';

            const crumbs = [];
            const add = (label, href = null) => crumbs.push({ label, href });

            const titleFrom = (sel) => {
                try {
                    const el = document.querySelector(sel);
                    const t = (el && (el.textContent || '').trim()) || '';
                    return t;
                } catch (_) { return ''; }
            };

            const artistNameGuess = () => {
                // Try artist detail hero heading, then fall back to document.title or slug.
                const fromHero = titleFrom('.artist-detail-page .hero-name') || titleFrom('.artist-detail-page h1');
                if (fromHero) return fromHero;
                const docTitle = (document.title || '').split('-')[0].trim();
                if (docTitle && docTitle.toLowerCase() !== 'artist') return docTitle;
                const slug = normalized.split('/').pop();
                return (slug || 'Artist').replace(/-/g, ' ');
            };

            const artistsFilterLabel = () => {
                try {
                    const active = document.querySelector('.filter-tabs .filter-tab.active span')
                        || document.querySelector('.filter-tabs-mobile .filter-tab-mobile.active span');
                    const t = (active && active.textContent || '').trim();
                    return t || 'All Artists';
                } catch (_) { return 'All Artists'; }
            };

            if (normalized === '/') {
                add('Explore', '/');
                add('Home', null);
                return crumbs;
            }
            if (normalized === '/music') {
                add('Music', '/music');
                add('Browse', null);
                return crumbs;
            }
            if (normalized === '/shows') {
                add('Videos', '/shows');
                add('Browse', null);
                return crumbs;
            }
            if (normalized === '/artists') {
                add('Artists', '/artists');
                add(artistsFilterLabel(), null);
                return crumbs;
            }
            if (normalized.startsWith('/artist/')) {
                add('Artists', '/artists');
                add(artistNameGuess(), null);
                return crumbs;
            }
            if (normalized === '/radio') {
                add('Radio', '/radio');
                add('Live', null);
                return crumbs;
            }
            if (normalized === '/podcasts') {
                add('Podcasts', '/podcasts');
                add('Browse', null);
                return crumbs;
            }
            if (normalized === '/events') {
                add('Events', '/events');
                add('Upcoming', null);
                return crumbs;
            }
            if (normalized === '/merch') {
                add('Merch', '/merch');
                add('Store', null);
                return crumbs;
            }
            if (normalized.startsWith('/podcasts/')) {
                add('Podcasts', '/podcasts');
                const showTitle = titleFrom('.podcast-show-hero-title') || titleFrom('.podcasts-hero h1') || normalized.split('/').pop().replace(/-/g, ' ');
                add(showTitle, null);
                return crumbs;
            }
            if (normalized === '/live-tv') {
                add('Live TV', '/live-tv');
                add('Now', null);
                return crumbs;
            }
            if (normalized === '/bookmarks') {
                add('Saved', '/bookmarks');
                add('Bookmarks', null);
                return crumbs;
            }
            if (normalized === '/settings') {
                add('Settings', null);
                return crumbs;
            }
            if (normalized === '/account') {
                add('Profile', null);
                return crumbs;
            }

            // Fallback: single crumb derived from path
            add(normalized.replace('/', '').replace(/-/g, ' ') || 'Explore', null);
            return crumbs;
        }

        function statusBar() {
            return {
                // Notification state
                newBookmarkCount: 0,
                hasNewBookmarks: false,
                breadcrumbText: '',

                init() {
                    // Load bookmark count
                    this.loadBookmarkCount();
                    this.refreshBreadcrumb();

                    // Listen for bookmark notifications
                    document.addEventListener('bookmark:notified', (e) => {
                        this.newBookmarkCount = e.detail.count;
                        this.hasNewBookmarks = true;
                    });
                    
                    // Listen for notification clearing
                    document.addEventListener('bookmark:notifications-cleared', () => {
                        this.newBookmarkCount = 0;
                        this.hasNewBookmarks = false;
                    });
                    
                    // Event-driven breadcrumb refresh (avoid frequent polling)
                    window.addEventListener('popstate', () => this.refreshBreadcrumb(), { passive: true });
                    window.addEventListener('hashchange', () => this.refreshBreadcrumb(), { passive: true });
                    document.addEventListener('ahoy:breadcrumb:update', () => this.refreshBreadcrumb());

                    // Slow periodic refresh (just in case something external changes state)
                    setInterval(() => {
                        this.loadBookmarkCount();
                        this.refreshBreadcrumb();
                    }, 30000);
                },

                async loadBookmarkCount() {
                    try {
                        // Get bookmark count from navbar if available
                        const navbar = document.querySelector('body')?.__x?.$data;
                        if (navbar && navbar.newBookmarkCount !== undefined) {
                            this.newBookmarkCount = navbar.newBookmarkCount || 0;
                            this.hasNewBookmarks = navbar.hasNewBookmarks || false;
                            return;
                        }
                        
                        // Fallback: try to get from global notification state
                        if (window.__ahoyNotificationState) {
                            this.newBookmarkCount = window.__ahoyNotificationState.newBookmarkCount || 0;
                            this.hasNewBookmarks = window.__ahoyNotificationState.hasNewBookmarks || false;
                        }
                    } catch (err) {
                        // Silently fail
                    }
                },
                
                openMobileSearch() {
                    // Trigger mobile search popup via Alpine store or direct access
                    const popup = document.getElementById('mobile-search-popup');
                    if (popup) {
                        // Try to access Alpine data
                        if (popup.__x && popup.__x.$data) {
                            popup.__x.$data.isOpen = true;
                        } else {
                            // Fallback: dispatch event
                            document.dispatchEvent(new CustomEvent('open-mobile-search'));
                        }
                        // Focus input after a brief delay
                        setTimeout(() => {
                            const input = popup.querySelector('.mobile-search-input');
                            if (input) input.focus();
                        }, 200);
                    }
                }
                ,
                refreshBreadcrumb() {
                    try {
                        const crumbs = ahoyBuildBreadcrumb();
                        this.breadcrumbText = crumbs.map(c => c.label).join(' › ');
                    } catch (_) {
                        this.breadcrumbText = '';
                    }
                }
            };
        }
        
        // Mobile Search Popup Component
        function mobileSearch() {
            return {
                isOpen: false,
                searchQuery: '',
                suggestions: [],
                recentSearches: [],

                init() {
                    // Load recent searches from localStorage
                    this.loadRecentSearches();
                    
                    // Listen for open event
                    document.addEventListener('open-mobile-search', () => {
                        this.isOpen = true;
                        setTimeout(() => {
                            const input = document.querySelector('.mobile-search-input');
                            if (input) input.focus();
                        }, 100);
                    });
                    
                    // Close on escape key
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen) {
                            this.close();
                        }
                    });
                },

                loadRecentSearches() {
                    try {
                        const stored = localStorage.getItem('ahoy.recentSearches');
                        this.recentSearches = stored ? JSON.parse(stored) : [];
                    } catch (err) {
                        this.recentSearches = [];
                    }
                },

                saveRecentSearch(query) {
                    if (!query || query.trim() === '') return;
                    const trimmed = query.trim();
                    // Remove if already exists
                    this.recentSearches = this.recentSearches.filter(s => s !== trimmed);
                    // Add to beginning
                    this.recentSearches.unshift(trimmed);
                    // Keep only last 10
                    this.recentSearches = this.recentSearches.slice(0, 10);
                    localStorage.setItem('ahoy.recentSearches', JSON.stringify(this.recentSearches));
                },

                clearRecents() {
                    this.recentSearches = [];
                    localStorage.removeItem('ahoy.recentSearches');
                },

                handleInput() {
                    if (this.searchQuery.length > 2) {
                        this.fetchSuggestions();
                    } else {
                        this.suggestions = [];
                    }
                },

                async fetchSuggestions() {
                    try {
                        const response = await fetch(`/api/search?q=${encodeURIComponent(this.searchQuery)}&limit=5`);
                        if (response.ok) {
                            const data = await response.json();
                            this.suggestions = (data.results || []).slice(0, 5).map(item => ({
                                id: item.id,
                                title: item.title || item.name,
                                subtitle: item.artist || item.description || '',
                                type: item.type,
                                icon: item.type === 'music' ? 'fas fa-music' : item.type === 'show' ? 'fas fa-play-circle' : 'fas fa-user',
                                url: `/${item.type === 'music' ? 'music' : item.type === 'show' ? 'shows' : 'artists'}#${item.id}`
                            }));
                        }
                    } catch (err) {
                        this.suggestions = [];
                    }
                },

                selectSuggestion(suggestion) {
                    this.saveRecentSearch(this.searchQuery);
                    window.location.href = suggestion.url;
                },

                selectRecent(recent) {
                    this.searchQuery = recent;
                    this.performSearch();
                },

                clearSearch() {
                    this.searchQuery = '';
                    this.suggestions = [];
                },

                performSearch() {
                    if (!this.searchQuery || this.searchQuery.trim() === '') return;
                    this.saveRecentSearch(this.searchQuery);
                    window.location.href = `/search?q=${encodeURIComponent(this.searchQuery)}`;
                },

                close() {
                    this.isOpen = false;
                    this.searchQuery = '';
                    this.suggestions = [];
                }
            };
        }
        </script>

        <script>
            // Lightweight Boost modal controller (keeps existing /checkout wiring).
            (function () {
                const overlay = document.getElementById('ahoy-boost-modal');
                if (!overlay) return;

                const recipientNameEl = document.getElementById('ahoy-boost-recipient-name');
                const customWrap = document.getElementById('ahoy-boost-custom');
                const customInput = document.getElementById('ahoy-boost-custom-input');
                const amtButtons = overlay.querySelectorAll('[data-boost-amt]');
                const closeBtn = overlay.querySelector('[data-boost-close]');
                const confirmBtn = overlay.querySelector('[data-boost-confirm]');

                let state = {
                    recipientType: 'artist',
                    recipientId: '',
                    recipientName: '',
                    amount: 1
                };

                function setActiveAmountButton(value) {
                    amtButtons.forEach(btn => {
                        const v = btn.getAttribute('data-boost-amt');
                        btn.classList.toggle('active', String(v) === String(value));
                    });
                }

                function open(detail) {
                    state.recipientType = detail?.recipientType || 'artist';
                    state.recipientId = detail?.recipientId || '';
                    state.recipientName = detail?.recipientName || 'Creator';
                    state.amount = Number(detail?.suggestedAmount || 1);

                    if (recipientNameEl) recipientNameEl.textContent = state.recipientName;
                    if (customWrap) customWrap.style.display = 'none';
                    if (customInput) customInput.value = '';
                    setActiveAmountButton(String(state.amount));

                    overlay.style.display = 'flex';
                    overlay.setAttribute('aria-hidden', 'false');
                }

                function close() {
                    overlay.style.display = 'none';
                    overlay.setAttribute('aria-hidden', 'true');
                }

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) close();
                });
                closeBtn && closeBtn.addEventListener('click', close);
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && overlay.style.display !== 'none') close();
                });

                amtButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const v = btn.getAttribute('data-boost-amt');
                        if (v === 'custom') {
                            setActiveAmountButton('custom');
                            if (customWrap) customWrap.style.display = 'block';
                            if (customInput) customInput.focus();
                            return;
                        }
                        if (customWrap) customWrap.style.display = 'none';
                        state.amount = Number(v || 1);
                        setActiveAmountButton(v);
                    });
                });

                confirmBtn && confirmBtn.addEventListener('click', () => {
                    let amount = state.amount;
                    if (customWrap && customWrap.style.display !== 'none') {
                        const v = parseFloat(String(customInput?.value || ''));
                        if (!isNaN(v)) amount = v;
                    }
                    if (!amount || isNaN(amount) || amount < 0.5) {
                        try { document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Enter a valid boost amount (min $0.50).' })); } catch (_) { }
                        return;
                    }
                    const params = new URLSearchParams({
                        type: 'boost',
                        // Keep param name as-is to preserve existing checkout route contract.
                        artist_id: String(state.recipientId || state.recipientName || ''),
                        amount: String(amount.toFixed(2))
                    });
                    window.location.href = `/checkout?${params.toString()}`;
                });

                document.addEventListener('ahoy:boost:open', (e) => open(e.detail || {}));
                window.AhoyBoost = { open, close };
            })();
        </script>

        <!-- Navbar JavaScript -->
        <script>
        function navbar() {
            return {
                // Environment flags
                appEnv: window.APP_ENV || 'development',
                enableAccountNetworkCalls: (window.APP_ENV === 'production'),
                // Mobile nav state
                mobileNav: false,
                // User state
                isLoggedIn: window.LOGGED_IN || false,
                userProfile: window.userProfile || {
                    display_name: "Guest",
                    username: "guest",
                    email: "",
                    avatar: "/static/img/default-avatar.png"
                },
                // Wallet state
                walletBalanceCents: 0,

                // Notification state
                newBookmarkCount: 0,
                hasNewBookmarks: false,

                // StatusBar state
                breadcrumbs: [],
                nowPillText: '',

                // Weather removed for MVP (was slow + unneeded)

                // Mobile menu state
                leftMenuOpen: false,
                rightMenuOpen: false,
                accountMenuOpen: false,

                // Portfolio widget state
                totalBookmarkCount: 0,
                badges: [],

                // Initialize
                init() {
                    console.log('Navbar initialized. isLoggedIn:', this.isLoggedIn, 'accountMenuOpen:', this.accountMenuOpen);

                    // Listen for bookmark notifications
                    document.addEventListener('bookmark:notified', (e) => {
                        this.newBookmarkCount = e.detail.count;
                        this.hasNewBookmarks = true;
                    });

                    // Listen for notification clearing
                    document.addEventListener('bookmark:notifications-cleared', () => {
                        this.newBookmarkCount = 0;
                        this.hasNewBookmarks = false;
                    });

                    // Initialize from global state if available
                    if (window.__ahoyNotificationState) {
                        this.newBookmarkCount = window.__ahoyNotificationState.newBookmarkCount;
                        this.hasNewBookmarks = window.__ahoyNotificationState.hasNewBookmarks;
                    }

                    // Location breadcrumb
                    this.refreshBreadcrumbs();
                    this.watchArtistsFilter();

                    // Now playing pill (subtle)
                    this.initNowPlayingPill();

                    // Load wallet only in production to avoid 404s during development
                    if (this.enableAccountNetworkCalls) {
                        this.loadWallet();
                    }
                },

                async loadWallet() {
                    try {
                        const r = await fetch('/payments/wallet', { credentials: 'include' });
                        if (!r.ok) return;
                        const data = await r.json();
                        if (typeof data.balance_cents === 'number') {
                            this.walletBalanceCents = data.balance_cents;
                        } else if (typeof data.balance === 'number') {
                            this.walletBalanceCents = Math.round(data.balance * 100);
                        }
                    } catch (_) { /* ignore */ }
                },

                async addFunds(cents = 2000) {
                    try {
                        const r = await fetch('/payments/topup/checkout-session', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ amount_cents: cents })
                        });
                        const data = await r.json();
                        if (r.ok && data.url) {
                            window.location.href = data.url;
                        } else {
                            document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: data.error || 'Top-up unavailable' }));
                        }
                    } catch (e) {
                        document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Failed to start top-up' }));
                    }
                },

                // Search trigger (opens the existing search popup/modal)
                openSearch() {
                    try {
                        const popup = document.getElementById('mobile-search-popup');
                        if (popup && popup.__x && popup.__x.$data) {
                            popup.__x.$data.isOpen = true;
                        } else {
                            document.dispatchEvent(new CustomEvent('open-mobile-search'));
                        }
                    } catch (_) { }
                },

                refreshBreadcrumbs() {
                    try {
                        this.breadcrumbs = ahoyBuildBreadcrumb();
                    } catch (_) {
                        this.breadcrumbs = [];
                    }
                },

                watchArtistsFilter() {
                    // Optional polish: reflect Artists filter in breadcrumb
                    try {
                        const path = (window.location && window.location.pathname) || '';
                        if (!path.startsWith('/artists')) return;
                        const refreshSoon = () => {
                            // Update after UI handlers have applied active classes/state
                            setTimeout(() => this.refreshBreadcrumbs(), 0);
                        };

                        // Event-driven updates (avoid polling)
                        const tabs = document.querySelector('.filter-tabs');
                        const tabsMobile = document.querySelector('.filter-tabs-mobile');
                        if (tabs) tabs.addEventListener('click', refreshSoon, { passive: true });
                        if (tabsMobile) tabsMobile.addEventListener('click', refreshSoon, { passive: true });

                        // Also refresh on navigation changes within SPA-ish flows
                        window.addEventListener('popstate', () => this.refreshBreadcrumbs(), { passive: true });
                        window.addEventListener('hashchange', () => this.refreshBreadcrumbs(), { passive: true });
                        document.addEventListener('ahoy:breadcrumb:update', () => this.refreshBreadcrumbs());
                    } catch (_) { }
                },

                initNowPlayingPill() {
                    const update = () => {
                        try {
                            const mp = window.mediaPlayer;
                            const track = mp && mp.currentTrack ? mp.currentTrack : null;
                            const isPlaying = !!(mp && mp.isPlaying);
                            if (!track || !isPlaying) {
                                this.nowPillText = '';
                                return;
                            }
                            const title = (track.title || '').trim();
                            const artist = (track.artist || track.host || track.creator || '').trim();
                            const isLive = ((window.location && window.location.pathname) === '/radio') || track.type === 'radio' || !!track.is_live;

                            if (isLive) {
                                this.nowPillText = `LIVE • Radio: ${title}${artist ? ' — ' + artist : ''}`;
                            } else {
                                this.nowPillText = `Playing: ${title || 'Now playing'}`;
                            }
                        } catch (_) {
                            this.nowPillText = '';
                        }
                    };

                    // Try to hook into player events (if available), plus a light polling fallback.
                    try {
                        const mp = window.mediaPlayer;
                        if (mp && typeof mp.on === 'function') {
                            mp.on('play', update);
                            mp.on('pause', update);
                            mp.on('ended', update);
                            mp.on('durationchange', update);
                        }
                    } catch (_) { }
                    // Low-frequency fallback (keeps CPU down; events handle most updates)
                    // Pause when tab is hidden to save resources
                    let updatePoller = null;
                    const startUpdatePoll = () => {
                        if (updatePoller) return;
                        updatePoller = setInterval(() => {
                            if (document.visibilityState === 'visible') {
                                update();
                            }
                        }, 5000);
                    };
                    const stopUpdatePoll = () => {
                        if (updatePoller) {
                            clearInterval(updatePoller);
                            updatePoller = null;
                        }
                    };
                    if (document.visibilityState === 'visible') startUpdatePoll();
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                            update(); // Update immediately on return
                            startUpdatePoll();
                        } else {
                            stopUpdatePoll();
                        }
                    });
                    document.addEventListener('play-track', update);
                    update();
                },

                // Fullscreen functionality (with safe property access)
                toggleFullscreen() {
                    try {
                        // Safely check if fullscreen is active
                        let isFullscreen = false;
                        try {
                            isFullscreen = !!document.fullscreenElement;
                        } catch (e) {
                            // Try alternative properties
                            try {
                                isFullscreen = !!(document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
                            } catch (e2) {}
                        }
                        
                        if (!isFullscreen) {
                            const elem = document.documentElement;
                            if (elem.requestFullscreen) {
                                elem.requestFullscreen().catch(err => {
                                    console.log('Error attempting to enable fullscreen:', err);
                                });
                            } else if (elem.webkitRequestFullscreen) {
                                elem.webkitRequestFullscreen();
                            } else if (elem.mozRequestFullScreen) {
                                elem.mozRequestFullScreen();
                            } else if (elem.msRequestFullscreen) {
                                elem.msRequestFullscreen();
                            }
                        } else {
                            if (document.exitFullscreen) {
                                document.exitFullscreen().catch(err => {
                                    console.log('Error attempting to exit fullscreen:', err);
                                });
                            } else if (document.webkitExitFullscreen) {
                                document.webkitExitFullscreen();
                            } else if (document.mozCancelFullScreen) {
                                document.mozCancelFullScreen();
                            } else if (document.msExitFullscreen) {
                                document.msExitFullscreen();
                            }
                        }
                    } catch (err) {
                        console.log('Fullscreen toggle error:', err);
                    }
                },

                // Logout functionality
                logout() {
                    if (confirm('Are you sure you want to sign out?')) {
                        window.location.href = '/logout';
                    }
                },

                // Desktop nav utilities (screenshot-style)
                goBack() {
                    try { window.history.back(); } catch (_) {}
                },
                goForward() {
                    try { window.history.forward(); } catch (_) {}
                },
                openNotifications() {
                    window.location.href = '/bookmarks';
                },
                goPremium() {
                    document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Premium coming soon' }));
                }
            };
        }
        // Bridge: expose navbar state to external components (e.g., account sheet include)
        function navbarProxy() {
            const getNavbar = () => document.querySelector('.navbar')?.__x?.$data || {};
            return {
                get isLoggedIn() { return !!getNavbar().isLoggedIn; },
                get userProfile() { return getNavbar().userProfile || {}; },
                get walletBalanceCents() { return getNavbar().walletBalanceCents || 0; },
                get badges() { return getNavbar().badges || []; },
                get totalBookmarkCount() { return getNavbar().totalBookmarkCount || 0; },
                logout() { try { getNavbar().logout && getNavbar().logout(); } catch (_) {} }
            };
        }

    </script>

        <!-- Simple Image Deduplication Script -->
        <script>
        // Enhanced image loading to prevent infinite loops
        (function () {
            const loadedImages = new Set();
            const loadingImages = new Set();

            // Track image loads to prevent duplicates
            const originalImageLoad = Image.prototype.onload;
            const originalImageError = Image.prototype.onerror;

            Image.prototype.onload = function () {
                if (this.src) {
                    loadedImages.add(this.src);
                    loadingImages.delete(this.src);
                }
                if (originalImageLoad) {
                    originalImageLoad.call(this);
                }
            };

            Image.prototype.onerror = function () {
                if (this.src) {
                    loadingImages.delete(this.src);
                }
                if (originalImageError) {
                    originalImageError.call(this);
                }
            };

            // Prevent duplicate image requests
            // NOTE: bind() avoids "Illegal invocation" in some browsers when calling native fetch.
            const originalFetch = (window.fetch && window.fetch.bind) ? window.fetch.bind(window) : window.fetch;
            window.fetch = function (url, options) {
                if (typeof url === 'string' && url.includes('/static/img/')) {
                    if (loadedImages.has(url) || loadingImages.has(url)) {
                        return Promise.reject(new Error('Image already loading/loaded'));
                    }
                    loadingImages.add(url);
                }
                return originalFetch(url, options);
            };

            // Monitor Alpine.js image updates
            document.addEventListener('alpine:init', () => {
                Alpine.directive('src', (el, { expression }, { evaluateLater, effect }) => {
                    const evaluate = evaluateLater(expression);
                    effect(() => {
                        evaluate((src) => {
                            if (src && typeof src === 'string') {
                                if (loadedImages.has(src)) {
                                    el.src = src;
                                    return;
                                }
                                if (!loadingImages.has(src)) {
                                    loadingImages.add(src);
                                    el.src = src;
                                }
                            }
                        });
                    });
                });
            });
        })();

        // Global Player Alpine.js Function (proxy to window.mediaPlayer)
        function globalPlayer() {
            return {
                currentTrack: null,
                isPlaying: false,
                currentTime: 0,
                duration: 0,
                progressPercent: 0,
                volume: 50,
                isMuted: false,

                // Player state
                isLiked: false,
                isSaved: false,
                isShuffled: false,
                isRepeated: false,

                init() {
                    // Wrap entire initialization in try-catch to prevent blocking page execution
                    try {
                        // Ensure mediaPlayer exists; if not, create a minimal one
                        if (!window.mediaPlayer || typeof window.mediaPlayer.play !== 'function') {
                            try { import('/static/js/player.js'); } catch (e) { /* noop */ }
                        }

                        // Hydrate initial state from mediaPlayer if available
                        const mp = window.mediaPlayer;
                        if (mp && typeof mp === 'object') {
                            try {
                                this.currentTrack = mp.currentTrack || null;
                                this.isPlaying = !!mp.isPlaying;
                                this.currentTime = mp.currentTime || 0;
                                this.duration = mp.duration || 0;
                                this.isMuted = !!mp.isMuted;
                                this.volume = (typeof mp.volume === 'number') ? Math.round(mp.volume * 100) : 50;
                                this.isShuffled = !!mp.isShuffled;
                                this.isRepeated = !!mp.isRepeated;
                            } catch (e) {
                                console.warn('Error hydrating mediaPlayer state:', e);
                            }

                            // Bind mediaPlayer events to update Alpine state (with error handling)
                        try {
                            if (mp.on && typeof mp.on === 'function') {
                                mp.on('play', () => {
                                    try {
                                        this.isPlaying = true;
                                        this.currentTrack = mp.currentTrack;
                                        // Update saved state when track changes
                                        this.updateSavedState();
                                        // Keep Now Playing UI in sync (glassy theme only; no visualizer)
                                        if (window.nowPlayingController && mp.currentTrack) {
                                            window.nowPlayingController.onTrackChange(mp.currentTrack);
                                        }
                                    } catch (e) {
                                        console.warn('Error in play handler:', e);
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('Error setting up play event:', e);
                        }
                        
                        try {
                            if (mp.on && typeof mp.on === 'function') {
                                mp.on('pause', () => {
                                    try {
                                        this.isPlaying = false;
                                    } catch (e) {
                                        console.warn('Error in pause handler:', e);
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('Error setting up pause event:', e);
                        }
                        
                        try {
                            if (mp.on && typeof mp.on === 'function') {
                                mp.on('timeupdate', (t) => {
                                    try {
                                        this.currentTime = t;
                                        this.progressPercent = this.duration ? (t / this.duration) * 100 : 0;
                                    } catch (e) {
                                        console.warn('Error in timeupdate handler:', e);
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('Error setting up timeupdate event:', e);
                        }
                        
                        try {
                            if (mp.on && typeof mp.on === 'function') {
                                mp.on('durationchange', (d) => {
                                    try {
                                        this.duration = d;
                                    } catch (e) {
                                        console.warn('Error in durationchange handler:', e);
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('Error setting up durationchange event:', e);
                        }
                        
                        try {
                            if (mp.on && typeof mp.on === 'function') {
                                mp.on('volumechange', ({ volume, muted }) => {
                                    try {
                                        this.volume = Math.round(volume * 100);
                                        this.isMuted = !!muted;
                                    } catch (e) {
                                        // Silently ignore - don't log to avoid console spam
                                    }
                                });
                            }
                        } catch (e) {
                            // Silently ignore - don't log to avoid console spam
                        }
                        
                        try {
                            if (mp.on && typeof mp.on === 'function') {
                                mp.on('playlistchange', () => {
                                    try {
                                        this.currentTrack = mp.currentTrack;
                                        // Update saved state when track changes
                                        this.updateSavedState();
                                        // Keep Now Playing UI in sync (glassy theme only; no visualizer)
                                        if (window.nowPlayingController && mp.currentTrack) {
                                            window.nowPlayingController.onTrackChange(mp.currentTrack);
                                        }
                                    } catch (e) {
                                        console.warn('Error in playlistchange handler:', e);
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('Error setting up playlistchange event:', e);
                        }
                        }
                    } catch (e) {
                        console.warn('Error initializing mediaPlayer:', e);
                    }

                    // Listen for custom play events from anywhere
                    try {
                        document.addEventListener('play-track', (e) => {
                            try {
                                const track = e.detail && (e.detail.track || e.detail);
                                if (track) this.playTrack(track);
                            } catch (err) {
                                console.warn('Error in play-track handler:', err);
                            }
                        });
                    } catch (e) {
                        console.warn('Error setting up play-track listener:', e);
                    }

                    // Listen for bookmark changes to update saved state
                    try {
                        document.addEventListener('bookmarks:changed', () => {
                            try {
                                this.updateSavedState();
                            } catch (err) {
                                console.warn('Error updating saved state from bookmark change:', err);
                            }
                        });
                    } catch (e) {
                        console.warn('Error setting up bookmarks:changed listener:', e);
                    }

                    // Initialize bookmark state and start clock animation
                    try {
                        this.updateSavedState();
                        this.startClock();
                    } catch (e) {
                        console.warn('Error initializing bookmark state or clock:', e);
                    }

                    // Visualizer removed: no fullscreen/visualizer state needed.
                },

                playTrack(track) {
                    try {
                        this.currentTrack = track;
                        // Update saved state when track changes
                        this.updateSavedState();
                        if (window.mediaPlayer && typeof window.mediaPlayer === 'object' && typeof window.mediaPlayer.play === 'function') {
                            window.mediaPlayer.play(track);
                            return;
                        }
                    } catch (e) {
                        console.warn('Error in playTrack:', e);
                    }
                    // Fallback: navigate to appropriate player page
                    try {
                        if (track && (track.type === 'show' || track.video_url || track.mp4_link)) {
                            window.location.href = `/player?id=${track.id}&type=show`;
                        } else if (track && track.id) {
                            window.location.href = `/music?highlight=${track.id}`;
                        }
                    } catch (e) {
                        console.warn('Error navigating to player:', e);
                    }
                },

                togglePlay() {
                    try {
                        if (window.mediaPlayer && typeof window.mediaPlayer === 'object') {
                            if (this.isPlaying) {
                                if (typeof window.mediaPlayer.pause === 'function') {
                                    window.mediaPlayer.pause();
                                }
                            } else {
                                if (this.currentTrack && typeof window.mediaPlayer.play === 'function') {
                                    window.mediaPlayer.play(this.currentTrack);
                                } else if (typeof window.mediaPlayer.resume === 'function') {
                                    window.mediaPlayer.resume();
                                }
                            }
                            return;
                        }
                    } catch (e) {
                        console.warn('Error in togglePlay:', e);
                    }
                },

                toggleBookmarkCurrent() {
                    if (!this.currentTrack || !window.AhoyBookmarks) return;
                    const type = (this.currentTrack.type === 'show' ? 'show' : (this.currentTrack.type || 'track'));
                    const item = {
                        type,
                        id: this.currentTrack.id,
                        title: this.currentTrack.title,
                        artwork: this.currentTrack.cover_art || this.currentTrack.thumbnail
                    };
                    window.AhoyBookmarks.toggle(item);
                    this.updateSavedState();
                    // Notify others
                    document.dispatchEvent(new CustomEvent('bookmarks:changed', { detail: { item, totalCount: window.AhoyBookmarks.count?.() } }));
                },

                updateSavedState() {
                    if (!this.currentTrack || !window.AhoyBookmarks) {
                        this.isSaved = false;
                        return;
                    }
                    const type = (this.currentTrack.type === 'show' ? 'show' : (this.currentTrack.type || 'track'));
                    this.isSaved = !!window.AhoyBookmarks.isBookmarked?.(type, this.currentTrack.id);
                },

                previousTrack() {
                    try {
                        // Prefer playlist navigation when a playlist exists
                        if (window.mediaPlayer && Array.isArray(window.mediaPlayer.playlist) && window.mediaPlayer.playlist.length > 0 && typeof window.mediaPlayer.previousTrack === 'function') {
                            window.mediaPlayer.previousTrack();
                            return;
                        }
                        // Fallback: if homepage radio is active, try its previous logic
                        if (window.homePage && window.homePage.radioPrevious && typeof window.homePage.playRadioTrack === 'function') {
                            window.homePage.playRadioTrack(window.homePage.radioPrevious);
                            return;
                        }
                        // Fallback: step left in home indexes (music/shows)
                        if (window.homePage) {
                            const cur = window.mediaPlayer && window.mediaPlayer.currentTrack || this.currentTrack;
                            if (cur && (cur.type === 'show' || cur.video_url || cur.mp4_link)) {
                                const shows = (window.homePage.featuredShows || []);
                                if (shows.length) {
                                    const idx = shows.findIndex(s => String(s.id) === String(cur.id));
                                    const prev = shows[(idx > 0 ? idx - 1 : shows.length - 1)];
                                    if (prev) { window.location.href = `/player?id=${prev.id}&type=show`; return; }
                                }
                            } else if (cur) {
                                const tracks = (window.homePage.feedItems || []).filter(i => (i.type || 'track') !== 'show');
                                if (tracks.length) {
                                    const curId = String(cur.id || cur.track_id);
                                    const idx = tracks.findIndex(t => String(t.id || t.track_id) === curId);
                                    const prev = tracks[(idx > 0 ? idx - 1 : tracks.length - 1)];
                                    if (prev && window.mediaPlayer && typeof window.mediaPlayer.play === 'function') {
                                        const playItem = { ...prev, type: 'track', audio_url: prev.audio_url || prev.preview_url || prev.full_url, cover_art: prev.cover_art || prev.thumbnail };
                                        window.mediaPlayer.play(playItem);
                                        return;
                                    }
                                }
                            }
                        }
                        // Last resort: restart current track if available
                        if (window.mediaPlayer && window.mediaPlayer.currentTrack && typeof window.mediaPlayer.play === 'function') {
                            window.mediaPlayer.play(window.mediaPlayer.currentTrack);
                        }
                    } catch (e) {
                        console.warn('Error in previousTrack:', e);
                    }
                },
                
                nextTrack() {
                    try {
                        // Prefer playlist navigation when available
                        if (window.mediaPlayer && Array.isArray(window.mediaPlayer.playlist) && window.mediaPlayer.playlist.length > 0 && typeof window.mediaPlayer.nextTrack === 'function') {
                            window.mediaPlayer.nextTrack();
                            return;
                        }
                        // Fallback: if homepage radio is present, ask it to advance
                        if (window.homePage && typeof window.homePage._playNextRadio === 'function') {
                            window.homePage._playNextRadio();
                            return;
                        }
                        // Fallback: step right in home indexes (music/shows)
                        if (window.homePage) {
                            const cur = window.mediaPlayer && window.mediaPlayer.currentTrack || this.currentTrack;
                            if (cur && (cur.type === 'show' || cur.video_url || cur.mp4_link)) {
                                const shows = (window.homePage.featuredShows || []);
                                if (shows.length) {
                                    const idx = shows.findIndex(s => String(s.id) === String(cur.id));
                                    const next = shows[(idx >= 0 ? (idx + 1) % shows.length : 0)];
                                    if (next) { window.location.href = `/player?id=${next.id}&type=show`; return; }
                                }
                            } else if (cur) {
                                const tracks = (window.homePage.feedItems || []).filter(i => (i.type || 'track') !== 'show');
                                if (tracks.length) {
                                    const curId = String(cur.id || cur.track_id);
                                    const idx = tracks.findIndex(t => String(t.id || t.track_id) === curId);
                                    const next = tracks[(idx >= 0 ? (idx + 1) % tracks.length : 0)];
                                    if (next && window.mediaPlayer && typeof window.mediaPlayer.play === 'function') {
                                        const playItem = { ...next, type: 'track', audio_url: next.audio_url || next.preview_url || next.full_url, cover_art: next.cover_art || next.thumbnail };
                                        window.mediaPlayer.play(playItem);
                                        return;
                                    }
                                }
                            }
                        }
                        // Last resort: do nothing but notify
                        document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'No next item available' }));
                    } catch (e) {
                        console.warn('Error in nextTrack:', e);
                    }
                },

                seekBackward() {
                    try {
                        if (!window.mediaPlayer) return;
                        const t = Math.max(0, (window.mediaPlayer.currentTime || 0) - 15);
                        if (typeof window.mediaPlayer.seekTo === 'function') {
                            window.mediaPlayer.seekTo(t);
                        }
                    } catch (e) {
                        console.warn('Error in seekBackward:', e);
                    }
                },

                seekForward() {
                    try {
                        if (!window.mediaPlayer) return;
                        const t = Math.min(this.duration || (window.mediaPlayer.duration || 0), (window.mediaPlayer.currentTime || 0) + 15);
                        if (typeof window.mediaPlayer.seekTo === 'function') {
                            window.mediaPlayer.seekTo(t);
                        }
                    } catch (e) {
                        console.warn('Error in seekForward:', e);
                    }
                },

                seekTo(event) {
                    try {
                        if (!window.mediaPlayer) return;
                        const progressBar = event.currentTarget;
                        const rect = progressBar.getBoundingClientRect();
                        const clickX = event.clientX - rect.left;
                        const percentage = clickX / rect.width;
                        const newTime = percentage * (this.duration || 0);
                        if (typeof window.mediaPlayer.seekTo === 'function') {
                            window.mediaPlayer.seekTo(newTime);
                        }
                    } catch (e) {
                        console.warn('Error in seekTo:', e);
                    }
                },

                setVolume(volume) {
                    try {
                        this.volume = volume;
                        const v = Math.max(0, Math.min(1, volume / 100));
                        if (window.mediaPlayer && typeof window.mediaPlayer.setVolume === 'function') {
                            window.mediaPlayer.setVolume(v);
                        }
                    } catch (e) {
                        console.warn('Error in setVolume:', e);
                    }
                },

                toggleMute() {
                    try {
                        this.isMuted = !this.isMuted;
                        if (window.mediaPlayer && typeof window.mediaPlayer.setMuted === 'function') {
                            window.mediaPlayer.setMuted(this.isMuted);
                        }
                    } catch (e) {
                        console.warn('Error in toggleMute:', e);
                    }
                },

                formatTime(seconds) {
                    if (!seconds || isNaN(seconds)) return '0:00';
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                },

                // UI actions (stubs)
                toggleLike() { this.isLiked = !this.isLiked; },
                toggleSave() { this.isSaved = !this.isSaved; },
                addToPlaylist() { },
                async openBoost() {
                    try {
                        const track = this.currentTrack || (window.mediaPlayer && window.mediaPlayer.currentTrack) || {};
                        const recipientName = (track.artist || track.host || track.creator || '').trim();
                        const recipientId = String(track.artist_id || track.artistId || track.artist || '').trim();
                        document.dispatchEvent(new CustomEvent('ahoy:boost:open', {
                            detail: {
                                recipientType: (track.type === 'show' ? 'show' : 'artist'),
                                recipientId,
                                recipientName,
                                suggestedAmount: 1
                            }
                        }));
                    } catch (e) {
                        console.warn('Boost open failed:', e);
                        // Fallback to legacy checkout routing
                        try { window.location.href = `/checkout?type=boost&amount=1`; } catch (_) {}
                    }
                },
                toggleShuffle() {
                    this.isShuffled = !this.isShuffled;
                    window.mediaPlayer && window.mediaPlayer.setShuffle && window.mediaPlayer.setShuffle(this.isShuffled);
                },
                toggleRepeat() {
                    this.isRepeated = !this.isRepeated;
                    window.mediaPlayer && window.mediaPlayer.setRepeat && window.mediaPlayer.setRepeat(this.isRepeated);
                },
                openFullPlayer() {
                    if (this.currentTrack) {
                        const type = this.currentTrack.type === 'show' ? 'show' : 'track';
                        window.location.href = `/player?id=${this.currentTrack.id}&type=${type}`;
                    }
                },

                // Analog clock drawing for current time and progress ring
                startClock() {
                    const draw = () => {
                        const c = this.$refs.clock;
                        if (!c) return;
                        const ctx = c.getContext('2d');
                        const w = c.width, h = c.height, r = Math.min(w, h) / 2 - 2;
                        ctx.clearRect(0, 0, w, h);
                        ctx.translate(w / 2, h / 2);
                        // Clock face
                        ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.fill();
                        // Ticks
                        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
                        for (let i = 0; i < 12; i++) { ctx.save(); ctx.rotate(i * Math.PI / 6); ctx.beginPath(); ctx.moveTo(0, -r); ctx.lineTo(0, -r + 4); ctx.stroke(); ctx.restore(); }
                        // Hands (current time)
                        const now = new Date();
                        const sec = now.getSeconds();
                        const min = now.getMinutes() + sec / 60;
                        const hr = (now.getHours() % 12) + min / 60;
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2; ctx.beginPath(); ctx.rotate(hr * Math.PI / 6); ctx.moveTo(0, 5); ctx.lineTo(0, -r * 0.5); ctx.stroke(); ctx.rotate(-hr * Math.PI / 6);
                        ctx.lineWidth = 1.5; ctx.beginPath(); ctx.rotate(min * Math.PI / 30); ctx.moveTo(0, 7); ctx.lineTo(0, -r * 0.75); ctx.stroke(); ctx.rotate(-min * Math.PI / 30);
                        ctx.strokeStyle = '#f43f5e'; ctx.lineWidth = 1; ctx.beginPath(); ctx.rotate(sec * Math.PI / 30); ctx.moveTo(0, 10); ctx.lineTo(0, -r * 0.85); ctx.stroke(); ctx.rotate(-sec * Math.PI / 30);
                        // Progress ring for media
                        if (this.duration > 0) {
                            const frac = (this.currentTime || 0) / this.duration;
                            ctx.beginPath();
                            ctx.strokeStyle = 'var(--accent-color, #00d4ff)';
                            ctx.lineWidth = 3;
                            ctx.arc(0, 0, r, -Math.PI / 2, -Math.PI / 2 + frac * 2 * Math.PI);
                            ctx.stroke();
                        }
                        ctx.setTransform(1, 0, 0, 1, 0, 0);
                        requestAnimationFrame(draw);
                    };
                    requestAnimationFrame(draw);
                }
            };
        }

        // Global reference with a simple play alias
        window.globalPlayer = window.globalPlayer || {};
        window.globalPlayer.playTrack = (track) => {
            document.dispatchEvent(new CustomEvent('play-track', { detail: { track } }));
        };
        // Backward-compat: allow window.globalPlayer.play(item)
        window.globalPlayer.play = (item) => window.globalPlayer.playTrack(item);
    </script>

        <!-- Global Dashboard Sidebars Script -->
        <script>
        function dashboardCollection() {
            return {
                badges: [],
                collections: [],
                // XP / reinforcement
                showXpReward: false,
                xpGain: 0,
                xpTotal: 0,
                currentTrack: null,
                isTinyPlaying: false,
                // Boost state
                artists: [],
                selectedArtistId: '',
                tipAmount: '',
                isTipping: false,
                showTipSuccess: false,
                // Search state
                searchQuery: '',

                get isValid() {
                    return this.selectedArtistId &&
                        this.tipAmount &&
                        parseFloat(this.tipAmount) >= 0.50;
                },

                // Fee calculation functions
                calculateStripeFee(tipAmount) {
                    if (!tipAmount || tipAmount < 0.50) return 0;
                    return (tipAmount * 0.029) + 0.30;
                },

                calculatePlatformFee(tipAmount) {
                    if (!tipAmount || tipAmount < 0.50) return 0;
                    return tipAmount * 0.075;
                },

                calculateTotalCharge(tipAmount) {
                    if (!tipAmount || tipAmount < 0.50) return 0;
                    const stripeFee = this.calculateStripeFee(tipAmount);
                    const platformFee = this.calculatePlatformFee(tipAmount);
                    return tipAmount + stripeFee + platformFee;
                },

                initToast() {
                    this.$watch('showTipSuccess', (value) => {
                        if (value) {
                            setTimeout(() => {
                                this.showTipSuccess = false;
                            }, 3000);
                        }
                    });
                },
                async init() {
                    try {
                        const response = await fetch('/api/me/gamification');
                        if (response.ok) {
                            const data = await response.json();
                            this.badges = data.badges || [];
                        }
                    } catch (e) { /* Badges not available - non-critical */ }

                    // Initialize toast watcher
                    this.initToast();
                    // Load XP total (local positions helper)
                    try { this.xpTotal = parseInt(localStorage.getItem('ahoyXp') || '0', 10) || 0; } catch (_) { this.xpTotal = 0; }

                    // Load artists for boost
                    await this.loadArtists();
                    
                    // Load collections
                    await this.loadCollections();

                    // Sync with media player
                    this.syncMediaPlayer();
                    // Listen for media player updates
                    if (window.mediaPlayer && window.mediaPlayer.on) {
                        window.mediaPlayer.on('play', () => this.syncMediaPlayer());
                        window.mediaPlayer.on('pause', () => this.syncMediaPlayer());
                        window.mediaPlayer.on('trackchange', () => this.syncMediaPlayer());
                    }
                    // Poll for updates (reduced frequency: 3 seconds instead of 1, and pause when tab hidden)
                    let mediaPlayerPoller = null;
                    const startPolling = () => {
                        if (mediaPlayerPoller) return;
                        mediaPlayerPoller = setInterval(() => {
                            if (document.visibilityState === 'visible') {
                                this.syncMediaPlayer();
                            }
                        }, 3000); // Reduced from 1000ms to 3000ms
                    };
                    const stopPolling = () => {
                        if (mediaPlayerPoller) {
                            clearInterval(mediaPlayerPoller);
                            mediaPlayerPoller = null;
                        }
                    };
                    if (document.visibilityState === 'visible') startPolling();
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                            this.syncMediaPlayer(); // Quick sync on return
                            startPolling();
                        } else {
                            stopPolling();
                        }
                    });
                },
                async loadArtists() {
                    try {
                        // Use shared data store to prevent duplicate calls
                        const data = window.__ahoyDataStore ? 
                            await window.__ahoyDataStore.getArtists() :
                            await (await fetch('/api/artists')).json();
                        this.artists = data.artists || [];
                    } catch (e) {
                        /* Artists not available for boost - non-critical */
                        this.artists = [];
                    }
                },
                async loadCollections() {
                    if (!window.LOGGED_IN) return;
                    try {
                        const username = window.userProfile?.username;
                        // If no username, we might not be able to filter by user on the API
                        // But let's try calling without user if it returns my collections?
                        // API logic was: if user, filter by user. Else return all.
                        // We definitely want only ours.
                        if (!username) return;

                        const response = await fetch(`/api/collections/?user=${encodeURIComponent(username)}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.collections = data || [];
                        }
                    } catch (e) {
                        console.error('Error loading collections:', e);
                        this.collections = [];
                    }
                },
                goToCollection(id) {
                    // Navigate to bookmarks/collections page
                    // Ideally we would filter by collection ID, but simple navigation for now
                    window.location.href = '/bookmarks';
                },
                async sendTip() {
                    if (!this.selectedArtistId || !this.tipAmount) return;

                    const tipAmount = parseFloat(this.tipAmount);
                    if (tipAmount < 0.50) {
                        document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Enter a valid boost amount (min $0.50).' }));
                        return;
                    }

                    this.isTipping = true;
                    try {
                        const response = await fetch('/payments/tip-session', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                artist_id: this.selectedArtistId,
                                tip_amount: tipAmount  // Use tip_amount field name
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.checkout_url) {
                            // Open Stripe checkout in a new window
                            const checkoutWindow = window.open(data.checkout_url, 'stripe-checkout', 'width=600,height=700');

                            // Friendly toast
                            try {
                                const artistName = (this.artists.find(a => (a.id || a.name) == this.selectedArtistId)?.name) || 'artist';
                                document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: `Thank you! Your $${tipAmount.toFixed(2)} boost went to ${artistName} 🙌` }));
                            } catch (_) { }

                            // Monitor for window close (payment completion)
                            const checkClosed = setInterval(() => {
                                if (checkoutWindow.closed) {
                                    clearInterval(checkClosed);
                                    // Show success toast
                                    this.showTipSuccess = true;
                                    // Persist locally for positions
                                    try {
                                        const tips = JSON.parse(localStorage.getItem('ahoyTips') || '[]');
                                        tips.push({ artistID: this.selectedArtistId, amount: tipAmount, timestamp: Date.now() });
                                        localStorage.setItem('ahoyTips', JSON.stringify(tips));
                                        window.dispatchEvent(new CustomEvent('tipping:update', { detail: { total: tips.reduce((s, t) => s + (t.amount || 0), 0) } }));
                                        // XP reinforce
                                        this.xpGain = Math.max(5, Math.round(tipAmount));
                                        this.xpTotal = (this.xpTotal || 0) + this.xpGain;
                                        localStorage.setItem('ahoyXp', String(this.xpTotal));
                                        this.showXpReward = true;
                                        // Top status badge blip
                                        try {
                                            const badge = document.getElementById('tip-status-badge');
                                            if (badge) {
                                                badge.classList.add('visible');
                                                badge.querySelector('.tip-status-text').textContent = `+${this.xpGain} XP`;
                                                setTimeout(() => badge.classList.remove('visible'), 2500);
                                            }
                                        } catch (_) { }
                                    } catch (_) { }
                                    // Clear form
                                    this.selectedArtistId = '';
                                    this.tipAmount = '';
                                    // Auto-hide after 3 seconds (handled by x-init)
                                }
                            }, 500);
                        } else {
                            const errorMsg = data.error || 'Failed to create boost session';
                            document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: errorMsg }));
                        }
                    } catch (e) {
                        console.error('Tip error:', e);
                        document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Error processing boost. Please try again.' }));
                    } finally {
                        this.isTipping = false;
                    }
                },
                syncMediaPlayer() {
                    if (window.mediaPlayer) {
                        this.currentTrack = window.mediaPlayer.currentTrack;
                        this.isTinyPlaying = window.mediaPlayer.isPlaying || false;
                    }
                },
                toggleTinyPlayer() {
                    if (!window.mediaPlayer) return;
                    if (this.isTinyPlaying) {
                        window.mediaPlayer.pause();
                    } else {
                        if (this.currentTrack) {
                            window.mediaPlayer.resume();
                        } else {
                            // Try to play something if nothing is playing
                            console.log('No track to play');
                        }
                    }
                    this.syncMediaPlayer();
                },
                // Search functionality
                performSearch() {
                    if (!this.searchQuery.trim()) return;
                    const searchUrl = `/search?q=${encodeURIComponent(this.searchQuery)}`;
                    window.location.href = searchUrl;
                },
                clearSearch() {
                    this.searchQuery = '';
                },
                // Removed: redeemCode function (gamify feature removed)
            };
        }

        function dashboardUpNext() {
            return {
                nowPlaying: null,
                recent: [],
                queueItems: [],
                nowTime: '',
                async init() {
                    // Live clock (updates once per second)
                    const updateClock = () => {
                        try {
                            this.nowTime = new Date().toLocaleTimeString([], {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        } catch (e) {
                            this.nowTime = new Date().toLocaleTimeString();
                        }
                    };
                    updateClock();
                    // Optimize clock updates - pause when tab hidden, reduce frequency slightly
                    let clockPoller = null;
                    const startClock = () => {
                        if (clockPoller) return;
                        clockPoller = setInterval(() => {
                            if (document.visibilityState === 'visible') {
                                updateClock();
                            }
                        }, 2000); // Reduced from 1000ms to 2000ms (still smooth for clock)
                    };
                    const stopClock = () => {
                        if (clockPoller) {
                            clearInterval(clockPoller);
                            clockPoller = null;
                        }
                    };
                    if (document.visibilityState === 'visible') startClock();
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                            updateClock(); // Update immediately on return
                            startClock();
                        } else {
                            stopClock();
                        }
                    });

                    // Check if media player has a current track (radio or player)
                    // Prioritize actively playing radio/player content
                    if (window.mediaPlayer && window.mediaPlayer.currentTrack && window.mediaPlayer.isPlaying) {
                        this.nowPlaying = window.mediaPlayer.currentTrack;
                    } else if (window.mediaPlayer && window.mediaPlayer.currentTrack) {
                        this.nowPlaying = window.mediaPlayer.currentTrack;
                    } else {
                        // Load random media for "Now Playing"
                        try {
                            // Use shared data store to prevent duplicate calls
                            const [musicData, showsData] = await Promise.all([
                                window.__ahoyDataStore ? window.__ahoyDataStore.getMusic() : (await fetch('/api/music')).json(),
                                window.__ahoyDataStore ? window.__ahoyDataStore.getShows() : (await fetch('/api/shows')).json()
                            ]);

                            const allItems = [
                                ...(musicData.tracks || []).map(t => ({
                                    ...t,
                                    type: 'track',
                                    artist: t.artist
                                })),
                                ...(showsData.shows || []).map(s => ({
                                    ...s,
                                    type: 'show',
                                    title: s.title,
                                    artist: s.host,
                                    cover_art: s.thumbnail
                                }))
                            ];

                            // Pick a random item for "Now Playing" if nothing is playing
                            if (allItems.length > 0) {
                                const randomIndex = Math.floor(Math.random() * allItems.length);
                                this.nowPlaying = allItems[randomIndex];
                            }

                            // Pick 3 random items for "Recently Added"
                            const shuffled = [...allItems].sort(() => 0.5 - Math.random());
                            this.recent = shuffled.slice(0, 3);
                        } catch (e) { console.log('Media data not available', e); }
                    }

                    // Set up listener for media player changes (radio/player updates)
                    if (window.mediaPlayer && window.mediaPlayer.on) {
                        window.mediaPlayer.on('play', () => {
                            this.nowPlaying = window.mediaPlayer.currentTrack;
                        });
                        window.mediaPlayer.on('playlistchange', () => {
                            this.nowPlaying = window.mediaPlayer.currentTrack;
                        });
                        window.mediaPlayer.on('trackchange', () => {
                            this.nowPlaying = window.mediaPlayer.currentTrack;
                        });
                    }

                    // Poll for radio updates if radio page is active
                    setInterval(() => {
                        if (window.mediaPlayer && window.mediaPlayer.currentTrack && window.mediaPlayer.isPlaying) {
                            this.nowPlaying = window.mediaPlayer.currentTrack;
                        }
                    }, 2000);

                    // Load queue from media player if available
                    if (window.mediaPlayer && window.mediaPlayer.playlist) {
                        const currentIdx = window.mediaPlayer.currentIndex || 0;
                        this.queueItems = window.mediaPlayer.playlist.slice(currentIdx + 1);
                    }

                    // Listen for playlist changes to update queue
                    if (window.mediaPlayer && window.mediaPlayer.on) {
                        window.mediaPlayer.on('playlistchange', () => {
                            if (window.mediaPlayer && window.mediaPlayer.playlist) {
                                this.queueItems = window.mediaPlayer.playlist.slice((window.mediaPlayer.currentIndex || 0) + 1);
                            }
                        });
                    }
                },
                isRadioTrack(item) {
                    // Check if this track is from radio (has radio-specific properties or is in radio queue)
                    if (!item || !window.homePage) return false;
                    // Check if it matches the radio current track
                    if (window.homePage.radioCurrent &&
                        (window.homePage.radioCurrent.id === item.id ||
                            window.homePage.radioCurrent.track_id === item.track_id)) {
                        return true;
                    }
                    // Check if it's in radio tracks
                    if (window.homePage.radioTracks) {
                        return window.homePage.radioTracks.some(t =>
                            (t.id && item.id && String(t.id) === String(item.id)) ||
                            (t.track_id && item.track_id && String(t.track_id) === String(item.track_id))
                        );
                    }
                    return false;
                },
                goToMediaItem(item) {
                    // If it's a radio track, go to radio page, otherwise go to player
                    if (this.isRadioTrack(item)) {
                        window.location.href = '/radio';
                        return;
                    }
                    // Navigate to the media item's detail page
                    const type = item.type === 'show' ? 'show' : 'track';
                    window.location.href = `/player?id=${encodeURIComponent(item.id)}&type=${type}`;
                },
                addToQueue(item) {
                    // Add item to media player queue
                    if (window.mediaPlayer) {
                        window.mediaPlayer.addToPlaylist(item);
                        // Update local queue display
                        this.queueItems = window.mediaPlayer.playlist.slice((window.mediaPlayer.currentIndex || 0) + 1);
                    }
                    // Show notification
                    if (window.ahoyApp?.showNotification) {
                        window.ahoyApp.showNotification('Added to queue', 'success');
                    }
                },
                removeFromQueue(index) {
                    // Remove item from queue (adjust index based on current track position)
                    if (window.mediaPlayer && window.mediaPlayer.playlist) {
                        const actualIndex = (window.mediaPlayer.currentIndex || 0) + 1 + index;
                        window.mediaPlayer.removeFromPlaylist(actualIndex);
                        // Update local queue display
                        this.queueItems = window.mediaPlayer.playlist.slice((window.mediaPlayer.currentIndex || 0) + 1);
                    }
                },
                playItem(item) {
                    if (window.globalPlayer?.play) {
                        window.globalPlayer.play(item);
                    }
                },
                goTo(url) {
                    window.location.href = url;
                }
            };
        }
    </script>

        {% block extra_scripts %}{% endblock %}

        <!-- Service Worker Registration -->
        <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
        <script>
        // Initialize NProgress with enhanced configuration (guarded: CDN may be blocked)
        if (window.NProgress) {
        NProgress.configure({
            showSpinner: false,
            minimum: 0.08,
            trickleSpeed: 200,
            easing: 'ease',
            speed: 500,
            template: '<div class="nprogress-bar" role="bar"><div class="nprogress-peg"></div></div>'
        });

        // Custom styling for progress bar (purple theme)
        const style = document.createElement('style');
        style.textContent = `
            #nprogress {
                pointer-events: none;
                z-index: 99999;
            }
            #nprogress .nprogress-bar {
                background: linear-gradient(90deg, #a855f7 0%, #9333ea 50%, #a855f7 100%);
                background-size: 200% 100%;
                animation: nprogress-shimmer 1.5s ease-in-out infinite;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 3px;
                z-index: 99999;
            }
            @media (max-width: 767px) {
                #nprogress .nprogress-bar {
                    height: 4px;
                }
            }
            #nprogress .nprogress-peg {
                display: block;
                position: absolute;
                right: 0px;
                width: 100px;
                height: 100%;
                box-shadow: 0 0 10px #a855f7, 0 0 5px #a855f7;
                opacity: 1.0;
                transform: rotate(3deg) translate(0px, -4px);
            }
            @keyframes nprogress-shimmer {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            /* Fade out animation */
            #nprogress.nprogress-custom-parent {
                overflow: hidden;
                position: relative;
            }
            #nprogress.nprogress-custom-parent #nprogress .nprogress-bar {
                position: absolute;
            }
        `;
        document.head.appendChild(style);

        // Trigger on page load
        document.addEventListener('DOMContentLoaded', () => {
            NProgress.done();
        });

        // Trigger on page unload
        window.addEventListener('beforeunload', () => {
            NProgress.start();
        });

        // Enhanced fetch interceptor with better request detection
        // NOTE: bind() avoids "Illegal invocation" in some browsers when calling native fetch.
        const originalFetch = (window.fetch && window.fetch.bind) ? window.fetch.bind(window) : window.fetch;
        window.fetch = async function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : (args[0]?.url || '');
            const options = args[1] || {};
            
            // Skip progress bar for:
            // - Polling/background requests
            // - Image/media requests
            // - Service worker requests
            // - Requests with no-progress header
            const isPolling = url.includes('/api/radio/now') || 
                            url.includes('/widget-data') || 
                            url.includes('/api/check') ||
                            url.includes('/static/') ||
                            url.includes('service-worker') ||
                            options.headers?.['X-No-Progress'] === 'true';
            
            if (!isPolling && !url.match(/\.(jpg|jpeg|png|gif|svg|webp|mp3|mp4|webm|ogg)$/i)) {
                NProgress.start();
            }
            
            try {
                const response = await originalFetch(...args);
                if (!isPolling && !url.match(/\.(jpg|jpeg|png|gif|svg|webp|mp3|mp4|webm|ogg)$/i)) {
                    // Delay completion slightly for better UX
                    setTimeout(() => NProgress.done(), 100);
                }
                return response;
            } catch (error) {
                if (!isPolling && !url.match(/\.(jpg|jpeg|png|gif|svg|webp|mp3|mp4|webm|ogg)$/i)) {
                    NProgress.done();
                }
                throw error;
            }
        };

        // Handle navigation events (for SPA-like behavior)
        let navigationTimeout;
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a[href]');
            if (link && link.href && !link.target && !link.hasAttribute('download')) {
                const href = link.getAttribute('href');
                // Only show progress for internal links
                if (href.startsWith('/') || href.startsWith(window.location.origin)) {
                    clearTimeout(navigationTimeout);
                    NProgress.start();
                    // If navigation doesn't happen quickly, it's probably a slow page
                    navigationTimeout = setTimeout(() => {
                        NProgress.set(0.3);
                    }, 200);
                }
            }
        });
        } else {
            // NProgress isn't available (blocked/slow CDN). Keep the site functional.
            // eslint-disable-next-line no-console
            console.debug('NProgress not available; skipping progress-bar hooks');
        }
    </script>

    <!-- Extended Hover Effects for Sidebar Icons -->
    <script>
        (function() {
            // Extended hover detection for sidebar items (1.5 seconds)
            const EXTENDED_HOVER_DELAY = 1500; // 1.5 seconds
            let hoverTimers = new Map();
            
            function initExtendedHover() {
                const sidebarItems = document.querySelectorAll('.app-sidebar-item[data-icon]');
                
                sidebarItems.forEach(item => {
                    let hoverTimer = null;
                    
                    item.addEventListener('mouseenter', function() {
                        // Clear any existing timer
                        if (hoverTimer) {
                            clearTimeout(hoverTimer);
                        }
                        
                        // Set timer for extended hover
                        hoverTimer = setTimeout(() => {
                            item.classList.add('hover-extended');
                            hoverTimers.set(item, hoverTimer);
                        }, EXTENDED_HOVER_DELAY);
                    });
                    
                    item.addEventListener('mouseleave', function() {
                        // Clear timer if still pending
                        if (hoverTimer) {
                            clearTimeout(hoverTimer);
                            hoverTimer = null;
                        }
                        
                        // Remove extended hover class
                        item.classList.remove('hover-extended');
                        hoverTimers.delete(item);
                    });
                });
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initExtendedHover);
            } else {
                initExtendedHover();
            }
        })();
    </script>
    </body>

</html>