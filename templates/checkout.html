{% extends "base.html" %}
{% block title %}Checkout - Ahoy Indie Media{% endblock %}
{% block content %}
<div id="checkoutContainer"
    class="checkout-overlay fixed inset-0 z-[9998] flex items-center justify-center p-6"
    style="pointer-events: auto; background: radial-gradient(1200px circle at 50% 20%, rgba(120, 140, 255, 0.08), rgba(10, 12, 18, 0.95) 70%);">

    <div
        class="checkout-card w-full max-w-xl rounded-2xl text-white relative"
        style="pointer-events: auto; z-index: 9999; position: relative; backdrop-filter: blur(var(--blur-strong, 24px)) saturate(160%); -webkit-backdrop-filter: blur(var(--blur-strong, 24px)) saturate(160%); background: linear-gradient(180deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.01) 100%), var(--glass-bg, rgba(12, 14, 18, 0.55)); border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.08)); box-shadow: var(--shadow-glass, 0 20px 60px rgba(0, 0, 0, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.05)); padding: 2rem;">

        <div class="checkout-steps flex items-center justify-center gap-3 mb-6">
            <div class="step active px-4 py-2 rounded-full bg-white/20 text-white text-sm">Review</div>
            <div class="step px-4 py-2 rounded-full bg-white/10 text-white/60 text-sm">Pay</div>
            <div class="step px-4 py-2 rounded-full bg-white/10 text-white/60 text-sm">Complete</div>
        </div>

        <div class="checkout-panel">
            <h1 class="text-2xl font-bold mb-4">Checkout</h1>

            {% if error %}
            <div class="bg-red-500/10 border border-red-500/30 text-red-200 px-4 py-3 rounded-lg mb-4">{{
                error }}</div>
            {% endif %}

            <div class="grid grid-cols-1 gap-4">
                {% if kind == 'boost' %}
                <div class="bg-white/5 rounded-lg p-4 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
                    <p class="text-white/60 text-sm">Boost for Artist</p>
                    <p class="text-lg font-semibold">{{ artist_id or
                        'Unknown Artist' }}</p>
                </div>

                <div class="breakdown border border-white/10 rounded-xl p-4 mt-2 mb-2 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%); background: linear-gradient(180deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.01) 100%), rgba(12, 14, 18, 0.4);">
                    <h3 class="font-semibold text-lg mb-3">Breakdown</h3>
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Boost Amount</span>
                        <span id="boostAmount">${{ '%.2f'|format(amount|float if amount else 0) }}</span>
                    </div>
                    {% if stripe_fee is not none %}
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Stripe Fee</span>
                        <span id="stripeFee">${{ '%.2f'|format(stripe_fee)
                            }}</span>
                    </div>
                    {% endif %}
                    {% if platform_fee is not none %}
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Ahoy Fee</span>
                        <span id="ahoyFee">${{ '%.2f'|format(platform_fee)
                            }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between pt-3 mt-2 border-t border-white/10">
                        <span class="font-semibold">Total</span>
                        <span id="checkoutTotal" class="font-semibold">${{
                            '%.2f'|format(total if total is not none else 0) }}</span>
                    </div>
                </div>
                
                {% if wallet_balance is not none %}
                {% set boost_total = (total if total is not none else (amount|float if amount else 0)) %}
                <div class="wallet-payment-option rounded-lg p-4 border border-purple-500/20 mt-4 backdrop-filter: blur(14px) saturate(150%); -webkit-backdrop-filter: blur(14px) saturate(150%); background: linear-gradient(135deg, rgba(147, 51, 234, 0.12) 0%, rgba(59, 130, 246, 0.12) 100%), rgba(12, 14, 18, 0.5); box-shadow: 0 0 20px rgba(147, 51, 234, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.05);">
                    {% if wallet_balance >= boost_total %}
                    <!-- Sufficient Balance: Offer Instant Payment -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-white/80 text-sm">Wallet Balance</p>
                            <p class="text-xl font-semibold text-purple-300">${{ '%.2f'|format(wallet_balance) }}</p>
                        </div>
                        <i class="fas fa-wallet text-purple-400 text-2xl"></i>
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-white/5 transition">
                        <input type="checkbox" id="useWalletCheckboxBoost" class="w-5 h-5 rounded border-white/20 bg-white/10 text-purple-500 focus:ring-purple-500" onchange="document.getElementById('useWalletHidden').value = this.checked ? 'true' : 'false'; updateCheckoutButtonText();">
                        <div class="flex-1">
                            <span class="text-white/90 font-medium">Pay instantly from wallet</span>
                            <p class="text-xs text-white/60 mt-1">No card entry needed • Instant checkout</p>
                        </div>
                    </label>
                    <p class="text-xs text-purple-300 mt-2">
                        <i class="fas fa-bolt"></i> You'll save time - no redirect to payment page
                    </p>
                    {% else %}
                    <!-- Insufficient Balance -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-white/80 text-sm">Wallet Balance</p>
                            <p class="text-xl font-semibold text-purple-300">${{ '%.2f'|format(wallet_balance) }}</p>
                            <p class="text-xs text-white/60">Need ${{ '%.2f'|format(boost_total - wallet_balance) }} more</p>
                        </div>
                        <i class="fas fa-wallet text-purple-400 text-2xl"></i>
                    </div>
                    <p class="text-white/70 text-sm mb-3">Add funds to wallet for instant checkout, or pay with card below.</p>
                    <div class="flex gap-2">
                        <button onclick="window.open('/account', '_blank')" class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-wallet"></i> Add ${{ '%.2f'|format(boost_total - wallet_balance) }} to Wallet
                        </button>
                        <p class="text-xs text-white/60 self-center px-2">or</p>
                        <p class="text-xs text-white/60 self-center">Pay with card below</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}
                
                {% if wallet_balance is not none %}
                {% set total_amount = (total if total is not none else (amount|float if amount else 0)) %}
                <div class="wallet-payment-option rounded-lg p-4 border border-purple-500/20 mt-4 backdrop-filter: blur(14px) saturate(150%); -webkit-backdrop-filter: blur(14px) saturate(150%); background: linear-gradient(135deg, rgba(147, 51, 234, 0.12) 0%, rgba(59, 130, 246, 0.12) 100%), rgba(12, 14, 18, 0.5); box-shadow: 0 0 20px rgba(147, 51, 234, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.05);">
                    {% if wallet_balance >= total_amount %}
                    <!-- Sufficient Balance: Offer Instant Payment -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-white/80 text-sm">Wallet Balance</p>
                            <p class="text-xl font-semibold text-purple-300">${{ '%.2f'|format(wallet_balance) }}</p>
                        </div>
                        <i class="fas fa-wallet text-purple-400 text-2xl"></i>
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-white/5 transition">
                        <input type="checkbox" id="useWalletCheckboxMerch" class="w-5 h-5 rounded border-white/20 bg-white/10 text-purple-500 focus:ring-purple-500" onchange="document.getElementById('useWalletHidden').value = this.checked ? 'true' : 'false'; updateCheckoutButtonText();">
                        <div class="flex-1">
                            <span class="text-white/90 font-medium">Pay instantly from wallet</span>
                            <p class="text-xs text-white/60 mt-1">No card entry needed • Instant checkout</p>
                        </div>
                    </label>
                    <p class="text-xs text-purple-300 mt-2">
                        <i class="fas fa-bolt"></i> You'll save time - no redirect to payment page
                    </p>
                    {% else %}
                    <!-- Insufficient Balance: Show Option to Add More -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-white/80 text-sm">Wallet Balance</p>
                            <p class="text-xl font-semibold text-purple-300">${{ '%.2f'|format(wallet_balance) }}</p>
                            <p class="text-xs text-white/60">Need ${{ '%.2f'|format(total_amount - wallet_balance) }} more</p>
                        </div>
                        <i class="fas fa-wallet text-purple-400 text-2xl"></i>
                    </div>
                    <p class="text-white/70 text-sm mb-3">Add funds to wallet for instant checkout, or pay with card below.</p>
                    <div class="flex gap-2">
                        <button onclick="window.open('/account', '_blank')" class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-wallet"></i> Add ${{ '%.2f'|format(total_amount - wallet_balance) }} to Wallet
                        </button>
                        <p class="text-xs text-white/60 self-center px-2">or</p>
                        <p class="text-xs text-white/60 self-center">Pay with card below</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Payment Method Selection Info -->
                {% if wallet_balance is not none %}
                <div class="payment-method-info rounded-lg p-3 border border-white/10 mt-4 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%); background: linear-gradient(180deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.01) 100%), rgba(12, 14, 18, 0.4);">
                    <p class="text-xs text-white/70 mb-2">
                        <i class="fas fa-info-circle"></i> <strong>Two ways to pay:</strong>
                    </p>
                    <div class="grid grid-cols-1 gap-2 text-xs">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-wallet text-purple-400 mt-0.5"></i>
                            <div>
                                <strong class="text-white/90">Wallet (Instant):</strong>
                                <span class="text-white/60"> No card entry, instant checkout</span>
                            </div>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-credit-card text-blue-400 mt-0.5"></i>
                            <div>
                                <strong class="text-white/90">Card (Stripe):</strong>
                                <span class="text-white/60"> Secure payment via Stripe Checkout</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <form method="POST" action="/checkout/process" id="checkoutForm" class="space-y-3" style="pointer-events: auto; position: relative; z-index: 10000;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="type" value="{{ kind }}">
                <input type="hidden" name="artist_id" value="{{ artist_id }}">
                <input type="hidden" name="amount" value="{{ amount }}">
                <input type="hidden" name="item_id" value="{{ item_id }}">
                <input type="hidden" name="qty" value="{{ qty }}">
                <input type="hidden" name="title" value="{{ title }}">
                <input type="hidden" name="computed_total" value="{{ total if total is not none else amount }}">
                <input type="hidden" name="use_wallet" id="useWalletHidden" value="false">
            </form>
            
            <!-- NEW WORKING BUTTON - Completely outside form, programmatically submits -->
            <div style="margin-top: 1.5rem; width: 100%;">
                <button type="submit"
                    id="newCheckoutBtn"
                    form="checkoutForm"
                    style="width: 100%; padding: 1rem; border-radius: 1rem; background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; backdrop-filter: saturate(140%) blur(12px); -webkit-backdrop-filter: saturate(140%) blur(12px); color: white !important; font-size: 1.125rem; font-weight: 600; cursor: pointer !important; pointer-events: auto !important; position: relative; z-index: 10002 !important; transition: all 0.3s; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); opacity: 1 !important;"
                    onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 15px 40px rgba(0, 0, 0, 0.4)'; this.style.opacity='1';"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 10px 30px rgba(0, 0, 0, 0.3)'; this.style.opacity='1';"
                    onclick="console.log('=== NATIVE SUBMIT BUTTON CLICKED ==='); if (window.createConfetti) { window.createConfetti(); } return true;">
                    <span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i class="fas fa-lock" id="checkoutIcon"></i>
                        <span id="checkoutButtonText">Complete Checkout{% if total is not none and total > 0 %} — ${{ '%.2f'|format(total) }}{% else %} — ${{ '%.2f'|format(amount|float if amount else 0) }}{% endif %}</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Console Error Logger - Persists across navigation
    (function initErrorLogger() {
        if (!window.checkoutErrorLog) {
            window.checkoutErrorLog = [];
        }
        
        // Override console.error to capture errors
        const originalError = console.error;
        console.error = function(...args) {
            const errorEntry = {
                timestamp: new Date().toISOString(),
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '),
                stack: new Error().stack,
                url: window.location.href
            };
            window.checkoutErrorLog.push(errorEntry);
            originalError.apply(console, args);
        };
        
        // Capture unhandled errors
        window.addEventListener('error', (event) => {
            window.checkoutErrorLog.push({
                timestamp: new Date().toISOString(),
                message: event.message || 'Unhandled error',
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack,
                url: window.location.href
            });
        });
        
        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            window.checkoutErrorLog.push({
                timestamp: new Date().toISOString(),
                message: 'Unhandled Promise Rejection: ' + (event.reason?.message || String(event.reason)),
                stack: event.reason?.stack,
                url: window.location.href
            });
        });
        
        // Expose log getter
        window.getCheckoutErrorLog = function() {
            return JSON.stringify(window.checkoutErrorLog, null, 2);
        };
        
        // Log to console that error logging is active
        console.log('[Checkout] Error logging initialized. Use window.getCheckoutErrorLog() to retrieve log.');
    })();
    
    // Dim rest of page while checkout open
    // FORCE ENABLE THE BUTTON IMMEDIATELY - Run this ASAP
    (function forceEnableButton() {
        const btn = document.getElementById('newCheckoutBtn');
        if (btn) {
            console.log('=== FORCING BUTTON ENABLE (IMMEDIATE) ===');
            btn.disabled = false;
            btn.removeAttribute('disabled');
            btn.style.opacity = '1 !important';
            btn.style.cursor = 'pointer !important';
            btn.style.pointerEvents = 'auto !important';
            btn.style.color = 'white !important';
            btn.setAttribute('aria-disabled', 'false');
            console.log('Button disabled?', btn.disabled);
            console.log('Button is now enabled!');
        }
    })();
    
    document.addEventListener('DOMContentLoaded', () => {
        try { document.body.classList.add('checkout-mode'); } catch (_) { }
        
        // FORCE ENABLE THE BUTTON AGAIN - Remove any disabled state
        const btn = document.getElementById('newCheckoutBtn');
        if (btn) {
            console.log('=== FORCING BUTTON ENABLE (DOMContentLoaded) ===');
            btn.disabled = false;
            btn.removeAttribute('disabled');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.pointerEvents = 'auto';
            btn.style.color = 'white';
            btn.setAttribute('aria-disabled', 'false');
            console.log('Button disabled?', btn.disabled);
            console.log('Button style.opacity:', btn.style.opacity);
            console.log('Button computed opacity:', window.getComputedStyle(btn).opacity);
            console.log('Button is now enabled!');
        } else {
            console.error('Button not found!');
        }
        
        // Update button text based on wallet selection
        const walletCheckbox = document.getElementById('useWalletCheckboxBoost') || document.getElementById('useWalletCheckboxMerch');
        const checkoutBtn = document.getElementById('newCheckoutBtn');
        const checkoutText = document.getElementById('checkoutButtonText');
        const checkoutIcon = document.getElementById('checkoutIcon');
        
        function updateCheckoutButton() {
            const useWallet = document.getElementById('useWalletHidden')?.value === 'true';
            if (checkoutText && checkoutIcon) {
                if (useWallet) {
                    checkoutIcon.className = 'fas fa-wallet';
                    checkoutText.textContent = 'Pay Instantly with Wallet';
                } else {
                    checkoutIcon.className = 'fas fa-lock';
                    const total = {% if total is not none and total > 0 %}{{ '%.2f'|format(total) }}{% else %}{{ '%.2f'|format(amount|float if amount else 0) }}{% endif %};
                    checkoutText.textContent = `Pay $${total} with Card`;
                }
            }
        }
        
        // Make function global for inline onchange handlers
        window.updateCheckoutButtonText = updateCheckoutButton;
        
        // Listen to both checkboxes
        const walletCheckboxBoost = document.getElementById('useWalletCheckboxBoost');
        const walletCheckboxMerch = document.getElementById('useWalletCheckboxMerch');
        if (walletCheckboxBoost) {
            walletCheckboxBoost.addEventListener('change', updateCheckoutButton);
        }
        if (walletCheckboxMerch) {
            walletCheckboxMerch.addEventListener('change', updateCheckoutButton);
        }
        updateCheckoutButton(); // Initial update
    });
    window.addEventListener('beforeunload', () => {
        try { document.body.classList.remove('checkout-mode'); } catch (_) { }
    });

    // Direct form submission function - works independently
    // Make it globally accessible
    window.submitCheckoutForm = function submitCheckoutForm() {
        console.log('=== SUBMIT CHECKOUT FORM CALLED ===');
        
        // Create confetti immediately for visual feedback
        if (window.createConfetti) {
            window.createConfetti();
        }
        
        // Find form by ID first, then fallback to selector
        let form = document.getElementById('checkoutForm');
        if (!form) {
            form = document.querySelector('form[action="/checkout/process"]');
        }
        if (!form) {
            console.error('Form not found!');
            alert('Error: Form not found. Please refresh the page.');
            return;
        }
        
        console.log('Form found:', form);
        console.log('Form action:', form.action);
        console.log('Form method:', form.method);
        
        // Show loading state (don't disable - let form submit)
        const btn = document.getElementById('newCheckoutBtn');
        if (btn) {
            // Don't disable - just show loading state
            btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><i class="fas fa-spinner fa-spin"></i><span>Processing...</span></span>';
        }
        
        // Animate steps
        const steps = document.querySelectorAll('.checkout-steps .step');
        if (steps && steps.length === 3) {
            steps[0].classList.remove('active');
            steps[1].classList.add('active');
        }
        
        // Submit the form - ensure CSRF token is included
        try {
            console.log('Submitting form...');
            
            // Verify CSRF token exists in form
            const csrfInput = form.querySelector('input[name="csrf_token"]');
            if (csrfInput) {
                const tokenValue = csrfInput.value;
                console.log('CSRF token found:', tokenValue ? `Yes (length: ${tokenValue.length}, first 10 chars: ${tokenValue.substring(0, 10)}...)` : 'No (empty)');
                if (!tokenValue) {
                    console.error('CSRF token is empty!');
                    alert('Error: CSRF token is missing. Please refresh the page and try again.');
                    return;
                }
            } else {
                console.error('CSRF token input not found in form!');
                alert('Error: CSRF token input not found. Please refresh the page and try again.');
                return;
            }
            
            // Log all form fields to verify they're present
            const formData = new FormData(form);
            console.log('Form fields being submitted:');
            for (let [key, value] of formData.entries()) {
                if (key === 'csrf_token') {
                    console.log(`  ${key}: ${value ? `Present (length: ${value.length})` : 'Missing'}`);
                } else {
                    console.log(`  ${key}: ${value}`);
                }
            }
            
            // Use the most reliable method: create a real submit button and click it
            // This ensures all form fields (including CSRF token) are included
            console.log('Creating submit button and submitting form...');
            const submitBtn = document.createElement('button');
            submitBtn.type = 'submit';
            submitBtn.style.position = 'absolute';
            submitBtn.style.left = '-9999px';
            submitBtn.style.opacity = '0';
            submitBtn.style.pointerEvents = 'none';
            form.appendChild(submitBtn);
            
            // Submit immediately
            submitBtn.click();
            
        } catch (e) {
            console.error('Error submitting form:', e);
            // Fallback: submit via fetch with proper CSRF token
            submitFormViaFetch(form);
        }
        
        // Fallback function to submit form via fetch (ensures CSRF token is included)
        function submitFormViaFetch(formElement) {
            console.log('Using fetch to submit form...');
            const formData = new FormData(formElement);
            
            // Verify CSRF token is in FormData
            const csrfToken = formData.get('csrf_token');
            console.log('CSRF token in FormData:', csrfToken ? 'Yes' : 'No');
            
            if (!csrfToken) {
                console.error('CSRF token missing from FormData!');
                alert('Error: CSRF token missing. Please refresh the page and try again.');
                return;
            }
            
            fetch(formElement.action, {
                method: formElement.method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin' // Important for cookies/session
            }).then(response => {
                console.log('Form submitted via fetch, status:', response.status);
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (response.ok) {
                    return response.text().then(html => {
                        // If response is HTML, replace the page
                        if (html.trim().startsWith('<!')) {
                            document.open();
                            document.write(html);
                            document.close();
                        } else {
                            // If it's JSON (error), handle it
                            try {
                                const json = JSON.parse(html);
                                if (json.error) {
                                    alert('Error: ' + json.reason || json.error);
                                }
                            } catch (e) {
                                // Not JSON, treat as HTML
                                document.open();
                                document.write(html);
                                document.close();
                            }
                        }
                    });
                } else {
                    return response.json().then(json => {
                        console.error('Form submission error:', json);
                        alert('Error: ' + (json.reason || json.error || 'Unknown error'));
                    });
                }
            }).catch(err => {
                console.error('Fetch submission failed:', err);
                alert('Error submitting checkout. Please try again.');
            });
        }
    };
    
    // Confetti function for visual feedback - make globally accessible
    window.createConfetti = function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.borderRadius = '50%';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '99999';
                confetti.style.boxShadow = '0 0 6px ' + confetti.style.backgroundColor;
                
                document.body.appendChild(confetti);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 2 + Math.random() * 3;
                const rotation = Math.random() * 360;
                const rotationSpeed = (Math.random() - 0.5) * 10;
                
                let x = parseFloat(confetti.style.left);
                let y = -10;
                let currentRotation = rotation;
                
                const animate = () => {
                    x += Math.cos(angle) * velocity;
                    y += Math.sin(angle) * velocity + 0.5; // gravity
                    currentRotation += rotationSpeed;
                    
                    confetti.style.left = x + '%';
                    confetti.style.top = y + 'px';
                    confetti.style.transform = `rotate(${currentRotation}deg)`;
                    
                    if (y < window.innerHeight + 50) {
                        requestAnimationFrame(animate);
                    } else {
                        confetti.remove();
                    }
                };
                
                animate();
            }, i * 10);
        }
    }
</script>
{% endblock %}