{% extends "base.html" %}
{% block title %}Checkout - Ahoy Indie Media{% endblock %}
{% block content %}
<div id="checkoutContainer"
    class="checkout-overlay fixed inset-0 z-[9998] flex items-center justify-center p-6 backdrop-blur-xl bg-black/60"
    style="pointer-events: auto;">

    <div
        class="checkout-card w-full max-w-xl bg-black/50 rounded-2xl border border-white/10 shadow-2xl p-8 text-white relative"
        style="pointer-events: auto; z-index: 9999; position: relative;">

        <div class="checkout-steps flex items-center justify-center gap-3 mb-6">
            <div class="step active px-4 py-2 rounded-full bg-white/20 text-white text-sm">Review</div>
            <div class="step px-4 py-2 rounded-full bg-white/10 text-white/60 text-sm">Pay</div>
            <div class="step px-4 py-2 rounded-full bg-white/10 text-white/60 text-sm">Complete</div>
        </div>

        <div class="checkout-panel">
            <h1 class="text-2xl font-bold mb-4">Checkout</h1>

            {% if error %}
            <div class="bg-red-500/10 border border-red-500/30 text-red-200 px-4 py-3 rounded-lg mb-4">{{
                error }}</div>
            {% endif %}

            <div class="grid grid-cols-1 gap-4">
                {% if kind == 'boost' %}
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <p class="text-white/60 text-sm">Boost for Artist</p>
                    <p class="text-lg font-semibold">{{ artist_id or
                        'Unknown Artist' }}</p>
                </div>

                <div class="breakdown bg-black/30 border border-white/10 rounded-xl p-4 mt-2 mb-2">
                    <h3 class="font-semibold text-lg mb-3">Breakdown</h3>
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Boost Amount</span>
                        <span id="boostAmount">${{ '%.2f'|format(amount|float if amount else 0) }}</span>
                    </div>
                    {% if stripe_fee is not none %}
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Stripe Fee</span>
                        <span id="stripeFee">${{ '%.2f'|format(stripe_fee)
                            }}</span>
                    </div>
                    {% endif %}
                    {% if platform_fee is not none %}
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Ahoy Fee</span>
                        <span id="ahoyFee">${{ '%.2f'|format(platform_fee)
                            }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between pt-3 mt-2 border-t border-white/10">
                        <span class="font-semibold">Total</span>
                        <span id="checkoutTotal" class="font-semibold">${{
                            '%.2f'|format(total if total is not none else 0) }}</span>
                    </div>
                </div>
                {% else %}
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <p class="text-white/60 text-sm">Item</p>
                    <p class="text-lg font-semibold">{{ title or 'Item' }}</p>
                    <div class="flex justify-between text-sm mt-2">
                        <span class="text-white/70">Qty</span>
                        <span class="text-white font-medium">{{ qty or 1
                            }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-white/70">Amount</span>
                        <span class="text-white font-medium">${{
                            '%.2f'|format(amount|float if amount else 0) }}</span>
                    </div>
                    <div class="flex justify-between pt-3 mt-2 border-t border-white/10">
                        <span class="font-semibold">Total</span>
                        <span class="font-semibold">${{
                            '%.2f'|format(total if total is not none else (amount|float if amount else 0)) }}</span>
                    </div>
                </div>
                {% endif %}
            </div>

            <form method="POST" action="/checkout/process" id="checkoutForm" class="space-y-3" style="pointer-events: auto; position: relative; z-index: 10000;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="type" value="{{ kind }}">
                <input type="hidden" name="artist_id" value="{{ artist_id }}">
                <input type="hidden" name="amount" value="{{ amount }}">
                <input type="hidden" name="item_id" value="{{ item_id }}">
                <input type="hidden" name="qty" value="{{ qty }}">
                <input type="hidden" name="computed_total" value="{{ total if total is not none else amount }}">
            </form>
            
            <!-- NEW WORKING BUTTON - Completely outside form, programmatically submits -->
            <div style="margin-top: 1.5rem; width: 100%;">
                <button type="submit"
                    id="newCheckoutBtn"
                    form="checkoutForm"
                    style="width: 100%; padding: 1rem; border-radius: 1rem; background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; backdrop-filter: saturate(140%) blur(12px); -webkit-backdrop-filter: saturate(140%) blur(12px); color: white !important; font-size: 1.125rem; font-weight: 600; cursor: pointer !important; pointer-events: auto !important; position: relative; z-index: 10002 !important; transition: all 0.3s; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); opacity: 1 !important;"
                    onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 15px 40px rgba(0, 0, 0, 0.4)'; this.style.opacity='1';"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 10px 30px rgba(0, 0, 0, 0.3)'; this.style.opacity='1';"
                    onclick="console.log('=== NATIVE SUBMIT BUTTON CLICKED ==='); if (window.createConfetti) { window.createConfetti(); } return true;">
                    <span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i class="fas fa-lock"></i>
                        <span>Complete Checkout{% if total is not none and total > 0 %} — ${{ '%.2f'|format(total) }}{% else %} — ${{ '%.2f'|format(amount|float if amount else 0) }}{% endif %}</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Dim rest of page while checkout open
    // FORCE ENABLE THE BUTTON IMMEDIATELY - Run this ASAP
    (function forceEnableButton() {
        const btn = document.getElementById('newCheckoutBtn');
        if (btn) {
            console.log('=== FORCING BUTTON ENABLE (IMMEDIATE) ===');
            btn.disabled = false;
            btn.removeAttribute('disabled');
            btn.style.opacity = '1 !important';
            btn.style.cursor = 'pointer !important';
            btn.style.pointerEvents = 'auto !important';
            btn.style.color = 'white !important';
            btn.setAttribute('aria-disabled', 'false');
            console.log('Button disabled?', btn.disabled);
            console.log('Button is now enabled!');
        }
    })();
    
    document.addEventListener('DOMContentLoaded', () => {
        try { document.body.classList.add('checkout-mode'); } catch (_) { }
        
        // FORCE ENABLE THE BUTTON AGAIN - Remove any disabled state
        const btn = document.getElementById('newCheckoutBtn');
        if (btn) {
            console.log('=== FORCING BUTTON ENABLE (DOMContentLoaded) ===');
            btn.disabled = false;
            btn.removeAttribute('disabled');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.pointerEvents = 'auto';
            btn.style.color = 'white';
            btn.setAttribute('aria-disabled', 'false');
            console.log('Button disabled?', btn.disabled);
            console.log('Button style.opacity:', btn.style.opacity);
            console.log('Button computed opacity:', window.getComputedStyle(btn).opacity);
            console.log('Button is now enabled!');
        } else {
            console.error('Button not found!');
        }
    });
    window.addEventListener('beforeunload', () => {
        try { document.body.classList.remove('checkout-mode'); } catch (_) { }
    });

    // Direct form submission function - works independently
    // Make it globally accessible
    window.submitCheckoutForm = function submitCheckoutForm() {
        console.log('=== SUBMIT CHECKOUT FORM CALLED ===');
        
        // Create confetti immediately for visual feedback
        if (window.createConfetti) {
            window.createConfetti();
        }
        
        // Find form by ID first, then fallback to selector
        let form = document.getElementById('checkoutForm');
        if (!form) {
            form = document.querySelector('form[action="/checkout/process"]');
        }
        if (!form) {
            console.error('Form not found!');
            alert('Error: Form not found. Please refresh the page.');
            return;
        }
        
        console.log('Form found:', form);
        console.log('Form action:', form.action);
        console.log('Form method:', form.method);
        
        // Show loading state (don't disable - let form submit)
        const btn = document.getElementById('newCheckoutBtn');
        if (btn) {
            // Don't disable - just show loading state
            btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><i class="fas fa-spinner fa-spin"></i><span>Processing...</span></span>';
        }
        
        // Animate steps
        const steps = document.querySelectorAll('.checkout-steps .step');
        if (steps && steps.length === 3) {
            steps[0].classList.remove('active');
            steps[1].classList.add('active');
        }
        
        // Submit the form - ensure CSRF token is included
        try {
            console.log('Submitting form...');
            
            // Verify CSRF token exists in form
            const csrfInput = form.querySelector('input[name="csrf_token"]');
            if (csrfInput) {
                const tokenValue = csrfInput.value;
                console.log('CSRF token found:', tokenValue ? `Yes (length: ${tokenValue.length}, first 10 chars: ${tokenValue.substring(0, 10)}...)` : 'No (empty)');
                if (!tokenValue) {
                    console.error('CSRF token is empty!');
                    alert('Error: CSRF token is missing. Please refresh the page and try again.');
                    return;
                }
            } else {
                console.error('CSRF token input not found in form!');
                alert('Error: CSRF token input not found. Please refresh the page and try again.');
                return;
            }
            
            // Log all form fields to verify they're present
            const formData = new FormData(form);
            console.log('Form fields being submitted:');
            for (let [key, value] of formData.entries()) {
                if (key === 'csrf_token') {
                    console.log(`  ${key}: ${value ? `Present (length: ${value.length})` : 'Missing'}`);
                } else {
                    console.log(`  ${key}: ${value}`);
                }
            }
            
            // Use the most reliable method: create a real submit button and click it
            // This ensures all form fields (including CSRF token) are included
            console.log('Creating submit button and submitting form...');
            const submitBtn = document.createElement('button');
            submitBtn.type = 'submit';
            submitBtn.style.position = 'absolute';
            submitBtn.style.left = '-9999px';
            submitBtn.style.opacity = '0';
            submitBtn.style.pointerEvents = 'none';
            form.appendChild(submitBtn);
            
            // Submit immediately
            submitBtn.click();
            
        } catch (e) {
            console.error('Error submitting form:', e);
            // Fallback: submit via fetch with proper CSRF token
            submitFormViaFetch(form);
        }
        
        // Fallback function to submit form via fetch (ensures CSRF token is included)
        function submitFormViaFetch(formElement) {
            console.log('Using fetch to submit form...');
            const formData = new FormData(formElement);
            
            // Verify CSRF token is in FormData
            const csrfToken = formData.get('csrf_token');
            console.log('CSRF token in FormData:', csrfToken ? 'Yes' : 'No');
            
            if (!csrfToken) {
                console.error('CSRF token missing from FormData!');
                alert('Error: CSRF token missing. Please refresh the page and try again.');
                return;
            }
            
            fetch(formElement.action, {
                method: formElement.method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin' // Important for cookies/session
            }).then(response => {
                console.log('Form submitted via fetch, status:', response.status);
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (response.ok) {
                    return response.text().then(html => {
                        // If response is HTML, replace the page
                        if (html.trim().startsWith('<!')) {
                            document.open();
                            document.write(html);
                            document.close();
                        } else {
                            // If it's JSON (error), handle it
                            try {
                                const json = JSON.parse(html);
                                if (json.error) {
                                    alert('Error: ' + json.reason || json.error);
                                }
                            } catch (e) {
                                // Not JSON, treat as HTML
                                document.open();
                                document.write(html);
                                document.close();
                            }
                        }
                    });
                } else {
                    return response.json().then(json => {
                        console.error('Form submission error:', json);
                        alert('Error: ' + (json.reason || json.error || 'Unknown error'));
                    });
                }
            }).catch(err => {
                console.error('Fetch submission failed:', err);
                alert('Error submitting checkout. Please try again.');
            });
        }
    };
    
    // Confetti function for visual feedback - make globally accessible
    window.createConfetti = function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.borderRadius = '50%';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '99999';
                confetti.style.boxShadow = '0 0 6px ' + confetti.style.backgroundColor;
                
                document.body.appendChild(confetti);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 2 + Math.random() * 3;
                const rotation = Math.random() * 360;
                const rotationSpeed = (Math.random() - 0.5) * 10;
                
                let x = parseFloat(confetti.style.left);
                let y = -10;
                let currentRotation = rotation;
                
                const animate = () => {
                    x += Math.cos(angle) * velocity;
                    y += Math.sin(angle) * velocity + 0.5; // gravity
                    currentRotation += rotationSpeed;
                    
                    confetti.style.left = x + '%';
                    confetti.style.top = y + 'px';
                    confetti.style.transform = `rotate(${currentRotation}deg)`;
                    
                    if (y < window.innerHeight + 50) {
                        requestAnimationFrame(animate);
                    } else {
                        confetti.remove();
                    }
                };
                
                animate();
            }, i * 10);
        }
    }
</script>
{% endblock %}