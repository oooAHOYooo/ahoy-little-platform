{% extends "base.html" %}
{% block title %}Checkout - Ahoy Indie Media{% endblock %}
{% block content %}
<div id="checkoutContainer"
    class="checkout-overlay fixed inset-0 z-[9998] flex items-center justify-center p-6 backdrop-blur-xl bg-black/60"
    style="pointer-events: auto;">

    <div
        class="checkout-card w-full max-w-xl bg-black/50 rounded-2xl border border-white/10 shadow-2xl p-8 text-white relative"
        style="pointer-events: auto; z-index: 9999; position: relative;">

        <div class="checkout-steps flex items-center justify-center gap-3 mb-6">
            <div class="step active px-4 py-2 rounded-full bg-white/20 text-white text-sm">Review</div>
            <div class="step px-4 py-2 rounded-full bg-white/10 text-white/60 text-sm">Pay</div>
            <div class="step px-4 py-2 rounded-full bg-white/10 text-white/60 text-sm">Complete</div>
        </div>

        <div class="checkout-panel">
            <h1 class="text-2xl font-bold mb-4">Checkout</h1>

            {% if error %}
            <div class="bg-red-500/10 border border-red-500/30 text-red-200 px-4 py-3 rounded-lg mb-4">{{
                error }}</div>
            {% endif %}

            <div class="grid grid-cols-1 gap-4">
                {% if kind == 'boost' %}
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <p class="text-white/60 text-sm">Boost for Artist</p>
                    <p class="text-lg font-semibold">{{ artist_id or
                        'Unknown Artist' }}</p>
                </div>

                <div class="breakdown bg-black/30 border border-white/10 rounded-xl p-4 mt-2 mb-2">
                    <h3 class="font-semibold text-lg mb-3">Breakdown</h3>
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Boost Amount</span>
                        <span id="boostAmount">${{ '%.2f'|format(amount|float if amount else 0) }}</span>
                    </div>
                    {% if stripe_fee is not none %}
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Stripe Fee</span>
                        <span id="stripeFee">${{ '%.2f'|format(stripe_fee)
                            }}</span>
                    </div>
                    {% endif %}
                    {% if platform_fee is not none %}
                    <div class="flex justify-between py-1">
                        <span class="text-white/80">Ahoy Fee</span>
                        <span id="ahoyFee">${{ '%.2f'|format(platform_fee)
                            }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between pt-3 mt-2 border-t border-white/10">
                        <span class="font-semibold">Total</span>
                        <span id="checkoutTotal" class="font-semibold">${{
                            '%.2f'|format(total if total is not none else 0) }}</span>
                    </div>
                </div>
                {% else %}
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <p class="text-white/60 text-sm">Item</p>
                    <p class="text-lg font-semibold">{{ title or 'Item' }}</p>
                    <div class="flex justify-between text-sm mt-2">
                        <span class="text-white/70">Qty</span>
                        <span class="text-white font-medium">{{ qty or 1
                            }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-white/70">Amount</span>
                        <span class="text-white font-medium">${{
                            '%.2f'|format(amount|float if amount else 0) }}</span>
                    </div>
                    <div class="flex justify-between pt-3 mt-2 border-t border-white/10">
                        <span class="font-semibold">Total</span>
                        <span class="font-semibold">${{
                            '%.2f'|format(total if total is not none else (amount|float if amount else 0)) }}</span>
                    </div>
                </div>
                {% endif %}
            </div>

            <form method="POST" action="/checkout/process" class="space-y-3" style="pointer-events: auto; position: relative; z-index: 10000;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="type" value="{{ kind }}">
                <input type="hidden" name="artist_id" value="{{ artist_id }}">
                <input type="hidden" name="amount" value="{{ amount }}">
                <input type="hidden" name="item_id" value="{{ item_id }}">
                <input type="hidden" name="qty" value="{{ qty }}">
                <input type="hidden" name="computed_total" value="{{ total if total is not none else amount }}">

                <button type="submit"
                    class="complete-checkout w-full py-4 mt-6 rounded-2xl text-white text-lg font-semibold transition-all duration-300 shadow-xl hover:shadow-2xl hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                    style="background: linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: saturate(140%) blur(12px); -webkit-backdrop-filter: saturate(140%) blur(12px); pointer-events: auto !important; cursor: pointer !important; position: relative; z-index: 10001;"
                    id="completeCheckoutBtn"
                    onclick="console.log('Button clicked - submitting form'); return true;"
                    {% if total is none or total <= 0 %}disabled{% endif %}>
                    <span class="flex items-center justify-center gap-2">
                        <i class="fas fa-lock"></i>
                        <span>Complete Checkout{% if total is not none and total > 0 %} â€” ${{ '%.2f'|format(total) }}{% endif %}</span>
                    </span>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Dim rest of page while checkout open
    document.addEventListener('DOMContentLoaded', () => {
        try { document.body.classList.add('checkout-mode'); } catch (_) { }
    });
    window.addEventListener('beforeunload', () => {
        try { document.body.classList.remove('checkout-mode'); } catch (_) { }
    });

    // Steps animation and form submission
    // Note: Form will work without JavaScript since it's a standard HTML form
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const form = document.querySelector('form[action="/checkout/process"]');
            const steps = document.querySelectorAll('.checkout-steps .step');
            const completeBtn = document.getElementById('completeCheckoutBtn');
            
            if (!form) {
                console.error('Checkout form not found');
                return;
            }
            
            if (!completeBtn) {
                console.error('Checkout button not found');
                return;
            }
            
            // Verify button is accessible
            console.log('=== CHECKOUT BUTTON DEBUG ===');
            console.log('Checkout button found:', completeBtn);
            console.log('Button disabled?', completeBtn.disabled);
            console.log('Button type:', completeBtn.type);
            console.log('Button form:', completeBtn.form);
            console.log('Button computed pointer-events:', window.getComputedStyle(completeBtn).pointerEvents);
            console.log('Button computed z-index:', window.getComputedStyle(completeBtn).zIndex);
            console.log('Button computed cursor:', window.getComputedStyle(completeBtn).cursor);
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            console.log('===========================');
            
            // Force button to be clickable
            completeBtn.style.pointerEvents = 'auto';
            completeBtn.style.cursor = 'pointer';
            completeBtn.style.zIndex = '10001';
            completeBtn.style.position = 'relative';
            
            // Test click handler
            completeBtn.addEventListener('click', function(e) {
                console.log('=== BUTTON CLICKED ===');
                console.log('Event:', e);
                console.log('Button element:', this);
                console.log('Form element:', this.form);
                console.log('Will submit form:', !e.defaultPrevented);
            }, true); // Use capture phase to catch early
            
            // Handle form submission (enhancement only - form works without this)
            form.addEventListener('submit', function(e) {
                try {
                    console.log('Checkout form submitting to:', form.action);
                    
                    // Animate steps
                    if (steps && steps.length === 3) {
                        steps[0].classList.remove('active');
                        steps[1].classList.add('active'); // Pay
                    }
                    
                    // Show loading state
                    completeBtn.disabled = true;
                    completeBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><i class="fas fa-spinner fa-spin"></i><span>Processing...</span></span>';
                    
                    // Let form submit naturally - don't prevent default
                } catch (err) {
                    console.warn('Error in form submit handler:', err);
                    // Form will still submit naturally
                }
            });
            
            // Handle button click for visual feedback (before form submits)
            completeBtn.addEventListener('click', function(e) {
                try {
                    console.log('Checkout button clicked');
                    
                    // Animate steps immediately for visual feedback
                    if (steps && steps.length === 3) {
                        steps[0].classList.remove('active');
                        steps[1].classList.add('active'); // Pay
                    }
                    
                    // Don't prevent default - let form submit naturally
                } catch (err) {
                    console.warn('Error in button click handler:', err);
                    // Form will still submit naturally
                }
            });
        } catch (err) {
            console.error('Error setting up checkout form:', err);
            // Form will still work without JavaScript
        }
    });
</script>
{% endblock %}