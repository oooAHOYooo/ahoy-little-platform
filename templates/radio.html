{% extends "base.html" %}

{% block title %}Ahoy Radio (Experimental){% endblock %}

{% block content %}
<div class="radio-page" x-data="radioPage()" x-init="init()">
    <section class="radio-hero">
        <div class="hero-content" style="text-align: center; margin: 2rem 0;">
            <h1 style="font-size: 4rem; color: #ff0066;"><i class="fas fa-broadcast-tower"
                    style="font-size: 3.5rem; margin-right: 8px;"></i> Ahoy
                Radio</h1>
            <p style="color: #ccc; font-size: 1.5rem;">Tune in for a continuous
                mix from your indie library.</p>
            <div class="radio-controls"
                style="display: flex; justify-content: space-around; align-items: center; margin-top: 2rem;">
                <button class="btn btn-primary" @click="toggle()"
                    style="background-color: #00b894; border: none; padding: 1rem 2rem; color: white; font-size: 1.5rem; flex-grow: 1; margin: 0 10px; border-radius: 12px;">
                    <span x-show="!isPlaying"><i class="fas fa-play"></i>
                        Play</span>
                    <span x-show="isPlaying"><i class="fas fa-pause"></i>
                        Pause</span>
                </button>
                <button class="btn" @click="skip()"
                    style="background-color: #0984e3; border: none; padding: 1rem 2rem; color: white; font-size: 1.5rem; flex-grow: 1; margin: 0 10px; border-radius: 12px;">
                    <i class="fas fa-forward"></i> Skip
                </button>
                <!-- Removed shuffle and experimental badge -->
            </div>
        </div>
    </section>

    <section class="radio-now">
        <div class="now-card" x-show="current">
            <img :src="current.cover_art || '/static/img/default-cover.jpg'" alt="cover" class="now-cover">
            <div class="now-info">
                <h3 x-text="current.title"></h3>
                <p x-text="current.artist"></p>
                <p class="artist-description" style="font-size: 0.85rem; color: #999; margin-top: 8px;"
                    x-text="current.artist_description || 'An amazing indie artist creating outstanding music.'"></p>
                <button @click="boostArtist(current)"
                    style="background-color: #e17055; border: none; padding: 0.5rem 1rem; color: white; font-size: 1rem; border-radius: 5px; margin-top: 10px;">Boost
                    the Artist</button>
            </div>
        </div>
    </section>

    <section class="radio-upnext">
        <h3>Up Next</h3>
        <div class="playing-list">
            <template x-for="item in upNext.slice(0, 8)" :key="item.id">
                <div class="playing-item"
                    :style="`background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url(${item.cover_art || '/static/img/default-cover.jpg'}); background-size: cover; background-position: center;`"
                    @click="playNow(item)">
                    <div class="item-details">
                        <h4 x-text="item.title"></h4>
                        <p x-text="item.artist"></p>
                    </div>
                    <div class="play-indicator"><i class="fas fa-play"></i></div>
                </div>
            </template>
        </div>
    </section>
</div>

<script>
    function radioPage() {
        return {
            isPlaying: false,
            shuffle: true,
            tracks: [],
            queue: [],
            current: null,
            upNext: [],
            async init() {
                try {
                    const r = await fetch('/api/music');
                    if (!r.ok) {
                        console.error('Radio API error:', r.status, r.statusText);
                        return;
                    }
                    const data = await r.json();
                    if (!data || !Array.isArray(data.tracks)) {
                        console.error('Invalid radio data format');
                        return;
                    }
                    const tracks = (data.tracks || []).filter(t => t.audio_url || t.preview_url);
                    // Deduplicate by id
                    const seen = new Set();
                    this.tracks = tracks.filter(t => { if (seen.has(t.id)) return false; seen.add(t.id); return true; });
                    this._buildQueue();
                } catch (e) {
                    console.error('radio load failed', e);
                    // Show user-friendly error message
                    if (window.ahoyApp?.showNotification) {
                        window.ahoyApp.showNotification('Failed to load radio. Please try again.', 'error');
                    }
                }
            },
            _buildQueue() {
                const list = [...this.tracks];
                if (this.shuffle) list.sort(() => 0.5 - Math.random());
                this.queue = list.map(t => ({ ...t, type: 'track' }));
                this.upNext = this.queue.slice(0, 20);
            },
            toggle() {
                if (!window.mediaPlayer) { console.error('Media player not available'); return; }
                if (this.isPlaying) { window.mediaPlayer.pause(); this.isPlaying = false; return; }
                if (!this.current) { this._playNext(); return; }
                window.mediaPlayer.resume(); this.isPlaying = true;
            },
            skip() { this._playNext(); },
            playNow(item) {
                if (!window.mediaPlayer) { console.error('Media player not available'); return; }
                this.current = item;
                window.mediaPlayer.play(item);
                this.isPlaying = true;
            },
            _playNext() {
                if (!window.mediaPlayer) { console.error('Media player not available'); return; }
                if (this.queue.length === 0) this._buildQueue();
                const next = this.queue.shift();
                if (next) { this.current = next; window.mediaPlayer.play(next); this.isPlaying = true; }
                this.upNext = this.queue.slice(0, 20);
            },
            boostArtist(item) {
                console.log(`Boosting artist: ${item.artist}`);
                // Implement boosting functionality here
                // Example: launch a modal or redirect to a payment page
            }
        }
    }
</script>
<!-- Visualizer Overlay Container -->
<div id="visualizerOverlay"
    class="viz-overlay hidden fixed inset-0 bg-black/85 backdrop-blur-2xl flex items-center justify-center z-[9999]">
    <div id="visualizerCanvasContainer"
        class="w-[92%] h-[70%] bg-black/40 rounded-2xl border border-white/10 shadow-2xl relative overflow-hidden">
        <!-- visualizer canvas gets appended here -->
    </div>
    <button id="closeVisualizer"
        class="absolute top-6 right-6 px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white hover:bg-white/20 backdrop-blur-md">
        ✕ Close
    </button>
</div>

<script>
    // Fullscreen Visualizer → Overlay
    document.addEventListener('DOMContentLoaded', () => {
        const vizOverlay = document.getElementById('visualizerOverlay');
        const vizBtn = document.querySelector('button[title="Fullscreen Visualizer"]');
        const closeViz = document.getElementById('closeVisualizer');
        const canvasContainer = document.getElementById('visualizerCanvasContainer');
        const originalContainer = document.getElementById('now-playing-visualizer');
        let moved = false;

        function openViz() {
            if (vizOverlay && canvasContainer && originalContainer) {
                // Move any existing visualizer children into overlay
                while (originalContainer.firstChild) {
                    canvasContainer.appendChild(originalContainer.firstChild);
                    moved = true;
                }
                vizOverlay.classList.remove('hidden');
                vizOverlay.classList.add('flex');
            }
        }
        function closeVizOverlay() {
            if (vizOverlay) {
                vizOverlay.classList.add('hidden');
                vizOverlay.classList.remove('flex');
            }
            // Move back canvas
            if (moved && canvasContainer && originalContainer) {
                while (canvasContainer.firstChild) {
                    originalContainer.appendChild(canvasContainer.firstChild);
                }
                moved = false;
            }
        }

        if (vizBtn) vizBtn.addEventListener('click', openViz);
        if (closeViz) closeViz.addEventListener('click', closeVizOverlay);
    });

    // Account Dropdown (Mobile) safeguard wrapper
    document.addEventListener('DOMContentLoaded', () => {
        const accountBtn = document.querySelector('button[title="User & Bookmarks Menu"]');
        const accountMenu = document.querySelector('.mobile-right-dropdown');
        if (accountBtn && accountMenu) {
            accountMenu.classList.add('hidden');
            accountBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                accountMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', () => accountMenu.classList.add('hidden'));
        }
    });
</script>
{% endblock %}