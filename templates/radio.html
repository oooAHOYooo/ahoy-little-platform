{% extends "base.html" %}

{% block title %}Ahoy Radio{% endblock %}

{% block content %}
<div class="radio-page" x-data="radioPage()" x-init="init()">
    <style>
        /* Monochrome, background-bleed styling */
        .radio-page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 2rem 3rem;
            background: transparent;
        }
        .neumo {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            backdrop-filter: blur(2px);
        }
        .neumo-inset {
            background: rgba(255,255,255,0.03);
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .lcd {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-height: 54px;
            padding: .75rem 1rem;
            color: rgba(255,255,255,.9);
            letter-spacing: .04em;
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.1));
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.12);
        }
        .radio-controls .btn {
            background: rgba(255,255,255,0.08);
            color: #eee;
            border: 0;
            border-radius: 12px;
            padding: 1rem 2rem;
            border: 1px solid rgba(255,255,255,0.12);
            transition: transform .05s ease, box-shadow .15s ease;
        }
        .radio-controls .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .now-card {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            align-items: center; /* Vertically center content */
        }
        .now-cover {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border-radius: 14px;
            box-shadow: none;
            border: 1px solid rgba(255,255,255,0.08);
            margin: 0 auto; /* Center image in its cell if resized */
        }
        .now-info {
            text-align: left; /* Keep left alignment on desktop */
        }
        /* ... */
        @media (max-width: 720px) {
            .now-card { 
                grid-template-columns: 1fr; 
                text-align: center; /* Center text on mobile */
            }
            .now-info {
                text-align: center; /* Center text on mobile */
            }
            .playing-list { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        /* Ensure global centering as requested */
        .radio-section-title { text-align: center; }
        .playing-item .item-details { text-align: center; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .now-info { text-align: center !important; }
    </style>
    <section class="radio-hero">
        <div class="hero-content" style="text-align: center; margin: 2rem 0;">
            <h1 style="font-size: 3rem">
                Radio</h1>
            <div class="lcd" style="margin: 1rem auto; max-width: 680px;">
                <span style="opacity:.75;">ARTIST:</span>
                <span x-text="current?.artist || '—'"></span>
                <span style="opacity:.5;">·</span>
                <span style="opacity:.75;">TRACK:</span>
                <span x-text="current?.title || '—'"></span>
            </div>

            <div class="radio-controls"
                style="display: flex; justify-content: center; align-items: center; margin-top: 1.25rem; gap: 40px;">
                <!-- Play/Pause Dial -->
                <div
                    style="display: flex; flex-direction: column; align-items: center;">
                    <button class="dial-btn" @click="toggle()">
                        <span x-show="!isPlaying">
                            <i class="fas fa-play"
                                style="font-size: 2rem; color: rgba(255,255,255,.9); margin-left: 2px;"></i>
                        </span>
                        <span x-show="isPlaying">
                            <i class="fas fa-pause"
                                style="font-size: 2rem; color: rgba(255,255,255,.9);"></i>
                        </span>
                    </button>
                    <span class="dial-caption">Play/Pause</span>
                </div>

            </div>
        </div>
    </section>

    <section class="radio-now">
        <div class="now-card neumo" x-show="current">
            <img :src="current.cover_art || '/static/img/default-cover.jpg'"
                alt="cover" class="now-cover">
            <div class="now-info">
                <h3 x-text="current.title"></h3>
                <p x-text="current.artist"></p>

                <div style="width:100%;display:flex;justify-content:center;">
                    <button
                        @click="boostArtist(current)"
                        style="
                          background: linear-gradient(110deg, rgba(34,139,230,0.16) 0%, rgba(255,255,255,0.11) 100%);
                          backdrop-filter: blur(12px) saturate(180%);
                          box-shadow:
                              0 2px 18px 0 rgba(34,139,230, 0.10),
                              0 1px 6px 0 rgba(35, 115, 247, 0.05) inset;
                          border: 1.4px solid rgba(34,139,230,0.19);
                          color: #1c4370;
                          font-family: 'Inter', 'DM Sans', 'Segoe UI', sans-serif;
                          font-size: 1.07rem;
                          letter-spacing: 0.01em;
                          padding: 0.44rem 1.17rem 0.44rem 1.02rem;
                          border-radius: 1.15rem;
                          font-weight: 500;
                          opacity: 0.95;
                          transition:
                              background 0.19s,
                              box-shadow 0.13s,
                              border 0.13s;
                          z-index: 11;
                          cursor: pointer;
                          display: flex;
                          align-items: center;
                          gap: 0.7em;
                          margin-top: 8px;
                      "
                        @mouseover="
                          $el.style.background='linear-gradient(110deg, rgba(34,139,230,0.23) 0%, rgba(248,251,255,0.16) 100%)';
                          $el.style.boxShadow='0 8px 36px 0 rgba(34,139,230, 0.16), 0 2px 10px 0 rgba(35, 115, 247, 0.13) inset';
                          $el.style.borderColor='rgba(34,139,230,0.25)';
                          "
                        @mouseleave="
                          $el.style.background='linear-gradient(110deg, rgba(34,139,230,0.16) 0%, rgba(255,255,255,0.11) 100%)';
                          $el.style.boxShadow='0 2px 18px 0 rgba(34,139,230, 0.10), 0 1px 6px 0 rgba(35, 115, 247, 0.05) inset';
                          $el.style.borderColor='rgba(34,139,230,0.19)';
                          ">

                        <span>Boost</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="radio-justplayed">
        <h3 class="radio-section-title">Previously Played</h3>
        <div class="playing-list">
            <template x-for="item in justPlayed.slice(0, 8)" :key="item.id">
                <div class="playing-item"
                    :style="`background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url(${item.cover_art || '/static/img/default-cover.jpg'}); background-size: cover; background-position: center;`"
                    @click="playNow(item)">
                    <div class="item-details">
                        <h4 x-text="item.title"></h4>
                        <p x-text="item.artist"></p>
                    </div>
                    <div class="play-indicator"><i
                            class="fas fa-play"></i></div>
                </div>
            </template>
        </div>
    </section>
</div>

<script>
    function radioPage() {
        return {
            isPlaying: false,
            current: null,
            upNext: [],
            justPlayed: [],
            serverState: null,
            
            async init() {
                await this.fetchState();
                
                const setupListener = () => {
                    if (window.mediaPlayer) {
                        window.mediaPlayer.on('play', () => this.isPlaying = true);
                        window.mediaPlayer.on('pause', () => this.isPlaying = false);
                        // Optional: refetch state when track ends to ensure sync
                        window.mediaPlayer.on('ended', () => { 
                            // this.fetchState(); 
                        });
                    }
                };

                if (window.mediaPlayer) {
                    setupListener();
                } else {
                    // Fallback if player.js hasn't run yet
                    window.addEventListener('load', setupListener);
                }
            },

            async fetchState() {
                try {
                    const r = await fetch('/api/radio/now');
                    if (r.ok) {
                        this.serverState = await r.json();
                        this.current = this.serverState.track;
                        this.upNext = this.serverState.next_tracks || [];
                    }
                } catch (e) {
                    console.error('Radio sync error:', e);
                }
            },

            async toggle() {
                if (!window.mediaPlayer) return;

                if (this.isPlaying) {
                    window.mediaPlayer.pause();
                    return; // State updates via event listener
                }

                // Starting playback
                await this.fetchState();
                if (!this.current) return;

                // Setup global player with radio queue
                const queue = [this.current, ...this.upNext];
                
                // We want to replace the current playlist with our radio queue
                if (window.mediaPlayer.setPlaylist) {
                    window.mediaPlayer.setPlaylist(queue);
                }

                // Play the current track
                await window.mediaPlayer.play(this.current);

                // Seek to the server-dictated offset
                // We add a small buffer (e.g. 0.5s) to account for network latency
                const offset = (this.serverState.offset_seconds || 0);
                if (offset > 0) {
                    // Try seeking immediately (might fail if metadata not loaded)
                    window.mediaPlayer.seekTo(offset);
                    
                    // Also try again after a short delay just in case
                    setTimeout(() => {
                        // Only seek if we are still near the start (don't jump back if user seeked)
                        if (window.mediaPlayer.currentTime < 1) {
                            window.mediaPlayer.seekTo(offset);
                        }
                    }, 500);
                }
                
                this.isPlaying = true;
            },

            boostArtist(item) {
                if (window.ahoyApp && window.ahoyApp.boostArtist) {
                    window.ahoyApp.boostArtist(item);
                } else {
                    console.log(`Boosting artist: ${item.artist}`);
                    window.location.href = `/checkout?type=boost&artist_id=${encodeURIComponent(item.id || item.artist)}&amount=1.00`;
                }
            },
            
            // "Play Now" on a previously played item just plays it normally (not synced)
            playNow(item) {
                if (window.mediaPlayer) {
                    window.mediaPlayer.play(item);
                }
            }
        }
    }
</script>
<!-- Visualizer Overlay Container -->
<div id="visualizerOverlay"
    class="viz-overlay hidden fixed inset-0 bg-black/85 backdrop-blur-2xl flex items-center justify-center z-[9999]">
    <div id="visualizerCanvasContainer"
        class="w-[92%] h-[70%] bg-black/40 rounded-2xl border border-white/10 shadow-2xl relative overflow-hidden">
        <!-- visualizer canvas gets appended here -->
    </div>
    <button id="closeVisualizer"
        class="absolute top-6 right-6 px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white hover:bg-white/20 backdrop-blur-md">
        ✕ Close
    </button>
</div>

<script>
    // Fullscreen Visualizer → Overlay
    document.addEventListener('DOMContentLoaded', () => {
        const vizOverlay = document.getElementById('visualizerOverlay');
        const vizBtn = document.querySelector('button[title="Fullscreen Visualizer"]');
        const closeViz = document.getElementById('closeVisualizer');
        const canvasContainer = document.getElementById('visualizerCanvasContainer');
        const originalContainer = document.getElementById('now-playing-visualizer');
        let moved = false;

        function openViz() {
            if (vizOverlay && canvasContainer && originalContainer) {
                // Move any existing visualizer children into overlay
                while (originalContainer.firstChild) {
                    canvasContainer.appendChild(originalContainer.firstChild);
                    moved = true;
                }
                vizOverlay.classList.remove('hidden');
                vizOverlay.classList.add('flex');
            }
        }
        function closeVizOverlay() {
            if (vizOverlay) {
                vizOverlay.classList.add('hidden');
                vizOverlay.classList.remove('flex');
            }
            // Move back canvas
            if (moved && canvasContainer && originalContainer) {
                while (canvasContainer.firstChild) {
                    originalContainer.appendChild(canvasContainer.firstChild);
                }
                moved = false;
            }
        }

        if (vizBtn) vizBtn.addEventListener('click', openViz);
        if (closeViz) closeViz.addEventListener('click', closeVizOverlay);
    });

    // Account Dropdown (Mobile) safeguard wrapper
    document.addEventListener('DOMContentLoaded', () => {
        const accountBtn = document.querySelector('button[title="User & Bookmarks Menu"]');
        const accountMenu = document.querySelector('.mobile-right-dropdown');
        if (accountBtn && accountMenu) {
            accountMenu.classList.add('hidden');
            accountBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                accountMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', () => accountMenu.classList.add('hidden'));
        }
    });
</script>
{% endblock %}