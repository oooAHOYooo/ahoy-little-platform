{% extends "base.html" %}

{% block title %}Ahoy Radio{% endblock %}

{% block content %}
<div class="radio-page radio-page--v2" x-data="radioPage()" x-init="init()">
    <style>
        /* Radio page v2 – styled to match provided mock */
        .radio-page--v2 {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem 1.25rem 3rem;
            background: transparent;
        }

        /* Mobile.css sets all buttons to width:100%; override for this page */
        .radio-page--v2 button {
            width: auto !important;
            min-height: unset;
        }

        .radio-hero {
            border-radius: 26px;
            overflow: hidden;
            position: relative;
            background: radial-gradient(1200px 420px at 35% 0%, rgba(140, 56, 255, 0.55) 0%, rgba(0, 0, 0, 0) 60%),
                        radial-gradient(900px 420px at 85% 30%, rgba(54, 107, 255, 0.30) 0%, rgba(0, 0, 0, 0) 60%),
                        linear-gradient(135deg, rgba(36, 13, 66, 0.90) 0%, rgba(10, 13, 28, 0.92) 55%, rgba(6, 7, 14, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.10);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.12);
        }

        .radio-hero-inner {
            padding: 28px 28px 26px;
        }

        .radio-hero-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 28px;
            align-items: center;
        }

        .radio-hero-art {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 22px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 14px 34px rgba(0, 0, 0, 0.45);
        }

        .radio-hero-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .radio-live {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(255, 92, 92, 0.95);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .radio-live-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: rgba(255, 92, 92, 0.95);
            box-shadow: 0 0 18px rgba(255, 92, 92, 0.45);
        }

        .radio-hero-title {
            margin: 0;
            font-size: clamp(2.4rem, 4.8vw, 4.2rem);
            line-height: 1.02;
            letter-spacing: -0.02em;
            color: #ffffff;
            font-weight: 900;
        }

        .radio-hero-subtitle {
            margin: 12px 0 0;
            max-width: 58ch;
            color: rgba(255, 255, 255, 0.78);
            font-size: 1.12rem;
            line-height: 1.45;
        }

        .radio-hero-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-top: 14px;
            color: rgba(255, 255, 255, 0.72);
            font-size: 0.98rem;
        }

        .radio-hero-meta .meta-item {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .radio-hero-meta .meta-item i {
            opacity: 0.75;
        }

        .radio-hero-actions {
            display: flex;
            gap: 14px;
            align-items: center;
            margin-top: 20px;
        }

        .radio-cta {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            border-radius: 999px;
            padding: 12px 18px;
            font-weight: 800;
            letter-spacing: 0.01em;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.92);
            color: rgba(10, 10, 10, 0.95);
            box-shadow: 0 18px 38px rgba(0, 0, 0, 0.35);
            cursor: pointer;
        }

        .radio-cta:active {
            transform: translateY(1px);
        }

        .radio-icon-btn {
            width: 48px !important;
            height: 48px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.22);
            color: rgba(255, 255, 255, 0.92);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .radio-icon-btn:hover {
            background: rgba(255, 255, 255, 0.10);
        }

        /* Currently Playing */
        .radio-section-title {
            margin: 26px 0 12px;
            font-size: 1.65rem;
            letter-spacing: -0.01em;
            color: rgba(255, 255, 255, 0.92);
            font-weight: 900;
        }

        .radio-track-card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 22px;
            overflow: hidden;
            box-shadow: 0 18px 44px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.10);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .radio-track-main {
            display: grid;
            grid-template-columns: 86px 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 16px 18px 10px;
        }

        .radio-track-cover {
            width: 74px;
            height: 74px;
            border-radius: 16px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(0, 0, 0, 0.25);
        }

        .radio-track-title {
            margin: 0;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.96);
            letter-spacing: -0.01em;
            font-size: 1.55rem;
            line-height: 1.1;
        }

        .radio-track-artist {
            margin: 6px 0 0;
            color: rgba(255, 255, 255, 0.68);
            font-weight: 700;
            font-size: 1.05rem;
        }

        .radio-track-meta {
            margin: 8px 0 0;
            color: rgba(255, 255, 255, 0.46);
            font-size: 0.95rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .radio-track-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .radio-track-actions .radio-icon-btn {
            width: 44px !important;
            height: 44px;
            background: rgba(255, 255, 255, 0.06);
        }

        .radio-progress-wrap {
            padding: 10px 18px 16px;
        }

        .radio-progress-times {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.55);
            font-size: 0.92rem;
            margin-bottom: 10px;
        }

        .radio-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.10);
            border-radius: 999px;
            overflow: hidden;
        }

        .radio-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(82, 136, 255, 0.85) 0%, rgba(82, 136, 255, 0.85) 60%, rgba(82, 136, 255, 0.55) 100%);
            border-radius: 999px;
            transition: width 0.12s linear;
        }

        /* Previously Played (keep existing data, restyle to fit) */
        .playing-list {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 14px;
        }

        .playing-item {
            position: relative;
            border-radius: 18px;
            min-height: 130px;
            overflow: hidden;
            color: #fff;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(255, 255, 255, 0.04);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.28);
        }

        .playing-item .item-details {
            position: absolute;
            left: 14px;
            right: 14px;
            bottom: 12px;
        }

        .playing-item h4 {
            margin: 0;
            font-weight: 900;
            font-size: 1.05rem;
            line-height: 1.1;
        }

        .playing-item p {
            margin: 6px 0 0;
            color: rgba(255, 255, 255, 0.76);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .play-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.35);
        }

        @media (max-width: 980px) {
            .radio-hero-grid { grid-template-columns: 220px 1fr; }
        }

        @media (max-width: 820px) {
            .radio-page--v2 { padding: 1rem 1rem 2.5rem; }
            .radio-hero-inner { padding: 18px 16px 18px; }
            .radio-hero-grid { grid-template-columns: 1fr; }
            .radio-hero-art { max-width: 320px; }
            .radio-hero-actions { flex-wrap: wrap; }
            .radio-cta { width: 100% !important; justify-content: center; }
            .playing-list { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .radio-track-main { grid-template-columns: 76px 1fr; }
            .radio-track-actions { grid-column: 1 / -1; justify-content: flex-end; }
        }
    </style>
    <section class="radio-hero">
        <div class="radio-hero-inner">
            <div class="radio-hero-grid">
                <div class="radio-hero-art">
                    <img :src="current?.cover_art || '/static/img/default-cover.jpg'" alt="Station artwork">
                </div>

                <div class="radio-hero-copy">
                    <div class="radio-live">
                        <span class="radio-live-dot"></span>
                        <span>Live Now</span>
                    </div>

                    <h1 class="radio-hero-title" x-text="stationName"></h1>
                    <p class="radio-hero-subtitle" x-text="stationTagline"></p>

                    <div class="radio-hero-meta">
                        <span class="meta-item">
                            <i class="fas fa-microphone"></i>
                            <span x-text="djName"></span>
                        </span>
                    </div>

                    <div class="radio-hero-actions">
                        <button class="radio-cta" @click="toggle()">
                            <i class="fas" :class="isPlaying ? 'fa-pause' : 'fa-play'"></i>
                            <span x-text="isPlaying ? 'Pause' : 'Listen Now'"></span>
                        </button>
                        <button class="radio-icon-btn" title="Favorite" @click="toggleFavoriteCurrent()">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="radio-icon-btn" title="Share" @click="shareCurrent()">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="radio-now" x-show="current">
        <h2 class="radio-section-title">Currently Playing</h2>
        <div class="radio-track-card">
            <div class="radio-track-main">
                <img class="radio-track-cover" :src="current?.cover_art || '/static/img/default-cover.jpg'" alt="cover">
                <div class="radio-track-info">
                    <h3 class="radio-track-title" x-text="current?.title || '—'"></h3>
                    <div class="radio-track-artist" x-text="current?.artist || '—'"></div>
                    <div class="radio-track-meta">
                        <template x-if="current?.album"><span x-text="`Album: ${current.album}`"></span></template>
                        <template x-if="current?.year"><span x-text="current.year"></span></template>
                        <template x-if="duration"><span x-text="formatTime(duration)"></span></template>
                    </div>
                </div>

                <div class="radio-track-actions">
                    <button class="radio-icon-btn" title="Boost" @click="boostArtist(current)">
                        <i class="fas fa-bolt"></i>
                    </button>
                    <button class="radio-icon-btn" title="Add to queue" @click="addToQueue(current)">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <div class="radio-progress-wrap">
                <div class="radio-progress-times">
                    <span x-text="formatTime(currentTime)"></span>
                    <span x-text="formatTime(duration)"></span>
                </div>
                <div class="radio-progress-bar" @click="seekFromClick($event)">
                    <div class="radio-progress-fill" :style="`width:${progressPercent}%;`"></div>
                </div>
            </div>
        </div>
    </section>

    <section class="radio-justplayed">
        <h3 class="radio-section-title">Previously Played</h3>
        <div class="playing-list">
            <template x-for="item in justPlayed.slice(0, 8)" :key="item.id">
                <div class="playing-item"
                    :style="`background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url(${item.cover_art || '/static/img/default-cover.jpg'}); background-size: cover; background-position: center;`"
                    @click="playNow(item)">
                    <div class="item-details">
                        <h4 x-text="item.title"></h4>
                        <p x-text="item.artist"></p>
                    </div>
                    <div class="play-indicator"><i
                            class="fas fa-play"></i></div>
                </div>
            </template>
        </div>
    </section>
</div>

<script>
    function radioPage() {
        return {
            stationName: 'Indie Rock Station',
            stationTagline: 'The best independent and alternative rock music, curated by music lovers.',
            djName: 'DJ Ahoy',
            isPlaying: false,
            shuffle: true,
            tracks: [],
            queue: [],
            current: null,
            upNext: [],
            justPlayed: [],
            currentTime: 0,
            duration: 0,
            progressPercent: 0,
            async init() {
                try {
                    this._bindMediaPlayer();
                    const r = await fetch('/api/music');
                    if (!r.ok) {
                        console.error('Radio API error:', r.status, r.statusText);
                        return;
                    }
                    const data = await r.json();
                    if (!data || !Array.isArray(data.tracks)) {
                        console.error('Invalid radio data format');
                        return;
                    }
                    const tracks = (data.tracks || []).filter(t => t.audio_url || t.preview_url);
                    // Deduplicate by id
                    const seen = new Set();
                    this.tracks = tracks.filter(t => { if (seen.has(t.id)) return false; seen.add(t.id); return true; });
                    this._buildQueue();
                } catch (e) {
                    console.error('radio load failed', e);
                    // Show user-friendly error message
                    if (window.ahoyApp?.showNotification) {
                        window.ahoyApp.showNotification('Failed to load radio. Please try again.', 'error');
                    }
                }
            },
            _bindMediaPlayer() {
                const mp = window.mediaPlayer;
                if (!mp || typeof mp !== 'object') return;

                // initial sync (if something is already playing)
                this._syncFromMediaPlayer();

                if (typeof mp.on === 'function') {
                    mp.on('play', () => this._syncFromMediaPlayer());
                    mp.on('pause', () => this._syncFromMediaPlayer());
                    mp.on('trackchange', () => this._syncFromMediaPlayer());
                    mp.on('timeupdate', (time) => {
                        this.currentTime = Number(time) || (mp.currentTime || 0);
                        this.duration = mp.duration || this.duration || 0;
                        this.progressPercent = this.duration ? Math.min(100, Math.max(0, (this.currentTime / this.duration) * 100)) : 0;
                    });
                    mp.on('durationchange', (d) => {
                        this.duration = Number(d) || mp.duration || 0;
                        this.progressPercent = this.duration ? Math.min(100, Math.max(0, (this.currentTime / this.duration) * 100)) : 0;
                    });
                }
            },
            _syncFromMediaPlayer() {
                const mp = window.mediaPlayer;
                if (!mp) return;
                this.isPlaying = !!mp.isPlaying;
                if (mp.currentTrack) this.current = mp.currentTrack;
                this.currentTime = mp.currentTime || 0;
                this.duration = mp.duration || this.duration || 0;
                this.progressPercent = this.duration ? Math.min(100, Math.max(0, (this.currentTime / this.duration) * 100)) : 0;
            },
            _buildQueue() {
                const list = [...this.tracks];
                if (this.shuffle) list.sort(() => 0.5 - Math.random());
                this.queue = list.map(t => ({ ...t, type: 'track' }));
                this.upNext = this.queue.slice(0, 20);
            },
            toggle() {
                if (!window.mediaPlayer) { console.error('Media player not available'); return; }
                if (this.isPlaying) { window.mediaPlayer.pause(); this.isPlaying = false; return; }
                if (!this.current) { this._playNext(); return; }
                window.mediaPlayer.resume(); this.isPlaying = true;
            },
            skip() { this._playNext(); },
            playNow(item) {
                if (!window.mediaPlayer) { console.error('Media player not available'); return; }
                if (this.current) {
                    this.justPlayed.unshift(this.current);
                    if (this.justPlayed.length > 20) this.justPlayed.length = 20;
                }
                this.current = item;
                window.mediaPlayer.play(item);
                this.isPlaying = true;
            },
            _playNext() {
                if (!window.mediaPlayer) { console.error('Media player not available'); return; }
                if (this.queue.length === 0) this._buildQueue();
                const next = this.queue.shift();
                if (this.current) {
                    this.justPlayed.unshift(this.current);
                    if (this.justPlayed.length > 20) this.justPlayed.length = 20;
                }
                if (next) { this.current = next; window.mediaPlayer.play(next); this.isPlaying = true; }
                this.upNext = this.queue.slice(0, 20);
            },
            formatTime(sec) {
                const s = Math.max(0, Math.floor(Number(sec) || 0));
                const m = Math.floor(s / 60);
                const r = s % 60;
                return `${m}:${String(r).padStart(2, '0')}`;
            },
            seekFromClick(e) {
                if (!window.mediaPlayer || typeof window.mediaPlayer.seekTo !== 'function') return;
                const bar = e.currentTarget;
                const rect = bar.getBoundingClientRect();
                const x = Math.min(rect.width, Math.max(0, e.clientX - rect.left));
                const pct = rect.width ? (x / rect.width) : 0;
                const t = (this.duration || window.mediaPlayer.duration || 0) * pct;
                window.mediaPlayer.seekTo(t);
            },
            toggleFavoriteCurrent() {
                // placeholder: hook to bookmarks/favorites when available
                document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Favorites coming soon' }));
            },
            async shareCurrent() {
                const title = this.current?.title || this.stationName || 'Ahoy Radio';
                const text = this.current?.artist ? `${this.current.artist} — ${this.current.title}` : title;
                const url = window.location.href;
                try {
                    if (navigator.share) {
                        await navigator.share({ title, text, url });
                        return;
                    }
                } catch (_) { /* ignore */ }
                try {
                    await navigator.clipboard.writeText(url);
                    document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Link copied' }));
                } catch (_) {
                    document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Copy failed' }));
                }
            },
            addToQueue(item) {
                if (!item || !window.mediaPlayer || typeof window.mediaPlayer.addToPlaylist !== 'function') {
                    document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Queue unavailable' }));
                    return;
                }
                window.mediaPlayer.addToPlaylist(item);
                document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Added to queue' }));
            },
            boostArtist(item) {
                console.log(`Boosting artist: ${item.artist}`);
                // Implement boosting functionality here
                // Example: launch a modal or redirect to a payment page
            }
        }
    }
</script>
<!-- Visualizer Overlay Container -->
<div id="visualizerOverlay"
    class="viz-overlay hidden fixed inset-0 bg-black/85 backdrop-blur-2xl flex items-center justify-center z-[9999]">
    <div id="visualizerCanvasContainer"
        class="w-[92%] h-[70%] bg-black/40 rounded-2xl border border-white/10 shadow-2xl relative overflow-hidden">
        <!-- visualizer canvas gets appended here -->
    </div>
    <button id="closeVisualizer"
        class="absolute top-6 right-6 px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white hover:bg-white/20 backdrop-blur-md">
        ✕ Close
    </button>
</div>

<script>
    // Fullscreen Visualizer → Overlay
    document.addEventListener('DOMContentLoaded', () => {
        const vizOverlay = document.getElementById('visualizerOverlay');
        const vizBtn = document.querySelector('button[title="Fullscreen Visualizer"]');
        const closeViz = document.getElementById('closeVisualizer');
        const canvasContainer = document.getElementById('visualizerCanvasContainer');
        const originalContainer = document.getElementById('now-playing-visualizer');
        let moved = false;

        function openViz() {
            if (vizOverlay && canvasContainer && originalContainer) {
                // Move any existing visualizer children into overlay
                while (originalContainer.firstChild) {
                    canvasContainer.appendChild(originalContainer.firstChild);
                    moved = true;
                }
                vizOverlay.classList.remove('hidden');
                vizOverlay.classList.add('flex');
            }
        }
        function closeVizOverlay() {
            if (vizOverlay) {
                vizOverlay.classList.add('hidden');
                vizOverlay.classList.remove('flex');
            }
            // Move back canvas
            if (moved && canvasContainer && originalContainer) {
                while (canvasContainer.firstChild) {
                    originalContainer.appendChild(canvasContainer.firstChild);
                }
                moved = false;
            }
        }

        if (vizBtn) vizBtn.addEventListener('click', openViz);
        if (closeViz) closeViz.addEventListener('click', closeVizOverlay);
    });

    // Account Dropdown (Mobile) safeguard wrapper
    document.addEventListener('DOMContentLoaded', () => {
        const accountBtn = document.querySelector('button[title="User & Bookmarks Menu"]');
        const accountMenu = document.querySelector('.mobile-right-dropdown');
        if (accountBtn && accountMenu) {
            accountMenu.classList.add('hidden');
            accountBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                accountMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', () => accountMenu.classList.add('hidden'));
        }
    });
</script>
{% endblock %}