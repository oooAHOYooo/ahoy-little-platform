{% extends "base.html" %}

{% block title %}My Saves - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="my-saves-container" x-data="mySavesLibrary()"
    x-init="loadUserData()">
    <!-- Xbox/Skate 4 Style Profile Header -->
    <div class="profile-hero">
        <div class="profile-background"></div>
        <div class="profile-content">
            <div class="profile-avatar-section">
                <div class="profile-avatar-large">
                    <template x-if="window.LOGGED_IN">
                        <img
                            :src="userProfile.avatar || '/static/img/default-avatar.png'"
                            :alt="userProfile.display_name || 'User'"
                            class="avatar-image">
                    </template>
                    <template x-if="!window.LOGGED_IN">
                        <span class="user-label">Guest</span>
                    </template>
                </div>
            </div>
            <div class="profile-info">
                <h1 class="profile-username"
                    x-text="userProfile.display_name || 'User'"></h1>
                <p class="profile-tagline"
                    x-text="userProfile.bio || 'Music & Show Enthusiast'"></p>
                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-number"
                            x-text="userStats.saved_tracks || 0"></span>
                        <span class="stat-label">Tracks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number"
                            x-text="userStats.saved_shows || 0"></span>
                        <span class="stat-label">Shows</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number"
                            x-text="userStats.playlists || 0"></span>
                        <span class="stat-label">Playlists</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="page-header">
        <h1>My Saves</h1>
    </div>

    <!-- Navigation Tabs -->
    <div class="saves-nav">
        <button @click="activeTab = 'saved'"
            :class="{'active': activeTab === 'saved'}"
            class="nav-tab">
            <i class="fas fa-bookmark"></i> Bookmarks
        </button>
        <button @click="activeTab = 'collections'"
            :class="{'active': activeTab === 'collections'}"
            class="nav-tab">
            <i class="fas fa-folder"></i> Collections
        </button>
        <button @click="activeTab = 'recent'"
            :class="{'active': activeTab === 'recent'}"
            class="nav-tab">
            <i class="fas fa-clock"></i> Recently Played
        </button>
    </div>

    <!-- Saved Content Tab -->
    <div x-show="activeTab === 'saved'" class="saves-content">
        <div class="content-filters">
            <button @click="savedFilter = 'all'"
                :class="{'active': savedFilter === 'all'}"
                class="filter-btn">All</button>
            <button @click="savedFilter = 'track'"
                :class="{'active': savedFilter === 'track'}"
                class="filter-btn">Tracks</button>
            <button @click="savedFilter = 'show'"
                :class="{'active': savedFilter === 'show'}"
                class="filter-btn">Shows</button>
            <button @click="savedFilter = 'artist'"
                :class="{'active': savedFilter === 'artist'}"
                class="filter-btn">Artists</button>
        </div>

        <div class="saved-grid">
            <template x-for="item in filteredSavedContent" :key="item.id">
                <div class="saved-item" @click="playContent(item)">
                    <div class="item-cover">
                        <img
                            :src="item.cover_art || item.thumbnail || '/static/img/default-cover.jpg'"
                            :alt="item.title || item.name">
                        <div class="item-overlay">
                            <button @click.stop="playContent(item)"
                                class="play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="item-actions">
                                <button @click.stop="unsaveContent(item)"
                                    class="action-btn">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                                <button @click.stop="showAddToPlaylist(item)"
                                    class="action-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item-info">
                        <h3 x-text="item.title || item.name"></h3>
                        <p x-text="item.artist || item.host"></p>
                        <div class="item-meta">
                            <span class="saved-date"
                                x-text="formatDate(item.saved_at)"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="filteredSavedContent.length === 0" class="empty-state">
            <div class="icon">üîñ</div>
            <h3>No bookmarks yet</h3>
            <p>Click the bookmark icon on any show, track, or artist to save it
                here.</p>
            <a class="btn" href="/shows">Browse Shows</a>
        </div>
    </div>

    <!-- Collections Tab -->
    <div x-show="activeTab === 'collections'" class="collections-content">
        <div class="collections-header">
            <h2>My Collections</h2>
            <button @click="showCreateCollection = true" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Collection
            </button>
        </div>

        <div class="collections-grid">
            <template x-for="collection in userCollections" :key="collection.id">
                <div class="collection-card">
                    <div class="collection-header">
                        <h3 x-text="collection.name"></h3>
                        <p x-text="collection.description"></p>
                        <div class="collection-meta">
                            <span x-text="collection.items?.length || 0"></span> items
                        </div>
                    </div>
                    <div class="collection-actions">
                        <button @click="viewCollection(collection)" class="btn btn-secondary">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <!-- Make Playlist Button -->
                        <button 
                            class="px-3 py-2 rounded-xl bg-black/80 text-white hover:bg-black transition text-sm desktop-only"
                            data-make-playlist
                            :data-collection-id="collection.id"
                            :data-collection-name="collection.name"
                            :data-owner="userProfile.username"
                            title="Turn this collection into an ordered playlist"
                        >
                            ‚ñ∂Ô∏è Make Playlist
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="userCollections.length === 0" class="empty-state">
            <div class="icon">üìÅ</div>
            <h3>No collections yet</h3>
            <p>Create collections to organize your favorite content.</p>
            <button @click="showCreateCollection = true" class="btn desktop-only">Create Collection</button>
        </div>
    </div>

    <!-- Recently Played Tab -->
    <div x-show="activeTab === 'recent'" class="recent-content">
        <div class="recent-list">
            <template x-for="item in recentlyPlayed"
                :key="item.id + '-' + item.type">
                <div class="recent-item" @click="playContent(item)">
                    <div class="item-cover">
                        <img
                            :src="item.data?.cover_art || item.data?.thumbnail || '/static/img/default-cover.jpg'"
                            :alt="item.data?.title || item.data?.name">
                    </div>
                    <div class="item-info">
                        <h3 x-text="item.data?.title || item.data?.name"></h3>
                        <p x-text="item.data?.artist || item.data?.host"></p>
                        <div class="item-meta">
                            <span class="played-date"
                                x-text="formatDate(item.played_at)"></span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button @click.stop="playContent(item)"
                            class="play-btn-small">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="recentlyPlayed.length === 0" class="empty-state">
            <i class="fas fa-clock"></i>
            <h3>No recent activity</h3>
            <p>Start playing content to see your recent activity here!</p>
        </div>
    </div>

</div>

<script>
function mySavesLibrary() {
    return {
        // State
        activeTab: 'saved',
        savedFilter: 'all',
        savedContent: [],
        recentlyPlayed: [],
        userCollections: [],
        userStats: null,
        selectedContent: null,
        showCreateCollection: false,
        
        // Computed
        get filteredSavedContent() {
            if (this.savedFilter === 'all') {
                return this.savedContent;
            }
            return this.savedContent.filter(item => item.type === this.savedFilter);
        },
        
        // Initialize
        async loadUserData() {
            try {
                await Promise.all([
                    this.loadSavedContent(),
                    this.loadRecentlyPlayed(),
                    this.loadUserCollections(),
                    this.loadUserStats()
                ]);
                
                // Images will load automatically
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        },
        
        async loadSavedContent() {
            try {
                // Try server first (guest-safe)
                const response = await fetch('/api/bookmarks');
                if (!response.ok) throw new Error('Not available');
                const data = await response.json();
                // Convert bookmarks to saved content format
                this.savedContent = (data.items || []).map(item => ({
                    id: item.id,
                    type: item.type,
                    title: item.title,
                    artwork: item.artwork,
                    saved_at: item.added_at || new Date().toISOString()
                }));
            } catch (error) {
                // If server fails, use local storage
                console.log('Server unavailable, using local storage for bookmarks');
                const localBookmarks = JSON.parse(localStorage.getItem('ahoy_bookmarks') || '[]');
                this.savedContent = localBookmarks.map(bookmark => {
                    const [kind, id] = bookmark.split(':');
                    return { id, type: kind, saved_at: new Date().toISOString() };
                });
            }
        },
        
        
        
        async loadRecentlyPlayed() {
            try {
                const response = await fetch('/api/recently-played');
                const data = await response.json();
                this.recentlyPlayed = data.recently_played || [];
            } catch (error) {
                console.error('Error loading recently played:', error);
            }
        },

        async loadUserCollections() {
            try {
                const response = await fetch('/api/collections/');
                if (response.ok) {
                    this.userCollections = await response.json();
                }
            } catch (error) {
                console.error('Error loading collections:', error);
                this.userCollections = [];
            }
        },
        
        async loadUserStats() {
            try {
                const response = await fetch('/api/user/stats');
                const data = await response.json();
                this.userStats = data.stats;
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        },
        
        
        // Content actions
        async playContent(item) {
            if (window.globalPlayer) {
                window.globalPlayer.playTrack(item);
            }
        },
        
        async unsaveContent(item) {
            try {
                // Use the unified bookmarks system
                if (window.AhoyBookmarks) {
                    const bookmarkItem = {
                        type: item.type || 'track',
                        id: item.id,
                        title: item.title,
                        artwork: item.artwork
                    };
                    window.AhoyBookmarks.toggle(bookmarkItem);
                    this.savedContent = this.savedContent.filter(i => i.id !== item.id);
                } else {
                    // Fallback: need to find bookmark ID first, then delete
                    const response = await fetch('/api/bookmarks');
                    if (response.ok) {
                        const data = await response.json();
                        const bookmark = (data.items || []).find(b => 
                            b.media_id == item.id && b.media_type === (item.type === 'track' ? 'music' : item.type)
                        );
                        if (bookmark) {
                            await fetch(`/api/bookmarks/${bookmark.id}`, { method: 'DELETE' });
                        }
                        this.savedContent = this.savedContent.filter(i => i.id !== item.id);
                    }
                }
            } catch (error) {
                console.error('Error unsaving content:', error);
            }
        },

        // Removed: viewCollection - collections feature removed
        
        

        showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary-color);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        },

        // Utility functions
        formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString();
        }
    };
}
</script>

{% endblock %}
