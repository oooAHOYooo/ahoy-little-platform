{% extends "base.html" %}

{% block title %}My Saves - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="my-saves-container" x-data="mySavesLibrary()"
    x-init="loadUserData()">
    <!-- Dark Liquid Glass Profile Header -->
    <div class="saves-profile-hero">
        <div class="saves-profile-glow"></div>
        <div class="saves-profile-content">
            <div class="saves-avatar-wrapper">
                <template x-if="window.LOGGED_IN">
                    <img
                        :src="userProfile.avatar || '/static/img/default-avatar.png'"
                        :alt="userProfile.display_name || 'User'"
                        class="saves-avatar-img">
                </template>
                <template x-if="!window.LOGGED_IN">
                    <div class="saves-avatar-guest">
                        <i class="fas fa-user"></i>
                    </div>
                </template>
            </div>
            <div class="saves-profile-info">
                <h1 class="saves-username" x-text="bookmarkCount >= 3 ? 'My Collection' : (userProfile.display_name || 'Guest')"></h1>
                <template x-if="window.LOGGED_IN && userProfile.username">
                    <a :href="'/account'" class="saves-user-handle" style="color:rgba(255,255,255,0.6); text-decoration:none; font-size:14px;">
                        @<span x-text="userProfile.username"></span>
                    </a>
                </template>
                <div class="saves-stats">
                    <div class="saves-stat">
                        <span class="saves-stat-number" x-text="bookmarkCount"></span>
                        <span class="saves-stat-label">Bookmarks</span>
                    </div>
                    <div class="saves-stat">
                        <span class="saves-stat-number" x-text="recentlyPlayed.length"></span>
                        <span class="saves-stat-label">Recently Played</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs - Glass Style -->
    <div class="saves-tabs-glass">
        <button @click="activeTab = 'saved'"
            :class="{'active': activeTab === 'saved'}"
            class="saves-tab-btn">
            <i class="fas fa-bookmark"></i>
            <span>Bookmarks</span>
            <span class="saves-tab-count" x-text="bookmarkCount"></span>
        </button>
        <button @click="activeTab = 'recent'"
            :class="{'active': activeTab === 'recent'}"
            class="saves-tab-btn">
            <i class="fas fa-history"></i>
            <span>Recently Played</span>
            <span class="saves-tab-count" x-text="recentlyPlayed.length"></span>
        </button>
    </div>

    <!-- Bookmarks Tab -->
    <div x-show="activeTab === 'saved'" class="saves-content-glass">
        <!-- Filter Pills -->
        <div class="saves-filter-pills">
            <button @click="savedFilter = 'all'"
                :class="{'active': savedFilter === 'all'}"
                class="saves-pill">All</button>
            <button @click="savedFilter = 'track'"
                :class="{'active': savedFilter === 'track'}"
                class="saves-pill">Tracks</button>
            <button @click="savedFilter = 'show'"
                :class="{'active': savedFilter === 'show'}"
                class="saves-pill">Shows</button>
            <button @click="savedFilter = 'artist'"
                :class="{'active': savedFilter === 'artist'}"
                class="saves-pill">Artists</button>
        </div>

        <!-- Bookmarks Grid -->
        <div class="saves-grid">
            <template x-for="item in filteredSavedContent" :key="item.key || item.id">
                <div class="saves-card" @click="playContent(item)">
                    <div class="saves-card-art">
                        <img
                            :src="item.artwork || item.cover_art || item.thumbnail || '/static/img/default-cover.jpg'"
                            :alt="item.title || item.name"
                            loading="lazy">
                        <div class="saves-card-overlay">
                            <button @click.stop="playContent(item)" class="saves-play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                        <button @click.stop="unsaveContent(item)" class="saves-remove-btn" title="Remove bookmark">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <span class="saves-type-badge" x-text="item.type"></span>
                    </div>
                    <div class="saves-card-info">
                        <h3 x-text="item.title || item.name"></h3>
                        <p x-text="item.artist || item.host || ''"></p>
                        <span class="saves-date" x-text="formatDate(item.saved_at)"></span>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="filteredSavedContent.length === 0" class="saves-empty-glass">
            <div class="saves-empty-icon">
                <i class="fas fa-bookmark"></i>
            </div>
            <h3>No bookmarks yet</h3>
            <p>Tap the bookmark icon on any track, show, or artist to save it here for easy access.</p>
            <a class="saves-cta-btn" href="/shows">Discover Shows</a>
        </div>
    </div>

    <!-- Recently Played Tab -->
    <div x-show="activeTab === 'recent'" class="saves-content-glass">
        <div class="saves-recent-list">
            <template x-for="item in recentlyPlayed" :key="item.key || (item.id + '-' + item.type)">
                <div class="saves-recent-item" @click="playContent(item)">
                    <div class="saves-recent-art">
                        <img
                            :src="item.artwork || item.cover_art || item.thumbnail || '/static/img/default-cover.jpg'"
                            :alt="item.title || item.name"
                            loading="lazy">
                        <div class="saves-recent-play">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="saves-recent-info">
                        <h3 x-text="item.title || item.name"></h3>
                        <p x-text="item.artist || item.host || ''"></p>
                        <span class="saves-recent-time" x-text="formatRelativeTime(item.played_at)"></span>
                    </div>
                    <div class="saves-recent-actions">
                        <button @click.stop="toggleBookmark(item)"
                            class="saves-action-btn"
                            :class="{'bookmarked': isBookmarked(item)}"
                            :title="isBookmarked(item) ? 'Remove bookmark' : 'Add bookmark'">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="recentlyPlayed.length === 0" class="saves-empty-glass">
            <div class="saves-empty-icon">
                <i class="fas fa-history"></i>
            </div>
            <h3>No recent plays</h3>
            <p>Content you listen to will appear here so you can easily find it again.</p>
            <a class="saves-cta-btn" href="/music">Browse Music</a>
        </div>
    </div>

</div>

<script>
// Recently Played Storage Key
const RECENT_STORAGE_KEY = 'ahoy.recentlyPlayed.v1';
const MAX_RECENT_ITEMS = 50;

// Track plays globally
window.trackRecentPlay = function(item) {
    if (!item || !item.id) return;
    try {
        const raw = localStorage.getItem(RECENT_STORAGE_KEY);
        let recent = raw ? JSON.parse(raw) : [];
        const playRecord = {
            id: item.id,
            type: item.type || 'track',
            title: item.title || item.name,
            artist: item.artist || item.host || '',
            artwork: item.artwork || item.cover_art || item.thumbnail,
            key: `${item.type || 'track'}:${item.id}`,
            played_at: new Date().toISOString()
        };
        recent = recent.filter(r => r.key !== playRecord.key);
        recent.unshift(playRecord);
        recent = recent.slice(0, MAX_RECENT_ITEMS);
        localStorage.setItem(RECENT_STORAGE_KEY, JSON.stringify(recent));
        document.dispatchEvent(new CustomEvent('recentlyPlayed:updated', { detail: { recent } }));
    } catch (e) {
        console.error('Error tracking recent play:', e);
    }
};

function mySavesLibrary() {
    return {
        // State
        activeTab: 'saved',
        savedFilter: 'all',
        savedContent: [],
        recentlyPlayed: [],
        bookmarkCount: 0,

        // User profile (from global)
        get userProfile() {
            return window.userProfile || { display_name: 'Guest', username: '', bio: '' };
        },

        // Computed
        get filteredSavedContent() {
            if (this.savedFilter === 'all') {
                return this.savedContent;
            }
            return this.savedContent.filter(item => item.type === this.savedFilter);
        },

        // Initialize
        async loadUserData() {
            await this.loadSavedContent();
            this.loadRecentlyPlayed();

            // Listen for updates
            document.addEventListener('bookmarks:changed', () => {
                this.loadSavedContent();
            });
            document.addEventListener('recentlyPlayed:updated', () => {
                this.loadRecentlyPlayed();
            });
        },

        async loadSavedContent() {
            if (window.AhoyBookmarks) {
                const items = window.AhoyBookmarks.all();
                this.savedContent = items.map(item => ({
                    id: item.id,
                    type: item.type,
                    title: item.title,
                    artist: item.artist || '',
                    host: item.host || '',
                    artwork: item.artwork,
                    cover_art: item.artwork,
                    thumbnail: item.artwork,
                    key: item.key || `${item.type}:${item.id}`,
                    saved_at: item.added_at || new Date().toISOString()
                }));
                this.bookmarkCount = items.length;
            } else {
                try {
                    const rawData = localStorage.getItem('ahoy.bookmarks.v1');
                    if (rawData) {
                        const data = JSON.parse(rawData);
                        if (data.items) {
                            const items = Object.values(data.items);
                            this.savedContent = items.map(item => ({
                                id: item.id,
                                type: item.type,
                                title: item.title,
                                artist: item.artist || '',
                                host: item.host || '',
                                artwork: item.artwork,
                                cover_art: item.artwork,
                                thumbnail: item.artwork,
                                key: item.key || `${item.type}:${item.id}`,
                                saved_at: item.added_at || new Date().toISOString()
                            }));
                            this.bookmarkCount = items.length;
                        }
                    }
                } catch (e) {
                    console.error('Error reading bookmarks:', e);
                    this.savedContent = [];
                    this.bookmarkCount = 0;
                }
            }
        },

        loadRecentlyPlayed() {
            try {
                const raw = localStorage.getItem(RECENT_STORAGE_KEY);
                this.recentlyPlayed = raw ? JSON.parse(raw) : [];
            } catch (e) {
                console.error('Error loading recently played:', e);
                this.recentlyPlayed = [];
            }
        },

        // Content actions
        async playContent(item) {
            window.trackRecentPlay(item);
            if (window.globalPlayer) {
                window.globalPlayer.playTrack(item);
            }
        },

        async unsaveContent(item) {
            if (window.AhoyBookmarks) {
                const bookmarkItem = {
                    type: item.type || 'track',
                    id: item.id,
                    title: item.title,
                    artwork: item.artwork
                };
                window.AhoyBookmarks.toggle(bookmarkItem);
                setTimeout(() => this.loadSavedContent(), 100);
            }
        },

        isBookmarked(item) {
            if (window.AhoyBookmarks) {
                return window.AhoyBookmarks.isBookmarked(item.type || 'track', item.id);
            }
            return false;
        },

        toggleBookmark(item) {
            if (window.AhoyBookmarks) {
                const bookmarkItem = {
                    type: item.type || 'track',
                    id: item.id,
                    title: item.title,
                    artwork: item.artwork || item.cover_art || item.thumbnail
                };
                window.AhoyBookmarks.toggle(bookmarkItem);
                setTimeout(() => this.loadSavedContent(), 100);
            }
        },

        // Utility functions
        formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString();
        },

        formatRelativeTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
    };
}
</script>

{% endblock %}
