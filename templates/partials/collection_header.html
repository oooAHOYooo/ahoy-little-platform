<div class="flex flex-wrap items-center gap-2">
  <h1 class="text-2xl font-bold">{{ collection.name }}</h1>
  <div class="flex items-center gap-2 ml-auto">
    <!-- Make Playlist (basic) -->
    <button
      class="px-3 py-2 rounded-xl bg-black text-white hover:bg-black/80"
      data-make-playlist
      data-collection-id="{{ collection.id }}"
      data-collection-name="{{ collection.name }}"
      data-owner="{{ current_user.username }}">
      ▶️ Make Playlist
    </button>

    <!-- Queue All (replace queue) -->
    <button
      class="px-3 py-2 rounded-xl border hover:bg-white/10"
      id="queue-all"
      data-collection-id="{{ collection.id }}"
      data-owner="{{ current_user.username }}">
      ⏯ Queue All
    </button>

    <!-- Queue Next (prepend to queue) -->
    <button
      class="px-3 py-2 rounded-xl border hover:bg-white/10"
      id="queue-next"
      data-collection-id="{{ collection.id }}"
      data-owner="{{ current_user.username }}">
      ⏭ Queue Next
    </button>
  </div>
</div>

<script type="module">
  // Uses your existing Playlists API (from earlier code) to create a playlist, then marks queue mode.
  async function postJSON(url, body) {
    const fx = (typeof window !== "undefined" && window.fetchWithPaywall) || fetch;
    const r = await fx(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!r.ok) throw new Error((await r.json()).error || "Request failed");
    return r.json();
  }

  // Queue helpers: create a transient playlist from this collection then signal the queue
  async function queueFromCollection(collectionId, owner, queueMode) {
    const pl = await postJSON(`/api/playlists/from-collection/${collectionId}`, { owner, name: "", is_public: false });
    // annotate with desired queue action so player-queue.js can act
    pl._queueMode = queueMode; 
    document.dispatchEvent(new CustomEvent("playlist:created", { detail: pl }));
    document.dispatchEvent(new CustomEvent("ahoy:toast", { detail: queueMode === "next" ? "Queued to play next" : "Queued all" }));
  }

  document.getElementById("queue-all")?.addEventListener("click", (e) => {
    const id = e.currentTarget.getAttribute("data-collection-id");
    const owner = e.currentTarget.getAttribute("data-owner");
    queueFromCollection(id, owner, "replace");
  });

  document.getElementById("queue-next")?.addEventListener("click", (e) => {
    const id = e.currentTarget.getAttribute("data-collection-id");
    const owner = e.currentTarget.getAttribute("data-owner");
    queueFromCollection(id, owner, "next");
  });
</script>
