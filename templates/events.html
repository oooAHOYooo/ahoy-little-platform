{% extends "base.html" %}

{% block title %}Events - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="events-page" x-data="eventsPage()" x-init="init()">
    {% from "macros/subpage_header.html" import subpage_hero %}
    {{ subpage_hero(title="Events",
    subtitle="Upcoming live Ahoy shows, plus past events and recordings.",
    icon_class="fas fa-calendar", scope_class="") }}

    <!-- Featured / Upcoming widget -->
    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>Upcoming</h2>
        </div>

        <template x-if="featured">
            <div class="podcast-show-hero" style="margin-top: 10px;">
                <img class="podcast-show-hero-art"
                    :src="featured.image || '/static/img/default-cover.jpg'"
                    alt>
                <div class="podcast-show-hero-meta">
                    <div class="podcast-show-hero-kicker">Featured event</div>
                    <h1 class="podcast-show-hero-title"
                        x-text="featured.title"></h1>
                    <p class="podcast-show-hero-desc"
                        x-text="featured.description"></p>
                    <div class="episode-subtitle" style="margin-bottom: 10px;">
                        <span x-text="formatDate(featured.date)"></span>
                        <span class="episode-dot">•</span>
                        <span x-text="featured.time || ''"></span>
                        <span class="episode-dot"
                            x-show="featured.venue">•</span>
                        <span x-show="featured.venue"
                            x-text="featured.venue"></span>
                    </div>
                    <div class="podcast-show-hero-actions">
                        <a class="podcast-cta"
                            :href="featured.rsvp_external_url || '/events'"
                            @click.stop
                            x-text="featured.rsvp_external_url ? 'RSVP' : 'View'"></a>
                        <button type="button" class="podcast-cta secondary"
                            @click="copyLink(featured.rsvp_external_url || (window.location.origin + '/events'))">
                            Copy link
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <div class="episode-list" style="margin-top: 12px;">
            <template x-for="evt in upcoming" :key="evt.id || evt.title">
                <article class="episode-row">
                    <img class="episode-art"
                        :src="evt.image || '/static/img/default-cover.jpg'" alt>
                    <div class="episode-meta">
                        <div class="episode-title"
                            x-text="evt.title || 'Live Show'"></div>
                        <div class="episode-subtitle">
                            <span x-text="formatDate(evt.date)"></span>
                            <span class="episode-dot">•</span>
                            <span x-text="evt.time || ''"></span>
                            <span class="episode-dot"
                                x-show="evt.venue">•</span>
                            <span x-show="evt.venue" x-text="evt.venue"></span>
                        </div>
                        <div class="episode-desc"
                            x-text="evt.description || ''"></div>
                    </div>
                    <div class="episode-actions">
                        <a class="episode-open"
                            :href="evt.rsvp_external_url || '/events'"
                            @click.stop
                            x-text="evt.rsvp_external_url ? 'RSVP' : 'Open'"></a>
                    </div>
                </article>
            </template>
        </div>

        <div x-show="!loading && upcoming.length === 0" class="empty-state"
            style="margin-top:14px;">
            <i class="fas fa-calendar-times"></i>
            <h4>No upcoming events</h4>
            <p>Check back soon.</p>
        </div>
    </section>

    <!-- Past events list -->
    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>Past events</h2>
        </div>

        <div class="episode-list">
            <template x-for="evt in past" :key="evt.id || evt.title">
                <article class="episode-row">
                    <img class="episode-art"
                        :src="evt.image || '/static/img/default-cover.jpg'" alt>
                    <div class="episode-meta">
                        <div class="episode-title"
                            x-text="evt.title || 'Event'"></div>
                        <div class="episode-subtitle">
                            <span x-text="formatDate(evt.date)"></span>
                            <span class="episode-dot">•</span>
                            <span x-text="evt.venue || ''"></span>
                            <span class="episode-dot"
                                x-show="evt.videoStatus">•</span>
                            <span x-show="evt.videoStatus"
                                x-text="evt.videoStatus"></span>
                        </div>
                        <div class="episode-desc"
                            x-text="evt.description || ''"></div>
                    </div>
                    <div class="episode-actions">
                        <a class="episode-open" x-show="evt.videoUrl"
                            :href="evt.videoUrl" target="_blank" rel="noopener"
                            @click.stop>
                            Watch
                        </a>
                        <a class="episode-open" x-show="evt.id || evt.title"
                            :href="`/events/${encodeURIComponent(evt.id || evt.title)}`"
                            @click.stop>
                            View
                        </a>
                        <span class="episode-open"
                            x-show="!evt.videoUrl && evt.videoStatus"
                            style="opacity:0.7; cursor:default;">
                            <span x-text="evt.videoStatus"></span>
                        </span>
                    </div>
                </article>
            </template>
        </div>
    </section>
</div>

<script>
    function eventsPage() {
        const rawEvents = {{ events|tojson|safe }};
        const rawVideos = {{ videos|tojson|safe }};
        return {
            loading: true,
            featured: null,
            upcoming: [],
            past: [],
            async init() {
                this.loading = true;
                try {
                    const isRemoteUrl = (u) => typeof u === 'string' && /^https?:\/\//i.test(u);
                    const pickFirstRemote = (arr) => {
                        if (!Array.isArray(arr)) return null;
                        for (const u of arr) {
                            if (isRemoteUrl(u)) return u;
                        }
                        return null;
                    };

                    const events = Array.isArray(rawEvents?.events) ? rawEvents.events : [];
                    const videos = Array.isArray(rawVideos?.videos) ? rawVideos.videos : [];
                    const videoByEventId = new Map();
                    for (const v of videos) {
                        if (!v?.event_id) continue;
                        videoByEventId.set(String(v.event_id), v);
                    }

                    // Normalize + attach video info
                    const normalized = events.map(e => {
                        const vid = videoByEventId.get(String(e.id || ''));
                        const remotePhoto = pickFirstRemote(e?.photos);
                        const remoteImage = isRemoteUrl(e?.image) ? e.image : null;
                        const remoteThumb = isRemoteUrl(vid?.thumbnail) ? vid.thumbnail : null;
                        return {
                            ...e,
                            // Prefer cloud/dynamic URLs (ignore /static/*). Falls back to default cover in the template.
                            image: remotePhoto || remoteImage || remoteThumb || null,
                            photos: Array.isArray(e?.photos) ? e.photos.filter(isRemoteUrl) : [],
                            videoUrl: vid?.url || null,
                            videoStatus: vid?.status === 'available' ? 'Recording available'
                                : vid?.status === 'coming_soon' ? 'Recording coming soon'
                                    : ''
                        };
                    });

                    // Separate upcoming vs past based on explicit status first.
                    const upcoming = normalized.filter(e => String(e.status || '').toLowerCase() === 'upcoming');
                    const past = normalized.filter(e => String(e.status || '').toLowerCase() === 'past');

                    // If status missing/messy, fallback to date comparison.
                    const unknown = normalized.filter(e => !['upcoming', 'past'].includes(String(e.status || '').toLowerCase()));
                    const now = new Date();
                    for (const e of unknown) {
                        const d = e.date ? new Date(e.date) : null;
                        if (!d || isNaN(d.getTime())) {
                            upcoming.push(e);
                        } else if (d >= now) {
                            upcoming.push(e);
                        } else {
                            past.push(e);
                        }
                    }

                    // Sort
                    upcoming.sort((a, b) => String(a.date || '').localeCompare(String(b.date || ''))); // soonest first
                    past.sort((a, b) => String(b.date || '').localeCompare(String(a.date || ''))); // newest past first

                    this.featured = upcoming[0] || null;
                    this.upcoming = upcoming.slice(0, 12);
                    this.past = past;
                } catch (e) {
                    console.warn('Failed to load events:', e);
                    this.upcoming = [];
                    this.past = [];
                    this.featured = null;
                } finally {
                    this.loading = false;
                }
            },
            formatDate(ds) {
                if (!ds) return '';
                const d = new Date(ds);
                if (isNaN(d.getTime())) return String(ds);
                return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            },
            async copyLink(url) {
                try {
                    await navigator.clipboard.writeText(url);
                    document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Link copied.' }));
                } catch (_) {
                    // ignore
                }
            }
        };
    }
</script>
{% endblock %}
