{% extends "base.html" %}

{% block title %}Ahoy Indie Media - Music Hub{% endblock %}

{% block content %}
<div class="home-page" x-data="homePage()" x-init="init()">
    <!-- TV-Style Hero Feed -->
    <section class="tv-hero">
        <div class="hero-feed"
            :style="`transform: translateX(${heroOffset}px)`"
            @touchstart="handleTouchStart"
            @touchmove="handleTouchMove"
            @touchend="handleTouchEnd">
            <template x-for="(item, index) in heroItems" :key="item.id">
                <div class="hero-item" x-show="item.cover_art || item.thumbnail"
                    :class="{'active': currentHeroIndex === index}"
                    :style="`background-image: url(${item.cover_art || item.thumbnail})`"
                    @click="playItem(item, index)">
                    <div class="hero-overlay">
                        <div class="hero-content">
                            <div class="hero-badge"
                                x-text="item.type?.toUpperCase()"></div>
                            <h1 x-text="item.title"></h1>
                            <p x-text="item.artist"></p>
                            <button class="hero-play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div class="hero-controls">
            <button @click="prevHero()" class="hero-nav">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button @click="nextHero()" class="hero-nav">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="hero-indicators">
            <template x-for="(item, index) in heroItems" :key="item.id">
                <button @click="setHeroIndex(index)"
                    :class="{'active': currentHeroIndex === index}"
                    class="hero-dot"></button>
            </template>
        </div>
    </section>

    <!-- Compact Discovery Grid -->
    <section class="discovery-grid">
        <div class="grid-container">
            <!-- Featured Artist Compact -->
            <div class="grid-item artist-spotlight">
                <div class="item-header">
                    <h3><i class="fas fa-star"></i> Artist Spotlight</h3>
                </div>
                <div class="artist-compact"
                    x-show="featuredArtist && (featuredArtist.image || featuredArtist.avatar)"
                    @click="viewArtist(featuredArtist)">
                    <img
                        :src="featuredArtist?.image || '/static/img/default-avatar.png'"
                        :alt="featuredArtist?.name">
                    <div class="artist-info">
                        <h4 x-text="featuredArtist?.name"></h4>
                        <p x-text="featuredArtist?.genre"></p>
                    </div>
                </div>
            </div>

            <!-- Now Playing Compact -->
            <div class="grid-item now-playing-compact">
                <div class="item-header">
                    <h3><i class="fas fa-music"></i> Now Playing</h3>
                    <button @click="playRandom()" class="shuffle-btn">
                        <i class="fas fa-random"></i>
                    </button>
                </div>
                <div class="playing-list">
                    <template x-for="(item, index) in feedItems.slice(0, 4)"
                        :key="item.id">
                        <div class="playing-item"
                            x-show="item.cover_art || item.thumbnail"
                            :class="{'playing': currentIndex === index}"
                            @click="playItem(item, index)">
                            <img :src="item.cover_art" :alt="item.title">
                            <div class="item-details">
                                <h4 x-text="item.title"></h4>
                                <p x-text="item.artist"></p>
                            </div>
                            <div class="play-indicator"
                                x-show="currentIndex === index">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Live Shows Compact -->
            <div class="grid-item shows-compact">
                <div class="item-header">
                    <h3><i class="fas fa-play-circle"></i> Live Now</h3>
                    <a href="/shows" class="view-all-btn">All</a>
                </div>
                <div class="shows-list">
                    <template x-for="show in featuredShows.slice(0, 3)"
                        :key="show.id">
                        <div class="show-item" x-show="show.thumbnail"
                            @click="playShow(show)">
                            <img :src="show.thumbnail" :alt="show.title">
                            <div class="show-details">
                                <h4 x-text="show.title"></h4>
                                <p x-text="show.host"></p>
                            </div>
                            <div class="play-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Quick Actions Compact -->
            <div class="grid-item quick-actions">
                <div class="item-header">
                    <h3><i class="fas fa-th-large"></i> Explore</h3>
                </div>
                <div class="action-grid">
                    <a href="/music" class="action-card">
                        <i class="fas fa-music"></i>
                        <span>Music</span>
                    </a>
                    <a href="/shows" class="action-card">
                        <i class="fas fa-play-circle"></i>
                        <span>Shows</span>
                    </a>
                    <a href="/artists" class="action-card">
                        <i class="fas fa-users"></i>
                        <span>Artists</span>
                    </a>
                    <a href="/my_saves" class="action-card">
                        <i class="fas fa-bookmark"></i>
                        <span>Saves</span>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Loading State -->
    <section x-show="isLoading" class="loading-section">
        <div class="spinner"></div>
        <p>Loading awesome content...</p>
    </section>
</div>

<script>
function homePage() {
    return {
        // State
        isLoading: true,
        feedItems: [],
        featuredArtist: null,
        featuredShows: [],
        heroItems: [],
        currentIndex: 0,
        currentHeroIndex: 0,
        heroOffset: 0,
        heroInterval: null,
        touchStartX: 0,
        touchStartY: 0,
        isDragging: false,
        
        // Initialize
        async init() {
            await this.loadAllData();
            this.isLoading = false;
            this.startHeroRotation();
            
            // Add resize listener to recalculate hero offset
            window.addEventListener('resize', () => {
                this.updateHeroOffset();
            });
            
            // Expose functions globally for keyboard navigation
            window.homePage = this;
        },
        
        // Data loading
        async loadAllData() {
            try {
                await Promise.all([
                    this.loadNowPlaying(),
                    this.loadFeaturedArtist(),
                    this.loadFeaturedShows()
                ]);
                this.prepareHeroItems();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        },
        
        async loadNowPlaying() {
            try {
                const response = await fetch('/api/now-playing');
                const data = await response.json();
                this.feedItems = data.feed || [];
            } catch (error) {
                console.error('Error loading now playing:', error);
            }
        },
        
        async loadFeaturedArtist() {
            try {
                const response = await fetch('/api/artists');
                const data = await response.json();
                const artists = data.artists || [];
                this.featuredArtist = artists[Math.floor(Math.random() * artists.length)];
            } catch (error) {
                console.error('Error loading featured artist:', error);
            }
        },
        
        async loadFeaturedShows() {
            try {
                const response = await fetch('/api/shows');
                const data = await response.json();
                const shows = data.shows || [];
                this.featuredShows = shows.sort(() => 0.5 - Math.random()).slice(0, 3);
            } catch (error) {
                console.error('Error loading featured shows:', error);
            }
        },
        
        prepareHeroItems() {
            // Mix music and shows for hero feed
            const musicItems = this.feedItems.slice(0, 4);
            const showItems = this.featuredShows.slice(0, 2);
            this.heroItems = [...musicItems, ...showItems].sort(() => 0.5 - Math.random());
            
            // Calculate initial hero offset after items are set
            setTimeout(() => {
                this.updateHeroOffset();
            }, 100);
        },
        
        startHeroRotation() {
            this.heroInterval = setInterval(() => {
                this.nextHero();
            }, 5000); // Change every 5 seconds
        },
        
        stopHeroRotation() {
            if (this.heroInterval) {
                clearInterval(this.heroInterval);
                this.heroInterval = null;
            }
        },
        
        // Hero navigation
        nextHero() {
            if (this.currentHeroIndex < this.heroItems.length - 1) {
                this.currentHeroIndex++;
            } else {
                this.currentHeroIndex = 0;
            }
            this.updateHeroOffset();
        },
        
        prevHero() {
            if (this.currentHeroIndex > 0) {
                this.currentHeroIndex--;
            } else {
                this.currentHeroIndex = this.heroItems.length - 1;
            }
            this.updateHeroOffset();
        },
        
        setHeroIndex(index) {
            this.currentHeroIndex = index;
            this.updateHeroOffset();
        },
        
        updateHeroOffset() {
            // Get the width of the hero container to calculate proper offset
            const heroContainer = document.querySelector('.tv-hero');
            if (heroContainer) {
                const containerWidth = heroContainer.offsetWidth;
                this.heroOffset = -this.currentHeroIndex * containerWidth;
            } else {
                // Fallback to 100% if container not found
                this.heroOffset = -this.currentHeroIndex * 100;
            }
        },
        
        // Touch handling for mobile swipe
        handleTouchStart(event) {
            this.touchStartX = event.touches[0].clientX;
            this.touchStartY = event.touches[0].clientY;
            this.isDragging = false;
            this.stopHeroRotation();
        },
        
        handleTouchMove(event) {
            if (!this.touchStartX) return;
            
            const touchX = event.touches[0].clientX;
            const touchY = event.touches[0].clientY;
            const diffX = this.touchStartX - touchX;
            const diffY = this.touchStartY - touchY;
            
            // Only consider it a drag if horizontal movement is greater than vertical
            if (Math.abs(diffX) > Math.abs(diffY)) {
                this.isDragging = true;
                event.preventDefault();
            }
        },
        
        handleTouchEnd(event) {
            if (!this.isDragging || !this.touchStartX) {
                this.startHeroRotation();
                return;
            }
            
            const touchX = event.changedTouches[0].clientX;
            const diffX = this.touchStartX - touchX;
            const threshold = 50; // Minimum swipe distance
            
            if (Math.abs(diffX) > threshold) {
                if (diffX > 0) {
                    // Swiped left - go to next
                    this.nextHero();
                } else {
                    // Swiped right - go to previous
                    this.prevHero();
                }
            }
            
            this.touchStartX = 0;
            this.touchStartY = 0;
            this.isDragging = false;
            this.startHeroRotation();
        },
        
        // Actions
        playRandom() {
            if (this.feedItems.length > 0) {
                const randomIndex = Math.floor(Math.random() * this.feedItems.length);
                this.playItem(this.feedItems[randomIndex], randomIndex);
            }
        },
        
        playItem(item, index) {
            this.currentIndex = index;
            this.stopHeroRotation();
            
            // Navigate to the item page based on type
            if (item.type === 'show') {
                window.location.href = `/shows?highlight=${item.id}`;
            } else if (item.type === 'music') {
                window.location.href = `/music?highlight=${item.id}`;
            } else if (item.artist) {
                // If it has an artist, it's likely music
                window.location.href = `/music?highlight=${item.id}`;
            } else {
                // Default to shows if no type specified
                window.location.href = `/shows?highlight=${item.id}`;
            }
            // Restart rotation after a delay
            setTimeout(() => this.startHeroRotation(), 10000);
        },
        
        playShow(show) {
            window.location.href = `/player?id=${show.id}&type=show`;
        },
        
        viewArtist(artist) {
            window.location.href = `/artists`;
        }
    }
}
</script>
{% endblock %}