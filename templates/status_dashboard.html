{% extends "base.html" %}
{% block title %}Status Dashboard - Ahoy Indie Media{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-white mb-2">Status Dashboard</h1>
    <p class="text-white/70">Real-time status checks for server, database, and webhook listener</p>
  </div>

  <!-- Status Cards -->
  <div id="statusContainer" class="space-y-6">
    <!-- Loading State -->
    <div class="bg-white/5 rounded-lg p-6 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
        <span class="text-white">Checking status...</span>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="mt-6 bg-white/5 rounded-lg p-6 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
    <h2 class="text-xl font-semibold text-white mb-4">
      <i class="fas fa-bolt"></i> Quick Actions
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <a href="/ops/webhooks/monitor" class="px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-center font-medium transition">
        <i class="fas fa-chart-line"></i> Webhook Monitor
      </a>
      <a href="/ops/debug/payments" class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-center font-medium transition">
        <i class="fas fa-bug"></i> Debug Payments
      </a>
      <a href="/ops/debug/checkout" class="px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg text-center font-medium transition">
        <i class="fas fa-shopping-cart"></i> Debug Checkout
      </a>
    </div>
  </div>
</div>

<script>
let statusCheckInterval;

async function checkStatus() {
  try {
    const response = await fetch('/ops/status/api');
    const data = await response.json();
    renderStatus(data);
  } catch (error) {
    renderError(error);
  }
}

function renderStatus(data) {
  const container = document.getElementById('statusContainer');
  
  const serverStatus = data.server?.running ? '✅ Running' : '❌ Not Running';
  const serverVersion = data.server?.version || 'unknown';
  const dbStatus = data.database?.connected ? '✅ Connected' : '❌ Disconnected';
  
  container.innerHTML = `
    <!-- Server Status -->
    <div class="bg-white/5 rounded-lg p-6 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">
          <i class="fas fa-server"></i> Server Status
        </h2>
        <span class="px-3 py-1 rounded-full text-sm font-medium ${data.server?.running ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
          ${serverStatus}
        </span>
      </div>
      <div class="space-y-2 text-white/80">
        <div><strong>Version:</strong> ${serverVersion}</div>
        <div><strong>Status:</strong> ${data.server?.ok ? 'OK' : 'Error'}</div>
        ${data.server?.error ? `<div class="text-red-400 text-sm mt-2">⚠️ ${data.server.error}</div>` : ''}
      </div>
    </div>

    <!-- Database Status -->
    <div class="bg-white/5 rounded-lg p-6 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">
          <i class="fas fa-database"></i> Database Status
        </h2>
        <span class="px-3 py-1 rounded-full text-sm font-medium ${data.database?.connected ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
          ${dbStatus}
        </span>
      </div>
      ${data.database?.error ? `<div class="text-red-400 text-sm">⚠️ ${data.database.error}</div>` : ''}
    </div>

    <!-- Webhook Listener Status -->
    <div class="bg-white/5 rounded-lg p-6 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">
          <i class="fas fa-satellite-dish"></i> Webhook Listener
        </h2>
        <span class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-500/20 text-yellow-400">
          ⚠️ Check Terminal
        </span>
      </div>
      <div class="space-y-3 text-white/80">
        <div>
          <strong>Instructions:</strong>
          <div class="bg-black/30 rounded-lg p-3 font-mono text-sm text-white/90 mt-2">
            <div class="text-green-400">$</div> ${data.webhook_listener?.instructions || './scripts/start_stripe_listen.sh'}
          </div>
        </div>
        <div class="text-sm text-white/60">
          ${data.webhook_listener?.check_terminal || "Look for 'Ready! Your webhook signing secret is whsec_...'"}
        </div>
        <div class="text-sm text-yellow-400">
          ${data.webhook_listener?.note || "Cannot auto-detect if Stripe CLI listener is running - check your terminal"}
        </div>
      </div>
    </div>

    <!-- Next Steps -->
    <div class="bg-white/5 rounded-lg p-6 border border-white/10 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
      <h2 class="text-xl font-semibold text-white mb-4">
        <i class="fas fa-list-check"></i> Next Steps
      </h2>
      <ul class="space-y-2">
        ${data.next_steps?.map(step => `
          <li class="flex items-start gap-2 text-white/80">
            <span class="text-green-400 mt-1">✓</span>
            <span>${step}</span>
          </li>
        `).join('') || '<li class="text-white/60">No next steps</li>'}
      </ul>
    </div>

    <!-- Last Updated -->
    <div class="text-center text-white/50 text-sm">
      Last updated: ${new Date(data.timestamp).toLocaleString()}
      <button onclick="checkStatus()" class="ml-4 px-3 py-1 bg-white/10 hover:bg-white/20 rounded text-sm border border-white/20">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  `;
}

function renderError(error) {
  const container = document.getElementById('statusContainer');
  container.innerHTML = `
    <div class="bg-red-500/20 rounded-lg p-6 border border-red-500/50 backdrop-filter: blur(12px) saturate(140%); -webkit-backdrop-filter: blur(12px) saturate(140%);">
      <div class="flex items-center gap-3 text-red-400">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
        <div>
          <h2 class="text-xl font-semibold">Error Checking Status</h2>
          <p class="text-sm mt-1">${error.message || 'Unknown error'}</p>
        </div>
      </div>
      <button onclick="checkStatus()" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition">
        <i class="fas fa-redo"></i> Retry
      </button>
    </div>
  `;
}

// Initial check
checkStatus();

// Auto-refresh every 10 seconds
statusCheckInterval = setInterval(checkStatus, 10000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  if (statusCheckInterval) {
    clearInterval(statusCheckInterval);
  }
});
</script>
{% endblock %}
