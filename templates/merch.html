{% extends "base.html" %}

{% block title %}Ahoy Merch - Ahoy Indie Media{% endblock %}

{% block content %}
<main class="page page-merch">
  <header class="page-header">
    <h1>Ahoy Merch</h1>
    <p class="page-subtitle">Support independent artists with shirts, posters, and more.</p>
  </header>

  <section id="merch-store" class="merch-store">
    <!-- Merch cards injected here -->
    <div class="merch-loading">Loading merch store...</div>
  </section>
</main>

<style>
/* Merch Page Styles */
.page-merch {
  padding: 1.5rem;
  max-width: 1400px;
  margin: 0 auto;
}

.page-header {
  margin-bottom: 1.5rem;
}

.page-header h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: var(--text-primary, #fff);
}

.page-subtitle {
  font-size: 1rem;
  color: var(--text-secondary, rgba(255, 255, 255, 0.7));
}

.merch-store {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 1.25rem;
}

.merch-loading, .merch-error, .merch-empty {
  grid-column: 1 / -1;
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary, rgba(255, 255, 255, 0.7));
  font-size: 1.2rem;
}

.merch-error {
  color: #ef4444;
}

.merch-card {
  background: var(--card-bg, rgba(255, 255, 255, 0.05));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--card-border, rgba(255, 255, 255, 0.1));
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex;
  flex-direction: column;
  position: relative;
}

.merch-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  border-color: var(--accent-color, #6366f1);
}

.merch-image-wrap {
  width: 100%;
  aspect-ratio: 1 / 1;
  background: rgba(0, 0, 0, 0.2);
  overflow: hidden;
  position: relative;
}

.merch-image-wrap img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.merch-card:hover .merch-image-wrap img {
  transform: scale(1.05);
}

.merch-bookmark-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.5);
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  cursor: pointer;
  z-index: 10;
  backdrop-filter: blur(4px);
  transition: all 0.2s ease;
  opacity: 0;
  transform: translateY(-5px);
}

.merch-card:hover .merch-bookmark-btn,
.merch-bookmark-btn.active {
  opacity: 1;
  transform: translateY(0);
}

.merch-bookmark-btn:hover {
  background: rgba(0, 0, 0, 0.8);
  transform: scale(1.1);
}

.merch-bookmark-btn.active {
  color: var(--accent-color, #6366f1);
  background: rgba(255, 255, 255, 0.9);
}

.merch-body {
  padding: 1rem;
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.merch-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0 0 0.25rem 0;
  color: var(--text-primary, #fff);
  line-height: 1.3;
}

.merch-artist {
  font-size: 0.85rem;
  color: var(--accent-color, #6366f1);
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.merch-description {
  font-size: 0.85rem;
  color: var(--text-secondary, rgba(255, 255, 255, 0.7));
  margin-bottom: 1rem;
  line-height: 1.4;
  flex-grow: 1;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.merch-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: auto;
}

.merch-price {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary, #fff);
}

.merch-buy-btn {
  background: var(--accent-color, #6366f1);
  color: white;
  border: none;
  padding: 0.4rem 1rem;
  border-radius: 9999px;
  font-weight: 600;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.2s;
}

.merch-buy-btn:hover {
  filter: brightness(1.1);
}

.merch-buy-btn:disabled {
  background: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.4);
  cursor: not-allowed;
  filter: none;
}

@media (max-width: 768px) {
  .page-merch {
    padding: 1rem;
  }
  
  .merch-store {
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 1rem;
  }
  
  .merch-bookmark-btn {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  loadMerchStore();
});

async function loadMerchStore() {
  const container = document.getElementById('merch-store');
  
  try {
    const response = await fetch('static/data/merch_products.json');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const products = await response.json();
    
    // Sort by name
    products.sort((a, b) => a.name.localeCompare(b.name));
    
    if (products.length === 0) {
      container.innerHTML = '<div class="merch-empty">No merch yet. Check back soon!</div>';
      return;
    }
    
    // Clear loading state
    container.innerHTML = '';
    
    // Render cards
    products.forEach(product => {
      const card = document.createElement('article');
      card.className = 'merch-card';
      card.dataset.id = product.id;
      
      const priceFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: product.currency || 'USD'
      }).format((product.price_cents || 0) / 100);
      
      const hasUrl = product.square_checkout_url && product.square_checkout_url.length > 0;
      const btnText = hasUrl ? 'Buy with Square' : 'Coming Soon';
      const btnDisabled = !hasUrl ? 'disabled' : '';
      
      // Bookmark state
      const isBookmarked = window.AhoyBookmarks ? window.AhoyBookmarks.isBookmarked('merch', product.id) : false;
      const bookmarkIcon = isBookmarked ? 'fas fa-bookmark' : 'far fa-bookmark';
      const bookmarkClass = isBookmarked ? 'active' : '';

      card.innerHTML = `
        <div class="merch-image-wrap">
          <img src="${product.image}" alt="${product.name}" loading="lazy">
          <button class="merch-bookmark-btn ${bookmarkClass}" type="button" aria-label="Bookmark this item">
            <i class="${bookmarkIcon}"></i>
          </button>
        </div>
        <div class="merch-body">
          <h3 class="merch-title">${product.name}</h3>
          <p class="merch-artist">${product.artist}</p>
          <p class="merch-description">${product.description || ''}</p>
          <div class="merch-footer">
            <span class="merch-price">${priceFormatted}</span>
            <button class="merch-buy-btn" type="button" ${btnDisabled}>
              ${btnText}
            </button>
          </div>
        </div>
      `;
      
      // Add event listener for buy button
      if (hasUrl) {
        const btn = card.querySelector('.merch-buy-btn');
        btn.addEventListener('click', () => {
          window.open(product.square_checkout_url, '_blank');
        });
      }

      // Add event listener for bookmark button
      const bookmarkBtn = card.querySelector('.merch-bookmark-btn');
      bookmarkBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (window.AhoyBookmarks) {
          const item = {
            type: 'merch',
            id: product.id,
            title: product.name,
            artwork: product.image,
            checkout_url: product.square_checkout_url
          };
          window.AhoyBookmarks.toggle(item);
        } else {
          console.warn('Bookmarks system not loaded');
        }
      });
      
      container.appendChild(card);
    });

    // Global listener for bookmark changes to update UI
    document.addEventListener('bookmarks:changed', (e) => {
      const item = e.detail.item;
      // If the changed item is merch, find its card and update
      if (item && item.type === 'merch') {
        const card = container.querySelector(`.merch-card[data-id="${item.id}"]`);
        if (card) {
          const btn = card.querySelector('.merch-bookmark-btn');
          const icon = btn.querySelector('i');
          const isActive = window.AhoyBookmarks.isBookmarked('merch', item.id);
          
          if (isActive) {
            btn.classList.add('active');
            icon.className = 'fas fa-bookmark';
          } else {
            btn.classList.remove('active');
            icon.className = 'far fa-bookmark';
          }
        }
      }
    });
    
  } catch (error) {
    console.error('Error loading merch:', error);
    container.innerHTML = `<div class="merch-error">Unable to load merch store. Please try again later.</div>`;
  }
}
</script>
{% endblock %}

