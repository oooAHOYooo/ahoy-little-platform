{% extends "base.html" %}

{% block title %}Search Results - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="search-results-page" x-data="searchResults()" x-init="init()">
    <!-- Header -->
    <div class="page-header">
        <div class="search-header">
            <div class="search-input-container">
                <input type="text" 
                    x-model="searchQuery" 
                    @keyup.enter="performSearch()"
                    placeholder="Search music, shows, artists..."
                    class="search-input-large">
                <button @click="performSearch()" class="search-btn-large">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="search-stats" x-show="searchResults.length > 0">
                <span x-text="`${searchResults.length} results for "${searchQuery}"`"></span>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="search-filters" x-show="searchResults.length > 0">
        <div class="filter-group">
            <label>Filter by:</label>
            <select x-model="selectedFilter" @change="filterResults()">
                <option value="all">All Results</option>
                <option value="music">Music</option>
                <option value="show">Shows</option>
                <option value="artist">Artists</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Sort by:</label>
            <select x-model="sortBy" @change="sortResults()">
                <option value="relevance">Relevance</option>
                <option value="title">Title</option>
                <option value="artist">Artist</option>
                <option value="date">Date</option>
            </select>
        </div>
        <div class="view-controls">
            <button @click="viewMode = 'grid'"
                :class="{'active': viewMode === 'grid'}"
                class="view-btn">
                <i class="fas fa-th"></i>
            </button>
            <button @click="viewMode = 'list'"
                :class="{'active': viewMode === 'list'}"
                class="view-btn">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>

    <!-- Search Results -->
    <div class="search-results" x-show="searchResults.length > 0">
        <!-- Grid View -->
        <div x-show="viewMode === 'grid'" class="search-grid">
            <template x-for="item in filteredResults" :key="item.id + '-' + item.kind">
                <div class="search-card" 
                     :class="{'music-card': item.kind === 'music', 'show-card': item.kind === 'show', 'artist-card': item.kind === 'artist'}"
                     @click="playContent(item)">
                    
                    <div class="card-cover">
                        <img :src="getItemImage(item)" 
                             :alt="item.title"
                             class="image-placeholder"
                             loading="lazy">
                        <div class="card-overlay">
                            <button @click.stop="playContent(item)" class="play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="card-actions">
                                <button class="action-btn bm-btn"
                                    @click.stop="toggleBookmark(item)"
                                    :aria-pressed="isBookmarked(item)"
                                    :class="{'just-bookmarked': isBookmarked(item)}">
                                    <span aria-hidden="true">
                                        <i x-show="isBookmarked(item)" class="fas fa-bookmark" style="color: var(--accent-color);"></i>
                                        <i x-show="!isBookmarked(item)" class="far fa-bookmark"></i>
                                    </span>
                                    <span class="sr-only" x-text="isBookmarked(item) ? 'Remove bookmark' : 'Add bookmark'"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-info">
                        <h4 x-text="item.title"></h4>
                        <p x-text="getItemSubtitle(item)"></p>
                        <div class="card-meta">
                            <span class="card-type" x-text="getItemTypeLabel(item.kind)"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- List View -->
        <div x-show="viewMode === 'list'" class="search-list">
            <div class="list-header">
                <span class="col-cover"></span>
                <span class="col-title">Title</span>
                <span class="col-subtitle">Artist/Host</span>
                <span class="col-type">Type</span>
                <span class="col-actions">Actions</span>
            </div>
            <div class="list-items">
                <template x-for="item in filteredResults" :key="item.id + '-' + item.kind">
                    <div class="list-item" @click="playContent(item)">
                        <div class="col-cover">
                            <img :src="getItemImage(item)" 
                                 :alt="item.title" 
                                 class="image-placeholder">
                            <div class="play-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="col-title">
                            <h4 x-text="item.title"></h4>
                        </div>
                        <div class="col-subtitle">
                            <p x-text="getItemSubtitle(item)"></p>
                        </div>
                        <div class="col-type">
                            <span class="type-badge" x-text="getItemTypeLabel(item.kind)"></span>
                        </div>
                        <div class="col-actions">
                            <button class="action-btn bm-btn"
                                @click.stop="toggleBookmark(item)"
                                :aria-pressed="isBookmarked(item)">
                                <span aria-hidden="true">
                                    <i x-show="isBookmarked(item)" class="fas fa-bookmark"></i>
                                    <i x-show="!isBookmarked(item)" class="far fa-bookmark"></i>
                                </span>
                                <span class="sr-only" x-text="isBookmarked(item) ? 'Remove bookmark' : 'Add bookmark'"></span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- No Results -->
    <div x-show="searchResults.length === 0 && hasSearched" class="no-results">
        <div class="no-results-content">
            <i class="fas fa-search"></i>
            <h3>No results found</h3>
            <p>Try searching for something else or check your spelling.</p>
            <div class="search-suggestions">
                <h4>Popular searches:</h4>
                <div class="suggestion-tags">
                    <button @click="searchSuggestion('indie rock')" class="suggestion-tag">Indie Rock</button>
                    <button @click="searchSuggestion('acoustic')" class="suggestion-tag">Acoustic</button>
                    <button @click="searchSuggestion('live performance')" class="suggestion-tag">Live Performance</button>
                    <button @click="searchSuggestion('new artist')" class="suggestion-tag">New Artist</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="loading-section">
        <div class="spinner"></div>
        <p>Searching...</p>
    </div>
</div>

<script>
function searchResults() {
    return {
        // State
        searchQuery: '',
        searchResults: [],
        filteredResults: [],
        selectedFilter: 'all',
        sortBy: 'relevance',
        viewMode: 'grid',
        isLoading: false,
        hasSearched: false,

        // Initialize
        init() {
            // Get search query from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            this.searchQuery = urlParams.get('q') || '';
            if (this.searchQuery) {
                this.performSearch();
            }
        },

        // Search functionality
        async performSearch() {
            if (!this.searchQuery.trim()) return;
            
            this.isLoading = true;
            this.hasSearched = true;
            
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(this.searchQuery)}`);
                const data = await response.json();
                this.searchResults = data.results || [];
                this.filteredResults = [...this.searchResults];
                this.sortResults();
            } catch (error) {
                console.error('Error performing search:', error);
                this.searchResults = [];
                this.filteredResults = [];
            } finally {
                this.isLoading = false;
            }
        },

        // Filter results
        filterResults() {
            if (this.selectedFilter === 'all') {
                this.filteredResults = [...this.searchResults];
            } else {
                this.filteredResults = this.searchResults.filter(item => 
                    item.kind === this.selectedFilter
                );
            }
            this.sortResults();
        },

        // Sort results
        sortResults() {
            this.filteredResults.sort((a, b) => {
                switch (this.sortBy) {
                    case 'title':
                        return (a.title || a.name || '').localeCompare(b.title || b.name || '');
                    case 'artist':
                        return (a.artist || a.host || '').localeCompare(b.artist || b.host || '');
                    case 'date':
                        return new Date(b.created_at || b.release_date || 0) - new Date(a.created_at || a.release_date || 0);
                    case 'relevance':
                    default:
                        return 0; // Keep original order for relevance
                }
            });
        },

        // Content actions
        playContent(item) {
            if (window.globalPlayer) {
                window.globalPlayer.playTrack(item);
            }
        },

        async saveContent(item) {
            try {
                const response = await fetch('/api/saves/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: item.type || 'music',
                        id: item.id,
                        data: item
                    })
                });
                
                if (response.ok) {
                    // Update UI to show saved state
                    item.saved = !item.saved;
                }
            } catch (error) {
                console.error('Error saving content:', error);
            }
        },

        async likeContent(item) {
            try {
                const response = await fetch('/api/likes/like', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: item.type || 'music',
                        id: item.id,
                        data: item
                    })
                });
                
                if (response.ok) {
                    // Update UI to show liked state
                    item.liked = !item.liked;
                }
            } catch (error) {
                console.error('Error liking content:', error);
            }
        },

        isSaved(item) {
            return item.saved || false;
        },

        isLiked(item) {
            return item.liked || false;
        },

        searchSuggestion(suggestion) {
            this.searchQuery = suggestion;
            this.performSearch();
        },

        // Helper functions for card layout
        getItemImage(item) {
            if (item.kind === 'music') {
                return item.cover_art || '/static/img/default-cover.jpg';
            } else if (item.kind === 'show') {
                return item.thumbnail || '/static/img/default-cover.jpg';
            } else if (item.kind === 'artist') {
                return item.image || '/static/img/default-avatar.png';
            }
            return '/static/img/default-cover.jpg';
        },

        getItemSubtitle(item) {
            if (item.kind === 'music') {
                return item.artist || item.fields?.artist || '';
            } else if (item.kind === 'show') {
                return item.host || item.fields?.host || '';
            } else if (item.kind === 'artist') {
                return item.fields?.name || item.name || '';
            }
            return '';
        },

        getItemTypeLabel(kind) {
            const labels = {
                'music': 'MUSIC',
                'show': 'SHOW', 
                'artist': 'ARTIST'
            };
            return labels[kind] || 'CONTENT';
        },

        async toggleBookmark(item) {
            try {
                const isBookmarked = this.isBookmarked(item);
                const url = isBookmarked ? `/api/bookmarks/${item.id}` : '/api/bookmarks';
                const method = isBookmarked ? 'DELETE' : 'POST';
                const body = isBookmarked ? null : JSON.stringify({
                    item_id: item.id,
                    item_type: item.kind
                });

                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: body
                });

                if (response.ok) {
                    // Update local state
                    item.bookmarked = !isBookmarked;
                    
                    // Trigger bookmark count update
                    if (window.navbar && window.navbar.loadBookmarkCount) {
                        window.navbar.loadBookmarkCount();
                    }
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
            }
        },

        isBookmarked(item) {
            return item.bookmarked || false;
        },

        // Utility functions
        formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString();
        }
    }
}
</script>
{% endblock %}
