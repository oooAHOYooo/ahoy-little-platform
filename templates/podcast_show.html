{% extends "base.html" %}

{% block title %}{{ show.title }} - Podcasts - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="podcast-show-page" x-data="podcastShow()" x-init="init()">
    <section class="podcast-show-hero">
        <img class="podcast-show-hero-art"
            src="{{ show.artwork or '/static/img/default-cover.jpg' }}"
            alt>
        <div class="podcast-show-hero-meta">
            <div class="podcast-show-hero-kicker">Podcast</div>
            <h1 class="podcast-show-hero-title">{{ show.title }}</h1>
            <p class="podcast-show-hero-desc">{{ show.description }}</p>

            <div class="podcast-show-hero-actions">
                <button type="button" class="podcast-cta"
                    @click="playLatest()">
                    <i class="fas fa-play" aria-hidden="true"></i>
                    Play Latest
                </button>
                <button type="button" class="podcast-cta secondary"
                    @click="toggleFollow()">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                    Follow / Save
                </button>
                <button type="button" class="podcast-cta secondary"
                    @click="openBoost()">
                    <i class="fas fa-bolt" aria-hidden="true"></i>
                    Boost
                </button>
            </div>
        </div>
    </section>

    <!-- Recent Queue Section -->
    <section class="podcasts-section" x-data="recentQueueSection()"
        x-init="init()" x-show="recentQueueItems.length > 0">
        <div class="podcasts-section-header">
            <h2>Recent Queue</h2>
            <span class="queue-count-badge"
                x-text="recentQueueItems.length"></span>
        </div>
        <div class="episode-list">
            <template x-for="(item, index) in recentQueueItems"
                :key="item.id || item.key || index">
                <article class="episode-row">
                    <img class="episode-art"
                        :src="item.cover_art || item.artwork || '/static/img/default-cover.jpg'"
                        alt>
                    <div class="episode-meta">
                        <div class="episode-title" x-text="item.title"></div>
                        <div class="episode-subtitle">
                            <span class="episode-time"
                                x-text="item.artist || item.showTitle || ''"></span>
                        </div>
                    </div>
                    <div class="episode-actions">
                        <button type="button" class="episode-btn"
                            @click="playFromQueue(index)" title="Play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                            <span class="sr-only">Play</span>
                        </button>
                        <button type="button" class="episode-btn"
                            @click="removeFromQueue(index)" title="Remove">
                            <i class="fas fa-times" aria-hidden="true"></i>
                            <span class="sr-only">Remove</span>
                        </button>
                    </div>
                </article>
            </template>
        </div>
    </section>
    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>Episodes</h2>
        </div>

        <div class="episode-list">
            <template x-for="ep in episodes" :key="ep.key">
                <article class="episode-row">
                    <img class="episode-art" :src="ep.artwork" alt>
                    <div class="episode-meta">
                        <div class="episode-title" x-text="ep.title"></div>
                        <div class="episode-subtitle">
                            <span class="episode-time"
                                x-text="ep.duration"></span>
                            <span class="episode-dot" x-show="ep.date">â€¢</span>
                            <span class="episode-date" x-show="ep.date"
                                x-text="ep.date"></span>
                        </div>
                        <div class="episode-desc" x-text="ep.description"></div>
                    </div>
                    <div class="episode-actions">
                        <button type="button" class="episode-btn"
                            @click="play(ep)" title="Play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                            <span class="sr-only">Play</span>
                        </button>
                        <div class="queue-container"
                            x-data="globalQueueHandler()" x-init="init()">
                            <button type="button" class="episode-btn queue-btn"
                                @click.stop="addToQueue('podcast-episode', ep.key, ep.title, ep.artwork, ep)"
                                :class="{ 'in-queue': isInQueue('podcast-episode', ep.key) }"
                                title="Add to queue">
                                <i
                                    :class="isInQueue('podcast-episode', ep.key) ? 'fas fa-check' : 'fas fa-plus'"
                                    aria-hidden="true"></i>
                                <span class="sr-only">Add to queue</span>
                            </button>
                        </div>
                        <button type="button" class="episode-btn bm-btn"
                            @click="toggleBookmark(ep)" title="Bookmark">
                            <i class="fas fa-bookmark" aria-hidden="true"></i>
                            <span class="sr-only">Bookmark</span>
                        </button>
                    </div>
                </article>
            </template>
        </div>
    </section>

</div>

<script>
    function podcastShow() {
        const show = {{ show|tojson|safe }};
        return {
            show,
            episodes: [],
            init() {
                const eps = (show.episodes || []).map(e => ({
                    key: `${show.slug}:${e.id}`,
                    showSlug: show.slug,
                    showTitle: show.title,
                    id: e.id,
                    title: e.title,
                    description: e.description || '',
                    date: e.date || '',
                    duration: e.duration || '',
                    duration_seconds: e.duration_seconds || 0,
                    artwork: e.artwork || show.artwork || '/static/img/default-cover.jpg',
                    audio_url: e.audio_url,
                    type: 'podcast',
                    artist: show.title,
                    cover_art: e.artwork || show.artwork || '/static/img/default-cover.jpg'
                }));
                // newest-first
                eps.sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')));
                this.episodes = eps;
            },
            async play(ep) {
                if (window.__ahoyEnsurePlayer) {
                    await window.__ahoyEnsurePlayer();
                }
                document.dispatchEvent(new CustomEvent('play-track', { detail: ep }));
            },
            playLatest() {
                if (!this.episodes.length) return;
                this.play(this.episodes[0]);
            },
            toggleFollow() {
                // Stub: wire to your follow system if/when it exists.
                document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Saved.' }));
            },
            toggleBookmark(ep) {
                if (!window.AhoyBookmarks) return;
                window.AhoyBookmarks.toggle({
                    type: 'podcast-episode',
                    id: ep.key,
                    title: ep.title,
                    artwork: ep.artwork
                });
                try {
                    document.dispatchEvent(new CustomEvent('bookmarks:changed', { detail: { item: ep } }));
                } catch (_) { }
            },
            openBoost() {
                // Keep wiring minimal for now; base.html will host the Boost modal.
                document.dispatchEvent(new CustomEvent('ahoy:boost:open', {
                    detail: { recipientType: 'podcast', recipientId: show.slug, recipientName: show.title }
                }));
            }
        };
    }

    // Recent Queue Section Handler
    function recentQueueSection() {
        return {
            recentQueueItems: [],
            
            init() {
                this.loadRecentQueue();
                // Listen for queue changes
                document.addEventListener('queue:changed', () => {
                    this.loadRecentQueue();
                });
            },
            
            loadRecentQueue() {
                if (window.playerQueue) {
                    const queue = window.playerQueue.getQueue();
                    // Show most recent items (last 5)
                    this.recentQueueItems = queue.slice(-5).reverse();
                }
            },
            
            playFromQueue(index) {
                // Calculate actual queue index (from the end)
                if (window.playerQueue) {
                    const queue = window.playerQueue.getQueue();
                    const actualIndex = queue.length - 1 - index;
                    const item = queue[actualIndex];
                    if (item) {
                        document.dispatchEvent(new CustomEvent('play-track', { detail: item }));
                    }
                }
            },
            
            removeFromQueue(index) {
                if (window.playerQueue) {
                    const queue = window.playerQueue.getQueue();
                    const actualIndex = queue.length - 1 - index;
                    window.playerQueue.remove(actualIndex);
                    this.loadRecentQueue();
                }
            }
        };
    }
</script>
{% endblock %}
