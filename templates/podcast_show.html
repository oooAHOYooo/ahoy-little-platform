{% extends "base.html" %}

{% block title %}{{ show.title }} - Podcasts - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="podcast-show-page" x-data="podcastShow()" x-init="init()">
    <section class="podcast-show-hero">
        <img class="podcast-show-hero-art"
            src="{{ show.artwork or '/static/img/default-cover.jpg' }}"
            alt="">
        <div class="podcast-show-hero-meta">
            <div class="podcast-show-hero-kicker">Podcast</div>
            <h1 class="podcast-show-hero-title">{{ show.title }}</h1>
            <p class="podcast-show-hero-desc">{{ show.description }}</p>

            <div class="podcast-show-hero-actions">
                <button type="button" class="podcast-cta"
                    @click="playLatest()">
                    <i class="fas fa-play" aria-hidden="true"></i>
                    Play Latest
                </button>
                <button type="button" class="podcast-cta secondary"
                    @click="toggleFollow()">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                    Follow / Save
                </button>
                <button type="button" class="podcast-cta secondary"
                    @click="openBoost()">
                    <i class="fas fa-bolt" aria-hidden="true"></i>
                    Boost
                </button>
            </div>
        </div>
    </section>

    <!-- Recent Queue Section -->
    <section class="podcasts-section" x-data="recentQueueSection()" x-init="init()" x-show="recentQueueItems.length > 0">
        <div class="podcasts-section-header">
            <h2>Recent Queue</h2>
            <span class="queue-count-badge" x-text="recentQueueItems.length"></span>
        </div>
        <div class="episode-list">
            <template x-for="(item, index) in recentQueueItems" :key="item.id || item.key || index">
                <article class="episode-row">
                    <img class="episode-art" :src="item.cover_art || item.artwork || '/static/img/default-cover.jpg'" alt="">
                    <div class="episode-meta">
                        <div class="episode-title" x-text="item.title"></div>
                        <div class="episode-subtitle">
                            <span class="episode-time" x-text="item.artist || item.showTitle || ''"></span>
                        </div>
                    </div>
                    <div class="episode-actions">
                        <button type="button" class="episode-btn"
                            @click="playFromQueue(index)" title="Play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                            <span class="sr-only">Play</span>
                        </button>
                        <button type="button" class="episode-btn"
                            @click="removeFromQueue(index)" title="Remove">
                            <i class="fas fa-times" aria-hidden="true"></i>
                            <span class="sr-only">Remove</span>
                        </button>
                    </div>
                </article>
            </template>
        </div>
    </section>
    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>Episodes</h2>
        </div>

        <div class="episode-list">
            <template x-for="ep in episodes" :key="ep.key">
                <article class="episode-row">
                    <img class="episode-art" :src="ep.artwork" alt="">
                    <div class="episode-meta">
                        <div class="episode-title" x-text="ep.title"></div>
                        <div class="episode-subtitle">
                            <span class="episode-time" x-text="ep.duration"></span>
                            <span class="episode-dot" x-show="ep.date">â€¢</span>
                            <span class="episode-date" x-show="ep.date" x-text="ep.date"></span>
                        </div>
                        <div class="episode-desc" x-text="ep.description"></div>
                    </div>
                    <div class="episode-actions">
                        <button type="button" class="episode-btn"
                            @click="play(ep)" title="Play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                            <span class="sr-only">Play</span>
                        </button>
                        <div class="queue-container" x-data="globalQueueHandler()" x-init="init()">
                            <button type="button" class="episode-btn queue-btn"
                                @click.stop="addToQueue('podcast-episode', ep.key, ep.title, ep.artwork, ep)"
                                :class="{ 'in-queue': isInQueue('podcast-episode', ep.key) }"
                                title="Add to queue">
                                <i :class="isInQueue('podcast-episode', ep.key) ? 'fas fa-check' : 'fas fa-plus'" aria-hidden="true"></i>
                                <span class="sr-only">Add to queue</span>
                            </button>
                        </div>
                        <button type="button" class="episode-btn bm-btn"
                            @click="toggleBookmark(ep)" title="Bookmark">
                            <i class="fas fa-bookmark" aria-hidden="true"></i>
                            <span class="sr-only">Bookmark</span>
                        </button>
                    </div>
                </article>
            </template>
        </div>
    </section>

    <!-- Contact Form Section -->
    <section class="podcast-contact-section">
        <div class="podcast-contact-container">
            <div class="podcast-contact-header">
                <h2>Get in Touch</h2>
                <p>Have a question, topic suggestion, or want to be a guest on {{ show.title }}? We'd love to hear from you.</p>
            </div>

            <form 
                id="podcastContactForm"
                action="https://formspree.io/f/YOUR_FORM_ID" 
                method="POST"
                x-data="podcastContactForm()"
                @submit.prevent="submitForm"
                class="podcast-contact-form">
                
                <!-- Hidden field for show name -->
                <input type="hidden" name="podcast_show" :value="show.title">
                <input type="hidden" name="show_slug" :value="show.slug">

                <!-- Name Field -->
                <div class="form-group">
                    <label for="contact_name">Name <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="contact_name" 
                        name="name" 
                        x-model="formData.name"
                        required
                        placeholder="Your name"
                        class="form-input"
                        aria-required="true">
                </div>

                <!-- Email Field -->
                <div class="form-group">
                    <label for="contact_email">Email <span class="required">*</span></label>
                    <input 
                        type="email" 
                        id="contact_email" 
                        name="email" 
                        x-model="formData.email"
                        required
                        placeholder="your@email.com"
                        class="form-input"
                        aria-required="true">
                </div>

                <!-- Subject Field -->
                <div class="form-group">
                    <label for="contact_subject">What's this about?</label>
                    <select 
                        id="contact_subject" 
                        name="subject" 
                        x-model="formData.subject"
                        class="form-input">
                        <option value="">Select a topic...</option>
                        <option value="guest">I want to be a guest</option>
                        <option value="topic">Topic suggestion</option>
                        <option value="question">Question about the show</option>
                        <option value="collaboration">Collaboration opportunity</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Message Field -->
                <div class="form-group">
                    <label for="contact_message">Message <span class="required">*</span></label>
                    <textarea 
                        id="contact_message" 
                        name="message" 
                        x-model="formData.message"
                        required
                        rows="6"
                        placeholder="Tell us what's on your mind..."
                        class="form-input form-textarea"
                        aria-required="true"></textarea>
                </div>

                <!-- Honeypot field for spam protection -->
                <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off">

                <!-- Submit Button -->
                <div class="form-actions">
                    <button 
                        type="submit" 
                        :disabled="isSubmitting"
                        class="btn btn-primary btn-large">
                        <i class="fas fa-paper-plane" x-show="!isSubmitting"></i>
                        <i class="fas fa-spinner fa-spin" x-show="isSubmitting"></i>
                        <span x-text="isSubmitting ? 'Sending...' : 'Send Message'"></span>
                    </button>
                </div>

                <!-- Success/Error Messages -->
                <div x-show="showSuccess" class="form-message form-message-success" x-cloak>
                    <i class="fas fa-check-circle"></i>
                    <p>Thank you! Your message has been sent successfully. We'll get back to you soon.</p>
                </div>

                <div x-show="showError" class="form-message form-message-error" x-cloak>
                    <i class="fas fa-exclamation-circle"></i>
                    <p x-text="errorMessage"></p>
                </div>
            </form>
        </div>
    </section>
</div>

<style>
.podcast-contact-section {
    padding: 3rem 1.5rem;
    background: rgba(255, 255, 255, 0.02);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.podcast-contact-container {
    max-width: 800px;
    margin: 0 auto;
}

.podcast-contact-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.podcast-contact-header h2 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.75rem 0;
    color: white;
}

.podcast-contact-header p {
    font-size: 1.125rem;
    color: rgba(255, 255, 255, 0.7);
    margin: 0;
}

.podcast-contact-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2rem;
}

.podcast-contact-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.podcast-contact-form label {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.podcast-contact-form .required {
    color: #ff6b6b;
}

.podcast-contact-form .form-input,
.podcast-contact-form .form-textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s;
}

.podcast-contact-form .form-input:focus,
.podcast-contact-form .form-textarea:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.08);
}

.podcast-contact-form .form-input::placeholder,
.podcast-contact-form .form-textarea::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

.podcast-contact-form .form-textarea {
    resize: vertical;
    min-height: 120px;
}

.podcast-contact-form .form-actions {
    margin-top: 0.5rem;
}

.podcast-contact-form .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 2rem;
    background: white;
    color: black;
    border: none;
    border-radius: 99px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}

.podcast-contact-form .btn:hover:not(:disabled) {
    background: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
}

.podcast-contact-form .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.podcast-contact-form .btn-large {
    padding: 1rem 2.5rem;
    font-size: 1.125rem;
}

.podcast-contact-form .form-message {
    padding: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-top: 1rem;
}

.podcast-contact-form .form-message i {
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 0.125rem;
}

.podcast-contact-form .form-message-success {
    background: rgba(76, 175, 80, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.3);
    color: #81c784;
}

.podcast-contact-form .form-message-error {
    background: rgba(244, 67, 54, 0.1);
    border: 1px solid rgba(244, 67, 54, 0.3);
    color: #ef5350;
}

.podcast-contact-form .form-message p {
    margin: 0;
    line-height: 1.5;
}

@media (max-width: 768px) {
    .podcast-contact-section {
        padding: 2rem 1rem;
    }

    .podcast-contact-form {
        padding: 1.5rem;
    }

    .podcast-contact-header h2 {
        font-size: 1.75rem;
    }
}
</style>

<script>
function podcastContactForm() {
    return {
        formData: {
            name: '',
            email: '',
            subject: '',
            message: ''
        },
        isSubmitting: false,
        showSuccess: false,
        showError: false,
        errorMessage: '',

        async submitForm() {
            // Reset messages
            this.showSuccess = false;
            this.showError = false;
            this.errorMessage = '';

            // Validate
            if (!this.formData.name.trim() || !this.formData.email.trim() || !this.formData.message.trim()) {
                this.showError = true;
                this.errorMessage = 'Please fill in all required fields.';
                return;
            }

            this.isSubmitting = true;

            try {
                const form = document.getElementById('podcastContactForm');
                const formData = new FormData(form);

                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    this.showSuccess = true;
                    // Reset form
                    this.formData = {
                        name: '',
                        email: '',
                        subject: '',
                        message: ''
                    };
                    form.reset();
                    
                    // Scroll to success message
                    setTimeout(() => {
                        const successMsg = document.querySelector('.form-message-success');
                        if (successMsg) {
                            successMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }, 100);
                } else {
                    const data = await response.json();
                    this.showError = true;
                    this.errorMessage = data.error || 'Something went wrong. Please try again.';
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                this.showError = true;
                this.errorMessage = 'Network error. Please check your connection and try again.';
            } finally {
                this.isSubmitting = false;
            }
        }
    }
}
</script>

<script>
    function podcastShow() {
        const show = {{ show|tojson|safe }};
        return {
            show,
            episodes: [],
            init() {
                const eps = (show.episodes || []).map(e => ({
                    key: `${show.slug}:${e.id}`,
                    showSlug: show.slug,
                    showTitle: show.title,
                    id: e.id,
                    title: e.title,
                    description: e.description || '',
                    date: e.date || '',
                    duration: e.duration || '',
                    duration_seconds: e.duration_seconds || 0,
                    artwork: e.artwork || show.artwork || '/static/img/default-cover.jpg',
                    audio_url: e.audio_url,
                    type: 'podcast',
                    artist: show.title,
                    cover_art: e.artwork || show.artwork || '/static/img/default-cover.jpg'
                }));
                // newest-first
                eps.sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')));
                this.episodes = eps;
            },
            play(ep) {
                document.dispatchEvent(new CustomEvent('play-track', { detail: ep }));
            },
            playLatest() {
                if (!this.episodes.length) return;
                this.play(this.episodes[0]);
            },
            toggleFollow() {
                // Stub: wire to your follow system if/when it exists.
                document.dispatchEvent(new CustomEvent('ahoy:toast', { detail: 'Saved.' }));
            },
            toggleBookmark(ep) {
                if (!window.AhoyBookmarks) return;
                window.AhoyBookmarks.toggle({
                    type: 'podcast-episode',
                    id: ep.key,
                    title: ep.title,
                    artwork: ep.artwork
                });
                try {
                    document.dispatchEvent(new CustomEvent('bookmarks:changed', { detail: { item: ep } }));
                } catch (_) { }
            },
            openBoost() {
                // Keep wiring minimal for now; base.html will host the Boost modal.
                document.dispatchEvent(new CustomEvent('ahoy:boost:open', {
                    detail: { recipientType: 'podcast', recipientId: show.slug, recipientName: show.title }
                }));
            }
        };
    }

    // Recent Queue Section Handler
    function recentQueueSection() {
        return {
            recentQueueItems: [],
            
            init() {
                this.loadRecentQueue();
                // Listen for queue changes
                document.addEventListener('queue:changed', () => {
                    this.loadRecentQueue();
                });
            },
            
            loadRecentQueue() {
                if (window.playerQueue) {
                    const queue = window.playerQueue.getQueue();
                    // Show most recent items (last 5)
                    this.recentQueueItems = queue.slice(-5).reverse();
                }
            },
            
            playFromQueue(index) {
                // Calculate actual queue index (from the end)
                if (window.playerQueue) {
                    const queue = window.playerQueue.getQueue();
                    const actualIndex = queue.length - 1 - index;
                    const item = queue[actualIndex];
                    if (item) {
                        document.dispatchEvent(new CustomEvent('play-track', { detail: item }));
                    }
                }
            },
            
            removeFromQueue(index) {
                if (window.playerQueue) {
                    const queue = window.playerQueue.getQueue();
                    const actualIndex = queue.length - 1 - index;
                    window.playerQueue.remove(actualIndex);
                    this.loadRecentQueue();
                }
            }
        };
    }
</script>
{% endblock %}

