{% extends "base.html" %}

{% block title %}Your Creative Portfolio - Ahoy Indie Media{% endblock %}

{% block extra_css %}
<style>
    /* Fintech-inspired dark UI for portfolio */
    .portfolio-page {
        min-height: 100vh;
        background: #0f0f14;
        padding: 2rem 1rem;
        color: #f0f0f7;
    }

    /* Sandbox banner */
    .sandbox-banner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
        background: rgba(255, 255, 255, 0.06);
        border: 1px dashed rgba(255, 255, 255, 0.18);
        color: #eaeaf2;
        padding: .65rem .9rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    .sandbox-pill {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        padding: .25rem .6rem;
        border-radius: 999px;
        background: #1b1b22;
        border: 1px solid rgba(255,255,255,.15);
        color: #cfd1da;
        font-size: .8rem;
        font-weight: 700;
    }
    .sandbox-banner .actions {
        display: flex;
        gap: .5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    .btn-ghost {
        background: transparent;
        border: 1px solid rgba(255,255,255,.18);
        color: #f0f0f7;
        border-radius: 8px;
        padding: .45rem .7rem;
        font-weight: 600;
        cursor: pointer;
    }
    .btn-ghost:hover { background: rgba(255,255,255,.06); }

    .portfolio-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .hero-header {
        text-align: center;
        color: #f0f0f7;
        margin-bottom: 2rem;
    }

    .hero-header h1 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
        letter-spacing: 0.2px;
    }

    .hero-header p {
        font-size: 0.95rem;
        color: #a6a6b3;
    }

    /* KPI strip */
    .portfolio-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .stat-card .stat-value {
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum";
        font-size: 1.6rem;
        font-weight: 800;
        color: #f0f0f7;
        margin-bottom: 0.25rem;
    }

    .stat-card .stat-label {
        color: #7a7a89;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    /* Charts */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .chart-card h3 {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: #e6e6f0;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    /* Positions table */
    .positions-table-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .positions-table-section h3 {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: #e6e6f0;
    }

    .positions-table {
        width: 100%;
        border-collapse: collapse;
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum";
    }

    .positions-table thead th {
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .positions-table th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 700;
        color: #c6c6d0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .positions-table td {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        color: #e6e6f0;
    }

    .positions-table tbody tr:nth-child(odd) {
        background: rgba(255, 255, 255, 0.02);
    }

    .positions-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    /* Column alignment: amount and weight right aligned */
    .positions-table td:nth-child(2),
    .positions-table td:nth-child(3) {
        text-align: right;
    }

    .artist-name {
        font-weight: 700;
        color: #f0f0f7;
    }

    .amount {
        font-weight: 800;
        color: #8be1c7;
    }

    .weight {
        display: inline-block;
        background: rgba(139, 225, 199, 0.08);
        border: 1px solid rgba(139, 225, 199, 0.25);
        color: #b5f2de;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .last-boost {
        color: #a6a6b3;
        font-size: 0.82rem;
    }

    /* Empty states */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #e6e6f0;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
        opacity: 0.65;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
        font-weight: 700;
    }

    .empty-state p {
        color: #a6a6b3;
    }

    @media (max-width: 768px) {
        .hero-header h1 { font-size: 1.5rem; }
        .charts-section { grid-template-columns: 1fr; }
        .positions-table { font-size: 0.875rem; }
        .positions-table th, .positions-table td { padding: 0.5rem; }
    }

    /* Sticky Make it Real bar */
    .make-real-bar {
        position: sticky;
        bottom: 0;
        margin-top: 1.25rem;
        background: linear-gradient(180deg, rgba(15,15,20,0) 0%, rgba(15,15,20,0.9) 20%, rgba(15,15,20,1) 100%);
        padding-top: 1rem;
    }
    .make-real-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
        border: 1px solid rgba(255,255,255,.08);
        background: rgba(255,255,255,.04);
        border-radius: 12px;
        padding: .75rem .9rem;
    }
    .btn-primary {
        background: #6366f1;
        border: 1px solid #6366f1;
        color: #fff;
        border-radius: 10px;
        padding: .6rem .9rem;
        font-weight: 800;
        cursor: pointer;
    }
    .btn-primary:hover { filter: brightness(1.05); }

    /* Compact wizard */
    .wizard-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.55);
        display: grid;
        place-items: center;
        z-index: 60;
    }
    .wizard {
        width: 96%;
        max-width: 520px;
        background: #111119;
        border: 1px solid rgba(255,255,255,.12);
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,.55);
    }
    .wizard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: .9rem 1rem;
        background: linear-gradient(135deg, rgba(99,102,241,.15), rgba(168,85,247,.12));
        border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .wizard-title { font-weight: 800; }
    .wizard-body { padding: 1rem; color: #dfe1ea; }
    .wizard-steps {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: .5rem;
        margin-bottom: .75rem;
    }
    .wizard-step {
        height: .35rem;
        border-radius: 999px;
        background: rgba(255,255,255,.12);
    }
    .wizard-step.active { background: linear-gradient(90deg,#6366f1,#a855f7); }
    .wizard-actions { display: flex; justify-content: flex-end; gap: .5rem; padding: .75rem 1rem 1rem; }
    .btn-secondary {
        background: rgba(255,255,255,.06);
        border: 1px solid rgba(255,255,255,.16);
        color: #f0f0f7;
        border-radius: 10px;
        padding: .5rem .8rem;
        font-weight: 700;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="portfolio-page" x-data="portfolioWidget()" x-init="init()">
    <div class="portfolio-container">
        <!-- Practice (Sandbox) banner -->
        <div class="sandbox-banner" x-show="sandboxEnabled">
            <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
                <span class="sandbox-pill"><i class="fas fa-coins"></i> Practice mode</span>
                <span style="color:#c7c8d4">You’re using sample “fake money” to preview your portfolio.</span>
            </div>
            <div class="actions">
                <button class="btn-ghost" @click="resetSandbox()">Reset practice data</button>
                <button class="btn-ghost" @click="disableSandbox()">Use real data</button>
            </div>
        </div>
        <!-- Hero Header -->
        <div class="hero-header">
            <h1>Your Creative Portfolio</h1>
            <p>Track your investments in independent artists</p>
        </div>

        <!-- Loading State -->
        <div x-show="isLoading" class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>Loading your portfolio...</h3>
        </div>

        <!-- Empty State -->
        <div x-show="!isLoading && totalContributed === 0" class="empty-state">
            <i class="fas fa-chart-line"></i>
            <h3>No Positions Yet</h3>
            <p x-show="!sandboxEnabled">Start boosting artists to build your creative portfolio!</p>
            <div x-show="sandboxEnabled" style="margin-top:10px">
                <button class="btn-primary" @click="seedSandbox()">Generate sample positions</button>
            </div>
        </div>

        <!-- Portfolio Content -->
        <div x-show="!isLoading && totalContributed > 0">
            <!-- Stats Cards -->
            <div class="portfolio-stats">
                <div class="stat-card">
                    <div class="stat-value" x-text="'$' + totalContributed.toFixed(2)"></div>
                    <div class="stat-label">Total Invested</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" x-text="positionCount"></div>
                    <div class="stat-label">Artists Supported</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" x-text="averageContribution.toFixed(2)"></div>
                    <div class="stat-label">Avg per Artist</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Pie Chart -->
                <div class="chart-card">
                    <h3>Contributions by Artist</h3>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>

                <!-- Timeline Chart -->
                <div class="chart-card">
                    <h3>Contribution Timeline</h3>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Positions Table -->
            <div class="positions-table-section">
                <h3>Your Positions</h3>
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>Artist</th>
                            <th>Total Contributed</th>
                            <th>Weight %</th>
                            <th>Last Boost</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="position in positions" :key="position.artist_id">
                            <tr>
                                <td>
                                    <span class="artist-name" x-text="position.artist_name"></span>
                                </td>
                                <td>
                                    <span class="amount" x-text="'$' + position.total_contributed.toFixed(2)"></span>
                                </td>
                                <td>
                                    <span class="weight" x-text="position.weight + '%'"></span>
                                </td>
                                <td>
                                    <span class="last-boost" x-text="formatDate(position.last_boost)"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sticky Make it real bar -->
        <div class="make-real-bar" x-show="sandboxEnabled">
            <div class="make-real-inner">
                <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;">
                    <i class="fas fa-info-circle" style="opacity:.9"></i>
                    <div>
                        <div style="font-weight:700;">You’re previewing with practice dollars</div>
                        <div style="font-size:.85rem;color:#b9bcc9;">Create an account to make your portfolio real.</div>
                    </div>
                </div>
                <button class="btn-primary" @click="openWizard()">Make it real</button>
            </div>
        </div>
    </div>

    <!-- Wizard modal -->
    <template x-if="wizardOpen">
        <div class="wizard-backdrop" @click.self="closeWizard()">
            <div class="wizard" role="dialog" aria-modal="true">
                <div class="wizard-header">
                    <div class="wizard-title">Get Started</div>
                    <button class="btn-ghost" @click="closeWizard()">Close</button>
                </div>
                <div class="wizard-body">
                    <div class="wizard-steps">
                        <div class="wizard-step" :class="{'active': wizardStep >= 1}"></div>
                        <div class="wizard-step" :class="{'active': wizardStep >= 2}"></div>
                        <div class="wizard-step" :class="{'active': wizardStep >= 3}"></div>
                        <div class="wizard-step" :class="{'active': wizardStep >= 4}"></div>
                    </div>
                    <div x-show="wizardStep === 1">
                        <h3 style="margin:0 0 .35rem 0;">Create your account</h3>
                        <p style="color:#bfc2cf;margin:0 0 .5rem 0;">We’ll set up a profile so you can track your real positions.</p>
                        <button class="btn-primary" @click="goToAccount()">Sign up / Log in</button>
                    </div>
                    <div x-show="wizardStep === 2">
                        <h3 style="margin:0 0 .35rem 0;">Verify your email</h3>
                        <p style="color:#bfc2cf;margin:0;">We’ll send a code to confirm it’s you.</p>
                    </div>
                    <div x-show="wizardStep === 3">
                        <h3 style="margin:0 0 .35rem 0;">Add a payment method</h3>
                        <p style="color:#bfc2cf;margin:0;">Securely add a card to fund your boosts.</p>
                    </div>
                    <div x-show="wizardStep === 4">
                        <h3 style="margin:0 0 .35rem 0;">Start boosting artists</h3>
                        <p style="color:#bfc2cf;margin:0;">Your portfolio will update as you support creators.</p>
                    </div>
                </div>
                <div class="wizard-actions">
                    <button class="btn-secondary" @click="prevStep()" :disabled="wizardStep===1">Back</button>
                    <button class="btn-primary" @click="nextStep()">{{ wizardStep < 4 ? 'Continue' : 'Finish' }}</button>
                </div>
            </div>
        </div>
    </template>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    function portfolioWidget() {
        return {
            isLoading: true,
            totalContributed: 0,
            positionCount: 0,
            positions: [],
            timeline: [],
            pieData: [],
            pieChart: null,
            timelineChart: null,
            // Sandbox state
            sandboxEnabled: true,
            wizardOpen: false,
            wizardStep: 1,

            get averageContribution() {
                return this.positionCount > 0 ? this.totalContributed / this.positionCount : 0;
            },

            async init() {
                // Load sandbox flag from storage (default: true for first-time visitors)
                try {
                    const stored = localStorage.getItem('portfolio:sandboxEnabled');
                    this.sandboxEnabled = stored === null ? true : stored === 'true';
                } catch (_) {}
                await (this.sandboxEnabled ? this.loadSandboxData() : this.loadPortfolioData());
            },

            async loadPortfolioData() {
                try {
                    this.isLoading = true;
                    const response = await fetch('/portfolio/data');
                    if (!response.ok) {
                        throw new Error('Failed to load portfolio data');
                    }
                    const data = await response.json();

                    this.totalContributed = data.total_contributed || 0;
                    this.positionCount = data.position_count || 0;
                    this.positions = data.positions || [];
                    this.timeline = data.timeline || [];
                    this.pieData = data.pie_data || [];

                    // Render charts after data is loaded
                    this.$nextTick(() => {
                        this.renderPieChart();
                        this.renderTimelineChart();
                    });
                } catch (error) {
                    console.error('Error loading portfolio data:', error);
                } finally {
                    this.isLoading = false;
                }
            },

            async loadSandboxData() {
                this.isLoading = true;
                try {
                    // Load or seed local sample data
                    const saved = localStorage.getItem('portfolio:sandboxData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.applyData(data);
                    } else {
                        this.seedSandbox();
                    }
                } catch (e) {
                    this.seedSandbox();
                } finally {
                    this.isLoading = false;
                }
            },

            seedSandbox() {
                // Simple sample dataset
                const now = new Date();
                const daysAgo = (n) => {
                    const d = new Date(now); d.setDate(d.getDate() - n); return d.toISOString().slice(0,10);
                };
                const data = {
                    total_contributed: 75,
                    position_count: 3,
                    positions: [
                        { artist_id: 'artist-a', artist_name: 'Echo Valence', total_contributed: 35, weight: 46.67, last_boost: new Date().toISOString(), created_at: now.toISOString() },
                        { artist_id: 'artist-b', artist_name: 'Neon Harbor', total_contributed: 25, weight: 33.33, last_boost: new Date(Date.now()-86400000*3).toISOString(), created_at: now.toISOString() },
                        { artist_id: 'artist-c', artist_name: 'Analog Vista', total_contributed: 15, weight: 20.00, last_boost: new Date(Date.now()-86400000*8).toISOString(), created_at: now.toISOString() },
                    ],
                    timeline: [
                        { date: daysAgo(14), amount: 10 },
                        { date: daysAgo(7), amount: 15 },
                        { date: daysAgo(3), amount: 25 },
                        { date: daysAgo(0), amount: 25 },
                    ],
                    pie_data: [
                        { artist_id: 'artist-a', artist_name: 'Echo Valence', amount: 35 },
                        { artist_id: 'artist-b', artist_name: 'Neon Harbor', amount: 25 },
                        { artist_id: 'artist-c', artist_name: 'Analog Vista', amount: 15 },
                    ]
                };
                try { localStorage.setItem('portfolio:sandboxData', JSON.stringify(data)); } catch (_) {}
                this.applyData(data);
            },

            applyData(data) {
                this.totalContributed = data.total_contributed || 0;
                this.positionCount = data.position_count || 0;
                this.positions = data.positions || [];
                this.timeline = data.timeline || [];
                this.pieData = data.pie_data || [];
                this.$nextTick(() => {
                    this.renderPieChart();
                    this.renderTimelineChart();
                });
            },

            resetSandbox() {
                try { localStorage.removeItem('portfolio:sandboxData'); } catch (_) {}
                this.seedSandbox();
            },

            disableSandbox() {
                this.sandboxEnabled = false;
                try { localStorage.setItem('portfolio:sandboxEnabled', 'false'); } catch (_) {}
                this.loadPortfolioData();
            },

            openWizard() { this.wizardOpen = true; this.wizardStep = 1; },
            closeWizard() { this.wizardOpen = false; },
            nextStep() { if (this.wizardStep < 4) this.wizardStep += 1; else this.closeWizard(); },
            prevStep() { if (this.wizardStep > 1) this.wizardStep -= 1; },
            goToAccount() { window.location.href = '/account'; },

            renderPieChart() {
                const ctx = document.getElementById('pieChart');
                if (!ctx || this.pieData.length === 0) return;

                // Destroy existing chart if it exists
                if (this.pieChart) {
                    this.pieChart.destroy();
                }

                const colors = [
                    '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                    '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#330867'
                ];

                this.pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: this.pieData.map(d => d.artist_name),
                        datasets: [{
                            data: this.pieData.map(d => d.amount),
                            backgroundColor: colors.slice(0, this.pieData.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            },

            renderTimelineChart() {
                const ctx = document.getElementById('timelineChart');
                if (!ctx || this.timeline.length === 0) return;

                // Destroy existing chart if it exists
                if (this.timelineChart) {
                    this.timelineChart.destroy();
                }

                // Calculate cumulative amounts
                let cumulative = 0;
                const cumulativeData = this.timeline.map(item => {
                    cumulative += item.amount;
                    return cumulative;
                });

                this.timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.timeline.map(d => this.formatDateShort(d.date)),
                        datasets: [{
                            label: 'Cumulative Contributions',
                            data: cumulativeData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `Total: $${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
            },

            formatDate(dateString) {
                if (!dateString) return 'Never';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },

            formatDateShort(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        };
    }
</script>
{% endblock %}