{% extends "base.html" %}

{% block title %}Music Library - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="music-container" x-data="musicLibrary()" x-init="loadMusic()">
    <!-- Unified Rotating Hero -->
    <section class="unified-hero tv-hero" x-data="createUnifiedHero({ pageType: 'music', rotationSpeed: 3000 })" x-init="init()"
        @touchstart="handleTouchStart" @touchmove="handleTouchMove" @touchend="handleTouchEnd">
        <div class="unified-hero-feed hero-feed" :style="`transform: translateX(${heroOffset}px)`">
            <template x-for="(item, index) in heroItems" :key="item.id">
                <div class="hero-item" x-show="getItemImage(item)"
                    :class="{'active': currentHeroIndex === index}"
                    :style="`background-image: url(${getItemImage(item)})`"
                    @click="playHeroItem(item)">
                    <div class="hero-overlay">
                        <div class="hero-content">
                            <div class="hero-badge" x-text="getPageBadge()"></div>
                            <h1 x-text="getItemTitle(item)"></h1>
                            <p x-text="getItemSubtitle(item)"></p>
                            <button @click.stop="playHeroItem(item)" class="hero-play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div class="hero-controls">
            <button @click="prevHero()" class="hero-nav">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button @click="nextHero()" class="hero-nav">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="hero-indicators">
            <template x-for="(item, index) in heroItems" :key="item.id">
                <button @click="setHeroIndex(index)" :class="{'active': currentHeroIndex === index}" class="hero-dot"></button>
            </template>
        </div>
    </section>
    <!-- Unified Header Section -->
    <section class="unified-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-text">
                    <h1><i class="fas fa-music"></i> Music Library</h1>
                    <p>Discover tracks, albums, and artists</p>
                    <div class="header-stats" x-show="bookmarkCount() > 0">
                        <a href="/bookmarks" class="bookmark-count-badge">
                            <i class="fas fa-bookmark"></i>
                            <span x-text="bookmarkCount()"></span>
                            <span x-text="bookmarkCount() === 1 ? 'saved' : 'saved'"></span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="header-search">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text"
                        x-model="searchQuery"
                        @input="filterMusic()"
                        placeholder="Search music, artists, or genres..."
                        class="search-input">
                    <button @click="clearSearch()" class="search-clear"
                        x-show="searchQuery">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="header-filters">
                <div class="filter-group">
                    <label>Artist:</label>
                    <select x-model="selectedArtist" @change="filterMusic()">
                        <option value>All Artists</option>
                        <template x-for="artist in artists" :key="artist">
                            <option :value="artist" x-text="artist"></option>
                        </template>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Sort by:</label>
                    <select x-model="sortBy" @change="sortMusic()">
                        <option value="title">Title</option>
                        <option value="artist">Artist</option>
                        <option value="added_date">Date Added</option>
                    </select>
                </div>
            </div>

            <div class="header-actions">
                <div class="view-options">
                    <button @click="viewMode = 'grid'"
                        :class="{'active': viewMode === 'grid'}"
                        class="view-btn">
                        <i class="fas fa-th"></i>
                    </button>
                    <button @click="viewMode = 'list'"
                        :class="{'active': viewMode === 'list'}"
                        class="view-btn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <button @click="playRandomTrack()"
                    class="btn btn-primary btn-large">
                    <i class="fas fa-play"></i> Play Random
                </button>
            </div>
        </div>
    </section>

    <!-- Music Grid View -->
    <div x-show="viewMode === 'grid'" class="music-grid">
        <template x-for="track in filteredTracks" :key="track.id">
            <div class="track-card"
                @click="playTrack(track)"
                :class="{'playing': currentTrack?.id === track.id}">

                <div class="track-cover">
                    <img
                        :src="track.cover_art || '/static/img/default-cover.jpg'"
                        :alt="track.title"
                        class="image-placeholder"
                        loading="lazy">
                    <div class="track-overlay">
                        <button @click.stop="playTrack(track)" class="play-btn">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="track-actions">
                            <button class="action-btn save-btn bm-btn"
                                @click.stop="toggleBookmark({ type: 'track', id: track.id, title: track.title, artwork: track.cover_art }); $el.classList.add('sparkle'); setTimeout(() => $el.classList.remove('sparkle'), 600)"
                                :aria-pressed="isBookmarked('track', track.id)"
                                :class="{ 'just-bookmarked': isBookmarked('track', track.id) }">
                                    <span aria-hidden="true">
                                        <i x-show="isBookmarked('track', track.id)" class="fas fa-bookmark" style="color: var(--accent-color);"></i>
                                        <i x-show="!isBookmarked('track', track.id)" class="far fa-bookmark"></i>
                                    </span>
                                <span class="sr-only" x-text="isBookmarked('track', track.id) ? 'Remove bookmark' : 'Add bookmark'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="track-info">
                    <h4 x-text="track.title"></h4>
                    <p x-text="track.artist"></p>
                    <div class="track-meta">
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Music List View -->
    <div x-show="viewMode === 'list'" class="music-list">
        <div class="list-header">
            <span class="col-cover"></span>
            <span class="col-title">Title</span>
            <span class="col-artist">Artist</span>
            <span class="col-actions">Actions</span>
        </div>

        <div class="list-items">
            <template x-for="(track, index) in filteredTracks" :key="track.id">
                <div class="list-item"
                    @click="playTrack(track)"
                    :class="{'playing': currentTrack?.id === track.id}">

                    <div class="col-cover">
                        <img
                            :src="track.cover_art || '/static/img/default-cover.jpg'"
                            :alt="track.title"
                            class="image-placeholder"
                            loading="lazy">
                    </div>

                    <div class="col-title">
                        <h4 x-text="track.title"></h4>
                        <p x-text="track.album || 'Single'"></p>
                    </div>

                    <span class="col-artist" x-text="track.artist"></span>

                    <div class="col-actions">
                        <button class="action-btn bm-btn"
                            @click.stop="toggleBookmark({ type: 'track', id: track.id, title: track.title, artwork: track.cover_art }); $el.classList.add('sparkle'); setTimeout(() => $el.classList.remove('sparkle'), 600)"
                            :aria-pressed="isBookmarked('track', track.id)"
                            :class="{ 'just-bookmarked': isBookmarked('track', track.id) }">
                                    <span aria-hidden="true">
                                        <i x-show="isBookmarked('track', track.id)" class="fas fa-bookmark" style="color: var(--accent-color);"></i>
                                        <i x-show="!isBookmarked('track', track.id)" class="far fa-bookmark"></i>
                                    </span>
                            <span class="sr-only" x-text="isBookmarked('track', track.id) ? 'Remove bookmark' : 'Add bookmark'"></span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading music library...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!isLoading && filteredTracks.length === 0" class="empty-state">
        <i class="fas fa-music"></i>
        <h3>No music found</h3>
        <p>Try adjusting your filters or search terms</p>
    </div>

    <!-- Add to Board Modal -->
    <div x-show="showAddToBoardModal" class="modal-overlay"
        @click="showAddToBoardModal = false">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>Add to Board</h3>
                <button @click="showAddToBoardModal = false" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="playlist-list">
                    <template x-for="playlist in playlists" :key="playlist.id">
                        <div class="playlist-option"
                            @click="addToBoard(playlist)">
                            <div class="playlist-color"
                                :style="`background-color: ${playlist.color}`"></div>
                            <div class="playlist-info">
                                <h4 x-text="playlist.name"></h4>
                                <p x-text="playlist.total_items + ' items'"></p>
                            </div>
                            <button class="add-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </template>

                    <div class="create-playlist-option"
                        @click="showCreateBoardModal = true">
                        <div class="playlist-color"
                            style="background: linear-gradient(45deg, #6366f1, #8b5cf6);"></div>
                        <div class="playlist-info">
                            <h4>Create New Board</h4>
                            <p>Start a new collection</p>
                        </div>
                        <button class="add-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Board Modal -->
    <div x-show="showCreateBoardModal" class="modal-overlay"
        @click="showCreateBoardModal = false">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>Create New Board</h3>
                <button @click="showCreateBoardModal = false" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Board Name</label>
                    <input type="text" x-model="newBoard.name"
                        placeholder="Enter playlist name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea x-model="newBoard.description"
                        placeholder="Enter playlist description"></textarea>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <button @click="newBoard.color = '#6366f1'"
                            :class="{'active': newBoard.color === '#6366f1'}"
                            class="color-option"
                            style="background: #6366f1;"></button>
                        <button @click="newBoard.color = '#ef4444'"
                            :class="{'active': newBoard.color === '#ef4444'}"
                            class="color-option"
                            style="background: #ef4444;"></button>
                        <button @click="newBoard.color = '#10b981'"
                            :class="{'active': newBoard.color === '#10b981'}"
                            class="color-option"
                            style="background: #10b981;"></button>
                        <button @click="newBoard.color = '#f59e0b'"
                            :class="{'active': newBoard.color === '#f59e0b'}"
                            class="color-option"
                            style="background: #f59e0b;"></button>
                        <button @click="newBoard.color = '#8b5cf6'"
                            :class="{'active': newBoard.color === '#8b5cf6'}"
                            class="color-option"
                            style="background: #8b5cf6;"></button>
                        <button @click="newBoard.color = '#ec4899'"
                            :class="{'active': newBoard.color === '#ec4899'}"
                            class="color-option"
                            style="background: #ec4899;"></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" x-model="newBoard.is_public">
                        Make this playlist public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button @click="showCreateBoardModal = false"
                    class="btn btn-outline">Cancel</button>
                <button @click="createBoard()" class="btn btn-primary">Create
                    Board</button>
            </div>
        </div>
    </div>
</div>

<script>
function musicLibrary() {
    return {
        // State
        tracks: [],
        filteredTracks: [],
        artists: [],
        viewMode: 'grid',
        searchQuery: '',
        selectedArtist: '',
        sortBy: 'title',
        isLoading: true,
        currentTrack: null,
        showAddToBoardModal: false,
        showCreateBoardModal: false,
        selectedTrack: null,
        playlists: [],
        newBoard: {
            name: '',
            description: '',
            color: '#6366f1',
            is_public: false
        },
        
        // Initialize
        async loadMusic() {
            try {
                this.isLoading = true;
                const response = await fetch('/api/music');
                const data = await response.json();
                this.tracks = data.tracks || [];
                this.filteredTracks = [...this.tracks];
                this.extractArtists();
                this.sortMusic();
                
                // Images will load automatically
                
                // Add debugging
                console.log('Loaded tracks:', this.tracks.length);
                console.log('First track:', this.tracks[0]);
            } catch (error) {
                console.error('Error loading music:', error);
            } finally {
                this.isLoading = false;
            }
        },
        
        extractArtists() {
            const artistSet = new Set();
            
            this.tracks.forEach(track => {
                if (track.artist) artistSet.add(track.artist);
            });
            
            this.artists = Array.from(artistSet).sort();
        },
        
        // Filtering and sorting
        filterMusic() {
            let filtered = [...this.tracks];
            
            // Search filter
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(track => 
                    track.title.toLowerCase().includes(query) ||
                    track.artist.toLowerCase().includes(query) ||
                    track.album?.toLowerCase().includes(query)
                );
            }
            
            // Artist filter
            if (this.selectedArtist) {
                filtered = filtered.filter(track => track.artist === this.selectedArtist);
            }
            
            this.filteredTracks = filtered;
            this.sortMusic();
        },
        
        sortMusic() {
            this.filteredTracks.sort((a, b) => {
                switch (this.sortBy) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'artist':
                        return a.artist.localeCompare(b.artist);
                    case 'added_date':
                        return new Date(b.added_date || 0) - new Date(a.added_date || 0);
                    default:
                        return 0;
                }
            });
        },
        
        // Track actions
        playTrack(track) {
            this.currentTrack = track;
            // Dispatch custom event to trigger global player
            document.dispatchEvent(new CustomEvent('play-track', {
                detail: { 
                    track: track,
                    type: 'track'
                }
            }));
        },

        playRandomTrack() {
            if (this.filteredTracks.length > 0) {
                const randomIndex = Math.floor(Math.random() * this.filteredTracks.length);
                this.playTrack(this.filteredTracks[randomIndex]);
            }
        },


        async saveTrack(track) {
            try {
                console.log('Bookmarking track:', track);
                const isCurrentlySaved = this.isSaved(track);
                console.log('Currently saved:', isCurrentlySaved);
                
                const response = await fetch('/api/activity/bookmark', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: track.id,
                        kind: 'track'
                    })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (response.ok) {
                    // Update UI state
                    track.saved = result.status === 'bookmarked';
                    
                    this.showNotification(result.status === 'bookmarked' ? 'Bookmarked track!' : 'Removed from bookmarks', 'success');
                } else {
                    console.error('Bookmark failed:', result);
                    this.showNotification(result.error || 'Failed to bookmark track', 'error');
                }
            } catch (error) {
                console.error('Error bookmarking track:', error);
                this.showNotification('Failed to bookmark track: ' + error.message, 'error');
            }
        },
        
        addToPlaylist(track) {
            // Show add to playlist modal
            this.selectedTrack = track;
            this.showAddToPlaylistModal = true;
        },
        
        showAddToPlaylist(track) {
            this.selectedTrack = track;
            this.loadPlaylists();
            this.showAddToPlaylistModal = true;
        },
        
        async loadPlaylists() {
            try {
                const response = await fetch('/api/playlists');
                const data = await response.json();
                this.playlists = data.playlists || [];
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        },
        
        async addToPlaylist(playlist) {
            if (!this.selectedTrack) return;
            
            try {
                const response = await fetch(`/api/playlists/${playlist.id}/add`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'track',
                        id: this.selectedTrack.id,
                        data: this.selectedTrack
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    this.showAddToBoardModal = false;
                    this.selectedTrack = null;
                    
                    if (result.guest) {
                        this.showNotification('Added to playlist! (Guest mode - create account to keep permanently)', 'info');
                        this.showUpgradePrompt();
                    } else {
                        this.showNotification('Added to playlist!', 'success');
                    }
                } else {
                    this.showNotification(result.error || 'Failed to add to playlist', 'error');
                }
            } catch (error) {
                console.error('Error adding to playlist:', error);
                this.showNotification('Failed to add to playlist', 'error');
            }
        },
        
        async createBoard() {
            try {
                const response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.newBoard)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.playlists.push(data.playlist);
                    this.showCreateBoardModal = false;
                    this.newBoard = { name: '', description: '', color: '#6366f1', is_public: false };
                    this.showNotification('Board created!', 'success');
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                this.showNotification('Failed to create playlist', 'error');
            }
        },
        
        showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
                color: white;
                border-radius: 8px;
                z-index: 1000;
                font-weight: 500;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        },
        
        showUpgradePrompt() {
            // Show upgrade prompt for guest users
            const prompt = document.createElement('div');
            prompt.className = 'upgrade-prompt';
            prompt.innerHTML = `
                <div class="upgrade-content">
                    <div class="upgrade-icon">🎵</div>
                    <h3>Keep Your Music Forever!</h3>
                    <p>You're saving content as a guest. Create a free account to keep your playlists and saves permanently.</p>
                    <div class="upgrade-actions">
                        <button onclick="window.location.href='/register'" class="btn btn-primary">Create Account</button>
                        <button onclick="this.closest('.upgrade-prompt').remove()" class="btn btn-outline">Maybe Later</button>
                    </div>
                </div>
            `;
            prompt.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--background-light);
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                z-index: 1001;
                max-width: 400px;
                text-align: center;
            `;
            document.body.appendChild(prompt);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (prompt.parentNode) {
                    prompt.remove();
                }
            }, 10000);
        },
        
        async migrateGuestData() {
            try {
                // Get guest data
                const guestResponse = await fetch('/api/guest-data');
                const guestData = await guestResponse.json();
                
                if (guestData.error) {
                    this.showNotification('No guest data to migrate', 'info');
                    return;
                }
                
                // Migrate to user account
                const migrateResponse = await fetch('/api/migrate-guest-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(guestData)
                });
                
                const result = await migrateResponse.json();
                
                if (migrateResponse.ok) {
                    this.showNotification(result.message, 'success');
                    // Reload playlists
                    this.loadBoards();
                } else {
                    this.showNotification('Failed to migrate data', 'error');
                }
            } catch (error) {
                console.error('Error migrating guest data:', error);
                this.showNotification('Failed to migrate data', 'error');
            }
        },
        
        showTrackMenu(track) {
            // Show track context menu
            console.log('Showing track menu:', track);
        },
        
        isSaved(track) {
            // Check server state first
            if (track.saved !== undefined) {
                return track.saved;
            }
            
            // Check local storage
            const key = `track:${track.id}`;
            const localBookmarks = JSON.parse(localStorage.getItem('ahoy_bookmarks') || '[]');
            return localBookmarks.includes(key);
        },
        
        // Bookmark methods
        toggleBookmark(item) {
            if (window.AhoyBookmarks) {
                window.AhoyBookmarks.toggle(item);
                // Force Alpine.js to re-evaluate bookmark states
                this.$nextTick(() => {
                    // Trigger reactivity by updating a dummy property
                    this.lastBookmarkAction = Date.now();
                });
            }
        },
        
        isBookmarked(type, id) {
            // Access lastBookmarkAction to trigger reactivity
            this.lastBookmarkAction;
            if (window.AhoyBookmarks) {
                return window.AhoyBookmarks.isBookmarked(type, id);
            }
            return false;
        },
        
        lastBookmarkAction: 0,
        
        bookmarkCount() {
            // Access lastBookmarkAction to trigger reactivity
            this.lastBookmarkAction;
            if (window.AhoyBookmarks) {
                return window.AhoyBookmarks.all().length;
            }
            return 0;
        },
        
        // Utility functions
    };
}

</script>
{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/unified-hero.js') }}"></script>
{% endblock %}
