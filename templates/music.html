{% extends "base.html" %}

{% block title %}Music Library - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="music-container" x-data="musicLibrary()" x-init="loadMusic()">
    <!-- Unified Header Section -->
    <section class="unified-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-text">
                    <h1><i class="fas fa-music"></i> Music Library</h1>
                    <p>Discover tracks, albums, and artists</p>
                </div>
            </div>

            <div class="header-search">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text"
                        x-model="searchQuery"
                        @input="filterMusic()"
                        placeholder="Search music, artists, or genres..."
                        class="search-input">
                    <button @click="clearSearch()" class="search-clear"
                        x-show="searchQuery">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="header-filters">
                <div class="filter-group">
                    <label>Artist:</label>
                    <select x-model="selectedArtist" @change="filterMusic()">
                        <option value>All Artists</option>
                        <template x-for="artist in artists" :key="artist">
                            <option :value="artist" x-text="artist"></option>
                        </template>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Sort by:</label>
                    <select x-model="sortBy" @change="sortMusic()">
                        <option value="title">Title</option>
                        <option value="artist">Artist</option>
                        <option value="added_date">Date Added</option>
                    </select>
                </div>
            </div>

            <div class="header-actions">
                <div class="view-options">
                    <button @click="viewMode = 'grid'"
                        :class="{'active': viewMode === 'grid'}"
                        class="view-btn">
                        <i class="fas fa-th"></i>
                    </button>
                    <button @click="viewMode = 'list'"
                        :class="{'active': viewMode === 'list'}"
                        class="view-btn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <button @click="playRandomTrack()"
                    class="btn btn-primary btn-large">
                    <i class="fas fa-play"></i> Play Random
                </button>
            </div>
        </div>
    </section>

    <!-- Music Grid View -->
    <div x-show="viewMode === 'grid'" class="music-grid">
        <template x-for="track in filteredTracks" :key="track.id">
            <div class="track-card"
                @click="playTrack(track)"
                :class="{'playing': currentTrack?.id === track.id}">

                <div class="track-cover">
                    <img
                        :data-src="track.cover_art || '/static/img/default-cover.jpg'"
                        :alt="track.title"
                        class="image-placeholder">
                    <div class="track-overlay">
                        <button @click.stop="playTrack(track)" class="play-btn">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="track-actions">
                            <button @click.stop="saveTrack(track)"
                                class="action-btn save-btn"
                                :class="{'saved': isSaved(track)}"
                                :title="isSaved(track) ? 'Remove from saves' : 'Save track'">
                                <i class="fas fa-bookmark"></i>
                            </button>
                            <button @click.stop="showAddToBoard(track)"
                                class="action-btn add-btn"
                                title="Add to playlist">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button @click.stop="likeTrack(track)"
                                class="action-btn like-btn"
                                :class="{'liked': isLiked(track)}"
                                :title="isLiked(track) ? 'Unlike' : 'Like'">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button @click.stop="showTrackMenu(track)"
                                class="action-btn menu-btn"
                                title="More options">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="track-info">
                    <h4 x-text="track.title"></h4>
                    <p x-text="track.artist"></p>
                    <div class="track-meta">
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Music List View -->
    <div x-show="viewMode === 'list'" class="music-list">
        <div class="list-header">
            <span class="col-cover"></span>
            <span class="col-title">Title</span>
            <span class="col-artist">Artist</span>
            <span class="col-actions">Actions</span>
        </div>

        <div class="list-items">
            <template x-for="(track, index) in filteredTracks" :key="track.id">
                <div class="list-item"
                    @click="playTrack(track)"
                    :class="{'playing': currentTrack?.id === track.id}">

                    <div class="col-cover">
                        <img
                            :data-src="track.cover_art || '/static/img/default-cover.jpg'"
                            :alt="track.title"
                            class="image-placeholder">
                    </div>

                    <div class="col-title">
                        <h4 x-text="track.title"></h4>
                        <p x-text="track.album || 'Single'"></p>
                    </div>

                    <span class="col-artist" x-text="track.artist"></span>

                    <div class="col-actions">
                        <button @click.stop="saveTrack(track)"
                            class="action-btn"
                            :class="{'saved': isSaved(track)}"
                            title="Save track">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button @click.stop="likeTrack(track)"
                            class="action-btn"
                            :class="{'liked': isLiked(track)}"
                            title="Like track">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button @click.stop="addToPlaylist(track)"
                            class="action-btn"
                            title="Add to playlist">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading music library...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!isLoading && filteredTracks.length === 0" class="empty-state">
        <i class="fas fa-music"></i>
        <h3>No music found</h3>
        <p>Try adjusting your filters or search terms</p>
    </div>

    <!-- Add to Board Modal -->
    <div x-show="showAddToBoardModal" class="modal-overlay"
        @click="showAddToBoardModal = false">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>Add to Board</h3>
                <button @click="showAddToBoardModal = false" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="playlist-list">
                    <template x-for="playlist in playlists" :key="playlist.id">
                        <div class="playlist-option"
                            @click="addToBoard(playlist)">
                            <div class="playlist-color"
                                :style="`background-color: ${playlist.color}`"></div>
                            <div class="playlist-info">
                                <h4 x-text="playlist.name"></h4>
                                <p x-text="playlist.total_items + ' items'"></p>
                            </div>
                            <button class="add-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </template>

                    <div class="create-playlist-option"
                        @click="showCreateBoardModal = true">
                        <div class="playlist-color"
                            style="background: linear-gradient(45deg, #6366f1, #8b5cf6);"></div>
                        <div class="playlist-info">
                            <h4>Create New Board</h4>
                            <p>Start a new collection</p>
                        </div>
                        <button class="add-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Board Modal -->
    <div x-show="showCreateBoardModal" class="modal-overlay"
        @click="showCreateBoardModal = false">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>Create New Board</h3>
                <button @click="showCreateBoardModal = false" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Board Name</label>
                    <input type="text" x-model="newBoard.name"
                        placeholder="Enter playlist name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea x-model="newBoard.description"
                        placeholder="Enter playlist description"></textarea>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <button @click="newBoard.color = '#6366f1'"
                            :class="{'active': newBoard.color === '#6366f1'}"
                            class="color-option"
                            style="background: #6366f1;"></button>
                        <button @click="newBoard.color = '#ef4444'"
                            :class="{'active': newBoard.color === '#ef4444'}"
                            class="color-option"
                            style="background: #ef4444;"></button>
                        <button @click="newBoard.color = '#10b981'"
                            :class="{'active': newBoard.color === '#10b981'}"
                            class="color-option"
                            style="background: #10b981;"></button>
                        <button @click="newBoard.color = '#f59e0b'"
                            :class="{'active': newBoard.color === '#f59e0b'}"
                            class="color-option"
                            style="background: #f59e0b;"></button>
                        <button @click="newBoard.color = '#8b5cf6'"
                            :class="{'active': newBoard.color === '#8b5cf6'}"
                            class="color-option"
                            style="background: #8b5cf6;"></button>
                        <button @click="newBoard.color = '#ec4899'"
                            :class="{'active': newBoard.color === '#ec4899'}"
                            class="color-option"
                            style="background: #ec4899;"></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" x-model="newBoard.is_public">
                        Make this playlist public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button @click="showCreateBoardModal = false"
                    class="btn btn-outline">Cancel</button>
                <button @click="createBoard()" class="btn btn-primary">Create
                    Board</button>
            </div>
        </div>
    </div>
</div>

<script>
function musicLibrary() {
    return {
        // State
        tracks: [],
        filteredTracks: [],
        artists: [],
        viewMode: 'grid',
        searchQuery: '',
        selectedArtist: '',
        sortBy: 'title',
        isLoading: true,
        currentTrack: null,
        showAddToBoardModal: false,
        showCreateBoardModal: false,
        selectedTrack: null,
        playlists: [],
        newBoard: {
            name: '',
            description: '',
            color: '#6366f1',
            is_public: false
        },
        
        // Initialize
        async loadMusic() {
            try {
                this.isLoading = true;
                const response = await fetch('/api/music');
                const data = await response.json();
                this.tracks = data.tracks || [];
                this.filteredTracks = [...this.tracks];
                this.extractArtists();
                this.sortMusic();
                
                // Refresh images after data loads
                this.$nextTick(() => {
                    if (window.imageOptimizer) {
                        window.imageOptimizer.refresh();
                    }
                });
                
                // Add debugging
                console.log('Loaded tracks:', this.tracks.length);
                console.log('First track:', this.tracks[0]);
            } catch (error) {
                console.error('Error loading music:', error);
            } finally {
                this.isLoading = false;
            }
        },
        
        extractArtists() {
            const artistSet = new Set();
            
            this.tracks.forEach(track => {
                if (track.artist) artistSet.add(track.artist);
            });
            
            this.artists = Array.from(artistSet).sort();
        },
        
        // Filtering and sorting
        filterMusic() {
            let filtered = [...this.tracks];
            
            // Search filter
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(track => 
                    track.title.toLowerCase().includes(query) ||
                    track.artist.toLowerCase().includes(query) ||
                    track.album?.toLowerCase().includes(query)
                );
            }
            
            // Artist filter
            if (this.selectedArtist) {
                filtered = filtered.filter(track => track.artist === this.selectedArtist);
            }
            
            this.filteredTracks = filtered;
            this.sortMusic();
        },
        
        sortMusic() {
            this.filteredTracks.sort((a, b) => {
                switch (this.sortBy) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'artist':
                        return a.artist.localeCompare(b.artist);
                    case 'added_date':
                        return new Date(b.added_date || 0) - new Date(a.added_date || 0);
                    default:
                        return 0;
                }
            });
        },
        
        // Track actions
        playTrack(track) {
            this.currentTrack = track;
            if (window.globalPlayer) {
                window.globalPlayer.playTrack(track);
            }
        },

        playRandomTrack() {
            if (this.filteredTracks.length > 0) {
                const randomIndex = Math.floor(Math.random() * this.filteredTracks.length);
                this.playTrack(this.filteredTracks[randomIndex]);
            }
        },


        likeTrack(track) {
            // Toggle like status
            console.log('Like track:', track);
        },

        isLiked(track) {
            // Check if track is liked
            return false;
        },
        
        async saveTrack(track) {
            try {
                console.log('Saving track:', track);
                const isCurrentlySaved = this.isSaved(track);
                console.log('Currently saved:', isCurrentlySaved);
                
                const response = await fetch(isCurrentlySaved ? '/api/saves/unsave' : '/api/saves/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'track',
                        id: track.id,
                        data: track
                    })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (response.ok) {
                    // Update UI state
                    track.saved = !isCurrentlySaved;
                    
                    if (result.guest) {
                        this.showNotification('Saved track! (Guest mode - create account to keep permanently)', 'info');
                        this.showUpgradePrompt();
                    } else {
                        this.showNotification('Saved track!', 'success');
                    }
                } else {
                    console.error('Save failed:', result);
                    this.showNotification(result.error || 'Failed to save track', 'error');
                }
            } catch (error) {
                console.error('Error saving track:', error);
                this.showNotification('Failed to save track: ' + error.message, 'error');
            }
        },
        
        async likeTrack(track) {
            try {
                const isCurrentlyLiked = this.isLiked(track);
                const response = await fetch(isCurrentlyLiked ? '/api/likes/unlike' : '/api/likes/like', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'track',
                        id: track.id,
                        data: track
                    })
                });
                
                if (response.ok) {
                    // Update UI state
                    track.liked = !isCurrentlyLiked;
                }
            } catch (error) {
                console.error('Error liking track:', error);
            }
        },
        
        addToPlaylist(track) {
            // Show add to playlist modal
            this.selectedTrack = track;
            this.showAddToPlaylistModal = true;
        },
        
        showAddToBoard(track) {
            this.selectedTrack = track;
            this.loadBoards();
            this.showAddToBoardModal = true;
        },
        
        async loadBoards() {
            try {
                const response = await fetch('/api/playlists');
                const data = await response.json();
                this.playlists = data.playlists || [];
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        },
        
        async addToBoard(playlist) {
            if (!this.selectedTrack) return;
            
            try {
                const response = await fetch(`/api/playlists/${playlist.id}/add`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'track',
                        id: this.selectedTrack.id,
                        data: this.selectedTrack
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    this.showAddToBoardModal = false;
                    this.selectedTrack = null;
                    
                    if (result.guest) {
                        this.showNotification('Added to playlist! (Guest mode - create account to keep permanently)', 'info');
                        this.showUpgradePrompt();
                    } else {
                        this.showNotification('Added to playlist!', 'success');
                    }
                } else {
                    this.showNotification(result.error || 'Failed to add to playlist', 'error');
                }
            } catch (error) {
                console.error('Error adding to playlist:', error);
                this.showNotification('Failed to add to playlist', 'error');
            }
        },
        
        async createBoard() {
            try {
                const response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.newBoard)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.playlists.push(data.playlist);
                    this.showCreateBoardModal = false;
                    this.newBoard = { name: '', description: '', color: '#6366f1', is_public: false };
                    this.showNotification('Board created!', 'success');
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                this.showNotification('Failed to create playlist', 'error');
            }
        },
        
        showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
                color: white;
                border-radius: 8px;
                z-index: 1000;
                font-weight: 500;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        },
        
        showUpgradePrompt() {
            // Show upgrade prompt for guest users
            const prompt = document.createElement('div');
            prompt.className = 'upgrade-prompt';
            prompt.innerHTML = `
                <div class="upgrade-content">
                    <div class="upgrade-icon">🎵</div>
                    <h3>Keep Your Music Forever!</h3>
                    <p>You're saving content as a guest. Create a free account to keep your playlists and saves permanently.</p>
                    <div class="upgrade-actions">
                        <button onclick="window.location.href='/register'" class="btn btn-primary">Create Account</button>
                        <button onclick="this.closest('.upgrade-prompt').remove()" class="btn btn-outline">Maybe Later</button>
                    </div>
                </div>
            `;
            prompt.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--background-light);
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                z-index: 1001;
                max-width: 400px;
                text-align: center;
            `;
            document.body.appendChild(prompt);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (prompt.parentNode) {
                    prompt.remove();
                }
            }, 10000);
        },
        
        async migrateGuestData() {
            try {
                // Get guest data
                const guestResponse = await fetch('/api/guest-data');
                const guestData = await guestResponse.json();
                
                if (guestData.error) {
                    this.showNotification('No guest data to migrate', 'info');
                    return;
                }
                
                // Migrate to user account
                const migrateResponse = await fetch('/api/migrate-guest-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(guestData)
                });
                
                const result = await migrateResponse.json();
                
                if (migrateResponse.ok) {
                    this.showNotification(result.message, 'success');
                    // Reload playlists
                    this.loadBoards();
                } else {
                    this.showNotification('Failed to migrate data', 'error');
                }
            } catch (error) {
                console.error('Error migrating guest data:', error);
                this.showNotification('Failed to migrate data', 'error');
            }
        },
        
        showTrackMenu(track) {
            // Show track context menu
            console.log('Showing track menu:', track);
        },
        
        isSaved(track) {
            return track.saved || false;
        },
        
        isLiked(track) {
            return track.liked || false;
        },
        
        // Utility functions
    };
}
</script>
{% endblock %}
