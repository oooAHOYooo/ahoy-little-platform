{% extends "base.html" %}

{% block title %}Admin - Orders & Stats{% endblock %}

{% block content %}
<div class="admin-ro" x-data="adminDashboard()" x-init="init()">
  <div class="admin-ro-header">
    <div>
      <h1>Admin</h1>
      <p class="muted">Read-only dashboard (orders + stats).</p>
    </div>
    <div class="admin-ro-actions">
      <button class="btn btn-secondary" @click="refresh()">Refresh</button>
    </div>
  </div>

  <div class="admin-ro-grid">
    <div class="card glass">
      <div class="card-header">Merch Orders</div>
      <div class="card-body">
        <div class="stat-lg" x-text="stats.orders.total || 0">0</div>
        <div class="muted text-sm">
          Pending <strong x-text="stats.orders.pending || 0">0</strong> •
          Paid <strong x-text="stats.orders.paid || 0">0</strong> •
          Fulfilled <strong x-text="stats.orders.fulfilled || 0">0</strong>
        </div>
      </div>
    </div>
    <div class="card glass">
      <div class="card-header">Users</div>
      <div class="card-body">
        <div class="stat-lg" x-text="stats.users.total || 0">0</div>
        <div class="muted text-sm">Active (30d) <strong x-text="stats.users.active_30d || 0">0</strong></div>
      </div>
    </div>
  </div>

  <div class="admin-ro-section">
    <div class="admin-ro-section-head">
      <h2>Recent Orders</h2>
      <div class="muted text-sm" x-show="orders.length">Showing <span x-text="orders.length"></span></div>
    </div>

    <div class="admin-ro-table-wrap glass">
      <table class="admin-ro-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>When</th>
            <th>Status</th>
            <th>Item</th>
            <th>Qty</th>
            <th>Total</th>
            <th>Stripe</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="o in orders" :key="o.id">
            <tr>
              <td x-text="o.id"></td>
              <td class="muted" x-text="formatDate(o.created_at)"></td>
              <td><span class="pill" :class="'st-' + (o.status || 'pending')" x-text="(o.status || 'pending')"></span></td>
              <td x-text="o.item_id || ''"></td>
              <td x-text="o.qty || 1"></td>
              <td x-text="formatMoney(o.total)"></td>
              <td class="muted" x-text="o.stripe_id || ''"></td>
            </tr>
          </template>
          <tr x-show="!orders.length">
            <td colspan="7" class="muted" style="padding:14px;">No orders yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function adminDashboard() {
  return {
    stats: { users: {}, orders: {} },
    orders: [],
    async init() {
      await this.refresh();
    },
    async refresh() {
      try {
        const [s, o] = await Promise.all([
          fetch('/api/admin/stats'),
          fetch('/api/admin/orders?limit=200')
        ]);
        if (s.ok) this.stats = await s.json();
        if (o.ok) this.orders = (await o.json()).orders || [];
      } catch (e) {
        console.error('Failed to load admin data', e);
      }
    },
    formatDate(iso) {
      if (!iso) return '';
      try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
    },
    formatMoney(v) {
      const n = Number(v || 0);
      if (!isFinite(n)) return '—';
      return '$' + n.toFixed(2);
    }
  };
}
</script>

<style>
  .admin-ro { max-width: 1100px; margin: 0 auto; padding: 18px 18px 40px; }
  .admin-ro-header { display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; margin-bottom: 14px; }
  .admin-ro-header h1 { margin: 0; }
  .admin-ro-header .muted { margin: 4px 0 0; color: rgba(255,255,255,0.65); }
  .admin-ro-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; margin-top: 12px; }
  @media (max-width: 768px){ .admin-ro-grid{ grid-template-columns: 1fr; } }
  .admin-ro-section { margin-top: 18px; }
  .admin-ro-section-head { display:flex; align-items:baseline; justify-content:space-between; gap: 12px; margin: 8px 2px; }
  .admin-ro-table-wrap { border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; overflow: hidden; }
  .admin-ro-table { width:100%; border-collapse: collapse; }
  .admin-ro-table th, .admin-ro-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align:left; font-size: 12px; }
  .admin-ro-table th { font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color: rgba(255,255,255,0.65); }
  .admin-ro-table tr:last-child td { border-bottom: 0; }
  .pill { display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); text-transform: uppercase; letter-spacing:.10em; font-size:10px; }
  .pill.st-paid { border-color: rgba(16,185,129,0.35); background: rgba(16,185,129,0.10); }
  .pill.st-pending { border-color: rgba(245,158,11,0.30); background: rgba(245,158,11,0.10); }
  .pill.st-fulfilled { border-color: rgba(59,130,246,0.28); background: rgba(59,130,246,0.10); }
</style>
{% endblock %}
