{% extends "base.html" %}

{% block title %}Admin - Orders & Stats{% endblock %}

{% block content %}
<div class="admin-ro" x-data="adminDashboard({{ current_user.id|default('null') }})" x-init="init()">
  <div class="admin-ro-header">
    <div>
      <h1>Admin</h1>
      <p class="muted">Read-only dashboard (orders + stats).</p>
    </div>
    <div class="admin-ro-actions">
      <button class="btn btn-secondary" @click="refresh()">Refresh</button>
    </div>
  </div>

  <div class="admin-ro-grid">
    <div class="card glass">
      <div class="card-header">Users</div>
      <div class="card-body">
        <div class="stat-lg" x-text="stats.users.total || 0">0</div>
        <div class="muted text-sm">
          Active (30d) <strong x-text="stats.users.active_30d || 0">0</strong> •
          New (7d) <strong x-text="stats.users.new_7d || 0">0</strong> •
          New (24h) <strong x-text="stats.users.new_24h || 0">0</strong>
        </div>
      </div>
    </div>
    <div class="card glass">
      <div class="card-header">Plays</div>
      <div class="card-body">
        <div class="stat-lg" x-text="stats.plays.total || 0">0</div>
        <div class="muted text-sm">
          Last 7d <strong x-text="stats.plays.last_7d || 0">0</strong> •
          Last 24h <strong x-text="stats.plays.last_24h || 0">0</strong> •
          Unique tracks <strong x-text="stats.plays.unique_tracks || 0">0</strong>
        </div>
      </div>
    </div>
    <div class="card glass">
      <div class="card-header">Listening Time</div>
      <div class="card-body">
        <div class="stat-lg" x-text="(stats.listening.total_hours || 0) + 'h'">0h</div>
        <div class="muted text-sm">
          Sessions <strong x-text="stats.listening.total_sessions || 0">0</strong> •
          Radio <strong x-text="stats.listening.radio_sessions || 0">0</strong> •
          Manual <strong x-text="stats.listening.manual_sessions || 0">0</strong>
        </div>
      </div>
    </div>
    <div class="card glass">
      <div class="card-header">Engagement</div>
      <div class="card-body">
        <div class="stat-lg" x-text="(stats.engagement.bookmarks || 0) + ' bookmarks'">0 bookmarks</div>
        <div class="muted text-sm">
          Follows <strong x-text="stats.engagement.follows || 0">0</strong> •
          Tips <strong x-text="stats.engagement.tips || 0">0</strong> •
          Amount <strong x-text="'$' + (stats.engagement.tip_amount || 0)">$0</strong>
        </div>
      </div>
    </div>
    <div class="card glass">
      <div class="card-header">Merch Orders</div>
      <div class="card-body">
        <div class="stat-lg" x-text="stats.orders.total || 0">0</div>
        <div class="muted text-sm">
          Pending <strong x-text="stats.orders.pending || 0">0</strong> •
          Paid <strong x-text="stats.orders.paid || 0">0</strong> •
          Fulfilled <strong x-text="stats.orders.fulfilled || 0">0</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="admin-ro-section" x-show="analytics">
    <div class="admin-ro-section-head">
      <h2>Analytics</h2>
      <div class="muted text-sm">Last 7 days</div>
    </div>

    <div class="admin-ro-analytics-grid">
      <div class="card glass">
        <div class="card-header">Daily Plays</div>
        <div class="card-body">
          <div class="daily-plays-chart">
            <template x-for="day in analytics.daily_plays || []" :key="day.date">
              <div class="chart-bar-wrap">
                <div class="chart-bar" :style="`height: ${Math.max(5, (day.count / Math.max(1, Math.max(...(analytics.daily_plays || []).map(d => d.count)))) * 100)}%`" :title="day.count + ' plays'"></div>
                <div class="chart-label" x-text="new Date(day.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})"></div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div class="card glass">
        <div class="card-header">Listening by Source</div>
        <div class="card-body">
          <div class="source-stats">
            <div class="source-item">
              <div class="source-label">Radio</div>
              <div class="source-value" x-text="(analytics.listening_by_source?.radio_hours || 0) + 'h'">0h</div>
            </div>
            <div class="source-item">
              <div class="source-label">Manual</div>
              <div class="source-value" x-text="(analytics.listening_by_source?.manual_hours || 0) + 'h'">0h</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="admin-ro-section" style="margin-top: 24px;">
      <div class="admin-ro-section-head">
        <h3>Top Users by Plays</h3>
      </div>
      <div class="admin-ro-table-wrap glass">
        <table class="admin-ro-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Plays</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="user in analytics.top_users || []" :key="user.id">
              <tr>
                <td x-text="user.username || '—'"></td>
                <td class="muted" x-text="user.email"></td>
                <td><strong x-text="user.play_count"></strong></td>
              </tr>
            </template>
            <tr x-show="!analytics.top_users || !analytics.top_users.length">
              <td colspan="3" class="muted" style="padding:14px;">No data yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="admin-ro-section" style="margin-top: 24px;">
      <div class="admin-ro-section-head">
        <h3>Most Played Tracks</h3>
      </div>
      <div class="admin-ro-table-wrap glass">
        <table class="admin-ro-table">
          <thead>
            <tr>
              <th>Track ID</th>
              <th>Play Count</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="track in analytics.top_tracks || []" :key="track.media_id">
              <tr>
                <td class="muted" x-text="track.media_id"></td>
                <td><strong x-text="track.play_count"></strong></td>
              </tr>
            </template>
            <tr x-show="!analytics.top_tracks || !analytics.top_tracks.length">
              <td colspan="2" class="muted" style="padding:14px;">No data yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- New Users Section -->
  <div class="admin-ro-section" style="margin-top: 24px;">
    <div class="admin-ro-section-head">
      <h2>All Users</h2>
      <div class="muted text-sm" x-show="users.length">Showing <span x-text="users.length"></span> users</div>
    </div>
    <div class="admin-ro-table-wrap glass">
      <table class="admin-ro-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Username</th>
            <th>Created</th>
            <th>Last Active</th>
            <th>Plays</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="user in users" :key="user.id">
            <tr>
              <td x-text="user.id"></td>
              <td x-text="user.email"></td>
              <td class="muted" x-text="user.username || '—'"></td>
              <td class="muted" x-text="formatDate(user.created_at)"></td>
              <td class="muted" x-text="user.last_active_at ? formatDate(user.last_active_at) : 'Never'"></td>
              <td><strong x-text="user.play_count || 0"></strong></td>
              <td>
                <span class="pill" :class="user.is_admin ? 'st-paid' : ''" x-show="user.is_admin">Admin</span>
                <span class="pill" :class="user.disabled ? 'st-pending' : 'st-fulfilled'" x-text="user.disabled ? 'Disabled' : 'Active'"></span>
              </td>
              <td>
                <button type="button" class="btn btn-small" x-show="user.id !== currentUserId" @click="toggleUserDisabled(user)" x-text="user.disabled ? 'Enable' : 'Disable'"></button>
                <span class="muted text-sm" x-show="user.id === currentUserId">(you)</span>
              </td>
            </tr>
          </template>
          <tr x-show="!users.length">
            <td colspan="8" class="muted" style="padding:14px;">No users yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="admin-ro-section">
    <div class="admin-ro-section-head">
      <h2>Recent Orders</h2>
      <div class="muted text-sm" x-show="orders.length">Showing <span x-text="orders.length"></span></div>
    </div>

    <div class="admin-ro-table-wrap glass">
      <table class="admin-ro-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>When</th>
            <th>Status</th>
            <th>Item</th>
            <th>Qty</th>
            <th>Total</th>
            <th>Shipping Address</th>
            <th>Tracking</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="o in orders" :key="o.id">
            <tr>
              <td x-text="o.id"></td>
              <td class="muted" x-text="formatDate(o.created_at)"></td>
              <td><span class="pill" :class="'st-' + (o.status || 'pending')" x-text="(o.status || 'pending')"></span></td>
              <td x-text="o.item_id || ''"></td>
              <td x-text="o.qty || 1"></td>
              <td x-text="formatMoney(o.total)"></td>
              <td class="muted text-sm">
                <template x-if="o.shipping">
                  <div>
                    <div x-text="o.shipping.name || ''"></div>
                    <div x-text="(o.shipping.line1 || '') + (o.shipping.line2 ? ', ' + o.shipping.line2 : '')"></div>
                    <div x-text="(o.shipping.city || '') + ', ' + (o.shipping.state || '') + ' ' + (o.shipping.postal_code || '')"></div>
                    <div x-text="o.shipping.country || ''"></div>
                  </div>
                </template>
                <template x-if="!o.shipping">
                  <span class="muted">—</span>
                </template>
              </td>
              <td class="muted text-sm">
                <template x-if="o.tracking_number">
                  <span x-text="o.tracking_number"></span>
                </template>
                <template x-if="!o.tracking_number">
                  <span class="muted">—</span>
                </template>
              </td>
              <td>
                <template x-if="o.status === 'paid'">
                  <button class="btn btn-small" @click="openFulfillModal(o)">Fulfill</button>
                </template>
                <template x-if="o.status === 'fulfilled'">
                  <span class="muted text-sm" x-text="o.fulfilled_at ? 'Shipped ' + formatDate(o.fulfilled_at) : 'Fulfilled'"></span>
                </template>
              </td>
            </tr>
          </template>
          <tr x-show="!orders.length">
            <td colspan="10" class="muted" style="padding:14px;">No orders yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Fulfill Order Modal -->
  <div x-show="fulfillModal.show" class="modal-overlay" @click.self="closeFulfillModal()" style="display:none;">
    <div class="modal-content glass" @click.stop>
      <h3>Mark Order as Fulfilled</h3>
      <p class="muted">Order #<span x-text="fulfillModal.order?.id"></span> - <span x-text="fulfillModal.order?.item_id"></span></p>

      <div style="margin: 16px 0;">
        <label for="tracking_number" style="display:block; margin-bottom:6px; font-size:13px;">Tracking Number (optional)</label>
        <input type="text" id="tracking_number" x-model="fulfillModal.trackingNumber"
               placeholder="e.g. 1Z999AA10123456784"
               style="width:100%; padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.15); background:rgba(0,0,0,0.3); color:#fff;">
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
        <button class="btn btn-secondary" @click="closeFulfillModal()">Cancel</button>
        <button class="btn" @click="fulfillOrder()" :disabled="fulfillModal.loading">
          <span x-show="!fulfillModal.loading">Mark Fulfilled</span>
          <span x-show="fulfillModal.loading">Saving...</span>
        </button>
      </div>

      <div x-show="fulfillModal.error" class="error-msg" style="margin-top:12px; color:#f87171;" x-text="fulfillModal.error"></div>
    </div>
  </div>
</div>

<script>
const CSRF_TOKEN = '{{ csrf_token }}';

function adminDashboard(currentUserId) {
  return {
    currentUserId: currentUserId || null,
    stats: { users: {}, orders: {}, plays: {}, listening: {}, engagement: {} },
    analytics: null,
    users: [],
    orders: [],
    fulfillModal: {
      show: false,
      order: null,
      trackingNumber: '',
      loading: false,
      error: ''
    },
    async init() {
      await this.refresh();
    },
    async refresh() {
      try {
        const [s, a, u, o] = await Promise.all([
          fetch('/api/admin/stats'),
          fetch('/api/admin/analytics'),
          fetch('/api/admin/users?limit=100'),
          fetch('/api/admin/orders?limit=200')
        ]);
        if (s.ok) this.stats = await s.json();
        if (a.ok) this.analytics = await a.json();
        if (u.ok) this.users = (await u.json()).users || [];
        if (o.ok) this.orders = (await o.json()).orders || [];
      } catch (e) {
        console.error('Failed to load admin data', e);
      }
    },
    async toggleUserDisabled(user) {
      if (user.id === this.currentUserId) return;
      const disabled = !user.disabled;
      try {
        const res = await fetch(`/api/admin/users/${user.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': CSRF_TOKEN },
          body: JSON.stringify({ disabled })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        user.disabled = data.disabled;
      } catch (e) {
        console.error('Toggle user failed', e);
        alert(e.message || 'Failed to update user');
      }
    },
    openFulfillModal(order) {
      this.fulfillModal = {
        show: true,
        order: order,
        trackingNumber: '',
        loading: false,
        error: ''
      };
    },
    closeFulfillModal() {
      this.fulfillModal.show = false;
      this.fulfillModal.order = null;
      this.fulfillModal.trackingNumber = '';
      this.fulfillModal.error = '';
    },
    async fulfillOrder() {
      if (!this.fulfillModal.order) return;
      this.fulfillModal.loading = true;
      this.fulfillModal.error = '';

      try {
        const res = await fetch(`/api/admin/orders/${this.fulfillModal.order.id}/fulfill`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': CSRF_TOKEN
          },
          body: JSON.stringify({
            tracking_number: this.fulfillModal.trackingNumber || null
          })
        });

        const data = await res.json();

        if (!res.ok) {
          this.fulfillModal.error = data.error || 'Failed to fulfill order';
          this.fulfillModal.loading = false;
          return;
        }

        // Update the order in our local state
        const idx = this.orders.findIndex(o => o.id === this.fulfillModal.order.id);
        if (idx >= 0) {
          this.orders[idx].status = 'fulfilled';
          this.orders[idx].tracking_number = this.fulfillModal.trackingNumber || null;
          this.orders[idx].fulfilled_at = new Date().toISOString();
        }

        this.closeFulfillModal();
      } catch (e) {
        console.error('Error fulfilling order', e);
        this.fulfillModal.error = 'Network error. Please try again.';
        this.fulfillModal.loading = false;
      }
    },
    formatDate(iso) {
      if (!iso) return '';
      try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
    },
    formatMoney(v) {
      const n = Number(v || 0);
      if (!isFinite(n)) return '—';
      return '$' + n.toFixed(2);
    }
  };
}
</script>

<style>
  .admin-ro { max-width: 1100px; margin: 0 auto; padding: 18px 18px 40px; }
  .admin-ro-header { display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; margin-bottom: 14px; }
  .admin-ro-header h1 { margin: 0; }
  .admin-ro-header .muted { margin: 4px 0 0; color: rgba(255,255,255,0.65); }
  .admin-ro-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin-top: 12px; }
  @media (max-width: 768px){ .admin-ro-grid{ grid-template-columns: 1fr; } }
  .admin-ro-analytics-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-top: 12px; }
  .daily-plays-chart { display:flex; align-items:flex-end; gap: 8px; height: 120px; padding: 8px 0; }
  .chart-bar-wrap { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; }
  .chart-bar { width:100%; background: linear-gradient(180deg, rgba(82,136,255,0.85) 0%, rgba(82,136,255,0.55) 100%); border-radius: 4px 4px 0 0; min-height: 4px; transition: height 0.3s; }
  .chart-label { margin-top: 6px; font-size: 10px; color: rgba(255,255,255,0.55); text-align:center; }
  .source-stats { display:flex; gap: 24px; }
  .source-item { flex:1; }
  .source-label { font-size: 12px; color: rgba(255,255,255,0.65); margin-bottom: 4px; }
  .source-value { font-size: 24px; font-weight: 900; color: rgba(255,255,255,0.95); }
  .admin-ro-section { margin-top: 18px; }
  .admin-ro-section-head { display:flex; align-items:baseline; justify-content:space-between; gap: 12px; margin: 8px 2px; }
  .admin-ro-table-wrap { border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; overflow: hidden; }
  .admin-ro-table { width:100%; border-collapse: collapse; }
  .admin-ro-table th, .admin-ro-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align:left; font-size: 12px; }
  .admin-ro-table th { font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color: rgba(255,255,255,0.65); }
  .admin-ro-table tr:last-child td { border-bottom: 0; }
  .pill { display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); text-transform: uppercase; letter-spacing:.10em; font-size:10px; }
  .pill.st-paid { border-color: rgba(16,185,129,0.35); background: rgba(16,185,129,0.10); }
  .pill.st-pending { border-color: rgba(245,158,11,0.30); background: rgba(245,158,11,0.10); }
  .pill.st-fulfilled { border-color: rgba(59,130,246,0.28); background: rgba(59,130,246,0.10); }
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000; }
  .modal-content { background:rgba(30,30,40,0.95); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:24px; min-width:340px; max-width:90vw; }
  .modal-content h3 { margin:0 0 8px 0; }
  .btn-small { padding:6px 12px; font-size:11px; }
</style>
{% endblock %}
