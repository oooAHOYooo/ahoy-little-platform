{% extends "base.html" %}

{% block title %}Podcasts - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="podcasts-page" x-data="podcastsHub()" x-init="init()">
    {% from "macros/subpage_header.html" import subpage_hero %}
    {{ subpage_hero(title="Podcasts", subtitle="Fresh episodes and shows from independent creators.", icon_class="fas fa-podcast", scope_class="") }}

    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>New Episodes</h2>
        </div>

        <div class="episode-list">
            <template x-for="ep in episodes" :key="ep.key">
                <article class="episode-row" @click="openShow(ep.showSlug)">
                    <img class="episode-art" :src="ep.artwork" alt="">
                    <div class="episode-meta">
                        <div class="episode-title" x-text="ep.title"></div>
                        <div class="episode-subtitle">
                            <span class="episode-show" x-text="ep.showTitle"></span>
                            <span class="episode-dot">•</span>
                            <span class="episode-time" x-text="ep.duration"></span>
                            <span class="episode-dot" x-show="ep.date">•</span>
                            <span class="episode-date" x-show="ep.date" x-text="ep.date"></span>
                        </div>
                        <div class="episode-desc" x-text="ep.description"></div>
                    </div>

                    <div class="episode-actions">
                        <button type="button" class="episode-btn"
                            @click.stop="play(ep)" title="Play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                            <span class="sr-only">Play</span>
                        </button>
                        <div class="queue-container" x-data="globalQueueHandler()" x-init="init()">
                            <button type="button" class="episode-btn queue-btn"
                                @click.stop="addToQueue('podcast-episode', ep.key, ep.title, ep.artwork, ep)"
                                :class="{ 'in-queue': isInQueue('podcast-episode', ep.key) }"
                                title="Add to queue">
                                <i :class="isInQueue('podcast-episode', ep.key) ? 'fas fa-list-check' : 'fas fa-list-plus'" aria-hidden="true"></i>
                                <span class="sr-only">Add to queue</span>
                            </button>
                        </div>
                        <button type="button" class="episode-btn bm-btn"
                            @click.stop="toggleBookmark(ep)" title="Bookmark">
                            <i class="fas fa-bookmark" aria-hidden="true"></i>
                            <span class="sr-only">Bookmark</span>
                        </button>
                        <a class="episode-open" :href="`/podcasts/${ep.showSlug}`"
                            @click.stop>
                            <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                            <span class="sr-only">Open</span>
                        </a>
                    </div>
                </article>
            </template>
        </div>
    </section>

    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>Shows</h2>
        </div>
        <div class="podcast-shows">
            <template x-for="show in shows" :key="show.slug">
                <a class="podcast-show-card" :href="`/podcasts/${show.slug}`">
                    <img :src="show.artwork" alt="" class="podcast-show-art">
                    <div class="podcast-show-title" x-text="show.title"></div>
                    <div class="podcast-show-desc" x-text="show.description"></div>
                    <div class="podcast-show-updated"
                        x-text="show.last_updated ? `Updated ${show.last_updated}` : ''"></div>
                </a>
            </template>
        </div>
    </section>
</div>

<script>
    function podcastsHub() {
        const raw = {{ podcasts|tojson|safe }};
        return {
            shows: raw?.shows || [],
            episodes: [],
            init() {
                // Prefer server-provided single episode list (from podcastCollection.json).
                const serverEps = Array.isArray(raw?.episodes) ? raw.episodes : null;
                const eps = [];

                if (serverEps) {
                    for (const e of serverEps) {
                        const showSlug = e.show_slug || 'rob';
                        const show = (this.shows || []).find(s => s.slug === showSlug);
                        eps.push({
                            key: `${showSlug}:${e.id}`,
                            showSlug,
                            showTitle: show?.title || showSlug,
                            id: e.id,
                            title: e.title,
                            description: e.description || '',
                            date: e.date || '',
                            duration: e.duration || '',
                            duration_seconds: e.duration_seconds || 0,
                            artwork: e.artwork || show?.artwork || '/static/img/default-cover.jpg',
                            audio_url: e.audio_url,
                            // Player expects these keys for the bottom bar UI.
                            type: 'podcast',
                            artist: show?.title || showSlug,
                            cover_art: e.artwork || show?.artwork || '/static/img/default-cover.jpg'
                        });
                    }
                } else {
                    // Fallback: flatten shows -> episodes.
                    for (const s of (this.shows || [])) {
                        for (const e of (s.episodes || [])) {
                            eps.push({
                                key: `${s.slug}:${e.id}`,
                                showSlug: s.slug,
                                showTitle: s.title,
                                id: e.id,
                                title: e.title,
                                description: e.description || '',
                                date: e.date || '',
                                duration: e.duration || '',
                                duration_seconds: e.duration_seconds || 0,
                                artwork: e.artwork || s.artwork || '/static/img/default-cover.jpg',
                                audio_url: e.audio_url,
                                // Player expects these keys for the bottom bar UI.
                                type: 'podcast',
                                artist: s.title,
                                cover_art: e.artwork || s.artwork || '/static/img/default-cover.jpg'
                            });
                        }
                    }
                }

                // Sort newest-first when dates are present.
                eps.sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')));
                this.episodes = eps;
            },
            play(ep) {
                document.dispatchEvent(new CustomEvent('play-track', { detail: ep }));
            },
            openShow(slug) {
                window.location.href = `/podcasts/${slug}`;
            },
            toggleBookmark(ep) {
                if (!window.AhoyBookmarks) return;
                window.AhoyBookmarks.toggle({
                    type: 'podcast-episode',
                    id: ep.key,
                    title: ep.title,
                    artwork: ep.artwork
                });
                try {
                    document.dispatchEvent(new CustomEvent('bookmarks:changed', { detail: { item: ep } }));
                } catch (_) { }
            }
        };
    }
</script>
{% endblock %}

