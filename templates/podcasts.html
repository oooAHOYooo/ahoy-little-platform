{% extends "base.html" %}

{% block title %}Podcasts - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="podcasts-page" x-data="podcastsHub()" x-init="init()">
    {% from "macros/subpage_header.html" import subpage_hero %}
    {{ subpage_hero(title="Podcasts",
    subtitle="Fresh episodes and shows from independent creators.",
    icon_class="fas fa-podcast", scope_class="") }}

    <section class="podcasts-section podcasts-featured-section">
        <div class="podcasts-section-header podcasts-featured-header">
            <div>
                <h2>Shows</h2>
                <p class="podcasts-section-subtitle">Pick a show to filter the
                    latest episodes.</p>
            </div>
            <div class="podcast-filter-chips">
                <button type="button" class="podcast-filter-chip"
                    @click="setActiveShow('all')"
                    :class="{ 'active': isShowActive('all') }">All</button>
                <template x-for="show in featuredShows" :key="show.slug">
                    <button type="button" class="podcast-filter-chip"
                        @click="setActiveShow(show.slug)"
                        :class="{ 'active': isShowActive(show.slug) }"
                        x-text="show.title"></button>
                </template>
            </div>
        </div>
        <!-- Mobile: dropdown show picker -->
        <div class="podcast-shows-dropdown-mobile">
            <select class="podcast-show-select"
                @change="setActiveShow($event.target.value)">
                <option value="all" :selected="activeShowSlug === 'all'">All Shows</option>
                <template x-for="show in featuredShows" :key="show.slug">
                    <option :value="show.slug" x-text="show.title"
                        :selected="activeShowSlug === show.slug"></option>
                </template>
            </select>
        </div>
        <!-- Desktop: show cards grid -->
        <div class="podcast-shows podcast-shows-preview podcast-shows-desktop">
            <template x-for="show in featuredShows" :key="show.slug">
                <div class="podcast-show-preview-card"
                    :class="{ 'active': isShowActive(show.slug) }">
                    <button type="button" class="podcast-show-card podcast-show-card--filter"
                        @click="setActiveShow(show.slug)">
                        <img :src="show.artwork" alt class="podcast-show-art">
                        <div class="podcast-show-title" x-text="show.title"></div>
                        <div class="podcast-show-desc"
                            x-text="show.description"></div>
                        <div class="podcast-show-updated"
                            x-text="show.last_updated ? `Updated ${show.last_updated}` : ''"></div>
                    </button>
                    <a class="podcast-show-open" :href="`/podcasts/${show.slug}`">
                        Open show
                        <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    </a>
                </div>
            </template>
        </div>
    </section>

    <section class="podcasts-section">
        <div class="podcasts-section-header">
            <h2>New Episodes</h2>
        </div>

        <div class="episode-list">
            <template x-for="ep in filteredEpisodes" :key="ep.key">
                <article class="episode-row" @click="openShow(ep.showSlug)">
                    <img class="episode-art" :src="ep.artwork" alt>
                    <div class="episode-meta">
                        <div class="episode-title" x-text="ep.title"></div>
                        <div class="episode-subtitle">
                            <span class="episode-show"
                                x-text="ep.showTitle"></span>
                            <span class="episode-dot">•</span>
                            <span class="episode-time"
                                x-text="ep.duration"></span>
                            <span class="episode-dot" x-show="ep.date">•</span>
                            <span class="episode-date" x-show="ep.date"
                                x-text="ep.date"></span>
                        </div>
                        <div class="episode-desc" x-text="ep.description"></div>
                    </div>

                    <div class="episode-actions">
                        <button type="button" class="episode-btn"
                            @click.stop="play(ep)" title="Play">
                            <i class="fas fa-play" aria-hidden="true"></i>
                            <span class="sr-only">Play</span>
                        </button>
                        <div class="queue-container"
                            x-data="globalQueueHandler()" x-init="init()">
                            <button type="button" class="episode-btn queue-btn"
                                @click.stop="addToQueue('podcast-episode', ep.key, ep.title, ep.artwork, ep)"
                                :class="{ 'in-queue': isInQueue('podcast-episode', ep.key) }"
                                title="Add to queue">
                                <i
                                    :class="isInQueue('podcast-episode', ep.key) ? 'fas fa-check' : 'fas fa-plus'"
                                    aria-hidden="true"></i>
                                <span class="sr-only">Add to queue</span>
                            </button>
                        </div>
                        <button type="button" class="episode-btn bm-btn"
                            @click.stop="toggleBookmark(ep)" title="Bookmark">
                            <i class="fas fa-bookmark" aria-hidden="true"></i>
                            <span class="sr-only">Bookmark</span>
                        </button>
                        <a class="episode-open"
                            :href="`/podcasts/${ep.showSlug}`"
                            @click.stop>
                            <i class="fas fa-external-link-alt"
                                aria-hidden="true"></i>
                            <span class="sr-only">Open</span>
                        </a>
                    </div>
                </article>
            </template>
        </div>
    </section>
</div>

<script>
    function podcastsHub() {
        const raw = {{ podcasts|tojson|safe }};
        return {
            shows: raw?.shows || [],
            featuredShows: [],
            episodes: [],
            activeShowSlug: 'all',
            init() {
                this.featuredShows = (this.shows || []).slice(0, 4);
                const featuredSlugs = new Set(this.featuredShows.map(s => s.slug));
                // Prefer server-provided single episode list (from podcastCollection.json).
                const serverEps = Array.isArray(raw?.episodes) ? raw.episodes : null;
                const eps = [];

                if (serverEps) {
                    for (const e of serverEps) {
                        const showSlug = e.show_slug || 'rob';
                        if (!featuredSlugs.has(showSlug)) continue;
                        const show = (this.shows || []).find(s => s.slug === showSlug);
                        eps.push({
                            key: `${showSlug}:${e.id}`,
                            showSlug,
                            showTitle: show?.title || showSlug,
                            id: e.id,
                            title: e.title,
                            description: e.description || '',
                            date: e.date || '',
                            duration: e.duration || '',
                            duration_seconds: e.duration_seconds || 0,
                            artwork: e.artwork || show?.artwork || '/static/img/default-cover.jpg',
                            audio_url: e.audio_url,
                            // Player expects these keys for the bottom bar UI.
                            type: 'podcast',
                            artist: show?.title || showSlug,
                            cover_art: e.artwork || show?.artwork || '/static/img/default-cover.jpg'
                        });
                    }
                } else {
                    // Fallback: flatten shows -> episodes.
                    for (const s of (this.shows || [])) {
                        if (!featuredSlugs.has(s.slug)) continue;
                        for (const e of (s.episodes || [])) {
                            eps.push({
                                key: `${s.slug}:${e.id}`,
                                showSlug: s.slug,
                                showTitle: s.title,
                                id: e.id,
                                title: e.title,
                                description: e.description || '',
                                date: e.date || '',
                                duration: e.duration || '',
                                duration_seconds: e.duration_seconds || 0,
                                artwork: e.artwork || s.artwork || '/static/img/default-cover.jpg',
                                audio_url: e.audio_url,
                                // Player expects these keys for the bottom bar UI.
                                type: 'podcast',
                                artist: s.title,
                                cover_art: e.artwork || s.artwork || '/static/img/default-cover.jpg'
                            });
                        }
                    }
                }

                // Sort newest-first when dates are present.
                eps.sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')));
                this.episodes = eps;
            },
            get filteredEpisodes() {
                if (this.activeShowSlug === 'all') return this.episodes;
                return this.episodes.filter(ep => ep.showSlug === this.activeShowSlug);
            },
            setActiveShow(slug) {
                this.activeShowSlug = slug;
            },
            isShowActive(slug) {
                return this.activeShowSlug === slug;
            },
            async play(ep) {
                // Set the full episode list as the playlist (sorted A-Z by title)
                // so next/prev buttons navigate through all episodes
                const sorted = [...this.episodes].sort((a, b) =>
                    (a.title || '').localeCompare(b.title || '', undefined, { sensitivity: 'base' })
                );
                if (window.__ahoyEnsurePlayer) {
                    await window.__ahoyEnsurePlayer();
                }
                if (window.mediaPlayer && typeof window.mediaPlayer.setPlaylist === 'function') {
                    window.mediaPlayer.setPlaylist(sorted);
                    const idx = sorted.findIndex(e => e.key === ep.key);
                    window.mediaPlayer.currentIndex = idx >= 0 ? idx : 0;
                }

                document.dispatchEvent(new CustomEvent('play-track', { detail: ep }));
            },
            openShow(slug) {
                window.location.href = `/podcasts/${slug}`;
            },
            toggleBookmark(ep) {
                if (!window.AhoyBookmarks) return;
                window.AhoyBookmarks.toggle({
                    type: 'podcast-episode',
                    id: ep.key,
                    title: ep.title,
                    artwork: ep.artwork
                });
                try {
                    document.dispatchEvent(new CustomEvent('bookmarks:changed', { detail: { item: ep } }));
                } catch (_) { }
            }
        };
    }
</script>
{% endblock %}
