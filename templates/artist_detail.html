{% extends "base.html" %}
<div class="track-actions">
    <button class="action-btn save-btn bm-btn"
        @click.stop="window.AhoyBookmarks && window.AhoyBookmarks.toggle({ type: 'track', id: track.id, title: track.title, artwork: track.cover_art }); $el.classList.add('sparkle'); setTimeout(() => $el.classList.remove('sparkle'), 600)"
        :aria-pressed="window.AhoyBookmarks ? window.AhoyBookmarks.isBookmarked('track', track.id) : false"
        :class="{ 'just-bookmarked': window.AhoyBookmarks && window.AhoyBookmarks.isBookmarked('track', track.id) }">
        <span aria-hidden="true">
            <i
                x-show="window.AhoyBookmarks && window.AhoyBookmarks.isBookmarked('track', track.id)"
                class="fas fa-bookmark"
                style="color: var(--accent-color);"></i>
            <i
                x-show="!(window.AhoyBookmarks && window.AhoyBookmarks.isBookmarked('track', track.id))"
                class="far fa-bookmark"></i>
        </span>
        <span class="sr-only">Bookmark</span>
    </button>
</div>
{% block title %}{{ artist.name }} - Artist Profile - Ahoy Indie Media{%
endblock %}

{% block meta %}
<meta name="description"
    content="{{ artist.bio or 'Discover ' + artist.name + ' on Ahoy Indie Media. ' + (artist.genre or 'Indie artist') + ' with ' + (artist.music_count or 0)|string + ' tracks and ' + (artist.show_count or 0)|string + ' shows.' }}">
<meta name="keywords"
    content="{{ artist.name }}, {{ artist.genre or 'indie music' }}, {{ artist.type or 'artist' }}, ahoy indie media, music, shows, {{ artist.location or 'indie artist' }}">
<meta property="og:title" content="{{ artist.name }} - Artist Profile">
<meta property="og:description"
    content="{{ artist.bio or 'Discover ' + artist.name + ' on Ahoy Indie Media' }}">
<meta property="og:image"
    content="{{ artist.image or '/static/img/default-avatar.png' }}">
<meta property="og:type" content="profile">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ artist.name }} - Artist Profile">
<meta name="twitter:description"
    content="{{ artist.bio or 'Discover ' + artist.name + ' on Ahoy Indie Media' }}">
<meta name="twitter:image"
    content="{{ artist.image or '/static/img/default-avatar.png' }}">
{% endblock %}

{% block content %}
<div class="artist-detail-page" x-data="artistGallery()" x-init="init()">
    <!-- Hero: image + big name only -->
    <section class="artist-hero">
        <div class="artist-hero-bg"
            :style="`background-image: url(${artist.image || '/static/img/default-avatar.png'})`"></div>
        <div class="artist-hero-content">
            <div class="artist-avatar-large">
                <img :src="artist.image || '/static/img/default-avatar.png'"
                    :alt="artist.name">
            </div>
            <div class="artist-info">
                <h1 data-artist-name x-text="artist.name"></h1>
            </div>
        </div>
    </section>

    <!-- Mixed media gallery (tracks + shows) -->
    <section class="artist-content">
        <div class="content-header">
            <h2>Media by <span x-text="artist.name"></span></h2>
        </div>

        <div class="music-grid">
            <template x-for="item in mediaItems" :key="item.key">
                <div class="track-card" @click="playItem(item)">
                    <div class="track-cover">
                        <img
                            :src="item.image || '/static/img/default-cover.jpg'"
                            :alt="item.title" class="image-placeholder"
                            loading="lazy">
                        <div class="track-overlay">
                            <button @click.stop="playItem(item)"
                                class="play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="track-actions">
                                <button class="action-btn save-btn bm-btn"
                                    @click.stop="toggleBookmark(item)"
                                    :aria-pressed="isBookmarked(item.kind, item.id)"
                                    :class="{ 'just-bookmarked': isBookmarked(item.kind, item.id) }">
                                    <span aria-hidden="true">
                                        <i
                                            x-show="isBookmarked(item.kind, item.id)"
                                            class="fas fa-bookmark"
                                            style="color: var(--accent-color);"></i>
                                        <i
                                            x-show="!isBookmarked(item.kind, item.id)"
                                            class="far fa-bookmark"></i>
                                    </span>
                                    <span class="sr-only"
                                        x-text="isBookmarked(item.kind, item.id) ? 'Remove bookmark' : 'Add bookmark'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="track-info">
                        <h4 x-text="item.title"></h4>
                        <p x-text="item.subtitle"></p>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="!isLoading && mediaItems.length === 0" class="empty-state">
            <i class="fas fa-box-open"></i>
            <h3>No media found</h3>
        </div>
    </section>
</div>

<script>
function artistGallery() {
    return {
        artist: {{ artist|tojson }},
        mediaItems: [],
        isLoading: true,

        init() {
            // Prefer client bootstrap artist if provided
            if (window.__ARTIST__) this.artist = window.__ARTIST__;
            this.composeMedia();
        },

        async composeMedia() {
            this.isLoading = true;
            const items = [];
            const tracks = Array.isArray(this.artist.tracks) ? this.artist.tracks : [];
            const shows  = Array.isArray(this.artist.shows)  ? this.artist.shows  : [];

            for (const t of tracks) {
                items.push({
                    key: `track:${t.id}`,
                    kind: 'track',
                    id: t.id,
                    title: t.title || 'Untitled',
                    subtitle: t.genre || 'Music',
                    image: t.cover_art || this.artist.image,
                    data: t
                });
            }
            for (const s of shows) {
                items.push({
                    key: `show:${s.id}`,
                    kind: 'show',
                    id: s.id,
                    title: s.title || 'Untitled',
                    subtitle: s.host || s.category || 'Show',
                    image: s.thumbnail || this.artist.image,
                    data: s
                });
            }

            // If the artist object didn't include media, build from global JSONs
            if (items.length === 0) {
                const slug = (window.slugify ? window.slugify(this.artist.slug || this.artist.name) : (this.artist.slug || (this.artist.name || '').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')));
                try {
                    const [musicRes, showsRes] = await Promise.all([
                        fetch('/api/music'),
                        fetch('/api/shows')
                    ]);
                    const musicJson = musicRes.ok ? await musicRes.json() : { tracks: [] };
                    const showsJson = showsRes.ok ? await showsRes.json() : { shows: [] };

                    const mTracks = Array.isArray(musicJson.tracks) ? musicJson.tracks.filter(t => (t.artist_slug || '').toLowerCase() === slug) : [];
                    for (const t of mTracks) {
                        items.push({
                            key: `track:${t.id}`,
                            kind: 'track',
                            id: t.id,
                            title: t.title || 'Untitled',
                            subtitle: t.artist || 'Music',
                            image: t.cover_art || this.artist.image,
                            data: t
                        });
                    }

                    const mShows = Array.isArray(showsJson.shows) ? showsJson.shows.filter(s => (s.host_slug || '').toLowerCase() === slug) : [];
                    for (const s of mShows) {
                        items.push({
                            key: `show:${s.id}`,
                            kind: 'show',
                            id: s.id,
                            title: s.title || 'Untitled',
                            subtitle: s.host || s.category || 'Show',
                            image: s.thumbnail || this.artist.image,
                            data: s
                        });
                    }
                } catch (e) {
                    console.error('Failed to build media from global JSONs', e);
                }
            }

            // Deduplicate by key in case of repeats
            const seen = new Set();
            const unique = [];
            for (const it of items) { if (!seen.has(it.key)) { seen.add(it.key); unique.push(it); } }

            unique.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            this.mediaItems = unique;
            this.isLoading = false;
        },

        playItem(item) {
            const type = item.kind === 'show' ? 'show' : 'music';
            window.location.href = `/player?id=${encodeURIComponent(item.id)}&type=${type}`;
        },

        toggleBookmark(item) {
            if (window.AhoyBookmarks) {
                window.AhoyBookmarks.toggle({ type: item.kind === 'show' ? 'show' : 'track', id: item.id, title: item.title, artwork: item.image });
                this.lastBookmarkAction = Date.now();
            }
        },

        isBookmarked(type, id) {
            this.lastBookmarkAction;
            if (window.AhoyBookmarks) return window.AhoyBookmarks.isBookmarked(type === 'show' ? 'show' : 'track', id);
            return false;
        },

        lastBookmarkAction: 0
    };
}
</script>
{% endblock %}
