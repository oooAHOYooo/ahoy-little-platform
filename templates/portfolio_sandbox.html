{% extends "base.html" %}

{% block title %}Portfolio Sandbox — Fake Money{% endblock %}

{% block extra_css %}
<style>
    .sandbox-page { min-height: 100vh; background:#0f1115; color:#e8e8f1; padding: 1.25rem; }
    .sandbox-container { max-width: 1100px; margin: 0 auto; }
    .sandbox-header { text-align:center; margin: .5rem 0 1rem; }
    .sandbox-header h1 { font-size: 1.5rem; font-weight: 800; margin: 0; }
    .sandbox-header p { color:#a2a3b0; margin:.25rem 0 0; font-size:.9rem; }

    .grid { display:grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }

    .card { background: rgba(255,255,255,.035); border:1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 12px; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
    .card h3 { margin: 0 0 .5rem; font-size: 1rem; font-weight: 700; color:#f1f1fa; }

    .kpis { display:grid; gap:10px; grid-template-columns: repeat(3,1fr); }
    .kpi { background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07); border-radius:10px; padding:10px; }
    .kpi .v { font-size:1.25rem; font-weight:800; font-variant-numeric: tabular-nums; }
    .kpi .l { font-size:.7rem; text-transform:uppercase; letter-spacing:.06em; color:#9aa0ad; }

    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .row input[type="number"], .row input[type="text"] { background:#12141a; color:#e8e8f1; border:1px solid #222532; border-radius:10px; padding:.5rem .6rem; min-width: 120px; }
    .row .btn { border-radius:10px; padding:.5rem .75rem; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); color:#e8e8f1; cursor:pointer; }
    .row .btn.primary { background: linear-gradient(180deg, #3a7bd5 0%, #00d2ff 100%); border-color: rgba(0,210,255,.35); color:white; }
    .row .btn.ghost { background: rgba(255,255,255,.03); }

    .alloc-list { display:grid; gap:8px; }
    .alloc-item { display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07); border-radius:10px; padding:8px; }
    .alloc-name { font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .alloc-amt { font-variant-numeric: tabular-nums; font-weight:800; }
    .alloc-actions .btn { padding:.35rem .6rem; }

    .chart-wrap { position: relative; height: 260px; }
    .muted { color:#9aa0ad; }
    .note { font-size:.8rem; color:#a2a3b0; }
</style>
{% endblock %}

{% block content %}
<div class="sandbox-page" x-data="portfolioSandbox()" x-init="init()">
    <div class="sandbox-container">
        <div class="sandbox-header">
            <h1>Portfolio Sandbox (Fake Money)</h1>
            <p>Practice funding and allocation flows with play credits. Nothing
                here touches real accounts.</p>
        </div>

        <div class="grid">
            <!-- Left: Wallet + Allocation + Charts -->
            <div class="stack">
                <div class="card">
                    <h3>Wallet & Inflows</h3>
                    <div class="kpis" style="margin-bottom:8px;">
                        <div class="kpi">
                            <div class="v"
                                x-text="formatMoney(walletBalance)"></div>
                            <div class="l">Wallet Balance</div>
                        </div>
                        <div class="kpi">
                            <div class="v"
                                x-text="formatMoney(portfolioValue)"></div>
                            <div class="l">Portfolio Value</div>
                        </div>
                        <div class="kpi">
                            <div class="v"
                                x-text="formatMoney(totalInflows)"></div>
                            <div class="l">Total Inflows</div>
                        </div>
                    </div>
                    <div class="row" style="margin-bottom:6px;">
                        <input type="number" min="0" step="1"
                            x-model.number="depositAmount"
                            placeholder="Amount" />
                        <button class="btn primary" @click="deposit()">Add
                            Funds</button>
                        <span class="note">Tip: use this to simulate loading
                            money into Ahoy.</span>
                    </div>
                    <div class="row" style="margin-top:6px;">
                        <select x-model="boostArtistId"
                            @click="artists.length===0 && loadArtists()"
                            style="min-width:180px; background:#12141a; color:#e8e8f1; border:1px solid #222532; border-radius:10px; padding:.5rem .6rem;">
                            <option value>Select artist for Boost…</option>
                            <template x-for="a in artists" :key="a.id">
                                <option :value="a.id" x-text="a.name"></option>
                            </template>
                        </select>
                        <input type="number" min="1" step="1"
                            x-model.number="boostAmount"
                            placeholder="Boost Amount" />
                        <button class="btn primary"
                            @click="simulateBoost()">Simulate Boost</button>
                        <span class="note">This mirrors the real Boost flow but
                            only affects your fake portfolio.</span>
                    </div>
                </div>

                <div class="card">
                    <h3>Allocate to Artists (like positions)</h3>
                    <div class="row" style="margin-bottom:6px;">
                        <input type="text" x-model="newAssetName"
                            placeholder="Artist or Asset Name" />
                        <input type="number" min="0" step="1"
                            x-model.number="newAssetAmount"
                            placeholder="Amount" />
                        <button class="btn primary"
                            @click="allocate()">Allocate</button>
                        <button class="btn ghost"
                            @click="distributeEven()">Distribute Even</button>
                        <span class="note">Allocations reduce wallet and
                            increase portfolio.</span>
                    </div>
                    <div class="alloc-list" x-show="positions.length > 0">
                        <template x-for="(pos, idx) in positions" :key="pos.id">
                            <div class="alloc-item">
                                <div class="alloc-name" x-text="pos.name"></div>
                                <div class="alloc-amt"
                                    x-text="formatMoney(pos.amount)"></div>
                                <div class="alloc-actions row">
                                    <button class="btn"
                                        @click="change(idx, 5)">+5</button>
                                    <button class="btn"
                                        @click="change(idx, -5)">-5</button>
                                    <button class="btn"
                                        @click="remove(idx)">Remove</button>
                                </div>
                            </div>
                        </template>
                        <div class="muted" x-show="positions.length === 0">No
                            allocations yet.</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Distribution</h3>
                    <div class="chart-wrap"><canvas
                            id="pieSandbox"></canvas></div>
                </div>

                <div class="card">
                    <h3>Balance Over Time</h3>
                    <div class="chart-wrap"><canvas
                            id="lineSandbox"></canvas></div>
                </div>
            </div>

            <!-- Right: History -->
            <div class="card">
                <h3>Activity</h3>
                <div class="muted" x-show="history.length === 0">No activity
                    yet. Add funds or allocate.</div>
                <ul style="list-style:none; padding-left:0; margin:0;">
                    <template x-for="evt in history" :key="evt.id">
                        <li
                            style="padding:.4rem 0; border-bottom:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; gap:8px;">
                            <span x-text="evt.label"></span>
                            <strong x-text="formatMoney(evt.amount)"></strong>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script
    src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
function portfolioSandbox() {
  const STORAGE_KEY = 'ahoy.sandbox.v1';
  return {
    // State
    walletBalance: 0,
    positions: [],
    history: [],
    depositAmount: 20,
    newAssetName: '',
    newAssetAmount: 10,
    // Boost (practice) state
    artists: [],
    boostArtistId: '',
    boostAmount: 3,
    pie: null,
    line: null,

    get portfolioValue() {
      return this.positions.reduce((s, p) => s + p.amount, 0);
    },
    get totalInflows() {
      return this.history.filter(h => h.type === 'deposit').reduce((s, h) => s + h.amount, 0);
    },

    init() {
      this.load();
      this.$nextTick(() => { this.renderCharts(); });
    },

    async loadArtists() {
      try {
        const r = await fetch('/api/artists');
        const d = await r.json();
        this.artists = (d.artists || []).map(a => ({ id: a.id || a.name, name: a.name || 'Artist' }));
      } catch (_) { this.artists = []; }
    },

    save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        walletBalance: this.walletBalance,
        positions: this.positions,
        history: this.history
      }));
      this.updateCharts();
    },
    load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          this.walletBalance = parsed.walletBalance || 0;
          this.positions = parsed.positions || [];
          this.history = parsed.history || [];
        }
      } catch {}
    },

    deposit() {
      const amt = Math.max(0, Number(this.depositAmount || 0));
      if (!amt) return;
      this.walletBalance += amt;
      this.history.unshift({ id: crypto.randomUUID(), type: 'deposit', amount: amt, label: `Deposit` });
      this.save();
    },

    allocate() {
      const name = (this.newAssetName || '').trim();
      const amt = Math.max(0, Number(this.newAssetAmount || 0));
      if (!name || !amt) return;
      if (this.walletBalance < amt) return alert('Not enough wallet balance.');
      this.walletBalance -= amt;
      const idx = this.positions.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
      if (idx >= 0) this.positions[idx].amount += amt;
      else this.positions.push({ id: crypto.randomUUID(), name, amount: amt });
      this.history.unshift({ id: crypto.randomUUID(), type: 'allocate', amount: amt, label: `Allocate → ${name}` });
      this.newAssetAmount = 10; this.newAssetName = '';
      this.save();
    },

    simulateBoost() {
      const artist = (this.artists || []).find(a => String(a.id) === String(this.boostArtistId));
      const name = artist ? artist.name : 'Unknown Artist';
      const amt = Math.max(0, Number(this.boostAmount || 0));
      if (!artist || !amt) return alert('Pick an artist and amount.');
      if (this.walletBalance < amt) return alert('Not enough wallet balance. Add funds first.');
      this.walletBalance -= amt;
      const idx = this.positions.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
      if (idx >= 0) this.positions[idx].amount += amt;
      else this.positions.push({ id: crypto.randomUUID(), name, amount: amt });
      this.history.unshift({ id: crypto.randomUUID(), type: 'boost', amount: amt, label: `Boost → ${name}` });
      this.save();
    },

    change(idx, delta) {
      const pos = this.positions[idx]; if (!pos) return;
      const adj = Math.min(Math.max(delta, -pos.amount), this.portfolioValue);
      if (adj > 0 && this.walletBalance < adj) return alert('Not enough wallet balance.');
      pos.amount += adj;
      if (pos.amount <= 0) this.positions.splice(idx,1);
      if (adj > 0) this.walletBalance -= adj; else this.walletBalance += -adj;
      this.history.unshift({ id: crypto.randomUUID(), type: 'rebalance', amount: Math.abs(adj), label: `${adj>0?'+':'-'} ${pos.name}` });
      this.save();
    },

    remove(idx) {
      const pos = this.positions[idx]; if (!pos) return;
      this.walletBalance += pos.amount;
      this.history.unshift({ id: crypto.randomUUID(), type: 'close', amount: pos.amount, label: `Close → ${pos.name}` });
      this.positions.splice(idx,1);
      this.save();
    },

    distributeEven() {
      if (this.positions.length === 0) return;
      const total = this.portfolioValue + this.walletBalance;
      const targetEach = total / this.positions.length;
      this.positions.forEach(p => {
        const diff = targetEach - p.amount;
        if (diff > 0) {
          const add = Math.min(diff, this.walletBalance);
          this.walletBalance -= add;
          p.amount += add;
        } else {
          const give = Math.min(-diff, p.amount);
          p.amount -= give;
          this.walletBalance += give;
        }
      });
      this.history.unshift({ id: crypto.randomUUID(), type: 'rebalance-even', amount: 0, label: `Distribute Even` });
      this.save();
    },

    renderCharts() {
      const pieEl = document.getElementById('pieSandbox');
      const lineEl = document.getElementById('lineSandbox');
      if (pieEl) {
        this.pie = new Chart(pieEl, {
          type: 'doughnut',
          data: { labels: [], datasets: [{ data: [], backgroundColor: ['#00d2ff','#3a7bd5','#43e97b','#fa709a','#fee140','#30cfd0'] }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      }
      if (lineEl) {
        this.line = new Chart(lineEl, {
          type: 'line',
          data: { labels: [], datasets: [{ label:'Total Value', data: [], borderColor:'#3a7bd5', backgroundColor:'rgba(58,123,213,.15)', fill:true, tension:.35 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
        });
      }
      this.updateCharts(true);
    },

    updateCharts(initial=false) {
      if (this.pie) {
        this.pie.data.labels = this.positions.map(p => p.name);
        this.pie.data.datasets[0].data = this.positions.map(p => Number(p.amount.toFixed(2)));
        this.pie.update();
      }
      if (this.line) {
        // maintain last 20 points of total value (wallet + portfolio)
        const total = Number((this.walletBalance + this.portfolioValue).toFixed(2));
        const ds = this.line.data.datasets[0];
        const labels = this.line.data.labels;
        if (initial && ds.data.length === 0) {
          // seed with a small history to show a line
          const seed = [total*0.6, total*0.75, total*0.9, total];
          ds.data = seed.map(v => Number(v.toFixed(2)));
          const now = new Date();
          labels.splice(0, labels.length, ...['T-3','T-2','T-1','Now']);
        } else {
          ds.data.push(total);
          labels.push(new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
          if (ds.data.length > 20) { ds.data.shift(); labels.shift(); }
        }
        this.line.update();
      }
    },

    formatMoney(n) { return '$' + (Number(n||0)).toFixed(2); }
  };
}
</script>
{% endblock %}
