{% extends "base.html" %}
{% block title %}Reset Password - Ahoy{% endblock %}

{% block extra_css %}
<style>
  .navbar { display:none; }
  .main-content { padding-top: 0; }
  .pw-wrap { max-width: 520px; margin: 0 auto; padding: 22px 16px 44px; }
  .pw-card { border-radius: 16px; border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03); padding: 16px; }
  .pw-title { font-size: 20px; margin: 0; }
  .pw-sub { margin: 8px 0 0; color: rgba(255,255,255,0.72); }
  .pw-form { margin-top: 14px; display:flex; flex-direction: column; gap: 10px; }
  .pw-label { font-weight: 800; display:flex; flex-direction: column; gap: 6px; }
  .pw-input { width:100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.35); color:#fff; }
  .pw-msg { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(16,185,129,0.30); background: rgba(16,185,129,0.10); color: rgba(255,255,255,0.92); }
  .pw-err { border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.10); }
</style>
{% endblock %}

{% block content %}
<div class="pw-wrap" x-data="resetPw()" x-init="init()">
  <div class="pw-card">
    <h1 class="pw-title">New password time üîê</h1>
    <p class="pw-sub">Make it strong-ish. Your future self will high-five you.</p>

    <form class="pw-form" @submit.prevent="submit()">
      <label class="pw-label">
        New password
        <input class="pw-input" :type="show ? 'text' : 'password'" autocomplete="new-password" minlength="8"
          x-model="password" required>
      </label>
      <label class="pw-label">
        Confirm
        <input class="pw-input" :type="show ? 'text' : 'password'" autocomplete="new-password" minlength="8"
          x-model="confirm" required>
      </label>
      <label style="display:flex; align-items:center; gap:8px; font-weight:800;">
        <input type="checkbox" x-model="show"> show password
      </label>
      <button class="btn btn-primary" type="submit" :disabled="loading || !canSubmit">
        <span x-show="!loading">Reset password üéâ</span>
        <span x-show="loading">Resetting‚Ä¶</span>
      </button>
    </form>

    <div class="pw-msg" :class="{ 'pw-err': isError }" x-show="message" x-text="message"></div>
    <div style="margin-top:10px;"><a href="/auth">Back to sign in</a></div>
  </div>
</div>

<script>
function resetPw() {
  return {
    token: '',
    password: '',
    confirm: '',
    show: false,
    loading: false,
    message: '',
    isError: false,
    get canSubmit() {
      return this.password && this.password.length >= 8 && this.password === this.confirm && !!this.token;
    },
    init() {
      const p = new URLSearchParams(window.location.search);
      this.token = p.get('token') || '';
      if (!this.token) {
        this.message = 'Missing reset token. Please request a new link.';
        this.isError = true;
      }
    },
    async submit() {
      this.loading = true;
      this.message = '';
      this.isError = false;
      if (this.password !== this.confirm) {
        this.message = 'Passwords do not match.';
        this.isError = true;
        this.loading = false;
        return;
      }
      try {
        const r = await fetch('/api/auth/password-reset/confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token: this.token, password: this.password })
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          this.isError = true;
          if (data.error === 'token_expired') this.message = 'That link expired. Request a new one?';
          else this.message = 'Reset failed. Try requesting a new link.';
          return;
        }
        this.message = 'Password reset! You can sign in now ‚ú®';
      } catch (_) {
        this.isError = true;
        this.message = 'Reset failed. Try requesting a new link.';
      } finally {
        this.loading = false;
      }
    }
  };
}
</script>
{% endblock %}

