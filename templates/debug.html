{% extends "base.html" %}

{% block title %}Debug - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="debug-page" x-data="debugPage()" x-init="loadSampleAccounts()">
    <!-- Hero Section -->
    <section class="hero-compact">
        <div class="container">
            <h1>Debug & Sample Accounts</h1>
            <p>Test accounts and development tools for Ahoy Indie Media</p>
        </div>
    </section>

    <!-- Sample Accounts Section -->
    <section class="debug-section">
        <div class="section-header">
            <h2><i class="fas fa-users"></i> Sample Accounts</h2>
            <p>Use these accounts to test different user experiences</p>
        </div>

        <div class="accounts-grid">
            <template x-for="account in sampleAccounts" :key="account.username">
                <div class="account-card">
                    <div class="account-avatar">
                        <img :src="account.avatar" :alt="account.display_name">
                    </div>
                    <div class="account-info">
                        <h3 x-text="account.display_name"></h3>
                        <p class="account-username"
                            x-text="'@' + account.username"></p>
                        <p class="account-email" x-text="account.email"></p>
                        <div class="account-stats">
                            <span class="stat">
                                <i class="fas fa-music"></i>
                                <span
                                    x-text="account.stats.saved_tracks"></span>
                                tracks
                            </span>
                            <span class="stat">
                                <i class="fas fa-play-circle"></i>
                                <span x-text="account.stats.saved_shows"></span>
                                shows
                            </span>
                            <span class="stat">
                                <i class="fas fa-heart"></i>
                                <span
                                    x-text="account.stats.liked_content"></span>
                                liked
                            </span>
                        </div>
                    </div>
                    <div class="account-actions">
                        <button @click="loginAs(account)"
                            class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <button @click="viewProfile(account)"
                            class="btn btn-outline">
                            <i class="fas fa-user"></i> Profile
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Database Health Section -->
    <section class="debug-section">
        <div class="section-header">
            <h2><i class="fas fa-database"></i> Database</h2>
            {% if db_ok %}
            <span
                style="background:#10b981;color:white;padding:4px 8px;border-radius:9999px;font-weight:600;">DB
                OK</span>
            {% else %}
            <span
                style="background:#ef4444;color:white;padding:4px 8px;border-radius:9999px;font-weight:600;">DB
                ERROR</span>
            {% endif %}
        </div>
        {% if not db_ok and db_error %}
        <p style="color:#b91c1c;">{{ db_error }}</p>
        {% endif %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Table</th>
                        <th>Row Count</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Users</td><td>{{ db_counts.users }}</td></tr>
                    <tr><td>Playlists</td><td>{{ db_counts.playlists
                            }}</td></tr>
                    <tr><td>Bookmarks</td><td>{{ db_counts.bookmarks
                            }}</td></tr>
                    <tr><td>Play History</td><td>{{ db_counts.play_history
                            }}</td></tr>
                    <tr><td>Feedback</td><td>{{ db_counts.feedback }}</td></tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Development Tools Section -->
    <section class="debug-section">
        <div class="section-header">
            <h2><i class="fas fa-tools"></i> Development Tools</h2>
            <p>Tools for testing and development</p>
        </div>

        <div class="tools-grid">
            <div class="tool-card">
                <div class="tool-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h3>Data Management</h3>
                <p>View and manage application data</p>
                <div class="tool-actions">
                    <button @click="viewData('users')" class="btn btn-outline">
                        <i class="fas fa-users"></i> Users
                    </button>
                    <button @click="viewData('music')" class="btn btn-outline">
                        <i class="fas fa-music"></i> Music
                    </button>
                    <button @click="viewData('shows')" class="btn btn-outline">
                        <i class="fas fa-video"></i> Shows
                    </button>
                </div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h3>System Status</h3>
                <p>Check application health and performance</p>
                <div class="tool-actions">
                    <button @click="checkSystemStatus()"
                        class="btn btn-outline">
                        <i class="fas fa-heartbeat"></i> Health Check
                    </button>
                    <button @click="viewLogs()" class="btn btn-outline">
                        <i class="fas fa-file-alt"></i> Logs
                    </button>
                </div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">
                    <i class="fas fa-flask"></i>
                </div>
                <h3>API Testing</h3>
                <p>Test API endpoints and responses</p>
                <div class="tool-actions">
                    <button @click="testAPI('now-playing')"
                        class="btn btn-outline">
                        <i class="fas fa-play"></i> Now Playing
                    </button>
                    <button @click="testAPI('search')" class="btn btn-outline">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button @click="testAPI('artists')" class="btn btn-outline">
                        <i class="fas fa-users"></i> Artists
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Current Session Info -->
    <section class="debug-section" x-show="currentUser">
        <div class="section-header">
            <h2><i class="fas fa-user-circle"></i> Current Session</h2>
        </div>

        <div class="session-info">
            <div class="session-card">
                <h3>Logged in as: <span
                        x-text="currentUser.display_name"></span></h3>
                <p>Username: <span x-text="currentUser.username"></span></p>
                <p>Email: <span x-text="currentUser.email"></span></p>
                <p>Last Login: <span
                        x-text="formatDate(currentUser.last_login)"></span></p>
                <div class="session-actions">
                    <button @click="logout()" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <button @click="refreshSession()" class="btn btn-outline">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Data Viewer Modal -->
    <div x-show="showDataModal" x-cloak class="modal-overlay"
        @click.away="showDataModal = false">
        <div class="modal large-modal">
            <div class="modal-header">
                <h3 x-text="'Data Viewer - ' + currentDataType"></h3>
                <button @click="showDataModal = false" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <pre x-text="JSON.stringify(currentData, null, 2)"></pre>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <section x-show="isLoading" class="loading-section">
        <div class="spinner"></div>
        <p>Loading debug information...</p>
    </section>
</div>

<script>
function debugPage() {
    return {
        // State
        isLoading: true,
        sampleAccounts: [],
        currentUser: null,
        showDataModal: false,
        currentData: null,
        currentDataType: '',
        
        // Initialize
        async loadSampleAccounts() {
            try {
                this.isLoading = true;
                const response = await fetch('/api/debug/sample-accounts');
                const data = await response.json();
                this.sampleAccounts = data.accounts || [];
                this.checkCurrentSession();
            } catch (error) {
                console.error('Error loading sample accounts:', error);
            } finally {
                this.isLoading = false;
            }
        },
        
        checkCurrentSession() {
            // Check if user is logged in
            const userData = window.ahoyApp?.user;
            if (userData) {
                this.currentUser = userData;
            }
        },
        
        // Account actions
        async loginAs(account) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: account.username,
                        password: account.password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.currentUser = data.user;
                    window.location.reload();
                } else {
                    alert('Login failed. Please try again.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        },
        
        viewProfile(account) {
            // Navigate to user profile or show account details
            console.log('View profile for:', account.username);
        },
        
        // Development tools
        async viewData(dataType) {
            try {
                const response = await fetch(`/api/debug/data/${dataType}`);
                const data = await response.json();
                this.currentData = data;
                this.currentDataType = dataType;
                this.showDataModal = true;
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data');
            }
        },
        
        async checkSystemStatus() {
            try {
                const response = await fetch('/api/debug/status');
                const data = await response.json();
                this.currentData = data;
                this.currentDataType = 'System Status';
                this.showDataModal = true;
            } catch (error) {
                console.error('Error checking status:', error);
                alert('Failed to check system status');
            }
        },
        
        viewLogs() {
            // Placeholder for log viewing
            console.log('View logs functionality');
            alert('Log viewing not implemented yet');
        },
        
        async testAPI(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                const data = await response.json();
                this.currentData = data;
                this.currentDataType = `API Test - ${endpoint}`;
                this.showDataModal = true;
            } catch (error) {
                console.error('API test error:', error);
                alert('API test failed');
            }
        },
        
        async logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                this.currentUser = null;
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        },
        
        refreshSession() {
            window.location.reload();
        },
        
        // Utility functions
        formatDate(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleDateString();
        }
    }
}
</script>
{% endblock %}