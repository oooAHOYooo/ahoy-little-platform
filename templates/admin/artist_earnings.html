{% extends "admin/layout.html" %}

{% block title %}Artist Earnings - Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <h1>Artist Earnings (Payout Buckets)</h1>
    
    <div class="admin-search" style="margin-bottom: 20px;">
        <input type="text" id="artistSearch" placeholder="Search artist by slug or name (e.g., alex-figueroa)" 
               style="width: 100%; max-width: 400px; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <button onclick="loadArtistEarnings()" style="margin-left: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
            View Earnings
        </button>
    </div>

    <div id="earningsResult" style="margin-top: 20px;"></div>
</div>

<script>
async function loadArtistEarnings() {
    const artistId = document.getElementById('artistSearch').value.trim();
    if (!artistId) {
        alert('Please enter an artist slug or name');
        return;
    }

    const resultDiv = document.getElementById('earningsResult');
    resultDiv.innerHTML = '<p>Loading...</p>';

    try {
        const response = await fetch(`/payments/artist/${encodeURIComponent(artistId)}/earnings`);
        const data = await response.json();

        if (!response.ok) {
            resultDiv.innerHTML = `<div style="padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 8px;">
                <strong>Error:</strong> ${data.error || 'Artist not found'}
            </div>`;
            return;
        }

        resultDiv.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="margin-top: 0;">${artistId}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Earnings</div>
                        <div style="font-size: 28px; font-weight: bold; color: #667eea;">$${data.total_earnings.toFixed(2)}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Amount to pay artist</div>
                    </div>
                    
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Total Boosted</div>
                        <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">$${data.total_boosted.toFixed(2)}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Total users boosted</div>
                    </div>
                    
                    <div style="padding: 15px; background: #f3e8ff; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Boost Count</div>
                        <div style="font-size: 28px; font-weight: bold; color: #9333ea;">${data.boost_count}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">Number of boosts</div>
                    </div>
                </div>

                ${data.recent_tips && data.recent_tips.length > 0 ? `
                <h3 style="margin-top: 30px;">Recent Boosts</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                            <th style="padding: 10px; text-align: left;">Date</th>
                            <th style="padding: 10px; text-align: right;">Boost Amount</th>
                            <th style="padding: 10px; text-align: right;">Artist Payout</th>
                            <th style="padding: 10px; text-align: center;">User ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.recent_tips.map(tip => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px;">${new Date(tip.created_at).toLocaleDateString()}</td>
                                <td style="padding: 10px; text-align: right;">$${tip.amount.toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; font-weight: bold; color: #667eea;">$${tip.artist_payout.toFixed(2)}</td>
                                <td style="padding: 10px; text-align: center;">${tip.user_id || 'Guest'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : '<p style="color: #999; margin-top: 20px;">No boosts yet.</p>'}
            </div>
        `;
    } catch (error) {
        resultDiv.innerHTML = `<div style="padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 8px;">
            <strong>Error:</strong> ${error.message}
        </div>`;
    }
}

// Allow Enter key to trigger search
document.getElementById('artistSearch').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        loadArtistEarnings();
    }
});
</script>
{% endblock %}
