{% extends "base.html" %}

{% block title %}Cast to TV - Ahoy Indie Media{% endblock %}

{% block content %}
<div class="page-container cast-page" x-data="castPage()" x-init="init()">
    <section class="header-simple">
        <h1><i class="fas fa-tv"></i> Cast Ahoy to your TV</h1>
        <p>Use built-in browser and platform APIs to cast music and shows to your TV or smart display.</p>
    </section>

    <section class="cast-section">
        <h2>1) WebRTC / Remote Play (in-browser)</h2>
        <p>On the TV, open this page and click "Open Receiver". On your phone or laptop, click "Send to Receiver". This uses a simple peer connection to relay the currently playing media URL.</p>
        <div class="cast-actions">
            <button class="btn btn-primary" @click="openReceiver()"><i class="fas fa-tv"></i> Open Receiver (TV)</button>
            <button class="btn btn-outline" @click="sendToReceiver()"><i class="fas fa-paper-plane"></i> Send to Receiver</button>
        </div>
        <div class="hint">Tip: The receiver opens a fullscreen player and auto-plays the selected item.</div>
    </section>

    <section class="cast-section">
        <h2>2) Apple AirPlay (Safari / iOS / macOS)</h2>
        <ul>
            <li>Use Safari on iOS/macOS. Start playing a video or audio in Ahoy.</li>
            <li>Click the AirPlay icon in the video controls or use the system media controls.</li>
            <li>Select your Apple TV or AirPlay-compatible device.</li>
        </ul>
    </section>

    <section class="cast-section">
        <h2>3) Google Cast (Chromecast / Android TV)</h2>
        <ul>
            <li>Use Chrome on desktop or Android. Install the "Cast" extension if prompted.</li>
            <li>Click the browser's Cast button and choose your Chromecast / Android TV.</li>
            <li>Select "Cast tab" for quick mirroring, or "Cast desktop" to mirror the system player.</li>
        </ul>
    </section>

    <section class="cast-section">
        <h2>4) DLNA / Miracast (device mirroring)</h2>
        <ul>
            <li>Windows: Settings → System → Display → Connect to a wireless display.</li>
            <li>Android: Quick Settings → Cast / Smart View (varies by device).</li>
            <li>Many Smart TVs expose a "DLNA receiver"; mirroring your device works with Ahoy’s player.</li>
        </ul>
    </section>

    <section class="cast-section">
        <h2>Receiver Window</h2>
        <p>This opens a minimal fullscreen page that plays a provided media URL. Use with the WebRTC sender above or paste a link manually.</p>
        <div class="cast-actions">
            <button class="btn" @click="openReceiver('/player')"><i class="fas fa-external-link-alt"></i> Open Minimal Player</button>
        </div>
    </section>
</div>

<script>
function castPage(){
  return {
    receiverRef: null,
    channel: null,
    init(){},
    openReceiver(path){
      const url = path || '/player';
      this.receiverRef = window.open(url, 'ahoy-cast-receiver');
      if (!this.receiverRef) alert('Pop-up blocked. Allow pop-ups for this site.');
    },
    async sendToReceiver(){
      try {
        const item = window.mediaPlayer?.currentTrack;
        if (!item) { alert('Play something first, then send.'); return; }
        // Try postMessage to the receiver window
        if (this.receiverRef && !this.receiverRef.closed) {
          this.receiverRef.postMessage({ type: 'ahoy:play', payload: item }, '*');
          alert('Sent to receiver window.');
          return;
        }
        // Fallback: open player URL directly
        const type = (item.type === 'show' || item.video_url) ? 'show' : 'music';
        const href = `/player?id=${encodeURIComponent(item.id)}&type=${type}`;
        this.openReceiver(href);
      } catch(e){
        console.error(e);
        alert('Failed to send to receiver.');
      }
    }
  };
}

// Minimal receiver handler: when a child window receives a play message
window.addEventListener('message', (e)=>{
  const data = e.data || {};
  if (data && data.type === 'ahoy:play' && window.globalPlayer) {
    window.globalPlayer.play(data.payload);
  }
});
</script>
{% endblock %}


