name: Build Android AAB

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-android-aab:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli@5.7.0
    
    - name: Sync Capacitor
      run: |
        npx cap sync android
    
    - name: Build AAB
      run: |
        cd android
        ./gradlew bundleRelease
    
    - name: Sign AAB (if credentials provided)
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      run: |
        chmod +x scripts/sign_apk.sh
        ./scripts/sign_apk.sh android/app/build/outputs/bundle/release/app-release.aab
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    
    - name: Prepare unsigned AAB (if no signing)
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 == '' }}
      run: |
        cp android/app/build/outputs/bundle/release/app-release.aab AhoyIndieMedia-Android-unsigned.aab
        echo "⚠️ AAB is unsigned - Google Play can sign it during upload"
    
    - name: Upload signed AAB
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: AhoyIndieMedia-Android
        path: AhoyIndieMedia-Android-release.aab
    
    - name: Upload unsigned AAB
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: AhoyIndieMedia-Android
        path: AhoyIndieMedia-Android-unsigned.aab
    
    - name: Determine release file
      id: release_file
      run: |
        if [ -f "AhoyIndieMedia-Android-release.aab" ]; then
          echo "file=AhoyIndieMedia-Android-release.aab" >> $GITHUB_OUTPUT
        elif [ -f "AhoyIndieMedia-Android-unsigned.aab" ]; then
          echo "file=AhoyIndieMedia-Android-unsigned.aab" >> $GITHUB_OUTPUT
        else
          echo "file=android/app/build/outputs/bundle/release/app-release.aab" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.release_file.outputs.file }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
